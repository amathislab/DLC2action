<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 12.0.0"/>
    <title>dlc2action.task.universal_task API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../task.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;dlc2action.task</a>

            <img src="https://i.ibb.co/NstG5hz/03.png" class="logo" alt="project logo"/>

            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="class" href="#MyDataParallel">MyDataParallel</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#MyDataParallel.__init__">MyDataParallel</a>
                        </li>
                        <li>
                                <a class="function" href="#MyDataParallel.freeze_feature_extractor">freeze_feature_extractor</a>
                        </li>
                        <li>
                                <a class="function" href="#MyDataParallel.unfreeze_feature_extractor">unfreeze_feature_extractor</a>
                        </li>
                        <li>
                                <a class="function" href="#MyDataParallel.transform_labels">transform_labels</a>
                        </li>
                        <li>
                                <a class="function" href="#MyDataParallel.logit_scale">logit_scale</a>
                        </li>
                        <li>
                                <a class="function" href="#MyDataParallel.main_task_off">main_task_off</a>
                        </li>
                        <li>
                                <a class="function" href="#MyDataParallel.state_dict">state_dict</a>
                        </li>
                        <li>
                                <a class="function" href="#MyDataParallel.ssl_on">ssl_on</a>
                        </li>
                        <li>
                                <a class="function" href="#MyDataParallel.ssl_off">ssl_off</a>
                        </li>
                        <li>
                                <a class="function" href="#MyDataParallel.extract_features">extract_features</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Task">Task</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Task.__init__">Task</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.save_checkpoint">save_checkpoint</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.load_from_checkpoint">load_from_checkpoint</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.save_model">save_model</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.train">train</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.evaluate_prediction">evaluate_prediction</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.evaluate">evaluate</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.predict">predict</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.dataset">dataset</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.dataloader">dataloader</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.generate_full_length_prediction">generate_full_length_prediction</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.generate_submission">generate_submission</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.visualize_results">visualize_results</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.set_ssl_transformations">set_ssl_transformations</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.set_ssl_losses">set_ssl_losses</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.set_log">set_log</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.set_keep_target_none">set_keep_target_none</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.set_generate_ssl_input">set_generate_ssl_input</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.set_model">set_model</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.set_dataloaders">set_dataloaders</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.set_loss">set_loss</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.set_metrics">set_metrics</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.set_transformer">set_transformer</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.set_predict_functions">set_predict_functions</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.count_classes">count_classes</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.behaviors_dict">behaviors_dict</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.update_parameters">update_parameters</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.generate_uncertainty_score">generate_uncertainty_score</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.generate_bald_score">generate_bald_score</a>
                        </li>
                        <li>
                                <a class="function" href="#Task.get_normalization_stats">get_normalization_stats</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../dlc2action.html">dlc2action</a><wbr>.<a href="./../task.html">task</a><wbr>.universal_task    </h1>

                        <div class="docstring"><p>Training and inference</p>
</div>

                        <input id="universal_task-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="universal_task-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="c1">#</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="c1"># DLC2Action is not open-sourced yet.</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="c1"># https://choosealicense.com/no-permission/</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="c1">#</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="sd">Training and inference</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="kn">from</span> <span class="nn">torch.optim</span> <span class="kn">import</span> <span class="n">Optimizer</span><span class="p">,</span> <span class="n">Adam</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="kn">import</span> <span class="nn">torch</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="kn">import</span> <span class="nn">warnings</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="kn">from</span> <span class="nn">dlc2action.transformer.base_transformer</span> <span class="kn">import</span> <span class="n">Transformer</span><span class="p">,</span> <span class="n">EmptyTransformer</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="kn">from</span> <span class="nn">dlc2action.data.dataset</span> <span class="kn">import</span> <span class="n">BehaviorDataset</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="kn">from</span> <span class="nn">dlc2action.model.base_model</span> <span class="kn">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">LoadedModel</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="kn">from</span> <span class="nn">dlc2action.metric.base_metric</span> <span class="kn">import</span> <span class="n">Metric</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="kn">import</span> <span class="nn">random</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span><span class="p">,</span> <span class="n">copy</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="kn">from</span> <span class="nn">optuna.trial</span> <span class="kn">import</span> <span class="n">Trial</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="kn">from</span> <span class="nn">optuna</span> <span class="kn">import</span> <span class="n">TrialPruned</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">floor</span><span class="p">,</span> <span class="n">ceil</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="k">class</span> <span class="nc">MyDataParallel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">):</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">process_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">process_labels</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a>    <span class="k">def</span> <span class="nf">freeze_feature_extractor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">freeze_feature_extractor</span><span class="p">()</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a>    <span class="k">def</span> <span class="nf">unfreeze_feature_extractor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">unfreeze_feature_extractor</span><span class="p">()</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a>    <span class="k">def</span> <span class="nf">transform_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">transform_labels</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a>    <span class="k">def</span> <span class="nf">logit_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">logit_scale</span><span class="p">()</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a>    <span class="k">def</span> <span class="nf">main_task_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">main_task_off</span><span class="p">()</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a>    <span class="k">def</span> <span class="nf">state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>    <span class="k">def</span> <span class="nf">ssl_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">ssl_on</span><span class="p">()</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a>    <span class="k">def</span> <span class="nf">ssl_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">ssl_off</span><span class="p">()</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a>    <span class="k">def</span> <span class="nf">extract_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a><span class="k">class</span> <span class="nc">Task</span><span class="p">:</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a><span class="sd">    A universal trainer class that performs training, evaluation and prediction for all types of tasks and data</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>        <span class="n">train_dataloader</span><span class="p">:</span> <span class="n">DataLoader</span><span class="p">,</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Model</span><span class="p">],</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>        <span class="n">loss</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>        <span class="n">num_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>        <span class="n">transformer</span><span class="p">:</span> <span class="n">Transformer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>        <span class="n">ssl_losses</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>        <span class="n">ssl_weights</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>        <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>        <span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>        <span class="n">val_dataloader</span><span class="p">:</span> <span class="n">DataLoader</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>        <span class="n">test_dataloader</span><span class="p">:</span> <span class="n">DataLoader</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>        <span class="n">optimizer</span><span class="p">:</span> <span class="n">Optimizer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>        <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span><span class="p">,</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>        <span class="n">log_file</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>        <span class="n">augment_train</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>        <span class="n">augment_val</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>        <span class="n">validation_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>        <span class="n">predict_function</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>        <span class="n">primary_predict_function</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>        <span class="n">exclusive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>        <span class="n">ignore_tags</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>        <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>        <span class="n">model_save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>        <span class="n">model_save_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>        <span class="n">pseudolabel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>        <span class="n">pseudolabel_start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>        <span class="n">correction_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>        <span class="n">pseudolabel_alpha_f</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>        <span class="n">alpha_growth_stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">600</span><span class="p">,</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>        <span class="n">parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>        <span class="n">skip_metrics</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a><span class="sd">        Parameters</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a><span class="sd">        ----------</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a><span class="sd">        train_dataloader : torch.utils.data.DataLoader</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a><span class="sd">            a training dataloader</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a><span class="sd">        model : dlc2action.model.base_model.Model</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a><span class="sd">            a model</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a><span class="sd">        loss : callable</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a><span class="sd">            a loss function</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a><span class="sd">        num_epochs : int, default 0</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a><span class="sd">            the number of epochs</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a><span class="sd">        transformer : dlc2action.transformer.base_transformer.Transformer, optional</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a><span class="sd">            a transformer</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a><span class="sd">        ssl_losses : list, optional</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a><span class="sd">            a list of SSL losses</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a><span class="sd">        ssl_weights : list, optional</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a><span class="sd">            a list of SSL weights (if not provided initializes to 1)</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a><span class="sd">        lr : float, default 1e-3</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a><span class="sd">            learning rate</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a><span class="sd">        metrics : dict, optional</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a><span class="sd">            a list of metric functions</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a><span class="sd">        val_dataloader : torch.utils.data.DataLoader, optional</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a><span class="sd">            a validation dataloader</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a><span class="sd">        optimizer : torch.optim.Optimizer, optional</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a><span class="sd">            an optimizer (`Adam` by default)</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a><span class="sd">        device : str, default &#39;cuda&#39;</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a><span class="sd">            the device to train the model on</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a><span class="sd">        verbose : bool, default True</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a><span class="sd">            if `True`, the process is described in standard output</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a><span class="sd">        log_file : str, optional</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a><span class="sd">            the path to a text file where the process will be logged</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a><span class="sd">        augment_train : {1, 0}</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a><span class="sd">            number of augmentations to apply at training</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a><span class="sd">        augment_val : int, default 0</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a><span class="sd">            number of augmentations to apply at validation</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a><span class="sd">        validation_interval : int, default 1</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a><span class="sd">            every time this number of epochs passes, validation metrics are computed</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a><span class="sd">        predict_function : callable, optional</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a><span class="sd">            a function that maps probabilities to class predictions (if not provided, a default is generated)</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a><span class="sd">        primary_predict_function : callable, optional</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a><span class="sd">            a function that maps model output to probabilities (if not provided, initialized as identity)</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a><span class="sd">        exclusive : bool, default True</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a><span class="sd">            set to False for multi-label classification</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a><span class="sd">        ignore_tags : bool, default False</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a><span class="sd">            if `True`, samples with different meta tags will be mixed in batches</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a><span class="sd">        threshold : float, default 0.5</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a><span class="sd">            the threshold used for multi-label classification default prediction function</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a><span class="sd">        model_save_path : str, optional</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a><span class="sd">            the path to the folder where model checkpoints will be saved (checkpoints will not be saved if the path</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a><span class="sd">            is not provided)</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a><span class="sd">        model_save_epochs : int, default 5</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a><span class="sd">            the interval for saving the model checkpoints (the last epoch is always saved)</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a><span class="sd">        pseudolabel : bool, default False</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a><span class="sd">            if True, the pseudolabeling procedure will be applied</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a><span class="sd">        pseudolabel_start : int, default 100</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a><span class="sd">            pseudolabeling starts after this epoch</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a><span class="sd">        correction_interval : int, default 1</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a><span class="sd">            after this number of epochs, if the pseudolabeling is on, the model is trained on the labeled data and</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a><span class="sd">            new pseudolabels are generated</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a><span class="sd">        pseudolabel_alpha_f : float, default 3</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a><span class="sd">            the maximum value of pseudolabeling alpha</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a><span class="sd">        alpha_growth_stop : int, default 600</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a><span class="sd">            pseudolabeling alpha stops growing after this epoch</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>        <span class="c1"># pseudolabeling might be buggy right now -- not using it!</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>        <span class="k">if</span> <span class="n">skip_metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>            <span class="n">skip_metrics</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">train_dataloader</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span> <span class="o">=</span> <span class="n">val_dataloader</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_dataloader</span> <span class="o">=</span> <span class="n">test_dataloader</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="o">=</span> <span class="n">transformer</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_epochs</span> <span class="o">=</span> <span class="n">num_epochs</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">skip_metrics</span> <span class="o">=</span> <span class="n">skip_metrics</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">augment_train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">augment_train</span><span class="p">)</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">augment_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">augment_val</span><span class="p">)</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_tags</span> <span class="o">=</span> <span class="n">ignore_tags</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validation_interval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">validation_interval</span><span class="p">)</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="n">log_file</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span> <span class="o">=</span> <span class="n">model_save_path</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_save_epochs</span> <span class="o">=</span> <span class="n">model_save_epochs</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>        <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>            <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>        <span class="k">if</span> <span class="n">optimizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>        <span class="k">if</span> <span class="n">ssl_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>            <span class="n">ssl_weights</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ssl_losses</span><span class="p">]</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ssl_weights</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>            <span class="n">ssl_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">ssl_weights</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ssl_losses</span><span class="p">]</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ssl_weights</span> <span class="o">=</span> <span class="n">ssl_weights</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_class</span> <span class="o">=</span> <span class="n">optimizer</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">LoadedModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">set_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="n">parallel</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">augment_val</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">augment_train</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="o">=</span> <span class="n">EmptyTransformer</span><span class="p">()</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">augment_train</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>                <span class="s1">&#39;The &quot;augment_train&quot; parameter is too large -&gt; setting it to 1.&#39;</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>            <span class="p">)</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">augment_train</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>            <span class="k">if</span> <span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>                <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>            <span class="k">raise</span> <span class="p">(</span><span class="s2">&quot;The format of the device is incorrect&quot;</span><span class="p">)</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>        <span class="k">if</span> <span class="n">ssl_losses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ssl_losses</span> <span class="o">=</span> <span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ssl_losses</span> <span class="o">=</span> <span class="n">ssl_losses</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>        <span class="k">if</span> <span class="n">primary_predict_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>            <span class="k">if</span> <span class="n">exclusive</span><span class="p">:</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>                <span class="n">primary_predict_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Softmax</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>                <span class="n">primary_predict_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">primary_predict_function</span> <span class="o">=</span> <span class="n">primary_predict_function</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>        <span class="k">if</span> <span class="n">predict_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>            <span class="k">if</span> <span class="n">exclusive</span><span class="p">:</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">predict_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">predict_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">int</span><span class="p">()</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">predict_function</span> <span class="o">=</span> <span class="n">predict_function</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pseudolabel</span> <span class="o">=</span> <span class="n">pseudolabel</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_f</span> <span class="o">=</span> <span class="n">pseudolabel_alpha_f</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">T2</span> <span class="o">=</span> <span class="n">alpha_growth_stop</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">T1</span> <span class="o">=</span> <span class="n">pseudolabel_start</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">correction_interval</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">T2</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T1</span><span class="p">:</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>                <span class="sa">f</span><span class="s2">&quot;The pseudolabel_start parameter has to be smaller than alpha_growth_stop; got &quot;</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pseudolabel_start</span><span class="si">=}</span><span class="s2"> and </span><span class="si">{</span><span class="n">alpha_growth_stop</span><span class="si">=}</span><span class="s2">&quot;</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>            <span class="p">)</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decision_thresholds</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()]</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>    <span class="k">def</span> <span class="nf">save_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a><span class="sd">        Save a general checkpoint</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a><span class="sd">        Parameters</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a><span class="sd">        ----------</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a><span class="sd">        checkpoint_path : str</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a><span class="sd">            the path where the checkpoint will be saved</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>            <span class="p">{</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>                <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>                <span class="s2">&quot;model_state_dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>                <span class="s2">&quot;optimizer_state_dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>            <span class="p">},</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>            <span class="n">checkpoint_path</span><span class="p">,</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>        <span class="p">)</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>    <span class="k">def</span> <span class="nf">load_from_checkpoint</span><span class="p">(</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">only_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">load_strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a><span class="sd">        Load from a checkpoint</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a><span class="sd">        Parameters</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a><span class="sd">        ----------</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a><span class="sd">        checkpoint_path : str</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a><span class="sd">            the path to the checkpoint</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a><span class="sd">        only_model : bool, default False</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a><span class="sd">            if `True`, only the model state dictionary will be loaded (and not the epoch and the optimizer state</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a><span class="sd">            dictionary)</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a><span class="sd">        load_strict : bool, default True</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a><span class="sd">            if `True`, any inconsistencies in state dictionaries are regarded as errors</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>        <span class="k">if</span> <span class="n">checkpoint_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>            <span class="k">return</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;model_state_dict&quot;</span><span class="p">],</span> <span class="n">strict</span><span class="o">=</span><span class="n">load_strict</span><span class="p">)</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">only_model</span><span class="p">:</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;optimizer_state_dict&quot;</span><span class="p">])</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a><span class="sd">        Save the model state dictionary</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a><span class="sd">        Parameters</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a><span class="sd">        ----------</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a><span class="sd">        save_path : str</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a><span class="sd">            the path where the state will be saved</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">save_path</span><span class="p">)</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;saved the model successfully&quot;</span><span class="p">)</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>    <span class="k">def</span> <span class="nf">_apply_predict_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predicted</span><span class="p">):</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a><span class="sd">        Map from model output to prediction</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_predict_function</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_function</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>        <span class="k">return</span> <span class="n">predicted</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>    <span class="k">def</span> <span class="nf">_get_prediction</span><span class="p">(</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>        <span class="n">main_input</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>        <span class="n">tags</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>        <span class="n">ssl_inputs</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>        <span class="n">ssl_targets</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>        <span class="n">augment_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>        <span class="n">embedding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>        <span class="n">subsample</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a><span class="sd">        Get the prediction of `self.model` for input averaged over `augment_n` augmentations</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>        <span class="k">if</span> <span class="n">augment_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>            <span class="n">augment_n</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>            <span class="n">augment</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>            <span class="n">augment</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>        <span class="n">model_input</span><span class="p">,</span> <span class="n">ssl_inputs</span><span class="p">,</span> <span class="n">ssl_targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>            <span class="n">deepcopy</span><span class="p">(</span><span class="n">main_input</span><span class="p">),</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>            <span class="n">ssl_inputs</span><span class="o">=</span><span class="n">ssl_inputs</span><span class="p">,</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>            <span class="n">ssl_targets</span><span class="o">=</span><span class="n">ssl_targets</span><span class="p">,</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>            <span class="n">augment</span><span class="o">=</span><span class="n">augment</span><span class="p">,</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>            <span class="n">subsample</span><span class="o">=</span><span class="n">subsample</span><span class="p">,</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>        <span class="p">)</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">embedding</span><span class="p">:</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>            <span class="n">predicted</span><span class="p">,</span> <span class="n">ssl_predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">model_input</span><span class="p">,</span> <span class="n">ssl_inputs</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>            <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="n">model_input</span><span class="p">)</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>            <span class="n">ssl_predicted</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="ow">and</span> <span class="n">predicted</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">predicted</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>            <span class="n">predicted</span> <span class="o">=</span> <span class="n">predicted</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>                <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">model_input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="n">predicted</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>            <span class="p">)</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>        <span class="k">if</span> <span class="n">predicted</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">augment_n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ssl_off</span><span class="p">()</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">augment_n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>                <span class="n">model_input</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>                    <span class="n">deepcopy</span><span class="p">(</span><span class="n">main_input</span><span class="p">),</span> <span class="n">augment</span><span class="o">=</span><span class="n">augment</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>                <span class="p">)</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">embedding</span><span class="p">:</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>                    <span class="n">pred</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">model_input</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>                    <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="n">model_input</span><span class="p">)</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>                <span class="n">predicted</span> <span class="o">+=</span> <span class="n">pred</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ssl_on</span><span class="p">()</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>            <span class="n">predicted</span> <span class="o">/=</span> <span class="n">augment_n</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">process_labels</span><span class="p">:</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>            <span class="n">class_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">transform_labels</span><span class="p">(</span><span class="n">predicted</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>            <span class="n">beh_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>            <span class="n">class_embedding</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>                <span class="p">[</span><span class="n">class_embedding</span><span class="p">[</span><span class="n">beh_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">beh_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())],</span> <span class="mi">0</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>            <span class="p">)</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>            <span class="n">predicted</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>                <span class="s2">&quot;video&quot;</span><span class="p">:</span> <span class="n">predicted</span><span class="p">,</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">class_embedding</span><span class="p">,</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>                <span class="s2">&quot;logit_scale&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">logit_scale</span><span class="p">(),</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>                <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="n">predicted</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>            <span class="p">}</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>        <span class="k">return</span> <span class="n">predicted</span><span class="p">,</span> <span class="n">ssl_predicted</span><span class="p">,</span> <span class="n">ssl_targets</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>    <span class="k">def</span> <span class="nf">_ssl_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ssl_predicted</span><span class="p">,</span> <span class="n">ssl_targets</span><span class="p">):</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a><span class="sd">        Apply SSL losses</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>        <span class="n">ssl_loss</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>        <span class="k">for</span> <span class="n">loss</span><span class="p">,</span> <span class="n">predicted</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssl_losses</span><span class="p">,</span> <span class="n">ssl_predicted</span><span class="p">,</span> <span class="n">ssl_targets</span><span class="p">):</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>            <span class="n">ssl_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">(</span><span class="n">predicted</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>        <span class="k">return</span> <span class="n">ssl_loss</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>    <span class="k">def</span> <span class="nf">_loss_function</span><span class="p">(</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>        <span class="n">augment_n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>        <span class="n">temporal_subsampling_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>        <span class="n">skip_metrics</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a><span class="sd">        Calculate the loss function and the metric for a dataloader batch</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a><span class="sd">        Averaging the predictions over augment_n augmentations.</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>        <span class="k">if</span> <span class="s2">&quot;target&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">batch</span> <span class="ow">or</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot compute loss function with nan targets!&quot;</span><span class="p">)</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>        <span class="n">main_input</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>        <span class="n">main_target</span><span class="p">,</span> <span class="n">ssl_targets</span><span class="p">,</span> <span class="n">ssl_inputs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>        <span class="n">main_target</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>        <span class="k">if</span> <span class="s2">&quot;ssl_targets&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>            <span class="n">ssl_targets</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>                <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>                <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;ssl_targets&quot;</span><span class="p">]</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>            <span class="p">]</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>        <span class="k">if</span> <span class="s2">&quot;ssl_inputs&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>            <span class="n">ssl_inputs</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>                <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>                <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;ssl_inputs&quot;</span><span class="p">]</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>            <span class="p">]</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>        <span class="k">if</span> <span class="n">temporal_subsampling_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>            <span class="n">subsample</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>                <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>                    <span class="nb">range</span><span class="p">(</span><span class="n">main_target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>                    <span class="nb">int</span><span class="p">(</span><span class="n">temporal_subsampling_size</span> <span class="o">*</span> <span class="n">main_target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>                <span class="p">)</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>            <span class="p">)</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>            <span class="n">main_target</span> <span class="o">=</span> <span class="n">main_target</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">subsample</span><span class="p">]</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>            <span class="n">subsample</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_tags</span><span class="p">:</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>            <span class="n">tag</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>            <span class="n">tag</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">)</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>        <span class="n">predicted</span><span class="p">,</span> <span class="n">ssl_predicted</span><span class="p">,</span> <span class="n">ssl_targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_prediction</span><span class="p">(</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>            <span class="n">main_input</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">ssl_inputs</span><span class="p">,</span> <span class="n">ssl_targets</span><span class="p">,</span> <span class="n">augment_n</span><span class="p">,</span> <span class="n">subsample</span><span class="o">=</span><span class="n">subsample</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>        <span class="p">)</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>        <span class="k">del</span> <span class="n">main_input</span><span class="p">,</span> <span class="n">ssl_inputs</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute</span><span class="p">(</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>            <span class="n">ssl_predicted</span><span class="p">,</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>            <span class="n">ssl_targets</span><span class="p">,</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>            <span class="n">predicted</span><span class="p">,</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>            <span class="n">main_target</span><span class="p">,</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>            <span class="n">tag</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">),</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>            <span class="n">skip_metrics</span><span class="o">=</span><span class="n">skip_metrics</span><span class="p">,</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>        <span class="p">)</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>        <span class="n">ssl_predicted</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>        <span class="n">ssl_targets</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>        <span class="n">predicted</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>        <span class="n">main_target</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>        <span class="n">tag</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>        <span class="n">skip_loss</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>        <span class="n">apply_primary_function</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>        <span class="n">skip_metrics</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a><span class="sd">        Compute the losses and metrics from predictions</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>        <span class="k">if</span> <span class="n">skip_metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>            <span class="n">skip_metrics</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_loss</span><span class="p">:</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>            <span class="n">ssl_losses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ssl_loss</span><span class="p">(</span><span class="n">ssl_predicted</span><span class="p">,</span> <span class="n">ssl_targets</span><span class="p">)</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>            <span class="k">if</span> <span class="n">predicted</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>                <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span><span class="n">predicted</span><span class="p">,</span> <span class="n">main_target</span><span class="p">)</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>                <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>            <span class="n">ssl_losses</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="p">[],</span> <span class="mi">0</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>        <span class="k">if</span> <span class="n">predicted</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">predicted</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>                <span class="n">predicted</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">predicted</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>                <span class="p">}</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>                <span class="n">predicted</span> <span class="o">=</span> <span class="n">predicted</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>            <span class="k">if</span> <span class="n">apply_primary_function</span><span class="p">:</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>                <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_predict_function</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>            <span class="n">predicted_transformed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_function</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">metric_function</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip_metrics</span><span class="p">:</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>                    <span class="k">if</span> <span class="n">metric_function</span><span class="o">.</span><span class="n">needs_raw_data</span><span class="p">:</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>                        <span class="n">metric_function</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">predicted</span><span class="p">,</span> <span class="n">main_target</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>                        <span class="n">metric_function</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>                            <span class="n">predicted_transformed</span><span class="p">,</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>                            <span class="n">main_target</span><span class="p">,</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>                            <span class="n">tag</span><span class="p">,</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>                        <span class="p">)</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>        <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">ssl_losses</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>    <span class="k">def</span> <span class="nf">_calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a><span class="sd">        Calculate the final values of epoch metrics</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>        <span class="n">epoch_metrics</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>        <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>            <span class="n">m</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">calculate</span><span class="p">()</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>                        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>                    <span class="n">epoch_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="ow">is</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>                    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>                <span class="n">epoch_metrics</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>            <span class="n">metric</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>        <span class="k">return</span> <span class="n">epoch_metrics</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>    <span class="k">def</span> <span class="nf">_run_epoch</span><span class="p">(</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>        <span class="n">dataloader</span><span class="p">:</span> <span class="n">DataLoader</span><span class="p">,</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>        <span class="n">augment_n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>        <span class="n">unlabeled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>        <span class="n">temporal_subsampling_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a><span class="sd">        Run one epoch on dataloader</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a><span class="sd">        Averaging the predictions over augment_n augmentations.</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a><span class="sd">        Use &quot;train&quot; mode for training and &quot;val&quot; mode for evaluation.</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>            <span class="k">pass</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>                <span class="sa">f</span><span class="s1">&#39;Mode </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s1"> is not recognized, please choose either &quot;train&quot; for training or &quot;val&quot; for validation&#39;</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>            <span class="p">)</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_tags</span><span class="p">:</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>            <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>            <span class="n">tags</span> <span class="o">=</span> <span class="n">dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_tags</span><span class="p">()</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>        <span class="n">epoch_loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>        <span class="n">epoch_ssl_loss</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>        <span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>        <span class="n">set_pars</span> <span class="o">=</span> <span class="n">dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">set_indexing_parameters</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>        <span class="n">skip_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_metrics</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>            <span class="n">set_pars</span><span class="p">(</span><span class="n">unlabeled</span><span class="o">=</span><span class="n">unlabeled</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>            <span class="n">data_len</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>                <span class="n">dataloader</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>                <span class="n">loss</span><span class="p">,</span> <span class="n">ssl_losses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loss_function</span><span class="p">(</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>                    <span class="n">batch</span><span class="p">,</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>                    <span class="n">augment_n</span><span class="p">,</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>                    <span class="n">temporal_subsampling_size</span><span class="o">=</span><span class="n">temporal_subsampling_size</span><span class="p">,</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>                    <span class="n">skip_metrics</span><span class="o">=</span><span class="n">skip_metrics</span><span class="p">,</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>                <span class="p">)</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>                <span class="k">if</span> <span class="n">loss</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>                    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">*</span> <span class="n">alpha</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>                    <span class="n">epoch_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ssl_loss</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>                    <span class="nb">zip</span><span class="p">(</span><span class="n">ssl_losses</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_weights</span><span class="p">)</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>                <span class="p">):</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>                    <span class="k">if</span> <span class="n">ssl_loss</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>                        <span class="n">epoch_ssl_loss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ssl_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>                        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">+</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">ssl_loss</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>                    <span class="k">if</span> <span class="n">loss</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">:</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>                        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>        <span class="n">epoch_loss</span> <span class="o">=</span> <span class="n">epoch_loss</span> <span class="o">/</span> <span class="n">data_len</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>        <span class="n">epoch_ssl_loss</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="o">/</span> <span class="n">data_len</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">epoch_ssl_loss</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>        <span class="n">epoch_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_metrics</span><span class="p">()</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>        <span class="k">return</span> <span class="n">epoch_loss</span><span class="p">,</span> <span class="n">epoch_ssl_loss</span><span class="p">,</span> <span class="n">epoch_metrics</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>        <span class="n">trial</span><span class="p">:</span> <span class="n">Trial</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>        <span class="n">optimized_metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>        <span class="n">to_ram</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>        <span class="n">autostop_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>        <span class="n">autostop_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>        <span class="n">autostop_metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>        <span class="n">main_task_on</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>        <span class="n">ssl_on</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>        <span class="n">temporal_subsampling_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>        <span class="n">loading_bar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a><span class="sd">        Train the task and return a log of epoch-average loss and metric</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a><span class="sd">        You can use the autostop parameters to finish training when the parameters are not improving. It will be</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a><span class="sd">        stopped if the average value of `autostop_metric` over the last `autostop_interval` epochs is smaller than</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a><span class="sd">        the average over the previous `autostop_interval` epochs + `autostop_threshold`. For example, if the</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a><span class="sd">        current epoch is 120 and `autostop_interval` is 50, the averages over epochs 70-120 and 20-70 will be compared.</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a><span class="sd">        Parameters</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a><span class="sd">        ----------</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a><span class="sd">        trial : Trial</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a><span class="sd">            an `optuna` trial (for hyperparameter searches)</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a><span class="sd">        optimized_metric : str</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a><span class="sd">            the name of the metric being optimized (for hyperparameter searches)</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a><span class="sd">        to_ram : bool, default False</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a><span class="sd">            if `True`, the dataset will be loaded in RAM (this speeds up the calculations but can lead to crashes</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a><span class="sd">            if the dataset is too large)</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a><span class="sd">        autostop_interval : int, default 50</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a><span class="sd">            the number of epochs to average the autostop metric over</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a><span class="sd">        autostop_threshold : float, default 0.001</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a><span class="sd">            the autostop difference threshold</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a><span class="sd">        autostop_metric : str, optional</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a><span class="sd">            the autostop metric (can be any one of the tracked metrics of `&#39;loss&#39;`)</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a><span class="sd">        main_task_on : bool, default True</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a><span class="sd">            if `False`, the main task (action segmentation) will not be used in training</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a><span class="sd">        ssl_on : bool, default True</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a><span class="sd">            if `False`, the SSL task will not be used in training</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a><span class="sd">        Returns</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a><span class="sd">        -------</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a><span class="sd">        loss_log: list</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a><span class="sd">            a list of float loss function values for each epoch</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a><span class="sd">        metrics_log: dict</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a><span class="sd">            a dictionary of metric value logs (first-level keys are &#39;train&#39; and &#39;val&#39;, second-level keys are metric</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a><span class="sd">            names, values are lists of function values)</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">):</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">MyDataParallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>        <span class="k">assert</span> <span class="n">autostop_metric</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;loss&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>        <span class="n">autostop_interval</span> <span class="o">//=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_interval</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>        <span class="k">if</span> <span class="n">trial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">optimized_metric</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>                <span class="s2">&quot;You need to provide the optimized metric name (optimized_metric parameter) &quot;</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>                <span class="s2">&quot;for optuna pruning to work!&quot;</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>            <span class="p">)</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>        <span class="k">if</span> <span class="n">to_ram</span><span class="p">:</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;transferring datasets to RAM...&quot;</span><span class="p">)</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">to_ram</span><span class="p">()</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">to_ram</span><span class="p">()</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>        <span class="n">loss_log</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>        <span class="n">metrics_log</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[]),</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[])}</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">main_task_on</span><span class="p">:</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">main_task_off</span><span class="p">()</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">ssl_on</span><span class="p">:</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ssl_off</span><span class="p">()</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">:</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>            <span class="n">unlabeled</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>            <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudolabel</span><span class="p">:</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T1</span><span class="p">:</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>                    <span class="n">unlabeled</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">T1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">!=</span> <span class="mi">0</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>                    <span class="k">if</span> <span class="n">unlabeled</span><span class="p">:</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>                        <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alpha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>                    <span class="n">unlabeled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>            <span class="n">epoch_loss</span><span class="p">,</span> <span class="n">epoch_ssl_loss</span><span class="p">,</span> <span class="n">epoch_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_epoch</span><span class="p">(</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>                <span class="n">dataloader</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span><span class="p">,</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">,</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>                <span class="n">augment_n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">augment_train</span><span class="p">,</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>                <span class="n">unlabeled</span><span class="o">=</span><span class="n">unlabeled</span><span class="p">,</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>                <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>                <span class="n">temporal_subsampling_size</span><span class="o">=</span><span class="n">temporal_subsampling_size</span><span class="p">,</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>                <span class="n">verbose</span><span class="o">=</span><span class="n">loading_bar</span><span class="p">,</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>            <span class="p">)</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>            <span class="n">loss_log</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_loss</span><span class="p">)</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>            <span class="n">epoch_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s2">]&quot;</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudolabel</span><span class="p">:</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>                <span class="k">if</span> <span class="n">unlabeled</span><span class="p">:</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>                    <span class="n">epoch_string</span> <span class="o">+=</span> <span class="s2">&quot; (unlabeled)&quot;</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>                    <span class="n">epoch_string</span> <span class="o">+=</span> <span class="s2">&quot; (labeled)&quot;</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>            <span class="n">epoch_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;: loss </span><span class="si">{</span><span class="n">epoch_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">epoch_ssl_loss</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">epoch_ssl_loss</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>                    <span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;ssl_loss_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>                    <span class="n">epoch_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, ssl_loss_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>            <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">epoch_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>                <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_metrics</span><span class="p">:</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>                    <span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">][</span><span class="n">metric_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_value</span><span class="p">)</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>                    <span class="n">epoch_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">metric_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_interval</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>            <span class="p">):</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>                    <span class="n">epoch_string</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>                    <span class="p">(</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>                        <span class="n">val_epoch_loss</span><span class="p">,</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>                        <span class="n">val_epoch_ssl_loss</span><span class="p">,</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>                        <span class="n">val_epoch_metrics</span><span class="p">,</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>                    <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_epoch</span><span class="p">(</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>                        <span class="n">dataloader</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span><span class="p">,</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>                        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;val&quot;</span><span class="p">,</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>                        <span class="n">augment_n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">augment_val</span><span class="p">,</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>                    <span class="p">)</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>                    <span class="n">loss_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_epoch_loss</span><span class="p">)</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>                    <span class="n">epoch_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;validation: loss </span><span class="si">{</span><span class="n">val_epoch_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_epoch_ssl_loss</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">val_epoch_ssl_loss</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>                            <span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;ssl_loss_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>                            <span class="n">epoch_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, ssl_loss_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>                    <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">val_epoch_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>                        <span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="n">metric_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_value</span><span class="p">)</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>                        <span class="n">epoch_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">metric_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>                <span class="k">if</span> <span class="n">trial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>                    <span class="k">if</span> <span class="n">optimized_metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]:</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>                            <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">optimized_metric</span><span class="si">}</span><span class="s2"> metric set for optimization is not being logged!&quot;</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>                        <span class="p">)</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>                    <span class="n">trial</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="n">optimized_metric</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>                    <span class="k">if</span> <span class="n">trial</span><span class="o">.</span><span class="n">should_prune</span><span class="p">():</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>                        <span class="k">raise</span> <span class="n">TrialPruned</span><span class="p">()</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">epoch_string</span><span class="p">)</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">epoch_string</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>            <span class="n">save_condition</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_epochs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>                <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_epochs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>            <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">)</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">save_condition</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>                <span class="n">epoch_s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">)))</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;epoch</span><span class="si">{</span><span class="n">epoch_s</span><span class="si">}</span><span class="s2">.pt&quot;</span><span class="p">)</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>                <span class="p">)</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudolabel</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">unlabeled</span><span class="p">:</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_set_pseudolabels</span><span class="p">()</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>            <span class="k">if</span> <span class="n">autostop_metric</span> <span class="o">==</span> <span class="s2">&quot;loss&quot;</span><span class="p">:</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">loss_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">autostop_interval</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>                    <span class="k">if</span> <span class="p">(</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="o">-</span><span class="n">autostop_interval</span><span class="p">:])</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>                        <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>                            <span class="n">loss_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">autostop_interval</span> <span class="p">:</span> <span class="o">-</span><span class="n">autostop_interval</span><span class="p">]</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>                        <span class="p">)</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>                        <span class="o">+</span> <span class="n">autostop_threshold</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>                    <span class="p">):</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>                        <span class="k">break</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>            <span class="k">elif</span> <span class="n">autostop_metric</span> <span class="ow">in</span> <span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]:</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="n">autostop_metric</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">autostop_interval</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>                    <span class="k">if</span> <span class="p">(</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>                            <span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="n">autostop_metric</span><span class="p">][</span><span class="o">-</span><span class="n">autostop_interval</span><span class="p">:]</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>                        <span class="p">)</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>                        <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>                            <span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="n">autostop_metric</span><span class="p">][</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>                                <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">autostop_interval</span> <span class="p">:</span> <span class="o">-</span><span class="n">autostop_interval</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>                            <span class="p">]</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>                        <span class="p">)</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>                        <span class="o">+</span> <span class="n">autostop_threshold</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>                    <span class="p">):</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>                        <span class="k">break</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>        <span class="n">metrics_log</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metrics_log</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>        <span class="k">return</span> <span class="n">loss_log</span><span class="p">,</span> <span class="n">metrics_log</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>    <span class="k">def</span> <span class="nf">evaluate_prediction</span><span class="p">(</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>        <span class="n">prediction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">DataLoader</span><span class="p">,</span> <span class="n">BehaviorDataset</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a><span class="sd">        Compute metrics for a prediction</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a><span class="sd">        Parameters</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a><span class="sd">        ----------</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a><span class="sd">        prediction : torch.Tensor</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a><span class="sd">            the prediction</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a><span class="sd">        data : torch.utils.data.DataLoader | dlc2action.data.dataset.BehaviorDataset, optional</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a><span class="sd">            the data the prediction was made for (if not provided, take the validation dataset)</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a><span class="sd">        batch_size : int, default 32</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a><span class="sd">            the batch size</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a><span class="sd">        Returns</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a><span class="sd">        -------</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a><span class="sd">        loss : float</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a><span class="sd">            the average value of the loss function</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a><span class="sd">        metric : dict</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a><span class="sd">            a dictionary of average values of metric functions</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">DataLoader</span><span class="p">:</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataset</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>        <span class="n">epoch_loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>            <span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">())</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>            <span class="n">length</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">len_segment</span><span class="p">()</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>            <span class="n">coords</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">annotation_store</span><span class="o">.</span><span class="n">get_original_coordinates</span><span class="p">()</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>                <span class="n">main_target</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>                <span class="n">pr_coords</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]]</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>                <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">pr_coords</span><span class="p">),</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pr_coords</span><span class="p">):</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>                    <span class="n">video_id</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">input_store</span><span class="o">.</span><span class="n">get_video_id</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>                    <span class="n">clip_id</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">input_store</span><span class="o">.</span><span class="n">get_clip_id</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>                    <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">input_store</span><span class="o">.</span><span class="n">get_clip_start_end</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>                    <span class="n">predicted</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="n">video_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">][</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>                        <span class="p">:,</span> <span class="n">start</span><span class="p">:</span><span class="n">end</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>                    <span class="p">]</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_compute</span><span class="p">(</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>                    <span class="p">[],</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>                    <span class="p">[],</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>                    <span class="n">predicted</span><span class="p">,</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>                    <span class="n">main_target</span><span class="p">,</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>                    <span class="n">skip_loss</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>                    <span class="n">tag</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">),</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>                    <span class="n">apply_primary_function</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>                <span class="p">)</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>                <span class="n">main_target</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>                <span class="n">predicted</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]]</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_compute</span><span class="p">(</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>                    <span class="p">[],</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>                    <span class="p">[],</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>                    <span class="n">predicted</span><span class="p">,</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>                    <span class="n">main_target</span><span class="p">,</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>                    <span class="n">skip_loss</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>                    <span class="n">tag</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">),</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>                    <span class="n">apply_primary_function</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>                <span class="p">)</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>        <span class="n">epoch_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_metrics</span><span class="p">()</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>        <span class="n">strings</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">metric_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>            <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_value</span> <span class="ow">in</span> <span class="n">epoch_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>        <span class="p">]</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>        <span class="n">val_string</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">strings</span><span class="p">))</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">val_string</span><span class="p">)</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>        <span class="k">return</span> <span class="n">epoch_loss</span><span class="p">,</span> <span class="n">epoch_metrics</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">DataLoader</span><span class="p">,</span> <span class="n">BehaviorDataset</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>        <span class="n">augment_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a><span class="sd">        Evaluate the Task model</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a><span class="sd">        Parameters</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a><span class="sd">        ----------</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a><span class="sd">        data : torch.utils.data.DataLoader | dlc2action.data.dataset.BehaviorDataset, optional</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a><span class="sd">            the data to evaluate on (if not provided, evaluate on the Task validation dataset)</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a><span class="sd">        augment_n : int, default 0</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a><span class="sd">            the number of augmentations to average results over</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a><span class="sd">        batch_size : int, default 32</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a><span class="sd">            the batch size</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a><span class="sd">        verbose : bool, default True</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a><span class="sd">            if True, the process is reported to standard output</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a><span class="sd">        Returns</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a><span class="sd">        -------</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a><span class="sd">        loss : float</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a><span class="sd">            the average value of the loss function</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a><span class="sd">        ssl_loss : float</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a><span class="sd">            the average value of the SSL loss function</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a><span class="sd">        metric : dict</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a><span class="sd">            a dictionary of average values of metric functions</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">):</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">MyDataParallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">DataLoader</span><span class="p">:</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataset</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>            <span class="n">epoch_loss</span><span class="p">,</span> <span class="n">epoch_ssl_loss</span><span class="p">,</span> <span class="n">epoch_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_epoch</span><span class="p">(</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>                <span class="n">dataloader</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="n">augment_n</span><span class="o">=</span><span class="n">augment_n</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>            <span class="p">)</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>        <span class="n">val_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;loss </span><span class="si">{</span><span class="n">epoch_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>        <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">epoch_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>            <span class="n">val_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">metric_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">val_string</span><span class="p">)</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>        <span class="k">return</span> <span class="n">epoch_loss</span><span class="p">,</span> <span class="n">epoch_ssl_loss</span><span class="p">,</span> <span class="n">epoch_metrics</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">DataLoader</span><span class="p">,</span> <span class="n">BehaviorDataset</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>        <span class="n">raw_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>        <span class="n">apply_primary_function</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>        <span class="n">augment_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>        <span class="n">train_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>        <span class="n">to_ram</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>        <span class="n">embedding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a><span class="sd">        Make a prediction with the Task model</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a><span class="sd">        Parameters</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a><span class="sd">        ----------</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a><span class="sd">        data : torch.utils.data.DataLoader | dlc2action.data.dataset.BehaviorDataset | str, optional</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a><span class="sd">            the data to evaluate on (if not provided, evaluate on the Task validation dataset)</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a><span class="sd">        raw_output : bool, default False</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a><span class="sd">            if `True`, the raw predicted probabilities are returned</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a><span class="sd">        apply_primary_function : bool, default True</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a><span class="sd">            if `True`, the primary predict function is applied (to map the model output into a shape corresponding to</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a><span class="sd">            the input)</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a><span class="sd">        augment_n : int, default 0</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a><span class="sd">            the number of augmentations to average results over</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a><span class="sd">        batch_size : int, default 32</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a><span class="sd">            the batch size</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a><span class="sd">        train_mode : bool, default False</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a><span class="sd">            if `True`, the model is used in training mode (affects dropout and batch normalization layers)</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a><span class="sd">        to_ram : bool, default False</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a><span class="sd">            if `True`, the dataset will be loaded in RAM (this speeds up the calculations but can lead to crashes</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a><span class="sd">            if the dataset is too large)</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a><span class="sd">        embedding : bool, default False</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a><span class="sd">            if `True`, the output of feature extractor is returned, ignoring the prediction module of the model</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a><span class="sd">        Returns</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a><span class="sd">        -------</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a><span class="sd">        prediction : torch.Tensor</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a><span class="sd">            a prediction for the input data</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">):</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">MyDataParallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>        <span class="k">if</span> <span class="n">train_mode</span><span class="p">:</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>        <span class="k">if</span> <span class="n">embedding</span><span class="p">:</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>            <span class="n">raw_output</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>            <span class="n">apply_primary_function</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">DataLoader</span><span class="p">:</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataset</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>            <span class="k">if</span> <span class="n">to_ram</span><span class="p">:</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;transferring dataset to RAM...&quot;</span><span class="p">)</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>                <span class="n">data</span><span class="o">.</span><span class="n">to_ram</span><span class="p">()</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ssl_off</span><span class="p">()</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>                <span class="nb">input</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>                <span class="n">predicted</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_prediction</span><span class="p">(</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>                    <span class="nb">input</span><span class="p">,</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>                    <span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">),</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>                    <span class="n">augment_n</span><span class="o">=</span><span class="n">augment_n</span><span class="p">,</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>                    <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>                <span class="p">)</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>                <span class="k">if</span> <span class="n">apply_primary_function</span><span class="p">:</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>                    <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_predict_function</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">raw_output</span><span class="p">:</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>                    <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_function</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predicted</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ssl_on</span><span class="p">()</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>        <span class="k">return</span> <span class="n">output</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>    <span class="k">def</span> <span class="nf">dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BehaviorDataset</span><span class="p">:</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a><span class="sd">        Get a dataset</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a><span class="sd">        Parameters</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a><span class="sd">        ----------</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a><span class="sd">        mode : {&#39;train&#39;, &#39;val&#39;, &#39;test}</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a><span class="sd">            the dataset to get</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a><span class="sd">        Returns</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a><span class="sd">        -------</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a><span class="sd">        dataset : dlc2action.data.dataset.BehaviorDataset</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a><span class="sd">            the dataset</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>        <span class="n">dataloader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>        <span class="k">if</span> <span class="n">dataloader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The length of the dataloader is 0!&quot;</span><span class="p">)</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>        <span class="k">return</span> <span class="n">dataloader</span><span class="o">.</span><span class="n">dataset</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>    <span class="k">def</span> <span class="nf">dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;train&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataLoader</span><span class="p">:</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a><span class="sd">        Get a dataloader</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a><span class="sd">        Parameters</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a><span class="sd">        ----------</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a><span class="sd">        mode : {&#39;train&#39;, &#39;val&#39;, &#39;test}</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a><span class="sd">            the dataset to get</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a><span class="sd">        Returns</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a><span class="sd">        -------</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a><span class="sd">        dataloader : torch.utils.data.DataLoader</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a><span class="sd">            the dataloader</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_dataloader</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>                <span class="sa">f</span><span class="s1">&#39;The </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s1"> mode is not recognized, please choose from &quot;train&quot;, &quot;val&quot; or &quot;test&quot;&#39;</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>            <span class="p">)</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>    <span class="k">def</span> <span class="nf">_get_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a><span class="sd">        Get a dataset from a dataloader, a string (&#39;train&#39;, &#39;test&#39; or &#39;val&#39;) or `None` (default)</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>        <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="s2">&quot;val&quot;</span><span class="p">)</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>        <span class="k">elif</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]:</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DataLoader</span><span class="p">:</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dataset</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="ow">is</span> <span class="n">BehaviorDataset</span><span class="p">:</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>            <span class="k">return</span> <span class="n">dataset</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2"> type of dataset is not recognized!&quot;</span><span class="p">)</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>    <span class="k">def</span> <span class="nf">_get_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a><span class="sd">        Get a dataloader from a dataset, a string (&#39;train&#39;, &#39;test&#39; or &#39;val&#39;) or `None` (default)</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>        <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span><span class="p">(</span><span class="s2">&quot;val&quot;</span><span class="p">)</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>        <span class="k">elif</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]:</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>            <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The length of the dataloader is 0!&quot;</span><span class="p">)</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="ow">is</span> <span class="n">BehaviorDataset</span><span class="p">:</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>            <span class="n">dataset</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DataLoader</span><span class="p">:</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>            <span class="k">return</span> <span class="n">dataset</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2"> type of dataset is not recognized!&quot;</span><span class="p">)</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>    <span class="k">def</span> <span class="nf">generate_full_length_prediction</span><span class="p">(</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">augment_n</span><span class="o">=</span><span class="mi">10</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>    <span class="p">):</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a><span class="sd">        Compile a prediction for the original input sequences</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a><span class="sd">        Parameters</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a><span class="sd">        ----------</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a><span class="sd">        dataset : BehaviorDataset, optional</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a><span class="sd">            the dataset to generate a prediction for (if `None`, generate for the validation dataset)</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a><span class="sd">        batch_size : int, default 32</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a><span class="sd">            the batch size</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a><span class="sd">        augment_n : int, default 10</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a><span class="sd">            the number of augmentations to average results over</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a><span class="sd">        Returns</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a><span class="sd">        -------</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a><span class="sd">        prediction : dict</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a><span class="sd">            a nested dictionary where first level keys are video ids, second level keys are clip ids and values</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a><span class="sd">            are prediction tensors</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">BehaviorDataset</span><span class="p">):</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>                <span class="sa">f</span><span class="s2">&quot;The dataset parameter has to be either None, string, &quot;</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>                <span class="sa">f</span><span class="s2">&quot;BehaviorDataset or Dataloader, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>            <span class="p">)</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>            <span class="n">dataset</span><span class="p">,</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>            <span class="n">raw_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>            <span class="n">apply_primary_function</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>            <span class="n">augment_n</span><span class="o">=</span><span class="n">augment_n</span><span class="p">,</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>        <span class="p">)</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">generate_full_length_prediction</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>            <span class="n">v_id</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>                <span class="n">clip_id</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_predict_functions</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>                <span class="k">for</span> <span class="n">clip_id</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">video_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>            <span class="p">}</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>            <span class="k">for</span> <span class="n">v_id</span><span class="p">,</span> <span class="n">video_dict</span> <span class="ow">in</span> <span class="n">predicted</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>        <span class="p">}</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>        <span class="k">return</span> <span class="n">predicted</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>    <span class="k">def</span> <span class="nf">generate_submission</span><span class="p">(</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">frame_number_map_file</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">augment_n</span><span class="o">=</span><span class="mi">10</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>    <span class="p">):</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a><span class="sd">        Generate a MABe-22 style submission dictionary</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a><span class="sd">        Parameters</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a><span class="sd">        ----------</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a><span class="sd">        dataset : BehaviorDataset, optional</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a><span class="sd">            the dataset to generate a prediction for (if `None`, generate for the validation dataset)</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a><span class="sd">        batch_size : int, default 32</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a><span class="sd">            the batch size</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a><span class="sd">        augment_n : int, default 10</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a><span class="sd">            the number of augmentations to average results over</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a><span class="sd">        Returns</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a><span class="sd">        -------</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a><span class="sd">        submission : dict</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a><span class="sd">            a dictionary with frame number mapping and embeddings</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">BehaviorDataset</span><span class="p">):</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>                <span class="sa">f</span><span class="s2">&quot;The dataset parameter has to be either None, string, &quot;</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>                <span class="sa">f</span><span class="s2">&quot;BehaviorDataset or Dataloader, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>            <span class="p">)</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>            <span class="n">dataset</span><span class="p">,</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>            <span class="n">raw_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>            <span class="n">apply_primary_function</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>            <span class="n">augment_n</span><span class="o">=</span><span class="n">augment_n</span><span class="p">,</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>            <span class="n">embedding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>        <span class="p">)</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">generate_full_length_prediction</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>        <span class="n">frame_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">frame_number_map_file</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>        <span class="n">length</span> <span class="o">=</span> <span class="n">frame_map</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">frame_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="o">-</span><span class="mi">1</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>        <span class="n">embeddings</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>        <span class="k">for</span> <span class="n">video_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">predicted</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>            <span class="n">split</span> <span class="o">=</span> <span class="n">video_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">predicted</span><span class="p">[</span><span class="n">video_id</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>                    <span class="s2">&quot;Generating submissions is only implemented for the mabe22 dataset!&quot;</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>                <span class="p">)</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>            <span class="k">if</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">frame_map</span><span class="p">:</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> video is not in the frame map file&quot;</span><span class="p">)</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>            <span class="n">v_id</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>            <span class="n">clip_id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">predicted</span><span class="p">[</span><span class="n">video_id</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>            <span class="k">if</span> <span class="n">embeddings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>                <span class="n">embeddings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">length</span><span class="p">,</span> <span class="n">predicted</span><span class="p">[</span><span class="n">video_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">frame_map</span><span class="p">[</span><span class="n">v_id</span><span class="p">]</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>            <span class="n">embeddings</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">predicted</span><span class="p">[</span><span class="n">video_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>            <span class="n">predicted</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">video_id</span><span class="p">)</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>            <span class="s2">&quot;frame_number_map&quot;</span><span class="p">:</span> <span class="n">frame_map</span><span class="p">,</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>            <span class="s2">&quot;embeddings&quot;</span><span class="p">:</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>        <span class="p">}</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>        <span class="k">return</span> <span class="n">predicted</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>    <span class="k">def</span> <span class="nf">_get_intervals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a><span class="sd">        Get a list of True group beginning and end indices from a boolean tensor</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>        <span class="n">output</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique_consecutive</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>        <span class="n">true_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>        <span class="n">starts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>            <span class="p">[(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">true_indices</span><span class="p">]</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>        <span class="p">)</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>        <span class="n">ends</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>            <span class="p">[(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">true_indices</span><span class="p">]</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>        <span class="p">)</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">starts</span><span class="p">,</span> <span class="n">ends</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>    <span class="k">def</span> <span class="nf">_smooth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">smooth_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a><span class="sd">        Get rid of jittering in a non-exclusive classification tensor</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a><span class="sd">        First, remove intervals of 0 shorter than `smooth_interval`. Then, remove intervals of 1 shorter than</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a><span class="sd">        `smooth_interval`.</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>                <span class="n">intervals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_intervals</span><span class="p">(</span><span class="n">tensor</span><span class="p">[:,</span> <span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>                <span class="n">interval_lengths</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>                    <span class="p">[</span><span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">]</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>                <span class="p">)</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>                <span class="n">short_intervals</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="n">interval_lengths</span> <span class="o">&lt;=</span> <span class="n">smooth_interval</span><span class="p">]</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>                <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">short_intervals</span><span class="p">:</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>                    <span class="n">tensor</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>                <span class="n">intervals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_intervals</span><span class="p">(</span><span class="n">tensor</span><span class="p">[:,</span> <span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>                <span class="n">interval_lengths</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>                    <span class="p">[</span><span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">]</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>                <span class="p">)</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>                <span class="n">short_intervals</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="n">interval_lengths</span> <span class="o">&lt;=</span> <span class="n">smooth_interval</span><span class="p">]</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>                <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">short_intervals</span><span class="p">:</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>                    <span class="n">tensor</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tensor</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>                <span class="n">intervals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_intervals</span><span class="p">(</span><span class="n">tensor</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>                <span class="n">interval_lengths</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>                    <span class="p">[</span><span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">]</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>                <span class="p">)</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>                <span class="n">short_intervals</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="n">interval_lengths</span> <span class="o">&lt;=</span> <span class="n">smooth_interval</span><span class="p">]</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>                <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">short_intervals</span><span class="p">:</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>                    <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>                        <span class="n">tensor</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">[</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>                        <span class="n">tensor</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">[</span><span class="n">start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>        <span class="k">return</span> <span class="n">tensor</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>    <span class="k">def</span> <span class="nf">_visualize_results_label</span><span class="p">(</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>        <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>        <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>        <span class="n">add_legend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>        <span class="n">ground_truth</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>        <span class="n">hide_axes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>        <span class="n">whole_video</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>        <span class="n">transparent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>        <span class="n">dataset</span><span class="p">:</span> <span class="n">BehaviorDataset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>        <span class="n">smooth_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>    <span class="p">):</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a><span class="sd">        Visualize random predictions</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a><span class="sd">        Parameters</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a><span class="sd">        ----------</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a><span class="sd">        save_path : str, optional</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a><span class="sd">            the path where the plot will be saved</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a><span class="sd">        add_legend : bool, default True</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a><span class="sd">            if `True`, legend will be added to the plot</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a><span class="sd">        ground_truth : bool, default True</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a><span class="sd">            if `True`, ground truth will be added to the plot</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a><span class="sd">        colormap : str, default &#39;viridis&#39;</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a><span class="sd">            the `matplotlib` colormap to use</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a><span class="sd">        hide_axes : bool, default True</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a><span class="sd">            if `True`, the axes will be hidden on the plot</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a><span class="sd">        min_classes : int, default 1</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a><span class="sd">            the minimum number of classes in a displayed interval</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a><span class="sd">        width : float, default 10</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a><span class="sd">            the width of the plot</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a><span class="sd">        whole_video : bool, default False</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a><span class="sd">            if `True`, whole videos are plotted instead of segments</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a><span class="sd">        transparent : bool, default False</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a><span class="sd">            if `True`, the background on the plot is transparent</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a><span class="sd">        dataset : BehaviorDataset, optional</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a><span class="sd">            the dataset to make the prediction for (if not provided, the validation dataset is used)</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a><span class="sd">        drop_classes : set, optional</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a><span class="sd">            a set of class names to not be displayed</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>        <span class="n">inverse_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>        <span class="n">label_ind</span> <span class="o">=</span> <span class="n">inverse_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>        <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">}</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>        <span class="n">label_keys</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">]</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a>        <span class="n">color_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">]</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>        <span class="k">if</span> <span class="n">whole_video</span><span class="p">:</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>            <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_full_length_prediction</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">predicted</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>        <span class="k">if</span> <span class="n">whole_video</span><span class="p">:</span>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>            <span class="n">max_iter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>            <span class="n">max_iter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>        <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>            <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="n">max_iter</span><span class="p">:</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>                    <span class="s2">&quot;Plotting is taking too many iterations; you should probably make some of the parameters less restrictive&quot;</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>                <span class="p">)</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>            <span class="k">if</span> <span class="n">whole_video</span><span class="p">:</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>                <span class="n">i</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="n">predicted</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>                <span class="n">keys_i</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">prediction</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>                <span class="n">j</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys_i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>                <span class="n">full_p</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="n">keys_i</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="n">keys_i</span><span class="p">[</span><span class="n">j</span><span class="p">]][</span><span class="n">label_ind</span><span class="p">]</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>                <span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>                <span class="n">i</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>                <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>                    <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>                        <span class="k">break</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>                <span class="n">input_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>                <span class="n">prediction</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_prediction</span><span class="p">(</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>                    <span class="n">input_data</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">),</span> <span class="n">augment_n</span><span class="o">=</span><span class="mi">5</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>                <span class="p">)</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_predict_functions</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>                <span class="n">j</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>                <span class="n">full_p</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">label_ind</span><span class="p">]</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>            <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">in</span> <span class="n">label_keys</span><span class="p">]</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>            <span class="n">ok</span> <span class="o">=</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">classes</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>            <span class="n">c_i</span> <span class="o">=</span> <span class="n">label_keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>            <span class="n">output</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique_consecutive</span><span class="p">(</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>                <span class="n">prediction</span> <span class="o">==</span> <span class="n">c</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>            <span class="p">)</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>            <span class="n">long_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>            <span class="n">res_indices_start</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>                <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_indices</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>            <span class="p">]</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>            <span class="n">res_indices_end</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>                <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_indices</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>            <span class="p">]</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>            <span class="n">res_indices_len</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>                <span class="n">end</span> <span class="o">-</span> <span class="n">start</span> <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">res_indices_start</span><span class="p">,</span> <span class="n">res_indices_end</span><span class="p">)</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>            <span class="p">]</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">broken_barh</span><span class="p">(</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a>                <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">res_indices_start</span><span class="p">,</span> <span class="n">res_indices_len</span><span class="p">)),</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>                <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)],</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>                <span class="n">facecolors</span><span class="o">=</span><span class="n">color_list</span><span class="p">[</span><span class="n">c_i</span><span class="p">],</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>            <span class="p">)</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>        <span class="k">if</span> <span class="n">ground_truth</span><span class="p">:</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>            <span class="n">gt</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">label_ind</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>            <span class="n">classes_gt</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">gt</span><span class="p">)</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">in</span> <span class="n">label_keys</span><span class="p">]</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">classes_gt</span><span class="p">:</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>                <span class="n">c_i</span> <span class="o">=</span> <span class="n">label_keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>                    <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>                    <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>                <span class="n">output</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique_consecutive</span><span class="p">(</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>                    <span class="n">gt</span> <span class="o">==</span> <span class="n">c</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>                <span class="p">)</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>                <span class="n">long_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">output</span> <span class="o">*</span> <span class="p">(</span><span class="n">counts</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>                <span class="n">res_indices_start</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>                    <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_indices</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>                <span class="p">]</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>                <span class="n">res_indices_end</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>                    <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_indices</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>                <span class="p">]</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>                <span class="n">res_indices_len</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>                    <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>                    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">res_indices_start</span><span class="p">,</span> <span class="n">res_indices_end</span><span class="p">)</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>                <span class="p">]</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">broken_barh</span><span class="p">(</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>                    <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">res_indices_start</span><span class="p">,</span> <span class="n">res_indices_len</span><span class="p">)),</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>                    <span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>                    <span class="n">facecolors</span><span class="o">=</span><span class="n">color_list</span><span class="p">[</span><span class="n">c_i</span><span class="p">],</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>                    <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>                <span class="p">)</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_compute</span><span class="p">(</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>            <span class="n">main_target</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>            <span class="n">predicted</span><span class="o">=</span><span class="n">full_p</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>            <span class="n">ssl_targets</span><span class="o">=</span><span class="p">[],</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>            <span class="n">ssl_predicted</span><span class="o">=</span><span class="p">[],</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>            <span class="n">skip_loss</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>        <span class="p">)</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>        <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_metrics</span><span class="p">()</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>        <span class="k">if</span> <span class="n">smooth_interval</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>            <span class="n">smoothed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smooth</span><span class="p">(</span><span class="n">full_p</span><span class="p">,</span> <span class="n">smooth_interval</span><span class="o">=</span><span class="n">smooth_interval</span><span class="p">)[</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>                <span class="n">label_ind</span><span class="p">,</span> <span class="p">:</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>            <span class="p">]</span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>                <span class="n">c_i</span> <span class="o">=</span> <span class="n">label_keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>                <span class="n">output</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique_consecutive</span><span class="p">(</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>                    <span class="n">smoothed</span> <span class="o">==</span> <span class="n">c</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>                <span class="p">)</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>                <span class="n">long_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>                <span class="n">res_indices_start</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>                    <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_indices</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>                <span class="p">]</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>                <span class="n">res_indices_end</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>                    <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_indices</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>                <span class="p">]</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>                <span class="n">res_indices_len</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>                    <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a>                    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">res_indices_start</span><span class="p">,</span> <span class="n">res_indices_end</span><span class="p">)</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>                <span class="p">]</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">broken_barh</span><span class="p">(</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>                    <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">res_indices_start</span><span class="p">,</span> <span class="n">res_indices_len</span><span class="p">)),</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a>                    <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>                    <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)],</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a>                    <span class="n">facecolors</span><span class="o">=</span><span class="n">color_list</span><span class="p">[</span><span class="n">c_i</span><span class="p">],</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a>                <span class="p">)</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a>        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">label_ind</span><span class="p">)):</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>                <span class="n">metrics</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>        <span class="n">title</span> <span class="o">=</span> <span class="p">[</span><span class="n">title</span><span class="p">]</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>            <span class="n">title</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">ground_truth</span><span class="p">:</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span> <span class="s2">&quot;ground truth&quot;</span><span class="p">])</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a>        <span class="k">if</span> <span class="n">add_legend</span><span class="p">:</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>        <span class="k">if</span> <span class="n">hide_axes</span><span class="p">:</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction</span><span class="p">)))</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>        <span class="k">if</span> <span class="n">save_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="n">transparent</span><span class="p">)</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>    <span class="k">def</span> <span class="nf">visualize_results</span><span class="p">(</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>        <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>        <span class="n">add_legend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>        <span class="n">ground_truth</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>        <span class="n">colormap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>        <span class="n">hide_axes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a>        <span class="n">min_classes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a>        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>        <span class="n">whole_video</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a>        <span class="n">transparent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a>        <span class="n">dataset</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">BehaviorDataset</span><span class="p">,</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a>        <span class="n">drop_classes</span><span class="p">:</span> <span class="n">Set</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>        <span class="n">search_classes</span><span class="p">:</span> <span class="n">Set</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>        <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>        <span class="n">smooth_interval_prediction</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>        <span class="n">behavior_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a>    <span class="p">):</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a><span class="sd">        Visualize random predictions</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a><span class="sd">        Parameters</span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a><span class="sd">        ----------</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a><span class="sd">        save_path : str, optional</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a><span class="sd">            the path where the plot will be saved</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a><span class="sd">        add_legend : bool, default True</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a><span class="sd">            if `True`, legend will be added to the plot</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a><span class="sd">        ground_truth : bool, default True</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a><span class="sd">            if `True`, ground truth will be added to the plot</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a><span class="sd">        colormap : str, default &#39;Accent&#39;</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a><span class="sd">            the `matplotlib` colormap to use</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a><span class="sd">        hide_axes : bool, default True</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a><span class="sd">            if `True`, the axes will be hidden on the plot</span>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a><span class="sd">        min_classes : int, default 1</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a><span class="sd">            the minimum number of classes in a displayed interval</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a><span class="sd">        width : float, default 10</span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a><span class="sd">            the width of the plot</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a><span class="sd">        whole_video : bool, default False</span>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a><span class="sd">            if `True`, whole videos are plotted instead of segments</span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a><span class="sd">        transparent : bool, default False</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a><span class="sd">            if `True`, the background on the plot is transparent</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a><span class="sd">        dataset : BehaviorDataset | DataLoader | str | None, optional</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a><span class="sd">            the dataset to make the prediction for (if not provided, the validation dataset is used)</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a><span class="sd">        drop_classes : set, optional</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a><span class="sd">            a set of class names to not be displayed</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a><span class="sd">        search_classes : set, optional</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a><span class="sd">            if given, only intervals where at least one of the classes is in ground truth will be shown</span>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a>        <span class="k">if</span> <span class="n">drop_classes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a>            <span class="n">drop_classes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>        <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">annotation_class</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;exclusive_classification&quot;</span><span class="p">:</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a>            <span class="n">exclusive</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>        <span class="k">elif</span> <span class="n">dataset</span><span class="o">.</span><span class="n">annotation_class</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;nonexclusive_classification&quot;</span><span class="p">:</span>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>            <span class="n">exclusive</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a>                <span class="sa">f</span><span class="s2">&quot;Results visualisation is not implemented for </span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">annotation_class</span><span class="p">()</span> <span class="si">}</span><span class="s2"> datasets!&quot;</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>            <span class="p">)</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>        <span class="k">if</span> <span class="n">exclusive</span><span class="p">:</span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>            <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>                <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a>                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>                <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">drop_classes</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>            <span class="p">}</span>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a>            <span class="n">labels</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="o">-</span><span class="mi">100</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">})</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a>            <span class="n">inverse_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>            <span class="k">if</span> <span class="n">behavior_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>                <span class="n">behavior_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inverse_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>            <span class="n">label_ind</span> <span class="o">=</span> <span class="n">inverse_dict</span><span class="p">[</span><span class="n">behavior_name</span><span class="p">]</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>            <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">}</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>        <span class="n">label_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">labels</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a>        <span class="k">if</span> <span class="n">search_classes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a>            <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a>        <span class="n">classes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a>        <span class="k">if</span> <span class="n">whole_video</span><span class="p">:</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>            <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_full_length_prediction</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">predicted</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>        <span class="k">if</span> <span class="n">whole_video</span><span class="p">:</span>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>            <span class="n">max_iter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>            <span class="n">max_iter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a>        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_classes</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>            <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="n">max_iter</span><span class="p">:</span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>                    <span class="s2">&quot;Plotting is taking too many iterations; you should probably make some of the parameters less restrictive&quot;</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a>                <span class="p">)</span>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>            <span class="k">if</span> <span class="n">whole_video</span><span class="p">:</span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a>                <span class="n">i</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="n">predicted</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>                <span class="n">keys_i</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">prediction</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a>                <span class="n">j</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys_i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="n">keys_i</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>                <span class="n">key1</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a>                <span class="n">key2</span> <span class="o">=</span> <span class="n">keys_i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a>                <span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a>                <span class="n">i</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a>                <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a>                    <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a>                        <span class="k">break</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a>                <span class="nb">input</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a>                <span class="n">prediction</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_prediction</span><span class="p">(</span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a>                    <span class="nb">input</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">),</span> <span class="n">augment_n</span><span class="o">=</span><span class="mi">5</span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a>                <span class="p">)</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_predict_functions</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a>                <span class="n">j</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">exclusive</span><span class="p">:</span>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="n">label_ind</span><span class="p">]</span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a>            <span class="k">if</span> <span class="n">smooth_interval_prediction</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a>                <span class="n">unsmoothed_prediction</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smooth</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">smooth_interval_prediction</span><span class="p">)</span>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a>                <span class="n">height</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a>                <span class="n">height</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a>            <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>                <span class="n">labels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">label_keys</span>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>            <span class="p">]</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>            <span class="k">if</span> <span class="n">search_classes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a>                <span class="n">ok</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">x</span> <span class="ow">in</span> <span class="n">classes</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">search_classes</span><span class="p">])</span>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a>        <span class="n">color_list</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="n">lut</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span><span class="o">.</span><span class="n">colors</span>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a>        <span class="k">def</span> <span class="nf">_plot_prediction</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">set_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">label_keys</span><span class="p">:</span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a>                <span class="n">c_i</span> <span class="o">=</span> <span class="n">label_keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a>                <span class="n">output</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique_consecutive</span><span class="p">(</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a>                    <span class="n">prediction</span> <span class="o">==</span> <span class="n">c</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a>                <span class="p">)</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a>                <span class="n">long_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">long_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a>                    <span class="k">continue</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>                <span class="n">res_indices_start</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>                    <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_indices</span>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a>                <span class="p">]</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a>                <span class="n">res_indices_end</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>                    <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_indices</span>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>                <span class="p">]</span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>                <span class="n">res_indices_len</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a>                    <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>                    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">res_indices_start</span><span class="p">,</span> <span class="n">res_indices_end</span><span class="p">)</span>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>                <span class="p">]</span>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a>                <span class="k">if</span> <span class="n">set_labels</span><span class="p">:</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a>                    <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>                    <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">broken_barh</span><span class="p">(</span>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>                    <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">res_indices_start</span><span class="p">,</span> <span class="n">res_indices_len</span><span class="p">)),</span>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>                    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>                    <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>                    <span class="n">facecolors</span><span class="o">=</span><span class="n">color_list</span><span class="p">[</span><span class="n">c_i</span><span class="p">],</span>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>                <span class="p">)</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>        <span class="k">if</span> <span class="n">smooth_interval_prediction</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>            <span class="n">_plot_prediction</span><span class="p">(</span><span class="n">unsmoothed_prediction</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>            <span class="n">_plot_prediction</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">set_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>            <span class="n">gt_height</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>            <span class="n">_plot_prediction</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>            <span class="n">gt_height</span> <span class="o">=</span> <span class="mf">1.5</span>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>        <span class="k">if</span> <span class="n">ground_truth</span><span class="p">:</span>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">whole_video</span><span class="p">:</span>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>                <span class="n">gt</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a>                <span class="n">gt</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">generate_full_length_gt</span><span class="p">()[</span><span class="n">key1</span><span class="p">][</span><span class="n">key2</span><span class="p">]</span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">label_keys</span><span class="p">:</span>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a>                <span class="n">c_i</span> <span class="o">=</span> <span class="n">label_keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a>                <span class="k">if</span> <span class="n">labels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a>                    <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a>                    <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a>                <span class="n">output</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique_consecutive</span><span class="p">(</span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a>                    <span class="n">gt</span> <span class="o">==</span> <span class="n">c</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a>                <span class="p">)</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a>                <span class="n">long_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">long_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a>                    <span class="k">continue</span>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a>                <span class="n">res_indices_start</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a>                    <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_indices</span>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a>                <span class="p">]</span>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a>                <span class="n">res_indices_end</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a>                    <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_indices</span>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a>                <span class="p">]</span>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a>                <span class="n">res_indices_len</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a>                    <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a>                    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">res_indices_start</span><span class="p">,</span> <span class="n">res_indices_end</span><span class="p">)</span>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a>                <span class="p">]</span>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">broken_barh</span><span class="p">(</span>
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a>                    <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">res_indices_start</span><span class="p">,</span> <span class="n">res_indices_len</span><span class="p">)),</span>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a>                    <span class="p">(</span><span class="n">gt_height</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a>                    <span class="n">facecolors</span><span class="o">=</span><span class="n">color_list</span><span class="p">[</span><span class="n">c_i</span><span class="p">]</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&quot;unknown&quot;</span> <span class="k">else</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span>
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a>                    <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a>                <span class="p">)</span>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">ground_truth</span><span class="p">:</span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a>            <span class="k">if</span> <span class="n">smooth_interval_prediction</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">])</span>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos">1646</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span> <span class="s2">&quot;smoothed&quot;</span><span class="p">,</span> <span class="s2">&quot;ground truth&quot;</span><span class="p">])</span>
</span><span id="L-1647"><a href="#L-1647"><span class="linenos">1647</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1648"><a href="#L-1648"><span class="linenos">1648</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span><span id="L-1649"><a href="#L-1649"><span class="linenos">1649</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span> <span class="s2">&quot;ground truth&quot;</span><span class="p">])</span>
</span><span id="L-1650"><a href="#L-1650"><span class="linenos">1650</span></a>        <span class="k">if</span> <span class="n">add_legend</span><span class="p">:</span>
</span><span id="L-1651"><a href="#L-1651"><span class="linenos">1651</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
</span><span id="L-1652"><a href="#L-1652"><span class="linenos">1652</span></a>        <span class="k">if</span> <span class="n">hide_axes</span><span class="p">:</span>
</span><span id="L-1653"><a href="#L-1653"><span class="linenos">1653</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="L-1654"><a href="#L-1654"><span class="linenos">1654</span></a>        <span class="k">if</span> <span class="n">save_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1655"><a href="#L-1655"><span class="linenos">1655</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="n">transparent</span><span class="p">)</span>
</span><span id="L-1656"><a href="#L-1656"><span class="linenos">1656</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-1657"><a href="#L-1657"><span class="linenos">1657</span></a>
</span><span id="L-1658"><a href="#L-1658"><span class="linenos">1658</span></a>    <span class="k">def</span> <span class="nf">set_ssl_transformations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ssl_transformations</span><span class="p">):</span>
</span><span id="L-1659"><a href="#L-1659"><span class="linenos">1659</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">set_ssl_transformations</span><span class="p">(</span><span class="n">ssl_transformations</span><span class="p">)</span>
</span><span id="L-1660"><a href="#L-1660"><span class="linenos">1660</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1661"><a href="#L-1661"><span class="linenos">1661</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">set_ssl_transformations</span><span class="p">(</span><span class="n">ssl_transformations</span><span class="p">)</span>
</span><span id="L-1662"><a href="#L-1662"><span class="linenos">1662</span></a>
</span><span id="L-1663"><a href="#L-1663"><span class="linenos">1663</span></a>    <span class="k">def</span> <span class="nf">set_ssl_losses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ssl_losses</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1664"><a href="#L-1664"><span class="linenos">1664</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1665"><a href="#L-1665"><span class="linenos">1665</span></a><span class="sd">        Set SSL losses</span>
</span><span id="L-1666"><a href="#L-1666"><span class="linenos">1666</span></a>
</span><span id="L-1667"><a href="#L-1667"><span class="linenos">1667</span></a><span class="sd">        Parameters</span>
</span><span id="L-1668"><a href="#L-1668"><span class="linenos">1668</span></a><span class="sd">        ----------</span>
</span><span id="L-1669"><a href="#L-1669"><span class="linenos">1669</span></a><span class="sd">        ssl_losses : list</span>
</span><span id="L-1670"><a href="#L-1670"><span class="linenos">1670</span></a><span class="sd">            a list of callable SSL losses</span>
</span><span id="L-1671"><a href="#L-1671"><span class="linenos">1671</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1672"><a href="#L-1672"><span class="linenos">1672</span></a>
</span><span id="L-1673"><a href="#L-1673"><span class="linenos">1673</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ssl_losses</span> <span class="o">=</span> <span class="n">ssl_losses</span>
</span><span id="L-1674"><a href="#L-1674"><span class="linenos">1674</span></a>
</span><span id="L-1675"><a href="#L-1675"><span class="linenos">1675</span></a>    <span class="k">def</span> <span class="nf">set_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1676"><a href="#L-1676"><span class="linenos">1676</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1677"><a href="#L-1677"><span class="linenos">1677</span></a><span class="sd">        Set the log file</span>
</span><span id="L-1678"><a href="#L-1678"><span class="linenos">1678</span></a>
</span><span id="L-1679"><a href="#L-1679"><span class="linenos">1679</span></a><span class="sd">        Parameters</span>
</span><span id="L-1680"><a href="#L-1680"><span class="linenos">1680</span></a><span class="sd">        ----------</span>
</span><span id="L-1681"><a href="#L-1681"><span class="linenos">1681</span></a><span class="sd">        log: str</span>
</span><span id="L-1682"><a href="#L-1682"><span class="linenos">1682</span></a><span class="sd">            the mew log file path</span>
</span><span id="L-1683"><a href="#L-1683"><span class="linenos">1683</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1684"><a href="#L-1684"><span class="linenos">1684</span></a>
</span><span id="L-1685"><a href="#L-1685"><span class="linenos">1685</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="n">log</span>
</span><span id="L-1686"><a href="#L-1686"><span class="linenos">1686</span></a>
</span><span id="L-1687"><a href="#L-1687"><span class="linenos">1687</span></a>    <span class="k">def</span> <span class="nf">set_keep_target_none</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep_target_none</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1688"><a href="#L-1688"><span class="linenos">1688</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1689"><a href="#L-1689"><span class="linenos">1689</span></a><span class="sd">        Set the keep_target_none parameter of the transformer</span>
</span><span id="L-1690"><a href="#L-1690"><span class="linenos">1690</span></a>
</span><span id="L-1691"><a href="#L-1691"><span class="linenos">1691</span></a><span class="sd">        Parameters</span>
</span><span id="L-1692"><a href="#L-1692"><span class="linenos">1692</span></a><span class="sd">        ----------</span>
</span><span id="L-1693"><a href="#L-1693"><span class="linenos">1693</span></a><span class="sd">        keep_target_none : list</span>
</span><span id="L-1694"><a href="#L-1694"><span class="linenos">1694</span></a><span class="sd">            a list of bool values</span>
</span><span id="L-1695"><a href="#L-1695"><span class="linenos">1695</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1696"><a href="#L-1696"><span class="linenos">1696</span></a>
</span><span id="L-1697"><a href="#L-1697"><span class="linenos">1697</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">keep_target_none</span> <span class="o">=</span> <span class="n">keep_target_none</span>
</span><span id="L-1698"><a href="#L-1698"><span class="linenos">1698</span></a>
</span><span id="L-1699"><a href="#L-1699"><span class="linenos">1699</span></a>    <span class="k">def</span> <span class="nf">set_generate_ssl_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generate_ssl_input</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1700"><a href="#L-1700"><span class="linenos">1700</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1701"><a href="#L-1701"><span class="linenos">1701</span></a><span class="sd">        Set the generate_ssl_input parameter of the transformer</span>
</span><span id="L-1702"><a href="#L-1702"><span class="linenos">1702</span></a>
</span><span id="L-1703"><a href="#L-1703"><span class="linenos">1703</span></a><span class="sd">        Parameters</span>
</span><span id="L-1704"><a href="#L-1704"><span class="linenos">1704</span></a><span class="sd">        ----------</span>
</span><span id="L-1705"><a href="#L-1705"><span class="linenos">1705</span></a><span class="sd">        generate_ssl_input : list</span>
</span><span id="L-1706"><a href="#L-1706"><span class="linenos">1706</span></a><span class="sd">            a list of bool values</span>
</span><span id="L-1707"><a href="#L-1707"><span class="linenos">1707</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1708"><a href="#L-1708"><span class="linenos">1708</span></a>
</span><span id="L-1709"><a href="#L-1709"><span class="linenos">1709</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">generate_ssl_input</span> <span class="o">=</span> <span class="n">generate_ssl_input</span>
</span><span id="L-1710"><a href="#L-1710"><span class="linenos">1710</span></a>
</span><span id="L-1711"><a href="#L-1711"><span class="linenos">1711</span></a>    <span class="k">def</span> <span class="nf">set_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1712"><a href="#L-1712"><span class="linenos">1712</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1713"><a href="#L-1713"><span class="linenos">1713</span></a><span class="sd">        Set a new model</span>
</span><span id="L-1714"><a href="#L-1714"><span class="linenos">1714</span></a>
</span><span id="L-1715"><a href="#L-1715"><span class="linenos">1715</span></a><span class="sd">        Parameters</span>
</span><span id="L-1716"><a href="#L-1716"><span class="linenos">1716</span></a><span class="sd">        ----------</span>
</span><span id="L-1717"><a href="#L-1717"><span class="linenos">1717</span></a><span class="sd">        model: Model</span>
</span><span id="L-1718"><a href="#L-1718"><span class="linenos">1718</span></a><span class="sd">            the new model</span>
</span><span id="L-1719"><a href="#L-1719"><span class="linenos">1719</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1720"><a href="#L-1720"><span class="linenos">1720</span></a>
</span><span id="L-1721"><a href="#L-1721"><span class="linenos">1721</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1722"><a href="#L-1722"><span class="linenos">1722</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="L-1723"><a href="#L-1723"><span class="linenos">1723</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_class</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
</span><span id="L-1724"><a href="#L-1724"><span class="linenos">1724</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">process_labels</span><span class="p">:</span>
</span><span id="L-1725"><a href="#L-1725"><span class="linenos">1725</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_behaviors</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</span><span id="L-1726"><a href="#L-1726"><span class="linenos">1726</span></a>
</span><span id="L-1727"><a href="#L-1727"><span class="linenos">1727</span></a>    <span class="k">def</span> <span class="nf">set_dataloaders</span><span class="p">(</span>
</span><span id="L-1728"><a href="#L-1728"><span class="linenos">1728</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1729"><a href="#L-1729"><span class="linenos">1729</span></a>        <span class="n">train_dataloader</span><span class="p">:</span> <span class="n">DataLoader</span><span class="p">,</span>
</span><span id="L-1730"><a href="#L-1730"><span class="linenos">1730</span></a>        <span class="n">val_dataloader</span><span class="p">:</span> <span class="n">DataLoader</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1731"><a href="#L-1731"><span class="linenos">1731</span></a>        <span class="n">test_dataloader</span><span class="p">:</span> <span class="n">DataLoader</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1732"><a href="#L-1732"><span class="linenos">1732</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1733"><a href="#L-1733"><span class="linenos">1733</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1734"><a href="#L-1734"><span class="linenos">1734</span></a><span class="sd">        Set new dataloaders</span>
</span><span id="L-1735"><a href="#L-1735"><span class="linenos">1735</span></a>
</span><span id="L-1736"><a href="#L-1736"><span class="linenos">1736</span></a><span class="sd">        Parameters</span>
</span><span id="L-1737"><a href="#L-1737"><span class="linenos">1737</span></a><span class="sd">        ----------</span>
</span><span id="L-1738"><a href="#L-1738"><span class="linenos">1738</span></a><span class="sd">        train_dataloader: torch.utils.data.DataLoader</span>
</span><span id="L-1739"><a href="#L-1739"><span class="linenos">1739</span></a><span class="sd">            the new train dataloader</span>
</span><span id="L-1740"><a href="#L-1740"><span class="linenos">1740</span></a><span class="sd">        val_dataloader : torch.utils.data.DataLoader</span>
</span><span id="L-1741"><a href="#L-1741"><span class="linenos">1741</span></a><span class="sd">            the new validation dataloader</span>
</span><span id="L-1742"><a href="#L-1742"><span class="linenos">1742</span></a><span class="sd">        test_dataloader : torch.utils.data.DataLoader</span>
</span><span id="L-1743"><a href="#L-1743"><span class="linenos">1743</span></a><span class="sd">            the new test dataloader</span>
</span><span id="L-1744"><a href="#L-1744"><span class="linenos">1744</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1745"><a href="#L-1745"><span class="linenos">1745</span></a>
</span><span id="L-1746"><a href="#L-1746"><span class="linenos">1746</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">train_dataloader</span>
</span><span id="L-1747"><a href="#L-1747"><span class="linenos">1747</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span> <span class="o">=</span> <span class="n">val_dataloader</span>
</span><span id="L-1748"><a href="#L-1748"><span class="linenos">1748</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_dataloader</span> <span class="o">=</span> <span class="n">test_dataloader</span>
</span><span id="L-1749"><a href="#L-1749"><span class="linenos">1749</span></a>
</span><span id="L-1750"><a href="#L-1750"><span class="linenos">1750</span></a>    <span class="k">def</span> <span class="nf">set_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1751"><a href="#L-1751"><span class="linenos">1751</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1752"><a href="#L-1752"><span class="linenos">1752</span></a><span class="sd">        Set new loss function</span>
</span><span id="L-1753"><a href="#L-1753"><span class="linenos">1753</span></a>
</span><span id="L-1754"><a href="#L-1754"><span class="linenos">1754</span></a><span class="sd">        Parameters</span>
</span><span id="L-1755"><a href="#L-1755"><span class="linenos">1755</span></a><span class="sd">        ----------</span>
</span><span id="L-1756"><a href="#L-1756"><span class="linenos">1756</span></a><span class="sd">        loss: callable</span>
</span><span id="L-1757"><a href="#L-1757"><span class="linenos">1757</span></a><span class="sd">            the new loss function</span>
</span><span id="L-1758"><a href="#L-1758"><span class="linenos">1758</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1759"><a href="#L-1759"><span class="linenos">1759</span></a>
</span><span id="L-1760"><a href="#L-1760"><span class="linenos">1760</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span>
</span><span id="L-1761"><a href="#L-1761"><span class="linenos">1761</span></a>
</span><span id="L-1762"><a href="#L-1762"><span class="linenos">1762</span></a>    <span class="k">def</span> <span class="nf">set_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1763"><a href="#L-1763"><span class="linenos">1763</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1764"><a href="#L-1764"><span class="linenos">1764</span></a><span class="sd">        Set new metric</span>
</span><span id="L-1765"><a href="#L-1765"><span class="linenos">1765</span></a>
</span><span id="L-1766"><a href="#L-1766"><span class="linenos">1766</span></a><span class="sd">        Parameters</span>
</span><span id="L-1767"><a href="#L-1767"><span class="linenos">1767</span></a><span class="sd">        ----------</span>
</span><span id="L-1768"><a href="#L-1768"><span class="linenos">1768</span></a><span class="sd">        metrics : dict</span>
</span><span id="L-1769"><a href="#L-1769"><span class="linenos">1769</span></a><span class="sd">            the new metric dictionary</span>
</span><span id="L-1770"><a href="#L-1770"><span class="linenos">1770</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1771"><a href="#L-1771"><span class="linenos">1771</span></a>
</span><span id="L-1772"><a href="#L-1772"><span class="linenos">1772</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics</span>
</span><span id="L-1773"><a href="#L-1773"><span class="linenos">1773</span></a>
</span><span id="L-1774"><a href="#L-1774"><span class="linenos">1774</span></a>    <span class="k">def</span> <span class="nf">set_transformer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transformer</span><span class="p">:</span> <span class="n">Transformer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1775"><a href="#L-1775"><span class="linenos">1775</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1776"><a href="#L-1776"><span class="linenos">1776</span></a><span class="sd">        Set a new transformer</span>
</span><span id="L-1777"><a href="#L-1777"><span class="linenos">1777</span></a>
</span><span id="L-1778"><a href="#L-1778"><span class="linenos">1778</span></a><span class="sd">        Parameters</span>
</span><span id="L-1779"><a href="#L-1779"><span class="linenos">1779</span></a><span class="sd">        ----------</span>
</span><span id="L-1780"><a href="#L-1780"><span class="linenos">1780</span></a><span class="sd">        transformer: Transformer</span>
</span><span id="L-1781"><a href="#L-1781"><span class="linenos">1781</span></a><span class="sd">            the new transformer</span>
</span><span id="L-1782"><a href="#L-1782"><span class="linenos">1782</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1783"><a href="#L-1783"><span class="linenos">1783</span></a>
</span><span id="L-1784"><a href="#L-1784"><span class="linenos">1784</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="o">=</span> <span class="n">transformer</span>
</span><span id="L-1785"><a href="#L-1785"><span class="linenos">1785</span></a>
</span><span id="L-1786"><a href="#L-1786"><span class="linenos">1786</span></a>    <span class="k">def</span> <span class="nf">set_predict_functions</span><span class="p">(</span>
</span><span id="L-1787"><a href="#L-1787"><span class="linenos">1787</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">primary_predict_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">predict_function</span><span class="p">:</span> <span class="n">Callable</span>
</span><span id="L-1788"><a href="#L-1788"><span class="linenos">1788</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1789"><a href="#L-1789"><span class="linenos">1789</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1790"><a href="#L-1790"><span class="linenos">1790</span></a><span class="sd">        Set new predict functions</span>
</span><span id="L-1791"><a href="#L-1791"><span class="linenos">1791</span></a>
</span><span id="L-1792"><a href="#L-1792"><span class="linenos">1792</span></a><span class="sd">        Parameters</span>
</span><span id="L-1793"><a href="#L-1793"><span class="linenos">1793</span></a><span class="sd">        ----------</span>
</span><span id="L-1794"><a href="#L-1794"><span class="linenos">1794</span></a><span class="sd">        primary_predict_function : callable</span>
</span><span id="L-1795"><a href="#L-1795"><span class="linenos">1795</span></a><span class="sd">            the new primary predict function</span>
</span><span id="L-1796"><a href="#L-1796"><span class="linenos">1796</span></a><span class="sd">        predict_function : callable</span>
</span><span id="L-1797"><a href="#L-1797"><span class="linenos">1797</span></a><span class="sd">            the new predict function</span>
</span><span id="L-1798"><a href="#L-1798"><span class="linenos">1798</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1799"><a href="#L-1799"><span class="linenos">1799</span></a>
</span><span id="L-1800"><a href="#L-1800"><span class="linenos">1800</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">primary_predict_function</span> <span class="o">=</span> <span class="n">primary_predict_function</span>
</span><span id="L-1801"><a href="#L-1801"><span class="linenos">1801</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">predict_function</span> <span class="o">=</span> <span class="n">predict_function</span>
</span><span id="L-1802"><a href="#L-1802"><span class="linenos">1802</span></a>
</span><span id="L-1803"><a href="#L-1803"><span class="linenos">1803</span></a>    <span class="k">def</span> <span class="nf">_set_pseudolabels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1804"><a href="#L-1804"><span class="linenos">1804</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1805"><a href="#L-1805"><span class="linenos">1805</span></a><span class="sd">        Set pseudolabels</span>
</span><span id="L-1806"><a href="#L-1806"><span class="linenos">1806</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1807"><a href="#L-1807"><span class="linenos">1807</span></a>
</span><span id="L-1808"><a href="#L-1808"><span class="linenos">1808</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">set_unlabeled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1809"><a href="#L-1809"><span class="linenos">1809</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
</span><span id="L-1810"><a href="#L-1810"><span class="linenos">1810</span></a>            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">),</span>
</span><span id="L-1811"><a href="#L-1811"><span class="linenos">1811</span></a>            <span class="n">raw_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1812"><a href="#L-1812"><span class="linenos">1812</span></a>            <span class="n">augment_n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">augment_val</span><span class="p">,</span>
</span><span id="L-1813"><a href="#L-1813"><span class="linenos">1813</span></a>            <span class="n">ssl_off</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1814"><a href="#L-1814"><span class="linenos">1814</span></a>        <span class="p">)</span>
</span><span id="L-1815"><a href="#L-1815"><span class="linenos">1815</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">set_annotation</span><span class="p">(</span><span class="n">predicted</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
</span><span id="L-1816"><a href="#L-1816"><span class="linenos">1816</span></a>
</span><span id="L-1817"><a href="#L-1817"><span class="linenos">1817</span></a>    <span class="k">def</span> <span class="nf">_alpha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
</span><span id="L-1818"><a href="#L-1818"><span class="linenos">1818</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1819"><a href="#L-1819"><span class="linenos">1819</span></a><span class="sd">        Get the current pseudolabeling alpha parameter</span>
</span><span id="L-1820"><a href="#L-1820"><span class="linenos">1820</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1821"><a href="#L-1821"><span class="linenos">1821</span></a>
</span><span id="L-1822"><a href="#L-1822"><span class="linenos">1822</span></a>        <span class="k">if</span> <span class="n">epoch</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T1</span><span class="p">:</span>
</span><span id="L-1823"><a href="#L-1823"><span class="linenos">1823</span></a>            <span class="k">return</span> <span class="mi">0</span>
</span><span id="L-1824"><a href="#L-1824"><span class="linenos">1824</span></a>        <span class="k">elif</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">T2</span><span class="p">:</span>
</span><span id="L-1825"><a href="#L-1825"><span class="linenos">1825</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_f</span> <span class="o">*</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">T1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">T1</span><span class="p">)</span>
</span><span id="L-1826"><a href="#L-1826"><span class="linenos">1826</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1827"><a href="#L-1827"><span class="linenos">1827</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_f</span>
</span><span id="L-1828"><a href="#L-1828"><span class="linenos">1828</span></a>
</span><span id="L-1829"><a href="#L-1829"><span class="linenos">1829</span></a>    <span class="k">def</span> <span class="nf">count_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bouts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="L-1830"><a href="#L-1830"><span class="linenos">1830</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1831"><a href="#L-1831"><span class="linenos">1831</span></a><span class="sd">        Get a dictionary of class counts in different modes</span>
</span><span id="L-1832"><a href="#L-1832"><span class="linenos">1832</span></a>
</span><span id="L-1833"><a href="#L-1833"><span class="linenos">1833</span></a><span class="sd">        Parameters</span>
</span><span id="L-1834"><a href="#L-1834"><span class="linenos">1834</span></a><span class="sd">        ----------</span>
</span><span id="L-1835"><a href="#L-1835"><span class="linenos">1835</span></a><span class="sd">        bouts : bool, default False</span>
</span><span id="L-1836"><a href="#L-1836"><span class="linenos">1836</span></a><span class="sd">            if `True`, instead of frame counts segment counts are returned</span>
</span><span id="L-1837"><a href="#L-1837"><span class="linenos">1837</span></a>
</span><span id="L-1838"><a href="#L-1838"><span class="linenos">1838</span></a><span class="sd">        Returns</span>
</span><span id="L-1839"><a href="#L-1839"><span class="linenos">1839</span></a><span class="sd">        -------</span>
</span><span id="L-1840"><a href="#L-1840"><span class="linenos">1840</span></a><span class="sd">        class_counts : dict</span>
</span><span id="L-1841"><a href="#L-1841"><span class="linenos">1841</span></a><span class="sd">            a dictionary where first-level keys are &quot;train&quot;, &quot;val&quot; and &quot;test&quot;, second-level keys are</span>
</span><span id="L-1842"><a href="#L-1842"><span class="linenos">1842</span></a><span class="sd">            class names and values are class counts (in frames)</span>
</span><span id="L-1843"><a href="#L-1843"><span class="linenos">1843</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1844"><a href="#L-1844"><span class="linenos">1844</span></a>
</span><span id="L-1845"><a href="#L-1845"><span class="linenos">1845</span></a>        <span class="n">class_counts</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1846"><a href="#L-1846"><span class="linenos">1846</span></a>        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]:</span>
</span><span id="L-1847"><a href="#L-1847"><span class="linenos">1847</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-1848"><a href="#L-1848"><span class="linenos">1848</span></a>                <span class="n">class_counts</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">count_classes</span><span class="p">(</span><span class="n">bouts</span><span class="p">)</span>
</span><span id="L-1849"><a href="#L-1849"><span class="linenos">1849</span></a>            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="L-1850"><a href="#L-1850"><span class="linenos">1850</span></a>                <span class="n">class_counts</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
</span><span id="L-1851"><a href="#L-1851"><span class="linenos">1851</span></a>        <span class="k">return</span> <span class="n">class_counts</span>
</span><span id="L-1852"><a href="#L-1852"><span class="linenos">1852</span></a>
</span><span id="L-1853"><a href="#L-1853"><span class="linenos">1853</span></a>    <span class="k">def</span> <span class="nf">behaviors_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="L-1854"><a href="#L-1854"><span class="linenos">1854</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1855"><a href="#L-1855"><span class="linenos">1855</span></a><span class="sd">        Get a behavior dictionary</span>
</span><span id="L-1856"><a href="#L-1856"><span class="linenos">1856</span></a>
</span><span id="L-1857"><a href="#L-1857"><span class="linenos">1857</span></a><span class="sd">        Keys are label indices and values are label names.</span>
</span><span id="L-1858"><a href="#L-1858"><span class="linenos">1858</span></a>
</span><span id="L-1859"><a href="#L-1859"><span class="linenos">1859</span></a><span class="sd">        Returns</span>
</span><span id="L-1860"><a href="#L-1860"><span class="linenos">1860</span></a><span class="sd">        -------</span>
</span><span id="L-1861"><a href="#L-1861"><span class="linenos">1861</span></a><span class="sd">        behaviors_dict : dict</span>
</span><span id="L-1862"><a href="#L-1862"><span class="linenos">1862</span></a><span class="sd">            behavior dictionary</span>
</span><span id="L-1863"><a href="#L-1863"><span class="linenos">1863</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1864"><a href="#L-1864"><span class="linenos">1864</span></a>
</span><span id="L-1865"><a href="#L-1865"><span class="linenos">1865</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">()</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span>
</span><span id="L-1866"><a href="#L-1866"><span class="linenos">1866</span></a>
</span><span id="L-1867"><a href="#L-1867"><span class="linenos">1867</span></a>    <span class="k">def</span> <span class="nf">update_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1868"><a href="#L-1868"><span class="linenos">1868</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1869"><a href="#L-1869"><span class="linenos">1869</span></a><span class="sd">        Update training parameters from a dictionary</span>
</span><span id="L-1870"><a href="#L-1870"><span class="linenos">1870</span></a>
</span><span id="L-1871"><a href="#L-1871"><span class="linenos">1871</span></a><span class="sd">        Parameters</span>
</span><span id="L-1872"><a href="#L-1872"><span class="linenos">1872</span></a><span class="sd">        ----------</span>
</span><span id="L-1873"><a href="#L-1873"><span class="linenos">1873</span></a><span class="sd">        parameters : dict</span>
</span><span id="L-1874"><a href="#L-1874"><span class="linenos">1874</span></a><span class="sd">            the update dictionary</span>
</span><span id="L-1875"><a href="#L-1875"><span class="linenos">1875</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1876"><a href="#L-1876"><span class="linenos">1876</span></a>
</span><span id="L-1877"><a href="#L-1877"><span class="linenos">1877</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lr&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
</span><span id="L-1878"><a href="#L-1878"><span class="linenos">1878</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parallel&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">)</span>
</span><span id="L-1879"><a href="#L-1879"><span class="linenos">1879</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
</span><span id="L-1880"><a href="#L-1880"><span class="linenos">1880</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
</span><span id="L-1881"><a href="#L-1881"><span class="linenos">1881</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1882"><a href="#L-1882"><span class="linenos">1882</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
</span><span id="L-1883"><a href="#L-1883"><span class="linenos">1883</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
</span><span id="L-1884"><a href="#L-1884"><span class="linenos">1884</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">augment_train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;augment_train&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">augment_train</span><span class="p">))</span>
</span><span id="L-1885"><a href="#L-1885"><span class="linenos">1885</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">augment_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;augment_val&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">augment_val</span><span class="p">))</span>
</span><span id="L-1886"><a href="#L-1886"><span class="linenos">1886</span></a>        <span class="n">ssl_weights</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ssl_weights&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_weights</span><span class="p">)</span>
</span><span id="L-1887"><a href="#L-1887"><span class="linenos">1887</span></a>        <span class="k">if</span> <span class="n">ssl_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1888"><a href="#L-1888"><span class="linenos">1888</span></a>            <span class="n">ssl_weights</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_losses</span><span class="p">]</span>
</span><span id="L-1889"><a href="#L-1889"><span class="linenos">1889</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ssl_weights</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
</span><span id="L-1890"><a href="#L-1890"><span class="linenos">1890</span></a>            <span class="n">ssl_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">ssl_weights</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_losses</span><span class="p">]</span>
</span><span id="L-1891"><a href="#L-1891"><span class="linenos">1891</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ssl_weights</span> <span class="o">=</span> <span class="n">ssl_weights</span>
</span><span id="L-1892"><a href="#L-1892"><span class="linenos">1892</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_epochs</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_epochs&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">)</span>
</span><span id="L-1893"><a href="#L-1893"><span class="linenos">1893</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_save_epochs</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="L-1894"><a href="#L-1894"><span class="linenos">1894</span></a>            <span class="s2">&quot;model_save_epochs&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_epochs</span>
</span><span id="L-1895"><a href="#L-1895"><span class="linenos">1895</span></a>        <span class="p">)</span>
</span><span id="L-1896"><a href="#L-1896"><span class="linenos">1896</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_save_path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">)</span>
</span><span id="L-1897"><a href="#L-1897"><span class="linenos">1897</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pseudolabel</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pseudolabel&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudolabel</span><span class="p">)</span>
</span><span id="L-1898"><a href="#L-1898"><span class="linenos">1898</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">T1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pseudolabel_start&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T1</span><span class="p">))</span>
</span><span id="L-1899"><a href="#L-1899"><span class="linenos">1899</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">T2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;alpha_growth_stop&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T2</span><span class="p">))</span>
</span><span id="L-1900"><a href="#L-1900"><span class="linenos">1900</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;correction_interval&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">))</span>
</span><span id="L-1901"><a href="#L-1901"><span class="linenos">1901</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_f</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pseudolabel_alpha_f&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_f</span><span class="p">)</span>
</span><span id="L-1902"><a href="#L-1902"><span class="linenos">1902</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;log_file&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">)</span>
</span><span id="L-1903"><a href="#L-1903"><span class="linenos">1903</span></a>
</span><span id="L-1904"><a href="#L-1904"><span class="linenos">1904</span></a>    <span class="k">def</span> <span class="nf">generate_uncertainty_score</span><span class="p">(</span>
</span><span id="L-1905"><a href="#L-1905"><span class="linenos">1905</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1906"><a href="#L-1906"><span class="linenos">1906</span></a>        <span class="n">classes</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
</span><span id="L-1907"><a href="#L-1907"><span class="linenos">1907</span></a>        <span class="n">augment_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-1908"><a href="#L-1908"><span class="linenos">1908</span></a>        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
</span><span id="L-1909"><a href="#L-1909"><span class="linenos">1909</span></a>        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;least_confidence&quot;</span><span class="p">,</span>
</span><span id="L-1910"><a href="#L-1910"><span class="linenos">1910</span></a>        <span class="n">predicted</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1911"><a href="#L-1911"><span class="linenos">1911</span></a>        <span class="n">behaviors_dict</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1912"><a href="#L-1912"><span class="linenos">1912</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="L-1913"><a href="#L-1913"><span class="linenos">1913</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1914"><a href="#L-1914"><span class="linenos">1914</span></a><span class="sd">        Generate frame-wise scores for active learning</span>
</span><span id="L-1915"><a href="#L-1915"><span class="linenos">1915</span></a>
</span><span id="L-1916"><a href="#L-1916"><span class="linenos">1916</span></a><span class="sd">        Parameters</span>
</span><span id="L-1917"><a href="#L-1917"><span class="linenos">1917</span></a><span class="sd">        ----------</span>
</span><span id="L-1918"><a href="#L-1918"><span class="linenos">1918</span></a><span class="sd">        classes : list</span>
</span><span id="L-1919"><a href="#L-1919"><span class="linenos">1919</span></a><span class="sd">            a list of class names or indices; their confidence scores will be computed separately and stacked</span>
</span><span id="L-1920"><a href="#L-1920"><span class="linenos">1920</span></a><span class="sd">        augment_n : int, default 0</span>
</span><span id="L-1921"><a href="#L-1921"><span class="linenos">1921</span></a><span class="sd">            the number of augmentations to average over</span>
</span><span id="L-1922"><a href="#L-1922"><span class="linenos">1922</span></a><span class="sd">        batch_size : int, default 32</span>
</span><span id="L-1923"><a href="#L-1923"><span class="linenos">1923</span></a><span class="sd">            the batch size</span>
</span><span id="L-1924"><a href="#L-1924"><span class="linenos">1924</span></a><span class="sd">        method : {&quot;least_confidence&quot;, &quot;entropy&quot;}</span>
</span><span id="L-1925"><a href="#L-1925"><span class="linenos">1925</span></a><span class="sd">            the method used to calculate the scores from the probability predictions (`&quot;least_confidence&quot;`: `1 - p_i` if</span>
</span><span id="L-1926"><a href="#L-1926"><span class="linenos">1926</span></a><span class="sd">            `p_i &gt; 0.5` or `p_i` if `p_i &lt; 0.5`; `&quot;entropy&quot;`: `- p_i * log(p_i) - (1 - p_i) * log(1 - p_i)`)</span>
</span><span id="L-1927"><a href="#L-1927"><span class="linenos">1927</span></a>
</span><span id="L-1928"><a href="#L-1928"><span class="linenos">1928</span></a><span class="sd">        Returns</span>
</span><span id="L-1929"><a href="#L-1929"><span class="linenos">1929</span></a><span class="sd">        -------</span>
</span><span id="L-1930"><a href="#L-1930"><span class="linenos">1930</span></a><span class="sd">        score_dicts : dict</span>
</span><span id="L-1931"><a href="#L-1931"><span class="linenos">1931</span></a><span class="sd">            a nested dictionary where first level keys are video ids, second level keys are clip ids and values</span>
</span><span id="L-1932"><a href="#L-1932"><span class="linenos">1932</span></a><span class="sd">            are score tensors</span>
</span><span id="L-1933"><a href="#L-1933"><span class="linenos">1933</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1934"><a href="#L-1934"><span class="linenos">1934</span></a>
</span><span id="L-1935"><a href="#L-1935"><span class="linenos">1935</span></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
</span><span id="L-1936"><a href="#L-1936"><span class="linenos">1936</span></a>        <span class="k">if</span> <span class="n">behaviors_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1937"><a href="#L-1937"><span class="linenos">1937</span></a>            <span class="n">behaviors_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span>
</span><span id="L-1938"><a href="#L-1938"><span class="linenos">1938</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">BehaviorDataset</span><span class="p">):</span>
</span><span id="L-1939"><a href="#L-1939"><span class="linenos">1939</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="L-1940"><a href="#L-1940"><span class="linenos">1940</span></a>                <span class="sa">f</span><span class="s2">&quot;The dataset parameter has to be either None, string, &quot;</span>
</span><span id="L-1941"><a href="#L-1941"><span class="linenos">1941</span></a>                <span class="sa">f</span><span class="s2">&quot;BehaviorDataset or Dataloader, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1942"><a href="#L-1942"><span class="linenos">1942</span></a>            <span class="p">)</span>
</span><span id="L-1943"><a href="#L-1943"><span class="linenos">1943</span></a>        <span class="k">if</span> <span class="n">predicted</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1944"><a href="#L-1944"><span class="linenos">1944</span></a>            <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
</span><span id="L-1945"><a href="#L-1945"><span class="linenos">1945</span></a>                <span class="n">dataset</span><span class="p">,</span>
</span><span id="L-1946"><a href="#L-1946"><span class="linenos">1946</span></a>                <span class="n">raw_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1947"><a href="#L-1947"><span class="linenos">1947</span></a>                <span class="n">apply_primary_function</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1948"><a href="#L-1948"><span class="linenos">1948</span></a>                <span class="n">augment_n</span><span class="o">=</span><span class="n">augment_n</span><span class="p">,</span>
</span><span id="L-1949"><a href="#L-1949"><span class="linenos">1949</span></a>                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="L-1950"><a href="#L-1950"><span class="linenos">1950</span></a>            <span class="p">)</span>
</span><span id="L-1951"><a href="#L-1951"><span class="linenos">1951</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">generate_full_length_prediction</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="L-1952"><a href="#L-1952"><span class="linenos">1952</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">classes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-1953"><a href="#L-1953"><span class="linenos">1953</span></a>            <span class="n">behaviors_dict_inverse</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">behaviors_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-1954"><a href="#L-1954"><span class="linenos">1954</span></a>            <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">behaviors_dict_inverse</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">]</span>
</span><span id="L-1955"><a href="#L-1955"><span class="linenos">1955</span></a>        <span class="k">for</span> <span class="n">v_id</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">predicted</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-1956"><a href="#L-1956"><span class="linenos">1956</span></a>            <span class="k">for</span> <span class="n">clip_id</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-1957"><a href="#L-1957"><span class="linenos">1957</span></a>                <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;least_confidence&quot;</span><span class="p">:</span>
</span><span id="L-1958"><a href="#L-1958"><span class="linenos">1958</span></a>                    <span class="n">predicted</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">][</span><span class="n">vv</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">vv</span><span class="p">[</span><span class="n">vv</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">]</span>
</span><span id="L-1959"><a href="#L-1959"><span class="linenos">1959</span></a>                <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;entropy&quot;</span><span class="p">:</span>
</span><span id="L-1960"><a href="#L-1960"><span class="linenos">1960</span></a>                    <span class="n">predicted</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">][</span><span class="n">vv</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1961"><a href="#L-1961"><span class="linenos">1961</span></a>                        <span class="o">-</span><span class="n">vv</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">vv</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">vv</span><span class="p">)</span>
</span><span id="L-1962"><a href="#L-1962"><span class="linenos">1962</span></a>                    <span class="p">)[</span><span class="n">vv</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">100</span><span class="p">]</span>
</span><span id="L-1963"><a href="#L-1963"><span class="linenos">1963</span></a>                <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
</span><span id="L-1964"><a href="#L-1964"><span class="linenos">1964</span></a>                    <span class="n">predicted</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">vv</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-1965"><a href="#L-1965"><span class="linenos">1965</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1966"><a href="#L-1966"><span class="linenos">1966</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-1967"><a href="#L-1967"><span class="linenos">1967</span></a>                        <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> method is not recognized; please choose from [&#39;least_confidence&#39;, &#39;entropy&#39;]&quot;</span>
</span><span id="L-1968"><a href="#L-1968"><span class="linenos">1968</span></a>                    <span class="p">)</span>
</span><span id="L-1969"><a href="#L-1969"><span class="linenos">1969</span></a>                <span class="n">predicted</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">][</span><span class="n">vv</span> <span class="o">==</span> <span class="o">-</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1970"><a href="#L-1970"><span class="linenos">1970</span></a>
</span><span id="L-1971"><a href="#L-1971"><span class="linenos">1971</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1972"><a href="#L-1972"><span class="linenos">1972</span></a>            <span class="n">v_id</span><span class="p">:</span> <span class="p">{</span><span class="n">clip_id</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">classes</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">clip_id</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">video_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-1973"><a href="#L-1973"><span class="linenos">1973</span></a>            <span class="k">for</span> <span class="n">v_id</span><span class="p">,</span> <span class="n">video_dict</span> <span class="ow">in</span> <span class="n">predicted</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-1974"><a href="#L-1974"><span class="linenos">1974</span></a>        <span class="p">}</span>
</span><span id="L-1975"><a href="#L-1975"><span class="linenos">1975</span></a>        <span class="k">return</span> <span class="n">predicted</span>
</span><span id="L-1976"><a href="#L-1976"><span class="linenos">1976</span></a>
</span><span id="L-1977"><a href="#L-1977"><span class="linenos">1977</span></a>    <span class="k">def</span> <span class="nf">generate_bald_score</span><span class="p">(</span>
</span><span id="L-1978"><a href="#L-1978"><span class="linenos">1978</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1979"><a href="#L-1979"><span class="linenos">1979</span></a>        <span class="n">classes</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
</span><span id="L-1980"><a href="#L-1980"><span class="linenos">1980</span></a>        <span class="n">augment_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-1981"><a href="#L-1981"><span class="linenos">1981</span></a>        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
</span><span id="L-1982"><a href="#L-1982"><span class="linenos">1982</span></a>        <span class="n">num_models</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="L-1983"><a href="#L-1983"><span class="linenos">1983</span></a>        <span class="n">kernel_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
</span><span id="L-1984"><a href="#L-1984"><span class="linenos">1984</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="L-1985"><a href="#L-1985"><span class="linenos">1985</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1986"><a href="#L-1986"><span class="linenos">1986</span></a><span class="sd">        Generate frame-wise Bayesian Active Learning by Disagreement scores for active learning</span>
</span><span id="L-1987"><a href="#L-1987"><span class="linenos">1987</span></a>
</span><span id="L-1988"><a href="#L-1988"><span class="linenos">1988</span></a><span class="sd">        Parameters</span>
</span><span id="L-1989"><a href="#L-1989"><span class="linenos">1989</span></a><span class="sd">        ----------</span>
</span><span id="L-1990"><a href="#L-1990"><span class="linenos">1990</span></a><span class="sd">        classes : list</span>
</span><span id="L-1991"><a href="#L-1991"><span class="linenos">1991</span></a><span class="sd">            a list of class names or indices; their confidence scores will be computed separately and stacked</span>
</span><span id="L-1992"><a href="#L-1992"><span class="linenos">1992</span></a><span class="sd">        augment_n : int, default 0</span>
</span><span id="L-1993"><a href="#L-1993"><span class="linenos">1993</span></a><span class="sd">            the number of augmentations to average over</span>
</span><span id="L-1994"><a href="#L-1994"><span class="linenos">1994</span></a><span class="sd">        batch_size : int, default 32</span>
</span><span id="L-1995"><a href="#L-1995"><span class="linenos">1995</span></a><span class="sd">            the batch size</span>
</span><span id="L-1996"><a href="#L-1996"><span class="linenos">1996</span></a><span class="sd">        num_models : int, default 10</span>
</span><span id="L-1997"><a href="#L-1997"><span class="linenos">1997</span></a><span class="sd">            the number of dropout masks to apply</span>
</span><span id="L-1998"><a href="#L-1998"><span class="linenos">1998</span></a><span class="sd">        kernel_size : int, default 11</span>
</span><span id="L-1999"><a href="#L-1999"><span class="linenos">1999</span></a><span class="sd">            the size of the smoothing gaussian kernel</span>
</span><span id="L-2000"><a href="#L-2000"><span class="linenos">2000</span></a>
</span><span id="L-2001"><a href="#L-2001"><span class="linenos">2001</span></a><span class="sd">        Returns</span>
</span><span id="L-2002"><a href="#L-2002"><span class="linenos">2002</span></a><span class="sd">        -------</span>
</span><span id="L-2003"><a href="#L-2003"><span class="linenos">2003</span></a><span class="sd">        score_dicts : dict</span>
</span><span id="L-2004"><a href="#L-2004"><span class="linenos">2004</span></a><span class="sd">            a nested dictionary where first level keys are video ids, second level keys are clip ids and values</span>
</span><span id="L-2005"><a href="#L-2005"><span class="linenos">2005</span></a><span class="sd">            are score tensors</span>
</span><span id="L-2006"><a href="#L-2006"><span class="linenos">2006</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2007"><a href="#L-2007"><span class="linenos">2007</span></a>
</span><span id="L-2008"><a href="#L-2008"><span class="linenos">2008</span></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
</span><span id="L-2009"><a href="#L-2009"><span class="linenos">2009</span></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="L-2010"><a href="#L-2010"><span class="linenos">2010</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">BehaviorDataset</span><span class="p">):</span>
</span><span id="L-2011"><a href="#L-2011"><span class="linenos">2011</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="L-2012"><a href="#L-2012"><span class="linenos">2012</span></a>                <span class="sa">f</span><span class="s2">&quot;The dataset parameter has to be either None, string, &quot;</span>
</span><span id="L-2013"><a href="#L-2013"><span class="linenos">2013</span></a>                <span class="sa">f</span><span class="s2">&quot;BehaviorDataset or Dataloader, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-2014"><a href="#L-2014"><span class="linenos">2014</span></a>            <span class="p">)</span>
</span><span id="L-2015"><a href="#L-2015"><span class="linenos">2015</span></a>        <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2016"><a href="#L-2016"><span class="linenos">2016</span></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">):</span>
</span><span id="L-2017"><a href="#L-2017"><span class="linenos">2017</span></a>            <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
</span><span id="L-2018"><a href="#L-2018"><span class="linenos">2018</span></a>                <span class="n">dataset</span><span class="p">,</span>
</span><span id="L-2019"><a href="#L-2019"><span class="linenos">2019</span></a>                <span class="n">raw_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-2020"><a href="#L-2020"><span class="linenos">2020</span></a>                <span class="n">apply_primary_function</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-2021"><a href="#L-2021"><span class="linenos">2021</span></a>                <span class="n">augment_n</span><span class="o">=</span><span class="n">augment_n</span><span class="p">,</span>
</span><span id="L-2022"><a href="#L-2022"><span class="linenos">2022</span></a>                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="L-2023"><a href="#L-2023"><span class="linenos">2023</span></a>                <span class="n">train_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-2024"><a href="#L-2024"><span class="linenos">2024</span></a>            <span class="p">)</span>
</span><span id="L-2025"><a href="#L-2025"><span class="linenos">2025</span></a>            <span class="n">predicted</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">generate_full_length_prediction</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="L-2026"><a href="#L-2026"><span class="linenos">2026</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">classes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-2027"><a href="#L-2027"><span class="linenos">2027</span></a>                <span class="n">behaviors_dict_inverse</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-2028"><a href="#L-2028"><span class="linenos">2028</span></a>                    <span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-2029"><a href="#L-2029"><span class="linenos">2029</span></a>                <span class="p">}</span>
</span><span id="L-2030"><a href="#L-2030"><span class="linenos">2030</span></a>                <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">behaviors_dict_inverse</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">]</span>
</span><span id="L-2031"><a href="#L-2031"><span class="linenos">2031</span></a>            <span class="k">for</span> <span class="n">v_id</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">predicted</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-2032"><a href="#L-2032"><span class="linenos">2032</span></a>                <span class="k">for</span> <span class="n">clip_id</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-2033"><a href="#L-2033"><span class="linenos">2033</span></a>                    <span class="n">vv</span><span class="p">[</span><span class="n">vv</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vv</span><span class="p">[</span><span class="n">vv</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">100</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">int</span><span class="p">()</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
</span><span id="L-2034"><a href="#L-2034"><span class="linenos">2034</span></a>                    <span class="n">predicted</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">vv</span>
</span><span id="L-2035"><a href="#L-2035"><span class="linenos">2035</span></a>            <span class="n">predicted</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-2036"><a href="#L-2036"><span class="linenos">2036</span></a>                <span class="n">v_id</span><span class="p">:</span> <span class="p">{</span><span class="n">clip_id</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">classes</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">clip_id</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">video_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-2037"><a href="#L-2037"><span class="linenos">2037</span></a>                <span class="k">for</span> <span class="n">v_id</span><span class="p">,</span> <span class="n">video_dict</span> <span class="ow">in</span> <span class="n">predicted</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-2038"><a href="#L-2038"><span class="linenos">2038</span></a>            <span class="p">}</span>
</span><span id="L-2039"><a href="#L-2039"><span class="linenos">2039</span></a>            <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="L-2040"><a href="#L-2040"><span class="linenos">2040</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">v_id</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">v_id</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
</span><span id="L-2041"><a href="#L-2041"><span class="linenos">2041</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">kernel_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">kernel_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-2042"><a href="#L-2042"><span class="linenos">2042</span></a>        <span class="n">gauss</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">))</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">1</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="p">]</span>
</span><span id="L-2043"><a href="#L-2043"><span class="linenos">2043</span></a>        <span class="n">gauss</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">gauss</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">gauss</span><span class="p">]</span>
</span><span id="L-2044"><a href="#L-2044"><span class="linenos">2044</span></a>        <span class="n">kernel</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">([[</span><span class="n">gauss</span><span class="p">]])</span>
</span><span id="L-2045"><a href="#L-2045"><span class="linenos">2045</span></a>        <span class="k">for</span> <span class="n">v_id</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-2046"><a href="#L-2046"><span class="linenos">2046</span></a>            <span class="k">for</span> <span class="n">clip_id</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">v_id</span><span class="p">]:</span>
</span><span id="L-2047"><a href="#L-2047"><span class="linenos">2047</span></a>                <span class="n">consensus</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-2048"><a href="#L-2048"><span class="linenos">2048</span></a>                    <span class="p">(</span>
</span><span id="L-2049"><a href="#L-2049"><span class="linenos">2049</span></a>                        <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
</span><span id="L-2050"><a href="#L-2050"><span class="linenos">2050</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span>
</span><span id="L-2051"><a href="#L-2051"><span class="linenos">2051</span></a>                        <span class="p">)</span>
</span><span id="L-2052"><a href="#L-2052"><span class="linenos">2052</span></a>                        <span class="o">&gt;</span> <span class="mf">0.5</span>
</span><span id="L-2053"><a href="#L-2053"><span class="linenos">2053</span></a>                    <span class="p">)</span>
</span><span id="L-2054"><a href="#L-2054"><span class="linenos">2054</span></a>                    <span class="o">.</span><span class="n">int</span><span class="p">()</span>
</span><span id="L-2055"><a href="#L-2055"><span class="linenos">2055</span></a>                    <span class="o">.</span><span class="n">float</span><span class="p">()</span>
</span><span id="L-2056"><a href="#L-2056"><span class="linenos">2056</span></a>                <span class="p">)</span>
</span><span id="L-2057"><a href="#L-2057"><span class="linenos">2057</span></a>                <span class="n">consensus</span><span class="p">[</span><span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>
</span><span id="L-2058"><a href="#L-2058"><span class="linenos">2058</span></a>                <span class="n">result</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">consensus</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-2059"><a href="#L-2059"><span class="linenos">2059</span></a>                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">:</span>
</span><span id="L-2060"><a href="#L-2060"><span class="linenos">2060</span></a>                    <span class="n">result</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">!=</span> <span class="n">consensus</span><span class="p">)</span><span class="o">.</span><span class="n">int</span><span class="p">()</span>
</span><span id="L-2061"><a href="#L-2061"><span class="linenos">2061</span></a>                <span class="n">result</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">num_models</span>
</span><span id="L-2062"><a href="#L-2062"><span class="linenos">2062</span></a>                <span class="n">res</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-2063"><a href="#L-2063"><span class="linenos">2063</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)):</span>
</span><span id="L-2064"><a href="#L-2064"><span class="linenos">2064</span></a>                    <span class="n">res</span><span class="p">[</span>
</span><span id="L-2065"><a href="#L-2065"><span class="linenos">2065</span></a>                        <span class="n">i</span><span class="p">,</span> <span class="n">floor</span><span class="p">(</span><span class="n">kernel_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="n">floor</span><span class="p">(</span><span class="n">kernel_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-2066"><a href="#L-2066"><span class="linenos">2066</span></a>                    <span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">conv1d</span><span class="p">(</span>
</span><span id="L-2067"><a href="#L-2067"><span class="linenos">2067</span></a>                        <span class="n">result</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">kernel</span>
</span><span id="L-2068"><a href="#L-2068"><span class="linenos">2068</span></a>                    <span class="p">)[</span>
</span><span id="L-2069"><a href="#L-2069"><span class="linenos">2069</span></a>                        <span class="mi">0</span><span class="p">,</span> <span class="o">...</span>
</span><span id="L-2070"><a href="#L-2070"><span class="linenos">2070</span></a>                    <span class="p">]</span>
</span><span id="L-2071"><a href="#L-2071"><span class="linenos">2071</span></a>                <span class="n">result</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
</span><span id="L-2072"><a href="#L-2072"><span class="linenos">2072</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="L-2073"><a href="#L-2073"><span class="linenos">2073</span></a>
</span><span id="L-2074"><a href="#L-2074"><span class="linenos">2074</span></a>    <span class="k">def</span> <span class="nf">get_normalization_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="L-2075"><a href="#L-2075"><span class="linenos">2075</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">stats</span>
</span></pre></div>


            </section>
                <section id="MyDataParallel">
                            <input id="MyDataParallel-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">MyDataParallel</span><wbr>(<span class="base">torch.nn.parallel.data_parallel.DataParallel</span>):

                <label class="view-source-button" for="MyDataParallel-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MyDataParallel"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MyDataParallel-36"><a href="#MyDataParallel-36"><span class="linenos">36</span></a><span class="k">class</span> <span class="nc">MyDataParallel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">):</span>
</span><span id="MyDataParallel-37"><a href="#MyDataParallel-37"><span class="linenos">37</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="MyDataParallel-38"><a href="#MyDataParallel-38"><span class="linenos">38</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="MyDataParallel-39"><a href="#MyDataParallel-39"><span class="linenos">39</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">process_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">process_labels</span>
</span><span id="MyDataParallel-40"><a href="#MyDataParallel-40"><span class="linenos">40</span></a>
</span><span id="MyDataParallel-41"><a href="#MyDataParallel-41"><span class="linenos">41</span></a>    <span class="k">def</span> <span class="nf">freeze_feature_extractor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MyDataParallel-42"><a href="#MyDataParallel-42"><span class="linenos">42</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">freeze_feature_extractor</span><span class="p">()</span>
</span><span id="MyDataParallel-43"><a href="#MyDataParallel-43"><span class="linenos">43</span></a>
</span><span id="MyDataParallel-44"><a href="#MyDataParallel-44"><span class="linenos">44</span></a>    <span class="k">def</span> <span class="nf">unfreeze_feature_extractor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MyDataParallel-45"><a href="#MyDataParallel-45"><span class="linenos">45</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">unfreeze_feature_extractor</span><span class="p">()</span>
</span><span id="MyDataParallel-46"><a href="#MyDataParallel-46"><span class="linenos">46</span></a>
</span><span id="MyDataParallel-47"><a href="#MyDataParallel-47"><span class="linenos">47</span></a>    <span class="k">def</span> <span class="nf">transform_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span id="MyDataParallel-48"><a href="#MyDataParallel-48"><span class="linenos">48</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">transform_labels</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="MyDataParallel-49"><a href="#MyDataParallel-49"><span class="linenos">49</span></a>
</span><span id="MyDataParallel-50"><a href="#MyDataParallel-50"><span class="linenos">50</span></a>    <span class="k">def</span> <span class="nf">logit_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MyDataParallel-51"><a href="#MyDataParallel-51"><span class="linenos">51</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">logit_scale</span><span class="p">()</span>
</span><span id="MyDataParallel-52"><a href="#MyDataParallel-52"><span class="linenos">52</span></a>
</span><span id="MyDataParallel-53"><a href="#MyDataParallel-53"><span class="linenos">53</span></a>    <span class="k">def</span> <span class="nf">main_task_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MyDataParallel-54"><a href="#MyDataParallel-54"><span class="linenos">54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">main_task_off</span><span class="p">()</span>
</span><span id="MyDataParallel-55"><a href="#MyDataParallel-55"><span class="linenos">55</span></a>
</span><span id="MyDataParallel-56"><a href="#MyDataParallel-56"><span class="linenos">56</span></a>    <span class="k">def</span> <span class="nf">state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="MyDataParallel-57"><a href="#MyDataParallel-57"><span class="linenos">57</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="MyDataParallel-58"><a href="#MyDataParallel-58"><span class="linenos">58</span></a>
</span><span id="MyDataParallel-59"><a href="#MyDataParallel-59"><span class="linenos">59</span></a>    <span class="k">def</span> <span class="nf">ssl_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MyDataParallel-60"><a href="#MyDataParallel-60"><span class="linenos">60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">ssl_on</span><span class="p">()</span>
</span><span id="MyDataParallel-61"><a href="#MyDataParallel-61"><span class="linenos">61</span></a>
</span><span id="MyDataParallel-62"><a href="#MyDataParallel-62"><span class="linenos">62</span></a>    <span class="k">def</span> <span class="nf">ssl_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MyDataParallel-63"><a href="#MyDataParallel-63"><span class="linenos">63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">ssl_off</span><span class="p">()</span>
</span><span id="MyDataParallel-64"><a href="#MyDataParallel-64"><span class="linenos">64</span></a>
</span><span id="MyDataParallel-65"><a href="#MyDataParallel-65"><span class="linenos">65</span></a>    <span class="k">def</span> <span class="nf">extract_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="MyDataParallel-66"><a href="#MyDataParallel-66"><span class="linenos">66</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Implements data parallelism at the module level.</p>

<p>This container parallelizes the application of the given <code>module</code> by
splitting the input across the specified devices by chunking in the batch
dimension (other objects will be copied once per device). In the forward
pass, the module is replicated on each device, and each replica handles a
portion of the input. During the backwards pass, gradients from each replica
are summed into the original module.</p>

<p>The batch size should be larger than the number of GPUs used.</p>

<div class="pdoc-alert pdoc-alert-warning">

<p>It is recommended to use <code>~torch.nn.parallel.DistributedDataParallel</code>,
instead of this class, to do multi-GPU training, even if there is only a single
node. See: :ref:<code>cuda-nn-ddp-instead</code> and :ref:<code>ddp</code>.</p>

</div>

<p>Arbitrary positional and keyword inputs are allowed to be passed into
DataParallel but some types are specially handled. tensors will be
<strong>scattered</strong> on dim specified (default 0). tuple, list and dict types will
be shallow copied. The other types will be shared among different threads
and can be corrupted if written to in the model's forward pass.</p>

<p>The parallelized <code>module</code> must have its parameters and buffers on
<code>device_ids[0]</code> before running this <code>~torch.nn.DataParallel</code>
module.</p>

<div class="pdoc-alert pdoc-alert-warning">

<p>In each forward, <code>module</code> is <strong>replicated</strong> on each device, so any
updates to the running module in <code><a href="#MyDataParallel.forward">forward</a></code> will be lost. For example,
if <code>module</code> has a counter attribute that is incremented in each
<code><a href="#MyDataParallel.forward">forward</a></code>, it will always stay at the initial value because the update
is done on the replicas which are destroyed after <code><a href="#MyDataParallel.forward">forward</a></code>. However,
<code>~torch.nn.DataParallel</code> guarantees that the replica on
<code>device[0]</code> will have its parameters and buffers sharing storage with
the base parallelized <code>module</code>. So <strong>in-place</strong> updates to the
parameters or buffers on <code>device[0]</code> will be recorded. E.g.,
<code>~torch.nn.BatchNorm2d</code> and <code>~torch.nn.utils.spectral_norm</code>
rely on this behavior to update the buffers.</p>

</div>

<div class="pdoc-alert pdoc-alert-warning">

<p>Forward and backward hooks defined on <code>module</code> and its submodules
will be invoked <code>len(device_ids)</code> times, each with inputs located on
a particular device. Particularly, the hooks are only guaranteed to be
executed in correct order with respect to operations on corresponding
devices. For example, it is not guaranteed that hooks set via
<code>~torch.nn.Module.register_forward_pre_hook</code> be executed before
<code>all</code> <code>len(device_ids)</code> <code>~torch.nn.Module.forward</code> calls, but
that each such hook be executed before the corresponding
<code>~torch.nn.Module.forward</code> call of that device.</p>

</div>

<div class="pdoc-alert pdoc-alert-warning">

<p>When <code>module</code> returns a scalar (i.e., 0-dimensional tensor) in
<code><a href="#MyDataParallel.forward">forward</a></code>, this wrapper will return a vector of length equal to
number of devices used in data parallelism, containing the result from
each device.</p>

</div>

<div class="pdoc-alert pdoc-alert-note">

<p>There is a subtlety in using the
<code>pack sequence -&gt; recurrent network -&gt; unpack sequence</code> pattern in a
<code>~torch.nn.Module</code> wrapped in <code>~torch.nn.DataParallel</code>.
See :ref:<code>pack-rnn-unpack-with-data-parallelism</code> section in FAQ for
details.</p>

</div>

<p>Args:
    module (Module): module to be parallelized
    device_ids (list of int or torch.device): CUDA devices (default: all devices)
    output_device (int or torch.device): device location of output (default: device_ids[0])</p>

<p>Attributes:
    module (Module): the module to be parallelized</p>

<p>Example::</p>

<pre><code>&gt;&gt;&gt; net = torch.nn.DataParallel(model, device_ids=[0, 1, 2])
&gt;&gt;&gt; output = net(input_var)  # input_var can be on any device, including CPU
</code></pre>
</div>


                            <div id="MyDataParallel.__init__" class="classattr">
                                        <input id="MyDataParallel.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">MyDataParallel</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="MyDataParallel.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MyDataParallel.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MyDataParallel.__init__-37"><a href="#MyDataParallel.__init__-37"><span class="linenos">37</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="MyDataParallel.__init__-38"><a href="#MyDataParallel.__init__-38"><span class="linenos">38</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="MyDataParallel.__init__-39"><a href="#MyDataParallel.__init__-39"><span class="linenos">39</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">process_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">process_labels</span>
</span></pre></div>


            <div class="docstring"><p>Initializes internal Module state, shared by both nn.Module and ScriptModule.</p>
</div>


                            </div>
                            <div id="MyDataParallel.freeze_feature_extractor" class="classattr">
                                        <input id="MyDataParallel.freeze_feature_extractor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">freeze_feature_extractor</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span>)</span>

                <label class="view-source-button" for="MyDataParallel.freeze_feature_extractor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MyDataParallel.freeze_feature_extractor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MyDataParallel.freeze_feature_extractor-41"><a href="#MyDataParallel.freeze_feature_extractor-41"><span class="linenos">41</span></a>    <span class="k">def</span> <span class="nf">freeze_feature_extractor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MyDataParallel.freeze_feature_extractor-42"><a href="#MyDataParallel.freeze_feature_extractor-42"><span class="linenos">42</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">freeze_feature_extractor</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="MyDataParallel.unfreeze_feature_extractor" class="classattr">
                                        <input id="MyDataParallel.unfreeze_feature_extractor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">unfreeze_feature_extractor</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span>)</span>

                <label class="view-source-button" for="MyDataParallel.unfreeze_feature_extractor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MyDataParallel.unfreeze_feature_extractor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MyDataParallel.unfreeze_feature_extractor-44"><a href="#MyDataParallel.unfreeze_feature_extractor-44"><span class="linenos">44</span></a>    <span class="k">def</span> <span class="nf">unfreeze_feature_extractor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MyDataParallel.unfreeze_feature_extractor-45"><a href="#MyDataParallel.unfreeze_feature_extractor-45"><span class="linenos">45</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">unfreeze_feature_extractor</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="MyDataParallel.transform_labels" class="classattr">
                                        <input id="MyDataParallel.transform_labels-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">transform_labels</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">device</span></span>)</span>

                <label class="view-source-button" for="MyDataParallel.transform_labels-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MyDataParallel.transform_labels"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MyDataParallel.transform_labels-47"><a href="#MyDataParallel.transform_labels-47"><span class="linenos">47</span></a>    <span class="k">def</span> <span class="nf">transform_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
</span><span id="MyDataParallel.transform_labels-48"><a href="#MyDataParallel.transform_labels-48"><span class="linenos">48</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">transform_labels</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="MyDataParallel.logit_scale" class="classattr">
                                        <input id="MyDataParallel.logit_scale-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">logit_scale</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span>)</span>

                <label class="view-source-button" for="MyDataParallel.logit_scale-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MyDataParallel.logit_scale"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MyDataParallel.logit_scale-50"><a href="#MyDataParallel.logit_scale-50"><span class="linenos">50</span></a>    <span class="k">def</span> <span class="nf">logit_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MyDataParallel.logit_scale-51"><a href="#MyDataParallel.logit_scale-51"><span class="linenos">51</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">logit_scale</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="MyDataParallel.main_task_off" class="classattr">
                                        <input id="MyDataParallel.main_task_off-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">main_task_off</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span>)</span>

                <label class="view-source-button" for="MyDataParallel.main_task_off-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MyDataParallel.main_task_off"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MyDataParallel.main_task_off-53"><a href="#MyDataParallel.main_task_off-53"><span class="linenos">53</span></a>    <span class="k">def</span> <span class="nf">main_task_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MyDataParallel.main_task_off-54"><a href="#MyDataParallel.main_task_off-54"><span class="linenos">54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">main_task_off</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="MyDataParallel.state_dict" class="classattr">
                                        <input id="MyDataParallel.state_dict-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">state_dict</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="MyDataParallel.state_dict-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MyDataParallel.state_dict"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MyDataParallel.state_dict-56"><a href="#MyDataParallel.state_dict-56"><span class="linenos">56</span></a>    <span class="k">def</span> <span class="nf">state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="MyDataParallel.state_dict-57"><a href="#MyDataParallel.state_dict-57"><span class="linenos">57</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Returns a dictionary containing a whole state of the module.</p>

<p>Both parameters and persistent buffers (e.g. running averages) are
included. Keys are corresponding parameter and buffer names.
Parameters and buffers set to <code>None</code> are not included.</p>

<div class="pdoc-alert pdoc-alert-warning">

<p>Currently <code><a href="#MyDataParallel.state_dict">state_dict()</a></code> also accepts positional arguments for
<code>destination</code>, <code>prefix</code> and <code>keep_vars</code> in order. However,
this is being deprecated and keyword arguments will be enforced in
future releases.</p>

</div>

<div class="pdoc-alert pdoc-alert-warning">

<p>Please avoid the use of argument <code>destination</code> as it is not
designed for end-users.</p>

</div>

<p>Args:
    destination (dict, optional): If provided, the state of module will
        be updated into the dict and the same object is returned.
        Otherwise, an <code>OrderedDict</code> will be created and returned.
        Default: <code>None</code>.
    prefix (str, optional): a prefix added to parameter and buffer
        names to compose the keys in state_dict. Default: <code>''</code>.
    keep_vars (bool, optional): by default the <code>~torch.Tensor</code> s
        returned in the state dict are detached from autograd. If it's
        set to <code>True</code>, detaching will not be performed.
        Default: <code>False</code>.</p>

<p>Returns:
    dict:
        a dictionary containing a whole state of the module</p>

<p>Example::</p>

<pre><code>&gt;&gt;&gt; module.state_dict().keys()
['bias', 'weight']
</code></pre>
</div>


                            </div>
                            <div id="MyDataParallel.ssl_on" class="classattr">
                                        <input id="MyDataParallel.ssl_on-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ssl_on</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span>)</span>

                <label class="view-source-button" for="MyDataParallel.ssl_on-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MyDataParallel.ssl_on"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MyDataParallel.ssl_on-59"><a href="#MyDataParallel.ssl_on-59"><span class="linenos">59</span></a>    <span class="k">def</span> <span class="nf">ssl_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MyDataParallel.ssl_on-60"><a href="#MyDataParallel.ssl_on-60"><span class="linenos">60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">ssl_on</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="MyDataParallel.ssl_off" class="classattr">
                                        <input id="MyDataParallel.ssl_off-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ssl_off</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span>)</span>

                <label class="view-source-button" for="MyDataParallel.ssl_off-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MyDataParallel.ssl_off"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MyDataParallel.ssl_off-62"><a href="#MyDataParallel.ssl_off-62"><span class="linenos">62</span></a>    <span class="k">def</span> <span class="nf">ssl_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MyDataParallel.ssl_off-63"><a href="#MyDataParallel.ssl_off-63"><span class="linenos">63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">ssl_off</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="MyDataParallel.extract_features" class="classattr">
                                        <input id="MyDataParallel.extract_features-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">extract_features</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x</span>, </span><span class="param"><span class="n">start</span><span class="o">=</span><span class="mi">0</span></span>)</span>

                <label class="view-source-button" for="MyDataParallel.extract_features-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MyDataParallel.extract_features"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MyDataParallel.extract_features-65"><a href="#MyDataParallel.extract_features-65"><span class="linenos">65</span></a>    <span class="k">def</span> <span class="nf">extract_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="MyDataParallel.extract_features-66"><a href="#MyDataParallel.extract_features-66"><span class="linenos">66</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>torch.nn.parallel.data_parallel.DataParallel</dt>
                                <dd id="MyDataParallel.forward" class="function">forward</dd>
                <dd id="MyDataParallel.replicate" class="function">replicate</dd>
                <dd id="MyDataParallel.scatter" class="function">scatter</dd>
                <dd id="MyDataParallel.parallel_apply" class="function">parallel_apply</dd>
                <dd id="MyDataParallel.gather" class="function">gather</dd>

            </div>
            <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="MyDataParallel.dump_patches" class="variable">dump_patches</dd>
                <dd id="MyDataParallel.register_buffer" class="function">register_buffer</dd>
                <dd id="MyDataParallel.register_parameter" class="function">register_parameter</dd>
                <dd id="MyDataParallel.add_module" class="function">add_module</dd>
                <dd id="MyDataParallel.register_module" class="function">register_module</dd>
                <dd id="MyDataParallel.get_submodule" class="function">get_submodule</dd>
                <dd id="MyDataParallel.get_parameter" class="function">get_parameter</dd>
                <dd id="MyDataParallel.get_buffer" class="function">get_buffer</dd>
                <dd id="MyDataParallel.get_extra_state" class="function">get_extra_state</dd>
                <dd id="MyDataParallel.set_extra_state" class="function">set_extra_state</dd>
                <dd id="MyDataParallel.apply" class="function">apply</dd>
                <dd id="MyDataParallel.cuda" class="function">cuda</dd>
                <dd id="MyDataParallel.ipu" class="function">ipu</dd>
                <dd id="MyDataParallel.xpu" class="function">xpu</dd>
                <dd id="MyDataParallel.cpu" class="function">cpu</dd>
                <dd id="MyDataParallel.type" class="function">type</dd>
                <dd id="MyDataParallel.float" class="function">float</dd>
                <dd id="MyDataParallel.double" class="function">double</dd>
                <dd id="MyDataParallel.half" class="function">half</dd>
                <dd id="MyDataParallel.bfloat16" class="function">bfloat16</dd>
                <dd id="MyDataParallel.to_empty" class="function">to_empty</dd>
                <dd id="MyDataParallel.to" class="function">to</dd>
                <dd id="MyDataParallel.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="MyDataParallel.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="MyDataParallel.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="MyDataParallel.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="MyDataParallel.T_destination" class="variable">T_destination</dd>
                <dd id="MyDataParallel.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="MyDataParallel.load_state_dict" class="function">load_state_dict</dd>
                <dd id="MyDataParallel.parameters" class="function">parameters</dd>
                <dd id="MyDataParallel.named_parameters" class="function">named_parameters</dd>
                <dd id="MyDataParallel.buffers" class="function">buffers</dd>
                <dd id="MyDataParallel.named_buffers" class="function">named_buffers</dd>
                <dd id="MyDataParallel.children" class="function">children</dd>
                <dd id="MyDataParallel.named_children" class="function">named_children</dd>
                <dd id="MyDataParallel.modules" class="function">modules</dd>
                <dd id="MyDataParallel.named_modules" class="function">named_modules</dd>
                <dd id="MyDataParallel.train" class="function">train</dd>
                <dd id="MyDataParallel.eval" class="function">eval</dd>
                <dd id="MyDataParallel.requires_grad_" class="function">requires_grad_</dd>
                <dd id="MyDataParallel.zero_grad" class="function">zero_grad</dd>
                <dd id="MyDataParallel.share_memory" class="function">share_memory</dd>
                <dd id="MyDataParallel.extra_repr" class="function">extra_repr</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Task">
                            <input id="Task-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Task</span>:

                <label class="view-source-button" for="Task-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task-69"><a href="#Task-69"><span class="linenos">  69</span></a><span class="k">class</span> <span class="nc">Task</span><span class="p">:</span>
</span><span id="Task-70"><a href="#Task-70"><span class="linenos">  70</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-71"><a href="#Task-71"><span class="linenos">  71</span></a><span class="sd">    A universal trainer class that performs training, evaluation and prediction for all types of tasks and data</span>
</span><span id="Task-72"><a href="#Task-72"><span class="linenos">  72</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Task-73"><a href="#Task-73"><span class="linenos">  73</span></a>
</span><span id="Task-74"><a href="#Task-74"><span class="linenos">  74</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="Task-75"><a href="#Task-75"><span class="linenos">  75</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Task-76"><a href="#Task-76"><span class="linenos">  76</span></a>        <span class="n">train_dataloader</span><span class="p">:</span> <span class="n">DataLoader</span><span class="p">,</span>
</span><span id="Task-77"><a href="#Task-77"><span class="linenos">  77</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Model</span><span class="p">],</span>
</span><span id="Task-78"><a href="#Task-78"><span class="linenos">  78</span></a>        <span class="n">loss</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="Task-79"><a href="#Task-79"><span class="linenos">  79</span></a>        <span class="n">num_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Task-80"><a href="#Task-80"><span class="linenos">  80</span></a>        <span class="n">transformer</span><span class="p">:</span> <span class="n">Transformer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-81"><a href="#Task-81"><span class="linenos">  81</span></a>        <span class="n">ssl_losses</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-82"><a href="#Task-82"><span class="linenos">  82</span></a>        <span class="n">ssl_weights</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-83"><a href="#Task-83"><span class="linenos">  83</span></a>        <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span>
</span><span id="Task-84"><a href="#Task-84"><span class="linenos">  84</span></a>        <span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-85"><a href="#Task-85"><span class="linenos">  85</span></a>        <span class="n">val_dataloader</span><span class="p">:</span> <span class="n">DataLoader</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-86"><a href="#Task-86"><span class="linenos">  86</span></a>        <span class="n">test_dataloader</span><span class="p">:</span> <span class="n">DataLoader</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-87"><a href="#Task-87"><span class="linenos">  87</span></a>        <span class="n">optimizer</span><span class="p">:</span> <span class="n">Optimizer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-88"><a href="#Task-88"><span class="linenos">  88</span></a>        <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span><span class="p">,</span>
</span><span id="Task-89"><a href="#Task-89"><span class="linenos">  89</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Task-90"><a href="#Task-90"><span class="linenos">  90</span></a>        <span class="n">log_file</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-91"><a href="#Task-91"><span class="linenos">  91</span></a>        <span class="n">augment_train</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="Task-92"><a href="#Task-92"><span class="linenos">  92</span></a>        <span class="n">augment_val</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Task-93"><a href="#Task-93"><span class="linenos">  93</span></a>        <span class="n">validation_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="Task-94"><a href="#Task-94"><span class="linenos">  94</span></a>        <span class="n">predict_function</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-95"><a href="#Task-95"><span class="linenos">  95</span></a>        <span class="n">primary_predict_function</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-96"><a href="#Task-96"><span class="linenos">  96</span></a>        <span class="n">exclusive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Task-97"><a href="#Task-97"><span class="linenos">  97</span></a>        <span class="n">ignore_tags</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Task-98"><a href="#Task-98"><span class="linenos">  98</span></a>        <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="Task-99"><a href="#Task-99"><span class="linenos">  99</span></a>        <span class="n">model_save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-100"><a href="#Task-100"><span class="linenos"> 100</span></a>        <span class="n">model_save_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="Task-101"><a href="#Task-101"><span class="linenos"> 101</span></a>        <span class="n">pseudolabel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task-102"><a href="#Task-102"><span class="linenos"> 102</span></a>        <span class="n">pseudolabel_start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
</span><span id="Task-103"><a href="#Task-103"><span class="linenos"> 103</span></a>        <span class="n">correction_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="Task-104"><a href="#Task-104"><span class="linenos"> 104</span></a>        <span class="n">pseudolabel_alpha_f</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="Task-105"><a href="#Task-105"><span class="linenos"> 105</span></a>        <span class="n">alpha_growth_stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">600</span><span class="p">,</span>
</span><span id="Task-106"><a href="#Task-106"><span class="linenos"> 106</span></a>        <span class="n">parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task-107"><a href="#Task-107"><span class="linenos"> 107</span></a>        <span class="n">skip_metrics</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-108"><a href="#Task-108"><span class="linenos"> 108</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-109"><a href="#Task-109"><span class="linenos"> 109</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-110"><a href="#Task-110"><span class="linenos"> 110</span></a><span class="sd">        Parameters</span>
</span><span id="Task-111"><a href="#Task-111"><span class="linenos"> 111</span></a><span class="sd">        ----------</span>
</span><span id="Task-112"><a href="#Task-112"><span class="linenos"> 112</span></a><span class="sd">        train_dataloader : torch.utils.data.DataLoader</span>
</span><span id="Task-113"><a href="#Task-113"><span class="linenos"> 113</span></a><span class="sd">            a training dataloader</span>
</span><span id="Task-114"><a href="#Task-114"><span class="linenos"> 114</span></a><span class="sd">        model : dlc2action.model.base_model.Model</span>
</span><span id="Task-115"><a href="#Task-115"><span class="linenos"> 115</span></a><span class="sd">            a model</span>
</span><span id="Task-116"><a href="#Task-116"><span class="linenos"> 116</span></a><span class="sd">        loss : callable</span>
</span><span id="Task-117"><a href="#Task-117"><span class="linenos"> 117</span></a><span class="sd">            a loss function</span>
</span><span id="Task-118"><a href="#Task-118"><span class="linenos"> 118</span></a><span class="sd">        num_epochs : int, default 0</span>
</span><span id="Task-119"><a href="#Task-119"><span class="linenos"> 119</span></a><span class="sd">            the number of epochs</span>
</span><span id="Task-120"><a href="#Task-120"><span class="linenos"> 120</span></a><span class="sd">        transformer : dlc2action.transformer.base_transformer.Transformer, optional</span>
</span><span id="Task-121"><a href="#Task-121"><span class="linenos"> 121</span></a><span class="sd">            a transformer</span>
</span><span id="Task-122"><a href="#Task-122"><span class="linenos"> 122</span></a><span class="sd">        ssl_losses : list, optional</span>
</span><span id="Task-123"><a href="#Task-123"><span class="linenos"> 123</span></a><span class="sd">            a list of SSL losses</span>
</span><span id="Task-124"><a href="#Task-124"><span class="linenos"> 124</span></a><span class="sd">        ssl_weights : list, optional</span>
</span><span id="Task-125"><a href="#Task-125"><span class="linenos"> 125</span></a><span class="sd">            a list of SSL weights (if not provided initializes to 1)</span>
</span><span id="Task-126"><a href="#Task-126"><span class="linenos"> 126</span></a><span class="sd">        lr : float, default 1e-3</span>
</span><span id="Task-127"><a href="#Task-127"><span class="linenos"> 127</span></a><span class="sd">            learning rate</span>
</span><span id="Task-128"><a href="#Task-128"><span class="linenos"> 128</span></a><span class="sd">        metrics : dict, optional</span>
</span><span id="Task-129"><a href="#Task-129"><span class="linenos"> 129</span></a><span class="sd">            a list of metric functions</span>
</span><span id="Task-130"><a href="#Task-130"><span class="linenos"> 130</span></a><span class="sd">        val_dataloader : torch.utils.data.DataLoader, optional</span>
</span><span id="Task-131"><a href="#Task-131"><span class="linenos"> 131</span></a><span class="sd">            a validation dataloader</span>
</span><span id="Task-132"><a href="#Task-132"><span class="linenos"> 132</span></a><span class="sd">        optimizer : torch.optim.Optimizer, optional</span>
</span><span id="Task-133"><a href="#Task-133"><span class="linenos"> 133</span></a><span class="sd">            an optimizer (`Adam` by default)</span>
</span><span id="Task-134"><a href="#Task-134"><span class="linenos"> 134</span></a><span class="sd">        device : str, default &#39;cuda&#39;</span>
</span><span id="Task-135"><a href="#Task-135"><span class="linenos"> 135</span></a><span class="sd">            the device to train the model on</span>
</span><span id="Task-136"><a href="#Task-136"><span class="linenos"> 136</span></a><span class="sd">        verbose : bool, default True</span>
</span><span id="Task-137"><a href="#Task-137"><span class="linenos"> 137</span></a><span class="sd">            if `True`, the process is described in standard output</span>
</span><span id="Task-138"><a href="#Task-138"><span class="linenos"> 138</span></a><span class="sd">        log_file : str, optional</span>
</span><span id="Task-139"><a href="#Task-139"><span class="linenos"> 139</span></a><span class="sd">            the path to a text file where the process will be logged</span>
</span><span id="Task-140"><a href="#Task-140"><span class="linenos"> 140</span></a><span class="sd">        augment_train : {1, 0}</span>
</span><span id="Task-141"><a href="#Task-141"><span class="linenos"> 141</span></a><span class="sd">            number of augmentations to apply at training</span>
</span><span id="Task-142"><a href="#Task-142"><span class="linenos"> 142</span></a><span class="sd">        augment_val : int, default 0</span>
</span><span id="Task-143"><a href="#Task-143"><span class="linenos"> 143</span></a><span class="sd">            number of augmentations to apply at validation</span>
</span><span id="Task-144"><a href="#Task-144"><span class="linenos"> 144</span></a><span class="sd">        validation_interval : int, default 1</span>
</span><span id="Task-145"><a href="#Task-145"><span class="linenos"> 145</span></a><span class="sd">            every time this number of epochs passes, validation metrics are computed</span>
</span><span id="Task-146"><a href="#Task-146"><span class="linenos"> 146</span></a><span class="sd">        predict_function : callable, optional</span>
</span><span id="Task-147"><a href="#Task-147"><span class="linenos"> 147</span></a><span class="sd">            a function that maps probabilities to class predictions (if not provided, a default is generated)</span>
</span><span id="Task-148"><a href="#Task-148"><span class="linenos"> 148</span></a><span class="sd">        primary_predict_function : callable, optional</span>
</span><span id="Task-149"><a href="#Task-149"><span class="linenos"> 149</span></a><span class="sd">            a function that maps model output to probabilities (if not provided, initialized as identity)</span>
</span><span id="Task-150"><a href="#Task-150"><span class="linenos"> 150</span></a><span class="sd">        exclusive : bool, default True</span>
</span><span id="Task-151"><a href="#Task-151"><span class="linenos"> 151</span></a><span class="sd">            set to False for multi-label classification</span>
</span><span id="Task-152"><a href="#Task-152"><span class="linenos"> 152</span></a><span class="sd">        ignore_tags : bool, default False</span>
</span><span id="Task-153"><a href="#Task-153"><span class="linenos"> 153</span></a><span class="sd">            if `True`, samples with different meta tags will be mixed in batches</span>
</span><span id="Task-154"><a href="#Task-154"><span class="linenos"> 154</span></a><span class="sd">        threshold : float, default 0.5</span>
</span><span id="Task-155"><a href="#Task-155"><span class="linenos"> 155</span></a><span class="sd">            the threshold used for multi-label classification default prediction function</span>
</span><span id="Task-156"><a href="#Task-156"><span class="linenos"> 156</span></a><span class="sd">        model_save_path : str, optional</span>
</span><span id="Task-157"><a href="#Task-157"><span class="linenos"> 157</span></a><span class="sd">            the path to the folder where model checkpoints will be saved (checkpoints will not be saved if the path</span>
</span><span id="Task-158"><a href="#Task-158"><span class="linenos"> 158</span></a><span class="sd">            is not provided)</span>
</span><span id="Task-159"><a href="#Task-159"><span class="linenos"> 159</span></a><span class="sd">        model_save_epochs : int, default 5</span>
</span><span id="Task-160"><a href="#Task-160"><span class="linenos"> 160</span></a><span class="sd">            the interval for saving the model checkpoints (the last epoch is always saved)</span>
</span><span id="Task-161"><a href="#Task-161"><span class="linenos"> 161</span></a><span class="sd">        pseudolabel : bool, default False</span>
</span><span id="Task-162"><a href="#Task-162"><span class="linenos"> 162</span></a><span class="sd">            if True, the pseudolabeling procedure will be applied</span>
</span><span id="Task-163"><a href="#Task-163"><span class="linenos"> 163</span></a><span class="sd">        pseudolabel_start : int, default 100</span>
</span><span id="Task-164"><a href="#Task-164"><span class="linenos"> 164</span></a><span class="sd">            pseudolabeling starts after this epoch</span>
</span><span id="Task-165"><a href="#Task-165"><span class="linenos"> 165</span></a><span class="sd">        correction_interval : int, default 1</span>
</span><span id="Task-166"><a href="#Task-166"><span class="linenos"> 166</span></a><span class="sd">            after this number of epochs, if the pseudolabeling is on, the model is trained on the labeled data and</span>
</span><span id="Task-167"><a href="#Task-167"><span class="linenos"> 167</span></a><span class="sd">            new pseudolabels are generated</span>
</span><span id="Task-168"><a href="#Task-168"><span class="linenos"> 168</span></a><span class="sd">        pseudolabel_alpha_f : float, default 3</span>
</span><span id="Task-169"><a href="#Task-169"><span class="linenos"> 169</span></a><span class="sd">            the maximum value of pseudolabeling alpha</span>
</span><span id="Task-170"><a href="#Task-170"><span class="linenos"> 170</span></a><span class="sd">        alpha_growth_stop : int, default 600</span>
</span><span id="Task-171"><a href="#Task-171"><span class="linenos"> 171</span></a><span class="sd">            pseudolabeling alpha stops growing after this epoch</span>
</span><span id="Task-172"><a href="#Task-172"><span class="linenos"> 172</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-173"><a href="#Task-173"><span class="linenos"> 173</span></a>
</span><span id="Task-174"><a href="#Task-174"><span class="linenos"> 174</span></a>        <span class="c1"># pseudolabeling might be buggy right now -- not using it!</span>
</span><span id="Task-175"><a href="#Task-175"><span class="linenos"> 175</span></a>        <span class="k">if</span> <span class="n">skip_metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-176"><a href="#Task-176"><span class="linenos"> 176</span></a>            <span class="n">skip_metrics</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Task-177"><a href="#Task-177"><span class="linenos"> 177</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">train_dataloader</span>
</span><span id="Task-178"><a href="#Task-178"><span class="linenos"> 178</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span> <span class="o">=</span> <span class="n">val_dataloader</span>
</span><span id="Task-179"><a href="#Task-179"><span class="linenos"> 179</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_dataloader</span> <span class="o">=</span> <span class="n">test_dataloader</span>
</span><span id="Task-180"><a href="#Task-180"><span class="linenos"> 180</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="o">=</span> <span class="n">transformer</span>
</span><span id="Task-181"><a href="#Task-181"><span class="linenos"> 181</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_epochs</span> <span class="o">=</span> <span class="n">num_epochs</span>
</span><span id="Task-182"><a href="#Task-182"><span class="linenos"> 182</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">skip_metrics</span> <span class="o">=</span> <span class="n">skip_metrics</span>
</span><span id="Task-183"><a href="#Task-183"><span class="linenos"> 183</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
</span><span id="Task-184"><a href="#Task-184"><span class="linenos"> 184</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">augment_train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">augment_train</span><span class="p">)</span>
</span><span id="Task-185"><a href="#Task-185"><span class="linenos"> 185</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">augment_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">augment_val</span><span class="p">)</span>
</span><span id="Task-186"><a href="#Task-186"><span class="linenos"> 186</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_tags</span> <span class="o">=</span> <span class="n">ignore_tags</span>
</span><span id="Task-187"><a href="#Task-187"><span class="linenos"> 187</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validation_interval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">validation_interval</span><span class="p">)</span>
</span><span id="Task-188"><a href="#Task-188"><span class="linenos"> 188</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="n">log_file</span>
</span><span id="Task-189"><a href="#Task-189"><span class="linenos"> 189</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span>
</span><span id="Task-190"><a href="#Task-190"><span class="linenos"> 190</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span> <span class="o">=</span> <span class="n">model_save_path</span>
</span><span id="Task-191"><a href="#Task-191"><span class="linenos"> 191</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_save_epochs</span> <span class="o">=</span> <span class="n">model_save_epochs</span>
</span><span id="Task-192"><a href="#Task-192"><span class="linenos"> 192</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Task-193"><a href="#Task-193"><span class="linenos"> 193</span></a>
</span><span id="Task-194"><a href="#Task-194"><span class="linenos"> 194</span></a>        <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-195"><a href="#Task-195"><span class="linenos"> 195</span></a>            <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Task-196"><a href="#Task-196"><span class="linenos"> 196</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics</span>
</span><span id="Task-197"><a href="#Task-197"><span class="linenos"> 197</span></a>
</span><span id="Task-198"><a href="#Task-198"><span class="linenos"> 198</span></a>        <span class="k">if</span> <span class="n">optimizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-199"><a href="#Task-199"><span class="linenos"> 199</span></a>            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span>
</span><span id="Task-200"><a href="#Task-200"><span class="linenos"> 200</span></a>
</span><span id="Task-201"><a href="#Task-201"><span class="linenos"> 201</span></a>        <span class="k">if</span> <span class="n">ssl_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-202"><a href="#Task-202"><span class="linenos"> 202</span></a>            <span class="n">ssl_weights</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ssl_losses</span><span class="p">]</span>
</span><span id="Task-203"><a href="#Task-203"><span class="linenos"> 203</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ssl_weights</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
</span><span id="Task-204"><a href="#Task-204"><span class="linenos"> 204</span></a>            <span class="n">ssl_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">ssl_weights</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ssl_losses</span><span class="p">]</span>
</span><span id="Task-205"><a href="#Task-205"><span class="linenos"> 205</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ssl_weights</span> <span class="o">=</span> <span class="n">ssl_weights</span>
</span><span id="Task-206"><a href="#Task-206"><span class="linenos"> 206</span></a>
</span><span id="Task-207"><a href="#Task-207"><span class="linenos"> 207</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_class</span> <span class="o">=</span> <span class="n">optimizer</span>
</span><span id="Task-208"><a href="#Task-208"><span class="linenos"> 208</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span>
</span><span id="Task-209"><a href="#Task-209"><span class="linenos"> 209</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
</span><span id="Task-210"><a href="#Task-210"><span class="linenos"> 210</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">LoadedModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
</span><span id="Task-211"><a href="#Task-211"><span class="linenos"> 211</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-212"><a href="#Task-212"><span class="linenos"> 212</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">set_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="Task-213"><a href="#Task-213"><span class="linenos"> 213</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="n">parallel</span>
</span><span id="Task-214"><a href="#Task-214"><span class="linenos"> 214</span></a>
</span><span id="Task-215"><a href="#Task-215"><span class="linenos"> 215</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-216"><a href="#Task-216"><span class="linenos"> 216</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">augment_val</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Task-217"><a href="#Task-217"><span class="linenos"> 217</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">augment_train</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Task-218"><a href="#Task-218"><span class="linenos"> 218</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="o">=</span> <span class="n">EmptyTransformer</span><span class="p">()</span>
</span><span id="Task-219"><a href="#Task-219"><span class="linenos"> 219</span></a>
</span><span id="Task-220"><a href="#Task-220"><span class="linenos"> 220</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">augment_train</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Task-221"><a href="#Task-221"><span class="linenos"> 221</span></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="Task-222"><a href="#Task-222"><span class="linenos"> 222</span></a>                <span class="s1">&#39;The &quot;augment_train&quot; parameter is too large -&gt; setting it to 1.&#39;</span>
</span><span id="Task-223"><a href="#Task-223"><span class="linenos"> 223</span></a>            <span class="p">)</span>
</span><span id="Task-224"><a href="#Task-224"><span class="linenos"> 224</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">augment_train</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Task-225"><a href="#Task-225"><span class="linenos"> 225</span></a>
</span><span id="Task-226"><a href="#Task-226"><span class="linenos"> 226</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Task-227"><a href="#Task-227"><span class="linenos"> 227</span></a>            <span class="k">if</span> <span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
</span><span id="Task-228"><a href="#Task-228"><span class="linenos"> 228</span></a>                <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
</span><span id="Task-229"><a href="#Task-229"><span class="linenos"> 229</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Task-230"><a href="#Task-230"><span class="linenos"> 230</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="Task-231"><a href="#Task-231"><span class="linenos"> 231</span></a>            <span class="k">raise</span> <span class="p">(</span><span class="s2">&quot;The format of the device is incorrect&quot;</span><span class="p">)</span>
</span><span id="Task-232"><a href="#Task-232"><span class="linenos"> 232</span></a>
</span><span id="Task-233"><a href="#Task-233"><span class="linenos"> 233</span></a>        <span class="k">if</span> <span class="n">ssl_losses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-234"><a href="#Task-234"><span class="linenos"> 234</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ssl_losses</span> <span class="o">=</span> <span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Task-235"><a href="#Task-235"><span class="linenos"> 235</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-236"><a href="#Task-236"><span class="linenos"> 236</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ssl_losses</span> <span class="o">=</span> <span class="n">ssl_losses</span>
</span><span id="Task-237"><a href="#Task-237"><span class="linenos"> 237</span></a>
</span><span id="Task-238"><a href="#Task-238"><span class="linenos"> 238</span></a>        <span class="k">if</span> <span class="n">primary_predict_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-239"><a href="#Task-239"><span class="linenos"> 239</span></a>            <span class="k">if</span> <span class="n">exclusive</span><span class="p">:</span>
</span><span id="Task-240"><a href="#Task-240"><span class="linenos"> 240</span></a>                <span class="n">primary_predict_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Softmax</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Task-241"><a href="#Task-241"><span class="linenos"> 241</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Task-242"><a href="#Task-242"><span class="linenos"> 242</span></a>                <span class="n">primary_predict_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="Task-243"><a href="#Task-243"><span class="linenos"> 243</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">primary_predict_function</span> <span class="o">=</span> <span class="n">primary_predict_function</span>
</span><span id="Task-244"><a href="#Task-244"><span class="linenos"> 244</span></a>
</span><span id="Task-245"><a href="#Task-245"><span class="linenos"> 245</span></a>        <span class="k">if</span> <span class="n">predict_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-246"><a href="#Task-246"><span class="linenos"> 246</span></a>            <span class="k">if</span> <span class="n">exclusive</span><span class="p">:</span>
</span><span id="Task-247"><a href="#Task-247"><span class="linenos"> 247</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">predict_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Task-248"><a href="#Task-248"><span class="linenos"> 248</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Task-249"><a href="#Task-249"><span class="linenos"> 249</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">predict_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">int</span><span class="p">()</span>
</span><span id="Task-250"><a href="#Task-250"><span class="linenos"> 250</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-251"><a href="#Task-251"><span class="linenos"> 251</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">predict_function</span> <span class="o">=</span> <span class="n">predict_function</span>
</span><span id="Task-252"><a href="#Task-252"><span class="linenos"> 252</span></a>
</span><span id="Task-253"><a href="#Task-253"><span class="linenos"> 253</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pseudolabel</span> <span class="o">=</span> <span class="n">pseudolabel</span>
</span><span id="Task-254"><a href="#Task-254"><span class="linenos"> 254</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_f</span> <span class="o">=</span> <span class="n">pseudolabel_alpha_f</span>
</span><span id="Task-255"><a href="#Task-255"><span class="linenos"> 255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">T2</span> <span class="o">=</span> <span class="n">alpha_growth_stop</span>
</span><span id="Task-256"><a href="#Task-256"><span class="linenos"> 256</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">T1</span> <span class="o">=</span> <span class="n">pseudolabel_start</span>
</span><span id="Task-257"><a href="#Task-257"><span class="linenos"> 257</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">correction_interval</span>
</span><span id="Task-258"><a href="#Task-258"><span class="linenos"> 258</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">T2</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T1</span><span class="p">:</span>
</span><span id="Task-259"><a href="#Task-259"><span class="linenos"> 259</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Task-260"><a href="#Task-260"><span class="linenos"> 260</span></a>                <span class="sa">f</span><span class="s2">&quot;The pseudolabel_start parameter has to be smaller than alpha_growth_stop; got &quot;</span>
</span><span id="Task-261"><a href="#Task-261"><span class="linenos"> 261</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pseudolabel_start</span><span class="si">=}</span><span class="s2"> and </span><span class="si">{</span><span class="n">alpha_growth_stop</span><span class="si">=}</span><span class="s2">&quot;</span>
</span><span id="Task-262"><a href="#Task-262"><span class="linenos"> 262</span></a>            <span class="p">)</span>
</span><span id="Task-263"><a href="#Task-263"><span class="linenos"> 263</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decision_thresholds</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()]</span>
</span><span id="Task-264"><a href="#Task-264"><span class="linenos"> 264</span></a>
</span><span id="Task-265"><a href="#Task-265"><span class="linenos"> 265</span></a>    <span class="k">def</span> <span class="nf">save_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-266"><a href="#Task-266"><span class="linenos"> 266</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-267"><a href="#Task-267"><span class="linenos"> 267</span></a><span class="sd">        Save a general checkpoint</span>
</span><span id="Task-268"><a href="#Task-268"><span class="linenos"> 268</span></a>
</span><span id="Task-269"><a href="#Task-269"><span class="linenos"> 269</span></a><span class="sd">        Parameters</span>
</span><span id="Task-270"><a href="#Task-270"><span class="linenos"> 270</span></a><span class="sd">        ----------</span>
</span><span id="Task-271"><a href="#Task-271"><span class="linenos"> 271</span></a><span class="sd">        checkpoint_path : str</span>
</span><span id="Task-272"><a href="#Task-272"><span class="linenos"> 272</span></a><span class="sd">            the path where the checkpoint will be saved</span>
</span><span id="Task-273"><a href="#Task-273"><span class="linenos"> 273</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-274"><a href="#Task-274"><span class="linenos"> 274</span></a>
</span><span id="Task-275"><a href="#Task-275"><span class="linenos"> 275</span></a>        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
</span><span id="Task-276"><a href="#Task-276"><span class="linenos"> 276</span></a>            <span class="p">{</span>
</span><span id="Task-277"><a href="#Task-277"><span class="linenos"> 277</span></a>                <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span>
</span><span id="Task-278"><a href="#Task-278"><span class="linenos"> 278</span></a>                <span class="s2">&quot;model_state_dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
</span><span id="Task-279"><a href="#Task-279"><span class="linenos"> 279</span></a>                <span class="s2">&quot;optimizer_state_dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
</span><span id="Task-280"><a href="#Task-280"><span class="linenos"> 280</span></a>            <span class="p">},</span>
</span><span id="Task-281"><a href="#Task-281"><span class="linenos"> 281</span></a>            <span class="n">checkpoint_path</span><span class="p">,</span>
</span><span id="Task-282"><a href="#Task-282"><span class="linenos"> 282</span></a>        <span class="p">)</span>
</span><span id="Task-283"><a href="#Task-283"><span class="linenos"> 283</span></a>
</span><span id="Task-284"><a href="#Task-284"><span class="linenos"> 284</span></a>    <span class="k">def</span> <span class="nf">load_from_checkpoint</span><span class="p">(</span>
</span><span id="Task-285"><a href="#Task-285"><span class="linenos"> 285</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">only_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">load_strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Task-286"><a href="#Task-286"><span class="linenos"> 286</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-287"><a href="#Task-287"><span class="linenos"> 287</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-288"><a href="#Task-288"><span class="linenos"> 288</span></a><span class="sd">        Load from a checkpoint</span>
</span><span id="Task-289"><a href="#Task-289"><span class="linenos"> 289</span></a>
</span><span id="Task-290"><a href="#Task-290"><span class="linenos"> 290</span></a><span class="sd">        Parameters</span>
</span><span id="Task-291"><a href="#Task-291"><span class="linenos"> 291</span></a><span class="sd">        ----------</span>
</span><span id="Task-292"><a href="#Task-292"><span class="linenos"> 292</span></a><span class="sd">        checkpoint_path : str</span>
</span><span id="Task-293"><a href="#Task-293"><span class="linenos"> 293</span></a><span class="sd">            the path to the checkpoint</span>
</span><span id="Task-294"><a href="#Task-294"><span class="linenos"> 294</span></a><span class="sd">        only_model : bool, default False</span>
</span><span id="Task-295"><a href="#Task-295"><span class="linenos"> 295</span></a><span class="sd">            if `True`, only the model state dictionary will be loaded (and not the epoch and the optimizer state</span>
</span><span id="Task-296"><a href="#Task-296"><span class="linenos"> 296</span></a><span class="sd">            dictionary)</span>
</span><span id="Task-297"><a href="#Task-297"><span class="linenos"> 297</span></a><span class="sd">        load_strict : bool, default True</span>
</span><span id="Task-298"><a href="#Task-298"><span class="linenos"> 298</span></a><span class="sd">            if `True`, any inconsistencies in state dictionaries are regarded as errors</span>
</span><span id="Task-299"><a href="#Task-299"><span class="linenos"> 299</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-300"><a href="#Task-300"><span class="linenos"> 300</span></a>
</span><span id="Task-301"><a href="#Task-301"><span class="linenos"> 301</span></a>        <span class="k">if</span> <span class="n">checkpoint_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-302"><a href="#Task-302"><span class="linenos"> 302</span></a>            <span class="k">return</span>
</span><span id="Task-303"><a href="#Task-303"><span class="linenos"> 303</span></a>        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Task-304"><a href="#Task-304"><span class="linenos"> 304</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Task-305"><a href="#Task-305"><span class="linenos"> 305</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;model_state_dict&quot;</span><span class="p">],</span> <span class="n">strict</span><span class="o">=</span><span class="n">load_strict</span><span class="p">)</span>
</span><span id="Task-306"><a href="#Task-306"><span class="linenos"> 306</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">only_model</span><span class="p">:</span>
</span><span id="Task-307"><a href="#Task-307"><span class="linenos"> 307</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;optimizer_state_dict&quot;</span><span class="p">])</span>
</span><span id="Task-308"><a href="#Task-308"><span class="linenos"> 308</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span>
</span><span id="Task-309"><a href="#Task-309"><span class="linenos"> 309</span></a>
</span><span id="Task-310"><a href="#Task-310"><span class="linenos"> 310</span></a>    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-311"><a href="#Task-311"><span class="linenos"> 311</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-312"><a href="#Task-312"><span class="linenos"> 312</span></a><span class="sd">        Save the model state dictionary</span>
</span><span id="Task-313"><a href="#Task-313"><span class="linenos"> 313</span></a>
</span><span id="Task-314"><a href="#Task-314"><span class="linenos"> 314</span></a><span class="sd">        Parameters</span>
</span><span id="Task-315"><a href="#Task-315"><span class="linenos"> 315</span></a><span class="sd">        ----------</span>
</span><span id="Task-316"><a href="#Task-316"><span class="linenos"> 316</span></a><span class="sd">        save_path : str</span>
</span><span id="Task-317"><a href="#Task-317"><span class="linenos"> 317</span></a><span class="sd">            the path where the state will be saved</span>
</span><span id="Task-318"><a href="#Task-318"><span class="linenos"> 318</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-319"><a href="#Task-319"><span class="linenos"> 319</span></a>
</span><span id="Task-320"><a href="#Task-320"><span class="linenos"> 320</span></a>        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">save_path</span><span class="p">)</span>
</span><span id="Task-321"><a href="#Task-321"><span class="linenos"> 321</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;saved the model successfully&quot;</span><span class="p">)</span>
</span><span id="Task-322"><a href="#Task-322"><span class="linenos"> 322</span></a>
</span><span id="Task-323"><a href="#Task-323"><span class="linenos"> 323</span></a>    <span class="k">def</span> <span class="nf">_apply_predict_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predicted</span><span class="p">):</span>
</span><span id="Task-324"><a href="#Task-324"><span class="linenos"> 324</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-325"><a href="#Task-325"><span class="linenos"> 325</span></a><span class="sd">        Map from model output to prediction</span>
</span><span id="Task-326"><a href="#Task-326"><span class="linenos"> 326</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-327"><a href="#Task-327"><span class="linenos"> 327</span></a>
</span><span id="Task-328"><a href="#Task-328"><span class="linenos"> 328</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_predict_function</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="Task-329"><a href="#Task-329"><span class="linenos"> 329</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_function</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="Task-330"><a href="#Task-330"><span class="linenos"> 330</span></a>        <span class="k">return</span> <span class="n">predicted</span>
</span><span id="Task-331"><a href="#Task-331"><span class="linenos"> 331</span></a>
</span><span id="Task-332"><a href="#Task-332"><span class="linenos"> 332</span></a>    <span class="k">def</span> <span class="nf">_get_prediction</span><span class="p">(</span>
</span><span id="Task-333"><a href="#Task-333"><span class="linenos"> 333</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Task-334"><a href="#Task-334"><span class="linenos"> 334</span></a>        <span class="n">main_input</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
</span><span id="Task-335"><a href="#Task-335"><span class="linenos"> 335</span></a>        <span class="n">tags</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
</span><span id="Task-336"><a href="#Task-336"><span class="linenos"> 336</span></a>        <span class="n">ssl_inputs</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-337"><a href="#Task-337"><span class="linenos"> 337</span></a>        <span class="n">ssl_targets</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-338"><a href="#Task-338"><span class="linenos"> 338</span></a>        <span class="n">augment_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Task-339"><a href="#Task-339"><span class="linenos"> 339</span></a>        <span class="n">embedding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task-340"><a href="#Task-340"><span class="linenos"> 340</span></a>        <span class="n">subsample</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-341"><a href="#Task-341"><span class="linenos"> 341</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
</span><span id="Task-342"><a href="#Task-342"><span class="linenos"> 342</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-343"><a href="#Task-343"><span class="linenos"> 343</span></a><span class="sd">        Get the prediction of `self.model` for input averaged over `augment_n` augmentations</span>
</span><span id="Task-344"><a href="#Task-344"><span class="linenos"> 344</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-345"><a href="#Task-345"><span class="linenos"> 345</span></a>
</span><span id="Task-346"><a href="#Task-346"><span class="linenos"> 346</span></a>        <span class="k">if</span> <span class="n">augment_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Task-347"><a href="#Task-347"><span class="linenos"> 347</span></a>            <span class="n">augment_n</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Task-348"><a href="#Task-348"><span class="linenos"> 348</span></a>            <span class="n">augment</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Task-349"><a href="#Task-349"><span class="linenos"> 349</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-350"><a href="#Task-350"><span class="linenos"> 350</span></a>            <span class="n">augment</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Task-351"><a href="#Task-351"><span class="linenos"> 351</span></a>        <span class="n">model_input</span><span class="p">,</span> <span class="n">ssl_inputs</span><span class="p">,</span> <span class="n">ssl_targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
</span><span id="Task-352"><a href="#Task-352"><span class="linenos"> 352</span></a>            <span class="n">deepcopy</span><span class="p">(</span><span class="n">main_input</span><span class="p">),</span>
</span><span id="Task-353"><a href="#Task-353"><span class="linenos"> 353</span></a>            <span class="n">ssl_inputs</span><span class="o">=</span><span class="n">ssl_inputs</span><span class="p">,</span>
</span><span id="Task-354"><a href="#Task-354"><span class="linenos"> 354</span></a>            <span class="n">ssl_targets</span><span class="o">=</span><span class="n">ssl_targets</span><span class="p">,</span>
</span><span id="Task-355"><a href="#Task-355"><span class="linenos"> 355</span></a>            <span class="n">augment</span><span class="o">=</span><span class="n">augment</span><span class="p">,</span>
</span><span id="Task-356"><a href="#Task-356"><span class="linenos"> 356</span></a>            <span class="n">subsample</span><span class="o">=</span><span class="n">subsample</span><span class="p">,</span>
</span><span id="Task-357"><a href="#Task-357"><span class="linenos"> 357</span></a>        <span class="p">)</span>
</span><span id="Task-358"><a href="#Task-358"><span class="linenos"> 358</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">embedding</span><span class="p">:</span>
</span><span id="Task-359"><a href="#Task-359"><span class="linenos"> 359</span></a>            <span class="n">predicted</span><span class="p">,</span> <span class="n">ssl_predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">model_input</span><span class="p">,</span> <span class="n">ssl_inputs</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
</span><span id="Task-360"><a href="#Task-360"><span class="linenos"> 360</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-361"><a href="#Task-361"><span class="linenos"> 361</span></a>            <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="n">model_input</span><span class="p">)</span>
</span><span id="Task-362"><a href="#Task-362"><span class="linenos"> 362</span></a>            <span class="n">ssl_predicted</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Task-363"><a href="#Task-363"><span class="linenos"> 363</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="ow">and</span> <span class="n">predicted</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">predicted</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="Task-364"><a href="#Task-364"><span class="linenos"> 364</span></a>            <span class="n">predicted</span> <span class="o">=</span> <span class="n">predicted</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
</span><span id="Task-365"><a href="#Task-365"><span class="linenos"> 365</span></a>                <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">model_input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="n">predicted</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
</span><span id="Task-366"><a href="#Task-366"><span class="linenos"> 366</span></a>            <span class="p">)</span>
</span><span id="Task-367"><a href="#Task-367"><span class="linenos"> 367</span></a>        <span class="k">if</span> <span class="n">predicted</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">augment_n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Task-368"><a href="#Task-368"><span class="linenos"> 368</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ssl_off</span><span class="p">()</span>
</span><span id="Task-369"><a href="#Task-369"><span class="linenos"> 369</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">augment_n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="Task-370"><a href="#Task-370"><span class="linenos"> 370</span></a>                <span class="n">model_input</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
</span><span id="Task-371"><a href="#Task-371"><span class="linenos"> 371</span></a>                    <span class="n">deepcopy</span><span class="p">(</span><span class="n">main_input</span><span class="p">),</span> <span class="n">augment</span><span class="o">=</span><span class="n">augment</span>
</span><span id="Task-372"><a href="#Task-372"><span class="linenos"> 372</span></a>                <span class="p">)</span>
</span><span id="Task-373"><a href="#Task-373"><span class="linenos"> 373</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">embedding</span><span class="p">:</span>
</span><span id="Task-374"><a href="#Task-374"><span class="linenos"> 374</span></a>                    <span class="n">pred</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">model_input</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
</span><span id="Task-375"><a href="#Task-375"><span class="linenos"> 375</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Task-376"><a href="#Task-376"><span class="linenos"> 376</span></a>                    <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="n">model_input</span><span class="p">)</span>
</span><span id="Task-377"><a href="#Task-377"><span class="linenos"> 377</span></a>                <span class="n">predicted</span> <span class="o">+=</span> <span class="n">pred</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="Task-378"><a href="#Task-378"><span class="linenos"> 378</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ssl_on</span><span class="p">()</span>
</span><span id="Task-379"><a href="#Task-379"><span class="linenos"> 379</span></a>            <span class="n">predicted</span> <span class="o">/=</span> <span class="n">augment_n</span>
</span><span id="Task-380"><a href="#Task-380"><span class="linenos"> 380</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">process_labels</span><span class="p">:</span>
</span><span id="Task-381"><a href="#Task-381"><span class="linenos"> 381</span></a>            <span class="n">class_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">transform_labels</span><span class="p">(</span><span class="n">predicted</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Task-382"><a href="#Task-382"><span class="linenos"> 382</span></a>            <span class="n">beh_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span>
</span><span id="Task-383"><a href="#Task-383"><span class="linenos"> 383</span></a>            <span class="n">class_embedding</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="Task-384"><a href="#Task-384"><span class="linenos"> 384</span></a>                <span class="p">[</span><span class="n">class_embedding</span><span class="p">[</span><span class="n">beh_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">beh_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())],</span> <span class="mi">0</span>
</span><span id="Task-385"><a href="#Task-385"><span class="linenos"> 385</span></a>            <span class="p">)</span>
</span><span id="Task-386"><a href="#Task-386"><span class="linenos"> 386</span></a>            <span class="n">predicted</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Task-387"><a href="#Task-387"><span class="linenos"> 387</span></a>                <span class="s2">&quot;video&quot;</span><span class="p">:</span> <span class="n">predicted</span><span class="p">,</span>
</span><span id="Task-388"><a href="#Task-388"><span class="linenos"> 388</span></a>                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">class_embedding</span><span class="p">,</span>
</span><span id="Task-389"><a href="#Task-389"><span class="linenos"> 389</span></a>                <span class="s2">&quot;logit_scale&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">logit_scale</span><span class="p">(),</span>
</span><span id="Task-390"><a href="#Task-390"><span class="linenos"> 390</span></a>                <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="n">predicted</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="Task-391"><a href="#Task-391"><span class="linenos"> 391</span></a>            <span class="p">}</span>
</span><span id="Task-392"><a href="#Task-392"><span class="linenos"> 392</span></a>        <span class="k">return</span> <span class="n">predicted</span><span class="p">,</span> <span class="n">ssl_predicted</span><span class="p">,</span> <span class="n">ssl_targets</span>
</span><span id="Task-393"><a href="#Task-393"><span class="linenos"> 393</span></a>
</span><span id="Task-394"><a href="#Task-394"><span class="linenos"> 394</span></a>    <span class="k">def</span> <span class="nf">_ssl_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ssl_predicted</span><span class="p">,</span> <span class="n">ssl_targets</span><span class="p">):</span>
</span><span id="Task-395"><a href="#Task-395"><span class="linenos"> 395</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-396"><a href="#Task-396"><span class="linenos"> 396</span></a><span class="sd">        Apply SSL losses</span>
</span><span id="Task-397"><a href="#Task-397"><span class="linenos"> 397</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-398"><a href="#Task-398"><span class="linenos"> 398</span></a>
</span><span id="Task-399"><a href="#Task-399"><span class="linenos"> 399</span></a>        <span class="n">ssl_loss</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Task-400"><a href="#Task-400"><span class="linenos"> 400</span></a>        <span class="k">for</span> <span class="n">loss</span><span class="p">,</span> <span class="n">predicted</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssl_losses</span><span class="p">,</span> <span class="n">ssl_predicted</span><span class="p">,</span> <span class="n">ssl_targets</span><span class="p">):</span>
</span><span id="Task-401"><a href="#Task-401"><span class="linenos"> 401</span></a>            <span class="n">ssl_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">(</span><span class="n">predicted</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
</span><span id="Task-402"><a href="#Task-402"><span class="linenos"> 402</span></a>        <span class="k">return</span> <span class="n">ssl_loss</span>
</span><span id="Task-403"><a href="#Task-403"><span class="linenos"> 403</span></a>
</span><span id="Task-404"><a href="#Task-404"><span class="linenos"> 404</span></a>    <span class="k">def</span> <span class="nf">_loss_function</span><span class="p">(</span>
</span><span id="Task-405"><a href="#Task-405"><span class="linenos"> 405</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Task-406"><a href="#Task-406"><span class="linenos"> 406</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
</span><span id="Task-407"><a href="#Task-407"><span class="linenos"> 407</span></a>        <span class="n">augment_n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="Task-408"><a href="#Task-408"><span class="linenos"> 408</span></a>        <span class="n">temporal_subsampling_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-409"><a href="#Task-409"><span class="linenos"> 409</span></a>        <span class="n">skip_metrics</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-410"><a href="#Task-410"><span class="linenos"> 410</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="Task-411"><a href="#Task-411"><span class="linenos"> 411</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-412"><a href="#Task-412"><span class="linenos"> 412</span></a><span class="sd">        Calculate the loss function and the metric for a dataloader batch</span>
</span><span id="Task-413"><a href="#Task-413"><span class="linenos"> 413</span></a>
</span><span id="Task-414"><a href="#Task-414"><span class="linenos"> 414</span></a><span class="sd">        Averaging the predictions over augment_n augmentations.</span>
</span><span id="Task-415"><a href="#Task-415"><span class="linenos"> 415</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-416"><a href="#Task-416"><span class="linenos"> 416</span></a>
</span><span id="Task-417"><a href="#Task-417"><span class="linenos"> 417</span></a>        <span class="k">if</span> <span class="s2">&quot;target&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">batch</span> <span class="ow">or</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
</span><span id="Task-418"><a href="#Task-418"><span class="linenos"> 418</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot compute loss function with nan targets!&quot;</span><span class="p">)</span>
</span><span id="Task-419"><a href="#Task-419"><span class="linenos"> 419</span></a>        <span class="n">main_input</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Task-420"><a href="#Task-420"><span class="linenos"> 420</span></a>        <span class="n">main_target</span><span class="p">,</span> <span class="n">ssl_targets</span><span class="p">,</span> <span class="n">ssl_inputs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="Task-421"><a href="#Task-421"><span class="linenos"> 421</span></a>        <span class="n">main_target</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Task-422"><a href="#Task-422"><span class="linenos"> 422</span></a>        <span class="k">if</span> <span class="s2">&quot;ssl_targets&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
</span><span id="Task-423"><a href="#Task-423"><span class="linenos"> 423</span></a>            <span class="n">ssl_targets</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task-424"><a href="#Task-424"><span class="linenos"> 424</span></a>                <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Task-425"><a href="#Task-425"><span class="linenos"> 425</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
</span><span id="Task-426"><a href="#Task-426"><span class="linenos"> 426</span></a>                <span class="k">else</span> <span class="kc">None</span>
</span><span id="Task-427"><a href="#Task-427"><span class="linenos"> 427</span></a>                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;ssl_targets&quot;</span><span class="p">]</span>
</span><span id="Task-428"><a href="#Task-428"><span class="linenos"> 428</span></a>            <span class="p">]</span>
</span><span id="Task-429"><a href="#Task-429"><span class="linenos"> 429</span></a>        <span class="k">if</span> <span class="s2">&quot;ssl_inputs&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
</span><span id="Task-430"><a href="#Task-430"><span class="linenos"> 430</span></a>            <span class="n">ssl_inputs</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task-431"><a href="#Task-431"><span class="linenos"> 431</span></a>                <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Task-432"><a href="#Task-432"><span class="linenos"> 432</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
</span><span id="Task-433"><a href="#Task-433"><span class="linenos"> 433</span></a>                <span class="k">else</span> <span class="kc">None</span>
</span><span id="Task-434"><a href="#Task-434"><span class="linenos"> 434</span></a>                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;ssl_inputs&quot;</span><span class="p">]</span>
</span><span id="Task-435"><a href="#Task-435"><span class="linenos"> 435</span></a>            <span class="p">]</span>
</span><span id="Task-436"><a href="#Task-436"><span class="linenos"> 436</span></a>        <span class="k">if</span> <span class="n">temporal_subsampling_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-437"><a href="#Task-437"><span class="linenos"> 437</span></a>            <span class="n">subsample</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
</span><span id="Task-438"><a href="#Task-438"><span class="linenos"> 438</span></a>                <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
</span><span id="Task-439"><a href="#Task-439"><span class="linenos"> 439</span></a>                    <span class="nb">range</span><span class="p">(</span><span class="n">main_target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="Task-440"><a href="#Task-440"><span class="linenos"> 440</span></a>                    <span class="nb">int</span><span class="p">(</span><span class="n">temporal_subsampling_size</span> <span class="o">*</span> <span class="n">main_target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="Task-441"><a href="#Task-441"><span class="linenos"> 441</span></a>                <span class="p">)</span>
</span><span id="Task-442"><a href="#Task-442"><span class="linenos"> 442</span></a>            <span class="p">)</span>
</span><span id="Task-443"><a href="#Task-443"><span class="linenos"> 443</span></a>            <span class="n">main_target</span> <span class="o">=</span> <span class="n">main_target</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">subsample</span><span class="p">]</span>
</span><span id="Task-444"><a href="#Task-444"><span class="linenos"> 444</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-445"><a href="#Task-445"><span class="linenos"> 445</span></a>            <span class="n">subsample</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Task-446"><a href="#Task-446"><span class="linenos"> 446</span></a>
</span><span id="Task-447"><a href="#Task-447"><span class="linenos"> 447</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_tags</span><span class="p">:</span>
</span><span id="Task-448"><a href="#Task-448"><span class="linenos"> 448</span></a>            <span class="n">tag</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Task-449"><a href="#Task-449"><span class="linenos"> 449</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-450"><a href="#Task-450"><span class="linenos"> 450</span></a>            <span class="n">tag</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">)</span>
</span><span id="Task-451"><a href="#Task-451"><span class="linenos"> 451</span></a>        <span class="n">predicted</span><span class="p">,</span> <span class="n">ssl_predicted</span><span class="p">,</span> <span class="n">ssl_targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_prediction</span><span class="p">(</span>
</span><span id="Task-452"><a href="#Task-452"><span class="linenos"> 452</span></a>            <span class="n">main_input</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">ssl_inputs</span><span class="p">,</span> <span class="n">ssl_targets</span><span class="p">,</span> <span class="n">augment_n</span><span class="p">,</span> <span class="n">subsample</span><span class="o">=</span><span class="n">subsample</span>
</span><span id="Task-453"><a href="#Task-453"><span class="linenos"> 453</span></a>        <span class="p">)</span>
</span><span id="Task-454"><a href="#Task-454"><span class="linenos"> 454</span></a>        <span class="k">del</span> <span class="n">main_input</span><span class="p">,</span> <span class="n">ssl_inputs</span>
</span><span id="Task-455"><a href="#Task-455"><span class="linenos"> 455</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute</span><span class="p">(</span>
</span><span id="Task-456"><a href="#Task-456"><span class="linenos"> 456</span></a>            <span class="n">ssl_predicted</span><span class="p">,</span>
</span><span id="Task-457"><a href="#Task-457"><span class="linenos"> 457</span></a>            <span class="n">ssl_targets</span><span class="p">,</span>
</span><span id="Task-458"><a href="#Task-458"><span class="linenos"> 458</span></a>            <span class="n">predicted</span><span class="p">,</span>
</span><span id="Task-459"><a href="#Task-459"><span class="linenos"> 459</span></a>            <span class="n">main_target</span><span class="p">,</span>
</span><span id="Task-460"><a href="#Task-460"><span class="linenos"> 460</span></a>            <span class="n">tag</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">),</span>
</span><span id="Task-461"><a href="#Task-461"><span class="linenos"> 461</span></a>            <span class="n">skip_metrics</span><span class="o">=</span><span class="n">skip_metrics</span><span class="p">,</span>
</span><span id="Task-462"><a href="#Task-462"><span class="linenos"> 462</span></a>        <span class="p">)</span>
</span><span id="Task-463"><a href="#Task-463"><span class="linenos"> 463</span></a>
</span><span id="Task-464"><a href="#Task-464"><span class="linenos"> 464</span></a>    <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span>
</span><span id="Task-465"><a href="#Task-465"><span class="linenos"> 465</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Task-466"><a href="#Task-466"><span class="linenos"> 466</span></a>        <span class="n">ssl_predicted</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
</span><span id="Task-467"><a href="#Task-467"><span class="linenos"> 467</span></a>        <span class="n">ssl_targets</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
</span><span id="Task-468"><a href="#Task-468"><span class="linenos"> 468</span></a>        <span class="n">predicted</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
</span><span id="Task-469"><a href="#Task-469"><span class="linenos"> 469</span></a>        <span class="n">main_target</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
</span><span id="Task-470"><a href="#Task-470"><span class="linenos"> 470</span></a>        <span class="n">tag</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-471"><a href="#Task-471"><span class="linenos"> 471</span></a>        <span class="n">skip_loss</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task-472"><a href="#Task-472"><span class="linenos"> 472</span></a>        <span class="n">apply_primary_function</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Task-473"><a href="#Task-473"><span class="linenos"> 473</span></a>        <span class="n">skip_metrics</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-474"><a href="#Task-474"><span class="linenos"> 474</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="Task-475"><a href="#Task-475"><span class="linenos"> 475</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-476"><a href="#Task-476"><span class="linenos"> 476</span></a><span class="sd">        Compute the losses and metrics from predictions</span>
</span><span id="Task-477"><a href="#Task-477"><span class="linenos"> 477</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-478"><a href="#Task-478"><span class="linenos"> 478</span></a>
</span><span id="Task-479"><a href="#Task-479"><span class="linenos"> 479</span></a>        <span class="k">if</span> <span class="n">skip_metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-480"><a href="#Task-480"><span class="linenos"> 480</span></a>            <span class="n">skip_metrics</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Task-481"><a href="#Task-481"><span class="linenos"> 481</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_loss</span><span class="p">:</span>
</span><span id="Task-482"><a href="#Task-482"><span class="linenos"> 482</span></a>            <span class="n">ssl_losses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ssl_loss</span><span class="p">(</span><span class="n">ssl_predicted</span><span class="p">,</span> <span class="n">ssl_targets</span><span class="p">)</span>
</span><span id="Task-483"><a href="#Task-483"><span class="linenos"> 483</span></a>            <span class="k">if</span> <span class="n">predicted</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-484"><a href="#Task-484"><span class="linenos"> 484</span></a>                <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span><span class="n">predicted</span><span class="p">,</span> <span class="n">main_target</span><span class="p">)</span>
</span><span id="Task-485"><a href="#Task-485"><span class="linenos"> 485</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Task-486"><a href="#Task-486"><span class="linenos"> 486</span></a>                <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Task-487"><a href="#Task-487"><span class="linenos"> 487</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-488"><a href="#Task-488"><span class="linenos"> 488</span></a>            <span class="n">ssl_losses</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="p">[],</span> <span class="mi">0</span>
</span><span id="Task-489"><a href="#Task-489"><span class="linenos"> 489</span></a>
</span><span id="Task-490"><a href="#Task-490"><span class="linenos"> 490</span></a>        <span class="k">if</span> <span class="n">predicted</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-491"><a href="#Task-491"><span class="linenos"> 491</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">predicted</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="Task-492"><a href="#Task-492"><span class="linenos"> 492</span></a>                <span class="n">predicted</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Task-493"><a href="#Task-493"><span class="linenos"> 493</span></a>                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="Task-494"><a href="#Task-494"><span class="linenos"> 494</span></a>                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">predicted</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Task-495"><a href="#Task-495"><span class="linenos"> 495</span></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>
</span><span id="Task-496"><a href="#Task-496"><span class="linenos"> 496</span></a>                <span class="p">}</span>
</span><span id="Task-497"><a href="#Task-497"><span class="linenos"> 497</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Task-498"><a href="#Task-498"><span class="linenos"> 498</span></a>                <span class="n">predicted</span> <span class="o">=</span> <span class="n">predicted</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="Task-499"><a href="#Task-499"><span class="linenos"> 499</span></a>            <span class="k">if</span> <span class="n">apply_primary_function</span><span class="p">:</span>
</span><span id="Task-500"><a href="#Task-500"><span class="linenos"> 500</span></a>                <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_predict_function</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="Task-501"><a href="#Task-501"><span class="linenos"> 501</span></a>            <span class="n">predicted_transformed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_function</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="Task-502"><a href="#Task-502"><span class="linenos"> 502</span></a>            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">metric_function</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Task-503"><a href="#Task-503"><span class="linenos"> 503</span></a>                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip_metrics</span><span class="p">:</span>
</span><span id="Task-504"><a href="#Task-504"><span class="linenos"> 504</span></a>                    <span class="k">if</span> <span class="n">metric_function</span><span class="o">.</span><span class="n">needs_raw_data</span><span class="p">:</span>
</span><span id="Task-505"><a href="#Task-505"><span class="linenos"> 505</span></a>                        <span class="n">metric_function</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">predicted</span><span class="p">,</span> <span class="n">main_target</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
</span><span id="Task-506"><a href="#Task-506"><span class="linenos"> 506</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Task-507"><a href="#Task-507"><span class="linenos"> 507</span></a>                        <span class="n">metric_function</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span id="Task-508"><a href="#Task-508"><span class="linenos"> 508</span></a>                            <span class="n">predicted_transformed</span><span class="p">,</span>
</span><span id="Task-509"><a href="#Task-509"><span class="linenos"> 509</span></a>                            <span class="n">main_target</span><span class="p">,</span>
</span><span id="Task-510"><a href="#Task-510"><span class="linenos"> 510</span></a>                            <span class="n">tag</span><span class="p">,</span>
</span><span id="Task-511"><a href="#Task-511"><span class="linenos"> 511</span></a>                        <span class="p">)</span>
</span><span id="Task-512"><a href="#Task-512"><span class="linenos"> 512</span></a>        <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">ssl_losses</span>
</span><span id="Task-513"><a href="#Task-513"><span class="linenos"> 513</span></a>
</span><span id="Task-514"><a href="#Task-514"><span class="linenos"> 514</span></a>    <span class="k">def</span> <span class="nf">_calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="Task-515"><a href="#Task-515"><span class="linenos"> 515</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-516"><a href="#Task-516"><span class="linenos"> 516</span></a><span class="sd">        Calculate the final values of epoch metrics</span>
</span><span id="Task-517"><a href="#Task-517"><span class="linenos"> 517</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-518"><a href="#Task-518"><span class="linenos"> 518</span></a>
</span><span id="Task-519"><a href="#Task-519"><span class="linenos"> 519</span></a>        <span class="n">epoch_metrics</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Task-520"><a href="#Task-520"><span class="linenos"> 520</span></a>        <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Task-521"><a href="#Task-521"><span class="linenos"> 521</span></a>            <span class="n">m</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">calculate</span><span class="p">()</span>
</span><span id="Task-522"><a href="#Task-522"><span class="linenos"> 522</span></a>            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="Task-523"><a href="#Task-523"><span class="linenos"> 523</span></a>                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Task-524"><a href="#Task-524"><span class="linenos"> 524</span></a>                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="Task-525"><a href="#Task-525"><span class="linenos"> 525</span></a>                        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="Task-526"><a href="#Task-526"><span class="linenos"> 526</span></a>                    <span class="n">epoch_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
</span><span id="Task-527"><a href="#Task-527"><span class="linenos"> 527</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Task-528"><a href="#Task-528"><span class="linenos"> 528</span></a>                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="ow">is</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="Task-529"><a href="#Task-529"><span class="linenos"> 529</span></a>                    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="Task-530"><a href="#Task-530"><span class="linenos"> 530</span></a>                <span class="n">epoch_metrics</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
</span><span id="Task-531"><a href="#Task-531"><span class="linenos"> 531</span></a>            <span class="n">metric</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</span><span id="Task-532"><a href="#Task-532"><span class="linenos"> 532</span></a>        <span class="k">return</span> <span class="n">epoch_metrics</span>
</span><span id="Task-533"><a href="#Task-533"><span class="linenos"> 533</span></a>
</span><span id="Task-534"><a href="#Task-534"><span class="linenos"> 534</span></a>    <span class="k">def</span> <span class="nf">_run_epoch</span><span class="p">(</span>
</span><span id="Task-535"><a href="#Task-535"><span class="linenos"> 535</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Task-536"><a href="#Task-536"><span class="linenos"> 536</span></a>        <span class="n">dataloader</span><span class="p">:</span> <span class="n">DataLoader</span><span class="p">,</span>
</span><span id="Task-537"><a href="#Task-537"><span class="linenos"> 537</span></a>        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Task-538"><a href="#Task-538"><span class="linenos"> 538</span></a>        <span class="n">augment_n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="Task-539"><a href="#Task-539"><span class="linenos"> 539</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task-540"><a href="#Task-540"><span class="linenos"> 540</span></a>        <span class="n">unlabeled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-541"><a href="#Task-541"><span class="linenos"> 541</span></a>        <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="Task-542"><a href="#Task-542"><span class="linenos"> 542</span></a>        <span class="n">temporal_subsampling_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-543"><a href="#Task-543"><span class="linenos"> 543</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
</span><span id="Task-544"><a href="#Task-544"><span class="linenos"> 544</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-545"><a href="#Task-545"><span class="linenos"> 545</span></a><span class="sd">        Run one epoch on dataloader</span>
</span><span id="Task-546"><a href="#Task-546"><span class="linenos"> 546</span></a>
</span><span id="Task-547"><a href="#Task-547"><span class="linenos"> 547</span></a><span class="sd">        Averaging the predictions over augment_n augmentations.</span>
</span><span id="Task-548"><a href="#Task-548"><span class="linenos"> 548</span></a><span class="sd">        Use &quot;train&quot; mode for training and &quot;val&quot; mode for evaluation.</span>
</span><span id="Task-549"><a href="#Task-549"><span class="linenos"> 549</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-550"><a href="#Task-550"><span class="linenos"> 550</span></a>
</span><span id="Task-551"><a href="#Task-551"><span class="linenos"> 551</span></a>        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
</span><span id="Task-552"><a href="#Task-552"><span class="linenos"> 552</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="Task-553"><a href="#Task-553"><span class="linenos"> 553</span></a>        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span>
</span><span id="Task-554"><a href="#Task-554"><span class="linenos"> 554</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="Task-555"><a href="#Task-555"><span class="linenos"> 555</span></a>            <span class="k">pass</span>
</span><span id="Task-556"><a href="#Task-556"><span class="linenos"> 556</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-557"><a href="#Task-557"><span class="linenos"> 557</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Task-558"><a href="#Task-558"><span class="linenos"> 558</span></a>                <span class="sa">f</span><span class="s1">&#39;Mode </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s1"> is not recognized, please choose either &quot;train&quot; for training or &quot;val&quot; for validation&#39;</span>
</span><span id="Task-559"><a href="#Task-559"><span class="linenos"> 559</span></a>            <span class="p">)</span>
</span><span id="Task-560"><a href="#Task-560"><span class="linenos"> 560</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_tags</span><span class="p">:</span>
</span><span id="Task-561"><a href="#Task-561"><span class="linenos"> 561</span></a>            <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
</span><span id="Task-562"><a href="#Task-562"><span class="linenos"> 562</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-563"><a href="#Task-563"><span class="linenos"> 563</span></a>            <span class="n">tags</span> <span class="o">=</span> <span class="n">dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_tags</span><span class="p">()</span>
</span><span id="Task-564"><a href="#Task-564"><span class="linenos"> 564</span></a>        <span class="n">epoch_loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Task-565"><a href="#Task-565"><span class="linenos"> 565</span></a>        <span class="n">epoch_ssl_loss</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="Task-566"><a href="#Task-566"><span class="linenos"> 566</span></a>        <span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Task-567"><a href="#Task-567"><span class="linenos"> 567</span></a>        <span class="n">set_pars</span> <span class="o">=</span> <span class="n">dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">set_indexing_parameters</span>
</span><span id="Task-568"><a href="#Task-568"><span class="linenos"> 568</span></a>        <span class="n">skip_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_metrics</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Task-569"><a href="#Task-569"><span class="linenos"> 569</span></a>        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
</span><span id="Task-570"><a href="#Task-570"><span class="linenos"> 570</span></a>            <span class="n">set_pars</span><span class="p">(</span><span class="n">unlabeled</span><span class="o">=</span><span class="n">unlabeled</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
</span><span id="Task-571"><a href="#Task-571"><span class="linenos"> 571</span></a>            <span class="n">data_len</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span>
</span><span id="Task-572"><a href="#Task-572"><span class="linenos"> 572</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Task-573"><a href="#Task-573"><span class="linenos"> 573</span></a>                <span class="n">dataloader</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span>
</span><span id="Task-574"><a href="#Task-574"><span class="linenos"> 574</span></a>            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
</span><span id="Task-575"><a href="#Task-575"><span class="linenos"> 575</span></a>                <span class="n">loss</span><span class="p">,</span> <span class="n">ssl_losses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loss_function</span><span class="p">(</span>
</span><span id="Task-576"><a href="#Task-576"><span class="linenos"> 576</span></a>                    <span class="n">batch</span><span class="p">,</span>
</span><span id="Task-577"><a href="#Task-577"><span class="linenos"> 577</span></a>                    <span class="n">augment_n</span><span class="p">,</span>
</span><span id="Task-578"><a href="#Task-578"><span class="linenos"> 578</span></a>                    <span class="n">temporal_subsampling_size</span><span class="o">=</span><span class="n">temporal_subsampling_size</span><span class="p">,</span>
</span><span id="Task-579"><a href="#Task-579"><span class="linenos"> 579</span></a>                    <span class="n">skip_metrics</span><span class="o">=</span><span class="n">skip_metrics</span><span class="p">,</span>
</span><span id="Task-580"><a href="#Task-580"><span class="linenos"> 580</span></a>                <span class="p">)</span>
</span><span id="Task-581"><a href="#Task-581"><span class="linenos"> 581</span></a>                <span class="k">if</span> <span class="n">loss</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Task-582"><a href="#Task-582"><span class="linenos"> 582</span></a>                    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">*</span> <span class="n">alpha</span>
</span><span id="Task-583"><a href="#Task-583"><span class="linenos"> 583</span></a>                    <span class="n">epoch_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="Task-584"><a href="#Task-584"><span class="linenos"> 584</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ssl_loss</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
</span><span id="Task-585"><a href="#Task-585"><span class="linenos"> 585</span></a>                    <span class="nb">zip</span><span class="p">(</span><span class="n">ssl_losses</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_weights</span><span class="p">)</span>
</span><span id="Task-586"><a href="#Task-586"><span class="linenos"> 586</span></a>                <span class="p">):</span>
</span><span id="Task-587"><a href="#Task-587"><span class="linenos"> 587</span></a>                    <span class="k">if</span> <span class="n">ssl_loss</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Task-588"><a href="#Task-588"><span class="linenos"> 588</span></a>                        <span class="n">epoch_ssl_loss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ssl_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="Task-589"><a href="#Task-589"><span class="linenos"> 589</span></a>                        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">+</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">ssl_loss</span>
</span><span id="Task-590"><a href="#Task-590"><span class="linenos"> 590</span></a>                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
</span><span id="Task-591"><a href="#Task-591"><span class="linenos"> 591</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</span><span id="Task-592"><a href="#Task-592"><span class="linenos"> 592</span></a>                    <span class="k">if</span> <span class="n">loss</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">:</span>
</span><span id="Task-593"><a href="#Task-593"><span class="linenos"> 593</span></a>                        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span><span id="Task-594"><a href="#Task-594"><span class="linenos"> 594</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="Task-595"><a href="#Task-595"><span class="linenos"> 595</span></a>
</span><span id="Task-596"><a href="#Task-596"><span class="linenos"> 596</span></a>        <span class="n">epoch_loss</span> <span class="o">=</span> <span class="n">epoch_loss</span> <span class="o">/</span> <span class="n">data_len</span>
</span><span id="Task-597"><a href="#Task-597"><span class="linenos"> 597</span></a>        <span class="n">epoch_ssl_loss</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="o">/</span> <span class="n">data_len</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">epoch_ssl_loss</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Task-598"><a href="#Task-598"><span class="linenos"> 598</span></a>        <span class="n">epoch_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_metrics</span><span class="p">()</span>
</span><span id="Task-599"><a href="#Task-599"><span class="linenos"> 599</span></a>
</span><span id="Task-600"><a href="#Task-600"><span class="linenos"> 600</span></a>        <span class="k">return</span> <span class="n">epoch_loss</span><span class="p">,</span> <span class="n">epoch_ssl_loss</span><span class="p">,</span> <span class="n">epoch_metrics</span>
</span><span id="Task-601"><a href="#Task-601"><span class="linenos"> 601</span></a>
</span><span id="Task-602"><a href="#Task-602"><span class="linenos"> 602</span></a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span>
</span><span id="Task-603"><a href="#Task-603"><span class="linenos"> 603</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Task-604"><a href="#Task-604"><span class="linenos"> 604</span></a>        <span class="n">trial</span><span class="p">:</span> <span class="n">Trial</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-605"><a href="#Task-605"><span class="linenos"> 605</span></a>        <span class="n">optimized_metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-606"><a href="#Task-606"><span class="linenos"> 606</span></a>        <span class="n">to_ram</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task-607"><a href="#Task-607"><span class="linenos"> 607</span></a>        <span class="n">autostop_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
</span><span id="Task-608"><a href="#Task-608"><span class="linenos"> 608</span></a>        <span class="n">autostop_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span>
</span><span id="Task-609"><a href="#Task-609"><span class="linenos"> 609</span></a>        <span class="n">autostop_metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-610"><a href="#Task-610"><span class="linenos"> 610</span></a>        <span class="n">main_task_on</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Task-611"><a href="#Task-611"><span class="linenos"> 611</span></a>        <span class="n">ssl_on</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Task-612"><a href="#Task-612"><span class="linenos"> 612</span></a>        <span class="n">temporal_subsampling_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-613"><a href="#Task-613"><span class="linenos"> 613</span></a>        <span class="n">loading_bar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task-614"><a href="#Task-614"><span class="linenos"> 614</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
</span><span id="Task-615"><a href="#Task-615"><span class="linenos"> 615</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-616"><a href="#Task-616"><span class="linenos"> 616</span></a><span class="sd">        Train the task and return a log of epoch-average loss and metric</span>
</span><span id="Task-617"><a href="#Task-617"><span class="linenos"> 617</span></a>
</span><span id="Task-618"><a href="#Task-618"><span class="linenos"> 618</span></a><span class="sd">        You can use the autostop parameters to finish training when the parameters are not improving. It will be</span>
</span><span id="Task-619"><a href="#Task-619"><span class="linenos"> 619</span></a><span class="sd">        stopped if the average value of `autostop_metric` over the last `autostop_interval` epochs is smaller than</span>
</span><span id="Task-620"><a href="#Task-620"><span class="linenos"> 620</span></a><span class="sd">        the average over the previous `autostop_interval` epochs + `autostop_threshold`. For example, if the</span>
</span><span id="Task-621"><a href="#Task-621"><span class="linenos"> 621</span></a><span class="sd">        current epoch is 120 and `autostop_interval` is 50, the averages over epochs 70-120 and 20-70 will be compared.</span>
</span><span id="Task-622"><a href="#Task-622"><span class="linenos"> 622</span></a>
</span><span id="Task-623"><a href="#Task-623"><span class="linenos"> 623</span></a><span class="sd">        Parameters</span>
</span><span id="Task-624"><a href="#Task-624"><span class="linenos"> 624</span></a><span class="sd">        ----------</span>
</span><span id="Task-625"><a href="#Task-625"><span class="linenos"> 625</span></a><span class="sd">        trial : Trial</span>
</span><span id="Task-626"><a href="#Task-626"><span class="linenos"> 626</span></a><span class="sd">            an `optuna` trial (for hyperparameter searches)</span>
</span><span id="Task-627"><a href="#Task-627"><span class="linenos"> 627</span></a><span class="sd">        optimized_metric : str</span>
</span><span id="Task-628"><a href="#Task-628"><span class="linenos"> 628</span></a><span class="sd">            the name of the metric being optimized (for hyperparameter searches)</span>
</span><span id="Task-629"><a href="#Task-629"><span class="linenos"> 629</span></a><span class="sd">        to_ram : bool, default False</span>
</span><span id="Task-630"><a href="#Task-630"><span class="linenos"> 630</span></a><span class="sd">            if `True`, the dataset will be loaded in RAM (this speeds up the calculations but can lead to crashes</span>
</span><span id="Task-631"><a href="#Task-631"><span class="linenos"> 631</span></a><span class="sd">            if the dataset is too large)</span>
</span><span id="Task-632"><a href="#Task-632"><span class="linenos"> 632</span></a><span class="sd">        autostop_interval : int, default 50</span>
</span><span id="Task-633"><a href="#Task-633"><span class="linenos"> 633</span></a><span class="sd">            the number of epochs to average the autostop metric over</span>
</span><span id="Task-634"><a href="#Task-634"><span class="linenos"> 634</span></a><span class="sd">        autostop_threshold : float, default 0.001</span>
</span><span id="Task-635"><a href="#Task-635"><span class="linenos"> 635</span></a><span class="sd">            the autostop difference threshold</span>
</span><span id="Task-636"><a href="#Task-636"><span class="linenos"> 636</span></a><span class="sd">        autostop_metric : str, optional</span>
</span><span id="Task-637"><a href="#Task-637"><span class="linenos"> 637</span></a><span class="sd">            the autostop metric (can be any one of the tracked metrics of `&#39;loss&#39;`)</span>
</span><span id="Task-638"><a href="#Task-638"><span class="linenos"> 638</span></a><span class="sd">        main_task_on : bool, default True</span>
</span><span id="Task-639"><a href="#Task-639"><span class="linenos"> 639</span></a><span class="sd">            if `False`, the main task (action segmentation) will not be used in training</span>
</span><span id="Task-640"><a href="#Task-640"><span class="linenos"> 640</span></a><span class="sd">        ssl_on : bool, default True</span>
</span><span id="Task-641"><a href="#Task-641"><span class="linenos"> 641</span></a><span class="sd">            if `False`, the SSL task will not be used in training</span>
</span><span id="Task-642"><a href="#Task-642"><span class="linenos"> 642</span></a>
</span><span id="Task-643"><a href="#Task-643"><span class="linenos"> 643</span></a><span class="sd">        Returns</span>
</span><span id="Task-644"><a href="#Task-644"><span class="linenos"> 644</span></a><span class="sd">        -------</span>
</span><span id="Task-645"><a href="#Task-645"><span class="linenos"> 645</span></a><span class="sd">        loss_log: list</span>
</span><span id="Task-646"><a href="#Task-646"><span class="linenos"> 646</span></a><span class="sd">            a list of float loss function values for each epoch</span>
</span><span id="Task-647"><a href="#Task-647"><span class="linenos"> 647</span></a><span class="sd">        metrics_log: dict</span>
</span><span id="Task-648"><a href="#Task-648"><span class="linenos"> 648</span></a><span class="sd">            a dictionary of metric value logs (first-level keys are &#39;train&#39; and &#39;val&#39;, second-level keys are metric</span>
</span><span id="Task-649"><a href="#Task-649"><span class="linenos"> 649</span></a><span class="sd">            names, values are lists of function values)</span>
</span><span id="Task-650"><a href="#Task-650"><span class="linenos"> 650</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-651"><a href="#Task-651"><span class="linenos"> 651</span></a>
</span><span id="Task-652"><a href="#Task-652"><span class="linenos"> 652</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">):</span>
</span><span id="Task-653"><a href="#Task-653"><span class="linenos"> 653</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">MyDataParallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
</span><span id="Task-654"><a href="#Task-654"><span class="linenos"> 654</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Task-655"><a href="#Task-655"><span class="linenos"> 655</span></a>        <span class="k">assert</span> <span class="n">autostop_metric</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;loss&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>
</span><span id="Task-656"><a href="#Task-656"><span class="linenos"> 656</span></a>        <span class="n">autostop_interval</span> <span class="o">//=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_interval</span>
</span><span id="Task-657"><a href="#Task-657"><span class="linenos"> 657</span></a>        <span class="k">if</span> <span class="n">trial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">optimized_metric</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-658"><a href="#Task-658"><span class="linenos"> 658</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Task-659"><a href="#Task-659"><span class="linenos"> 659</span></a>                <span class="s2">&quot;You need to provide the optimized metric name (optimized_metric parameter) &quot;</span>
</span><span id="Task-660"><a href="#Task-660"><span class="linenos"> 660</span></a>                <span class="s2">&quot;for optuna pruning to work!&quot;</span>
</span><span id="Task-661"><a href="#Task-661"><span class="linenos"> 661</span></a>            <span class="p">)</span>
</span><span id="Task-662"><a href="#Task-662"><span class="linenos"> 662</span></a>        <span class="k">if</span> <span class="n">to_ram</span><span class="p">:</span>
</span><span id="Task-663"><a href="#Task-663"><span class="linenos"> 663</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;transferring datasets to RAM...&quot;</span><span class="p">)</span>
</span><span id="Task-664"><a href="#Task-664"><span class="linenos"> 664</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">to_ram</span><span class="p">()</span>
</span><span id="Task-665"><a href="#Task-665"><span class="linenos"> 665</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Task-666"><a href="#Task-666"><span class="linenos"> 666</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">to_ram</span><span class="p">()</span>
</span><span id="Task-667"><a href="#Task-667"><span class="linenos"> 667</span></a>        <span class="n">loss_log</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="Task-668"><a href="#Task-668"><span class="linenos"> 668</span></a>        <span class="n">metrics_log</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[]),</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[])}</span>
</span><span id="Task-669"><a href="#Task-669"><span class="linenos"> 669</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">main_task_on</span><span class="p">:</span>
</span><span id="Task-670"><a href="#Task-670"><span class="linenos"> 670</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">main_task_off</span><span class="p">()</span>
</span><span id="Task-671"><a href="#Task-671"><span class="linenos"> 671</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">ssl_on</span><span class="p">:</span>
</span><span id="Task-672"><a href="#Task-672"><span class="linenos"> 672</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ssl_off</span><span class="p">()</span>
</span><span id="Task-673"><a href="#Task-673"><span class="linenos"> 673</span></a>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">:</span>
</span><span id="Task-674"><a href="#Task-674"><span class="linenos"> 674</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Task-675"><a href="#Task-675"><span class="linenos"> 675</span></a>            <span class="n">unlabeled</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Task-676"><a href="#Task-676"><span class="linenos"> 676</span></a>            <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Task-677"><a href="#Task-677"><span class="linenos"> 677</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudolabel</span><span class="p">:</span>
</span><span id="Task-678"><a href="#Task-678"><span class="linenos"> 678</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T1</span><span class="p">:</span>
</span><span id="Task-679"><a href="#Task-679"><span class="linenos"> 679</span></a>                    <span class="n">unlabeled</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">T1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">!=</span> <span class="mi">0</span>
</span><span id="Task-680"><a href="#Task-680"><span class="linenos"> 680</span></a>                    <span class="k">if</span> <span class="n">unlabeled</span><span class="p">:</span>
</span><span id="Task-681"><a href="#Task-681"><span class="linenos"> 681</span></a>                        <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alpha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
</span><span id="Task-682"><a href="#Task-682"><span class="linenos"> 682</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Task-683"><a href="#Task-683"><span class="linenos"> 683</span></a>                    <span class="n">unlabeled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Task-684"><a href="#Task-684"><span class="linenos"> 684</span></a>            <span class="n">epoch_loss</span><span class="p">,</span> <span class="n">epoch_ssl_loss</span><span class="p">,</span> <span class="n">epoch_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_epoch</span><span class="p">(</span>
</span><span id="Task-685"><a href="#Task-685"><span class="linenos"> 685</span></a>                <span class="n">dataloader</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span><span class="p">,</span>
</span><span id="Task-686"><a href="#Task-686"><span class="linenos"> 686</span></a>                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">,</span>
</span><span id="Task-687"><a href="#Task-687"><span class="linenos"> 687</span></a>                <span class="n">augment_n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">augment_train</span><span class="p">,</span>
</span><span id="Task-688"><a href="#Task-688"><span class="linenos"> 688</span></a>                <span class="n">unlabeled</span><span class="o">=</span><span class="n">unlabeled</span><span class="p">,</span>
</span><span id="Task-689"><a href="#Task-689"><span class="linenos"> 689</span></a>                <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
</span><span id="Task-690"><a href="#Task-690"><span class="linenos"> 690</span></a>                <span class="n">temporal_subsampling_size</span><span class="o">=</span><span class="n">temporal_subsampling_size</span><span class="p">,</span>
</span><span id="Task-691"><a href="#Task-691"><span class="linenos"> 691</span></a>                <span class="n">verbose</span><span class="o">=</span><span class="n">loading_bar</span><span class="p">,</span>
</span><span id="Task-692"><a href="#Task-692"><span class="linenos"> 692</span></a>            <span class="p">)</span>
</span><span id="Task-693"><a href="#Task-693"><span class="linenos"> 693</span></a>            <span class="n">loss_log</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_loss</span><span class="p">)</span>
</span><span id="Task-694"><a href="#Task-694"><span class="linenos"> 694</span></a>            <span class="n">epoch_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s2">]&quot;</span>
</span><span id="Task-695"><a href="#Task-695"><span class="linenos"> 695</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudolabel</span><span class="p">:</span>
</span><span id="Task-696"><a href="#Task-696"><span class="linenos"> 696</span></a>                <span class="k">if</span> <span class="n">unlabeled</span><span class="p">:</span>
</span><span id="Task-697"><a href="#Task-697"><span class="linenos"> 697</span></a>                    <span class="n">epoch_string</span> <span class="o">+=</span> <span class="s2">&quot; (unlabeled)&quot;</span>
</span><span id="Task-698"><a href="#Task-698"><span class="linenos"> 698</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Task-699"><a href="#Task-699"><span class="linenos"> 699</span></a>                    <span class="n">epoch_string</span> <span class="o">+=</span> <span class="s2">&quot; (labeled)&quot;</span>
</span><span id="Task-700"><a href="#Task-700"><span class="linenos"> 700</span></a>            <span class="n">epoch_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;: loss </span><span class="si">{</span><span class="n">epoch_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task-701"><a href="#Task-701"><span class="linenos"> 701</span></a>
</span><span id="Task-702"><a href="#Task-702"><span class="linenos"> 702</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">epoch_ssl_loss</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Task-703"><a href="#Task-703"><span class="linenos"> 703</span></a>                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">epoch_ssl_loss</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="Task-704"><a href="#Task-704"><span class="linenos"> 704</span></a>                    <span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;ssl_loss_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="Task-705"><a href="#Task-705"><span class="linenos"> 705</span></a>                    <span class="n">epoch_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, ssl_loss_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task-706"><a href="#Task-706"><span class="linenos"> 706</span></a>
</span><span id="Task-707"><a href="#Task-707"><span class="linenos"> 707</span></a>            <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">epoch_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="Task-708"><a href="#Task-708"><span class="linenos"> 708</span></a>                <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_metrics</span><span class="p">:</span>
</span><span id="Task-709"><a href="#Task-709"><span class="linenos"> 709</span></a>                    <span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">][</span><span class="n">metric_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_value</span><span class="p">)</span>
</span><span id="Task-710"><a href="#Task-710"><span class="linenos"> 710</span></a>                    <span class="n">epoch_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">metric_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task-711"><a href="#Task-711"><span class="linenos"> 711</span></a>
</span><span id="Task-712"><a href="#Task-712"><span class="linenos"> 712</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="Task-713"><a href="#Task-713"><span class="linenos"> 713</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="Task-714"><a href="#Task-714"><span class="linenos"> 714</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_interval</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="Task-715"><a href="#Task-715"><span class="linenos"> 715</span></a>            <span class="p">):</span>
</span><span id="Task-716"><a href="#Task-716"><span class="linenos"> 716</span></a>                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="Task-717"><a href="#Task-717"><span class="linenos"> 717</span></a>                    <span class="n">epoch_string</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="Task-718"><a href="#Task-718"><span class="linenos"> 718</span></a>                    <span class="p">(</span>
</span><span id="Task-719"><a href="#Task-719"><span class="linenos"> 719</span></a>                        <span class="n">val_epoch_loss</span><span class="p">,</span>
</span><span id="Task-720"><a href="#Task-720"><span class="linenos"> 720</span></a>                        <span class="n">val_epoch_ssl_loss</span><span class="p">,</span>
</span><span id="Task-721"><a href="#Task-721"><span class="linenos"> 721</span></a>                        <span class="n">val_epoch_metrics</span><span class="p">,</span>
</span><span id="Task-722"><a href="#Task-722"><span class="linenos"> 722</span></a>                    <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_epoch</span><span class="p">(</span>
</span><span id="Task-723"><a href="#Task-723"><span class="linenos"> 723</span></a>                        <span class="n">dataloader</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span><span class="p">,</span>
</span><span id="Task-724"><a href="#Task-724"><span class="linenos"> 724</span></a>                        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;val&quot;</span><span class="p">,</span>
</span><span id="Task-725"><a href="#Task-725"><span class="linenos"> 725</span></a>                        <span class="n">augment_n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">augment_val</span><span class="p">,</span>
</span><span id="Task-726"><a href="#Task-726"><span class="linenos"> 726</span></a>                    <span class="p">)</span>
</span><span id="Task-727"><a href="#Task-727"><span class="linenos"> 727</span></a>                    <span class="n">loss_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_epoch_loss</span><span class="p">)</span>
</span><span id="Task-728"><a href="#Task-728"><span class="linenos"> 728</span></a>                    <span class="n">epoch_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;validation: loss </span><span class="si">{</span><span class="n">val_epoch_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task-729"><a href="#Task-729"><span class="linenos"> 729</span></a>
</span><span id="Task-730"><a href="#Task-730"><span class="linenos"> 730</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_epoch_ssl_loss</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Task-731"><a href="#Task-731"><span class="linenos"> 731</span></a>                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">val_epoch_ssl_loss</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="Task-732"><a href="#Task-732"><span class="linenos"> 732</span></a>                            <span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;ssl_loss_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="Task-733"><a href="#Task-733"><span class="linenos"> 733</span></a>                            <span class="n">epoch_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, ssl_loss_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task-734"><a href="#Task-734"><span class="linenos"> 734</span></a>
</span><span id="Task-735"><a href="#Task-735"><span class="linenos"> 735</span></a>                    <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">val_epoch_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="Task-736"><a href="#Task-736"><span class="linenos"> 736</span></a>                        <span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="n">metric_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_value</span><span class="p">)</span>
</span><span id="Task-737"><a href="#Task-737"><span class="linenos"> 737</span></a>                        <span class="n">epoch_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">metric_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task-738"><a href="#Task-738"><span class="linenos"> 738</span></a>
</span><span id="Task-739"><a href="#Task-739"><span class="linenos"> 739</span></a>                <span class="k">if</span> <span class="n">trial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-740"><a href="#Task-740"><span class="linenos"> 740</span></a>                    <span class="k">if</span> <span class="n">optimized_metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]:</span>
</span><span id="Task-741"><a href="#Task-741"><span class="linenos"> 741</span></a>                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Task-742"><a href="#Task-742"><span class="linenos"> 742</span></a>                            <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">optimized_metric</span><span class="si">}</span><span class="s2"> metric set for optimization is not being logged!&quot;</span>
</span><span id="Task-743"><a href="#Task-743"><span class="linenos"> 743</span></a>                        <span class="p">)</span>
</span><span id="Task-744"><a href="#Task-744"><span class="linenos"> 744</span></a>                    <span class="n">trial</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="n">optimized_metric</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
</span><span id="Task-745"><a href="#Task-745"><span class="linenos"> 745</span></a>                    <span class="k">if</span> <span class="n">trial</span><span class="o">.</span><span class="n">should_prune</span><span class="p">():</span>
</span><span id="Task-746"><a href="#Task-746"><span class="linenos"> 746</span></a>                        <span class="k">raise</span> <span class="n">TrialPruned</span><span class="p">()</span>
</span><span id="Task-747"><a href="#Task-747"><span class="linenos"> 747</span></a>
</span><span id="Task-748"><a href="#Task-748"><span class="linenos"> 748</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Task-749"><a href="#Task-749"><span class="linenos"> 749</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">epoch_string</span><span class="p">)</span>
</span><span id="Task-750"><a href="#Task-750"><span class="linenos"> 750</span></a>
</span><span id="Task-751"><a href="#Task-751"><span class="linenos"> 751</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-752"><a href="#Task-752"><span class="linenos"> 752</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="Task-753"><a href="#Task-753"><span class="linenos"> 753</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">epoch_string</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Task-754"><a href="#Task-754"><span class="linenos"> 754</span></a>
</span><span id="Task-755"><a href="#Task-755"><span class="linenos"> 755</span></a>            <span class="n">save_condition</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Task-756"><a href="#Task-756"><span class="linenos"> 756</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_epochs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="Task-757"><a href="#Task-757"><span class="linenos"> 757</span></a>                <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_epochs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="Task-758"><a href="#Task-758"><span class="linenos"> 758</span></a>            <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">)</span>
</span><span id="Task-759"><a href="#Task-759"><span class="linenos"> 759</span></a>
</span><span id="Task-760"><a href="#Task-760"><span class="linenos"> 760</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">save_condition</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-761"><a href="#Task-761"><span class="linenos"> 761</span></a>                <span class="n">epoch_s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">)))</span>
</span><span id="Task-762"><a href="#Task-762"><span class="linenos"> 762</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span>
</span><span id="Task-763"><a href="#Task-763"><span class="linenos"> 763</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;epoch</span><span class="si">{</span><span class="n">epoch_s</span><span class="si">}</span><span class="s2">.pt&quot;</span><span class="p">)</span>
</span><span id="Task-764"><a href="#Task-764"><span class="linenos"> 764</span></a>                <span class="p">)</span>
</span><span id="Task-765"><a href="#Task-765"><span class="linenos"> 765</span></a>
</span><span id="Task-766"><a href="#Task-766"><span class="linenos"> 766</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudolabel</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">unlabeled</span><span class="p">:</span>
</span><span id="Task-767"><a href="#Task-767"><span class="linenos"> 767</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_set_pseudolabels</span><span class="p">()</span>
</span><span id="Task-768"><a href="#Task-768"><span class="linenos"> 768</span></a>
</span><span id="Task-769"><a href="#Task-769"><span class="linenos"> 769</span></a>            <span class="k">if</span> <span class="n">autostop_metric</span> <span class="o">==</span> <span class="s2">&quot;loss&quot;</span><span class="p">:</span>
</span><span id="Task-770"><a href="#Task-770"><span class="linenos"> 770</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">loss_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">autostop_interval</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Task-771"><a href="#Task-771"><span class="linenos"> 771</span></a>                    <span class="k">if</span> <span class="p">(</span>
</span><span id="Task-772"><a href="#Task-772"><span class="linenos"> 772</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="o">-</span><span class="n">autostop_interval</span><span class="p">:])</span>
</span><span id="Task-773"><a href="#Task-773"><span class="linenos"> 773</span></a>                        <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
</span><span id="Task-774"><a href="#Task-774"><span class="linenos"> 774</span></a>                            <span class="n">loss_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">autostop_interval</span> <span class="p">:</span> <span class="o">-</span><span class="n">autostop_interval</span><span class="p">]</span>
</span><span id="Task-775"><a href="#Task-775"><span class="linenos"> 775</span></a>                        <span class="p">)</span>
</span><span id="Task-776"><a href="#Task-776"><span class="linenos"> 776</span></a>                        <span class="o">+</span> <span class="n">autostop_threshold</span>
</span><span id="Task-777"><a href="#Task-777"><span class="linenos"> 777</span></a>                    <span class="p">):</span>
</span><span id="Task-778"><a href="#Task-778"><span class="linenos"> 778</span></a>                        <span class="k">break</span>
</span><span id="Task-779"><a href="#Task-779"><span class="linenos"> 779</span></a>            <span class="k">elif</span> <span class="n">autostop_metric</span> <span class="ow">in</span> <span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]:</span>
</span><span id="Task-780"><a href="#Task-780"><span class="linenos"> 780</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="n">autostop_metric</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">autostop_interval</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Task-781"><a href="#Task-781"><span class="linenos"> 781</span></a>                    <span class="k">if</span> <span class="p">(</span>
</span><span id="Task-782"><a href="#Task-782"><span class="linenos"> 782</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
</span><span id="Task-783"><a href="#Task-783"><span class="linenos"> 783</span></a>                            <span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="n">autostop_metric</span><span class="p">][</span><span class="o">-</span><span class="n">autostop_interval</span><span class="p">:]</span>
</span><span id="Task-784"><a href="#Task-784"><span class="linenos"> 784</span></a>                        <span class="p">)</span>
</span><span id="Task-785"><a href="#Task-785"><span class="linenos"> 785</span></a>                        <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
</span><span id="Task-786"><a href="#Task-786"><span class="linenos"> 786</span></a>                            <span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="n">autostop_metric</span><span class="p">][</span>
</span><span id="Task-787"><a href="#Task-787"><span class="linenos"> 787</span></a>                                <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">autostop_interval</span> <span class="p">:</span> <span class="o">-</span><span class="n">autostop_interval</span>
</span><span id="Task-788"><a href="#Task-788"><span class="linenos"> 788</span></a>                            <span class="p">]</span>
</span><span id="Task-789"><a href="#Task-789"><span class="linenos"> 789</span></a>                        <span class="p">)</span>
</span><span id="Task-790"><a href="#Task-790"><span class="linenos"> 790</span></a>                        <span class="o">+</span> <span class="n">autostop_threshold</span>
</span><span id="Task-791"><a href="#Task-791"><span class="linenos"> 791</span></a>                    <span class="p">):</span>
</span><span id="Task-792"><a href="#Task-792"><span class="linenos"> 792</span></a>                        <span class="k">break</span>
</span><span id="Task-793"><a href="#Task-793"><span class="linenos"> 793</span></a>
</span><span id="Task-794"><a href="#Task-794"><span class="linenos"> 794</span></a>        <span class="n">metrics_log</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metrics_log</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Task-795"><a href="#Task-795"><span class="linenos"> 795</span></a>
</span><span id="Task-796"><a href="#Task-796"><span class="linenos"> 796</span></a>        <span class="k">return</span> <span class="n">loss_log</span><span class="p">,</span> <span class="n">metrics_log</span>
</span><span id="Task-797"><a href="#Task-797"><span class="linenos"> 797</span></a>
</span><span id="Task-798"><a href="#Task-798"><span class="linenos"> 798</span></a>    <span class="k">def</span> <span class="nf">evaluate_prediction</span><span class="p">(</span>
</span><span id="Task-799"><a href="#Task-799"><span class="linenos"> 799</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Task-800"><a href="#Task-800"><span class="linenos"> 800</span></a>        <span class="n">prediction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span>
</span><span id="Task-801"><a href="#Task-801"><span class="linenos"> 801</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">DataLoader</span><span class="p">,</span> <span class="n">BehaviorDataset</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-802"><a href="#Task-802"><span class="linenos"> 802</span></a>        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
</span><span id="Task-803"><a href="#Task-803"><span class="linenos"> 803</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
</span><span id="Task-804"><a href="#Task-804"><span class="linenos"> 804</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-805"><a href="#Task-805"><span class="linenos"> 805</span></a><span class="sd">        Compute metrics for a prediction</span>
</span><span id="Task-806"><a href="#Task-806"><span class="linenos"> 806</span></a>
</span><span id="Task-807"><a href="#Task-807"><span class="linenos"> 807</span></a><span class="sd">        Parameters</span>
</span><span id="Task-808"><a href="#Task-808"><span class="linenos"> 808</span></a><span class="sd">        ----------</span>
</span><span id="Task-809"><a href="#Task-809"><span class="linenos"> 809</span></a><span class="sd">        prediction : torch.Tensor</span>
</span><span id="Task-810"><a href="#Task-810"><span class="linenos"> 810</span></a><span class="sd">            the prediction</span>
</span><span id="Task-811"><a href="#Task-811"><span class="linenos"> 811</span></a><span class="sd">        data : torch.utils.data.DataLoader | dlc2action.data.dataset.BehaviorDataset, optional</span>
</span><span id="Task-812"><a href="#Task-812"><span class="linenos"> 812</span></a><span class="sd">            the data the prediction was made for (if not provided, take the validation dataset)</span>
</span><span id="Task-813"><a href="#Task-813"><span class="linenos"> 813</span></a><span class="sd">        batch_size : int, default 32</span>
</span><span id="Task-814"><a href="#Task-814"><span class="linenos"> 814</span></a><span class="sd">            the batch size</span>
</span><span id="Task-815"><a href="#Task-815"><span class="linenos"> 815</span></a>
</span><span id="Task-816"><a href="#Task-816"><span class="linenos"> 816</span></a><span class="sd">        Returns</span>
</span><span id="Task-817"><a href="#Task-817"><span class="linenos"> 817</span></a><span class="sd">        -------</span>
</span><span id="Task-818"><a href="#Task-818"><span class="linenos"> 818</span></a><span class="sd">        loss : float</span>
</span><span id="Task-819"><a href="#Task-819"><span class="linenos"> 819</span></a><span class="sd">            the average value of the loss function</span>
</span><span id="Task-820"><a href="#Task-820"><span class="linenos"> 820</span></a><span class="sd">        metric : dict</span>
</span><span id="Task-821"><a href="#Task-821"><span class="linenos"> 821</span></a><span class="sd">            a dictionary of average values of metric functions</span>
</span><span id="Task-822"><a href="#Task-822"><span class="linenos"> 822</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-823"><a href="#Task-823"><span class="linenos"> 823</span></a>
</span><span id="Task-824"><a href="#Task-824"><span class="linenos"> 824</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">DataLoader</span><span class="p">:</span>
</span><span id="Task-825"><a href="#Task-825"><span class="linenos"> 825</span></a>            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataset</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="Task-826"><a href="#Task-826"><span class="linenos"> 826</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="Task-827"><a href="#Task-827"><span class="linenos"> 827</span></a>        <span class="n">epoch_loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Task-828"><a href="#Task-828"><span class="linenos"> 828</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="Task-829"><a href="#Task-829"><span class="linenos"> 829</span></a>            <span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">())</span>
</span><span id="Task-830"><a href="#Task-830"><span class="linenos"> 830</span></a>            <span class="n">length</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">len_segment</span><span class="p">()</span>
</span><span id="Task-831"><a href="#Task-831"><span class="linenos"> 831</span></a>            <span class="n">coords</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">annotation_store</span><span class="o">.</span><span class="n">get_original_coordinates</span><span class="p">()</span>
</span><span id="Task-832"><a href="#Task-832"><span class="linenos"> 832</span></a>            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="Task-833"><a href="#Task-833"><span class="linenos"> 833</span></a>                <span class="n">main_target</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span>
</span><span id="Task-834"><a href="#Task-834"><span class="linenos"> 834</span></a>                <span class="n">pr_coords</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]]</span>
</span><span id="Task-835"><a href="#Task-835"><span class="linenos"> 835</span></a>                <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">pr_coords</span><span class="p">),</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span>
</span><span id="Task-836"><a href="#Task-836"><span class="linenos"> 836</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pr_coords</span><span class="p">):</span>
</span><span id="Task-837"><a href="#Task-837"><span class="linenos"> 837</span></a>                    <span class="n">video_id</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">input_store</span><span class="o">.</span><span class="n">get_video_id</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span id="Task-838"><a href="#Task-838"><span class="linenos"> 838</span></a>                    <span class="n">clip_id</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">input_store</span><span class="o">.</span><span class="n">get_clip_id</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span id="Task-839"><a href="#Task-839"><span class="linenos"> 839</span></a>                    <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">input_store</span><span class="o">.</span><span class="n">get_clip_start_end</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span id="Task-840"><a href="#Task-840"><span class="linenos"> 840</span></a>                    <span class="n">predicted</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="n">video_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">][</span>
</span><span id="Task-841"><a href="#Task-841"><span class="linenos"> 841</span></a>                        <span class="p">:,</span> <span class="n">start</span><span class="p">:</span><span class="n">end</span>
</span><span id="Task-842"><a href="#Task-842"><span class="linenos"> 842</span></a>                    <span class="p">]</span>
</span><span id="Task-843"><a href="#Task-843"><span class="linenos"> 843</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_compute</span><span class="p">(</span>
</span><span id="Task-844"><a href="#Task-844"><span class="linenos"> 844</span></a>                    <span class="p">[],</span>
</span><span id="Task-845"><a href="#Task-845"><span class="linenos"> 845</span></a>                    <span class="p">[],</span>
</span><span id="Task-846"><a href="#Task-846"><span class="linenos"> 846</span></a>                    <span class="n">predicted</span><span class="p">,</span>
</span><span id="Task-847"><a href="#Task-847"><span class="linenos"> 847</span></a>                    <span class="n">main_target</span><span class="p">,</span>
</span><span id="Task-848"><a href="#Task-848"><span class="linenos"> 848</span></a>                    <span class="n">skip_loss</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task-849"><a href="#Task-849"><span class="linenos"> 849</span></a>                    <span class="n">tag</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">),</span>
</span><span id="Task-850"><a href="#Task-850"><span class="linenos"> 850</span></a>                    <span class="n">apply_primary_function</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Task-851"><a href="#Task-851"><span class="linenos"> 851</span></a>                <span class="p">)</span>
</span><span id="Task-852"><a href="#Task-852"><span class="linenos"> 852</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-853"><a href="#Task-853"><span class="linenos"> 853</span></a>            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="Task-854"><a href="#Task-854"><span class="linenos"> 854</span></a>                <span class="n">main_target</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span>
</span><span id="Task-855"><a href="#Task-855"><span class="linenos"> 855</span></a>                <span class="n">predicted</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]]</span>
</span><span id="Task-856"><a href="#Task-856"><span class="linenos"> 856</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_compute</span><span class="p">(</span>
</span><span id="Task-857"><a href="#Task-857"><span class="linenos"> 857</span></a>                    <span class="p">[],</span>
</span><span id="Task-858"><a href="#Task-858"><span class="linenos"> 858</span></a>                    <span class="p">[],</span>
</span><span id="Task-859"><a href="#Task-859"><span class="linenos"> 859</span></a>                    <span class="n">predicted</span><span class="p">,</span>
</span><span id="Task-860"><a href="#Task-860"><span class="linenos"> 860</span></a>                    <span class="n">main_target</span><span class="p">,</span>
</span><span id="Task-861"><a href="#Task-861"><span class="linenos"> 861</span></a>                    <span class="n">skip_loss</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task-862"><a href="#Task-862"><span class="linenos"> 862</span></a>                    <span class="n">tag</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">),</span>
</span><span id="Task-863"><a href="#Task-863"><span class="linenos"> 863</span></a>                    <span class="n">apply_primary_function</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Task-864"><a href="#Task-864"><span class="linenos"> 864</span></a>                <span class="p">)</span>
</span><span id="Task-865"><a href="#Task-865"><span class="linenos"> 865</span></a>        <span class="n">epoch_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_metrics</span><span class="p">()</span>
</span><span id="Task-866"><a href="#Task-866"><span class="linenos"> 866</span></a>        <span class="n">strings</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task-867"><a href="#Task-867"><span class="linenos"> 867</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">metric_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task-868"><a href="#Task-868"><span class="linenos"> 868</span></a>            <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_value</span> <span class="ow">in</span> <span class="n">epoch_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Task-869"><a href="#Task-869"><span class="linenos"> 869</span></a>        <span class="p">]</span>
</span><span id="Task-870"><a href="#Task-870"><span class="linenos"> 870</span></a>        <span class="n">val_string</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">strings</span><span class="p">))</span>
</span><span id="Task-871"><a href="#Task-871"><span class="linenos"> 871</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">val_string</span><span class="p">)</span>
</span><span id="Task-872"><a href="#Task-872"><span class="linenos"> 872</span></a>        <span class="k">return</span> <span class="n">epoch_loss</span><span class="p">,</span> <span class="n">epoch_metrics</span>
</span><span id="Task-873"><a href="#Task-873"><span class="linenos"> 873</span></a>
</span><span id="Task-874"><a href="#Task-874"><span class="linenos"> 874</span></a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span>
</span><span id="Task-875"><a href="#Task-875"><span class="linenos"> 875</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Task-876"><a href="#Task-876"><span class="linenos"> 876</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">DataLoader</span><span class="p">,</span> <span class="n">BehaviorDataset</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-877"><a href="#Task-877"><span class="linenos"> 877</span></a>        <span class="n">augment_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Task-878"><a href="#Task-878"><span class="linenos"> 878</span></a>        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
</span><span id="Task-879"><a href="#Task-879"><span class="linenos"> 879</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Task-880"><a href="#Task-880"><span class="linenos"> 880</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
</span><span id="Task-881"><a href="#Task-881"><span class="linenos"> 881</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-882"><a href="#Task-882"><span class="linenos"> 882</span></a><span class="sd">        Evaluate the Task model</span>
</span><span id="Task-883"><a href="#Task-883"><span class="linenos"> 883</span></a>
</span><span id="Task-884"><a href="#Task-884"><span class="linenos"> 884</span></a><span class="sd">        Parameters</span>
</span><span id="Task-885"><a href="#Task-885"><span class="linenos"> 885</span></a><span class="sd">        ----------</span>
</span><span id="Task-886"><a href="#Task-886"><span class="linenos"> 886</span></a><span class="sd">        data : torch.utils.data.DataLoader | dlc2action.data.dataset.BehaviorDataset, optional</span>
</span><span id="Task-887"><a href="#Task-887"><span class="linenos"> 887</span></a><span class="sd">            the data to evaluate on (if not provided, evaluate on the Task validation dataset)</span>
</span><span id="Task-888"><a href="#Task-888"><span class="linenos"> 888</span></a><span class="sd">        augment_n : int, default 0</span>
</span><span id="Task-889"><a href="#Task-889"><span class="linenos"> 889</span></a><span class="sd">            the number of augmentations to average results over</span>
</span><span id="Task-890"><a href="#Task-890"><span class="linenos"> 890</span></a><span class="sd">        batch_size : int, default 32</span>
</span><span id="Task-891"><a href="#Task-891"><span class="linenos"> 891</span></a><span class="sd">            the batch size</span>
</span><span id="Task-892"><a href="#Task-892"><span class="linenos"> 892</span></a><span class="sd">        verbose : bool, default True</span>
</span><span id="Task-893"><a href="#Task-893"><span class="linenos"> 893</span></a><span class="sd">            if True, the process is reported to standard output</span>
</span><span id="Task-894"><a href="#Task-894"><span class="linenos"> 894</span></a>
</span><span id="Task-895"><a href="#Task-895"><span class="linenos"> 895</span></a><span class="sd">        Returns</span>
</span><span id="Task-896"><a href="#Task-896"><span class="linenos"> 896</span></a><span class="sd">        -------</span>
</span><span id="Task-897"><a href="#Task-897"><span class="linenos"> 897</span></a><span class="sd">        loss : float</span>
</span><span id="Task-898"><a href="#Task-898"><span class="linenos"> 898</span></a><span class="sd">            the average value of the loss function</span>
</span><span id="Task-899"><a href="#Task-899"><span class="linenos"> 899</span></a><span class="sd">        ssl_loss : float</span>
</span><span id="Task-900"><a href="#Task-900"><span class="linenos"> 900</span></a><span class="sd">            the average value of the SSL loss function</span>
</span><span id="Task-901"><a href="#Task-901"><span class="linenos"> 901</span></a><span class="sd">        metric : dict</span>
</span><span id="Task-902"><a href="#Task-902"><span class="linenos"> 902</span></a><span class="sd">            a dictionary of average values of metric functions</span>
</span><span id="Task-903"><a href="#Task-903"><span class="linenos"> 903</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-904"><a href="#Task-904"><span class="linenos"> 904</span></a>
</span><span id="Task-905"><a href="#Task-905"><span class="linenos"> 905</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">):</span>
</span><span id="Task-906"><a href="#Task-906"><span class="linenos"> 906</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">MyDataParallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
</span><span id="Task-907"><a href="#Task-907"><span class="linenos"> 907</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Task-908"><a href="#Task-908"><span class="linenos"> 908</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">DataLoader</span><span class="p">:</span>
</span><span id="Task-909"><a href="#Task-909"><span class="linenos"> 909</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataset</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="Task-910"><a href="#Task-910"><span class="linenos"> 910</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="Task-911"><a href="#Task-911"><span class="linenos"> 911</span></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="Task-912"><a href="#Task-912"><span class="linenos"> 912</span></a>            <span class="n">epoch_loss</span><span class="p">,</span> <span class="n">epoch_ssl_loss</span><span class="p">,</span> <span class="n">epoch_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_epoch</span><span class="p">(</span>
</span><span id="Task-913"><a href="#Task-913"><span class="linenos"> 913</span></a>                <span class="n">dataloader</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="n">augment_n</span><span class="o">=</span><span class="n">augment_n</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
</span><span id="Task-914"><a href="#Task-914"><span class="linenos"> 914</span></a>            <span class="p">)</span>
</span><span id="Task-915"><a href="#Task-915"><span class="linenos"> 915</span></a>        <span class="n">val_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;loss </span><span class="si">{</span><span class="n">epoch_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task-916"><a href="#Task-916"><span class="linenos"> 916</span></a>        <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">epoch_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="Task-917"><a href="#Task-917"><span class="linenos"> 917</span></a>            <span class="n">val_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">metric_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task-918"><a href="#Task-918"><span class="linenos"> 918</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">val_string</span><span class="p">)</span>
</span><span id="Task-919"><a href="#Task-919"><span class="linenos"> 919</span></a>        <span class="k">return</span> <span class="n">epoch_loss</span><span class="p">,</span> <span class="n">epoch_ssl_loss</span><span class="p">,</span> <span class="n">epoch_metrics</span>
</span><span id="Task-920"><a href="#Task-920"><span class="linenos"> 920</span></a>
</span><span id="Task-921"><a href="#Task-921"><span class="linenos"> 921</span></a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span>
</span><span id="Task-922"><a href="#Task-922"><span class="linenos"> 922</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Task-923"><a href="#Task-923"><span class="linenos"> 923</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">DataLoader</span><span class="p">,</span> <span class="n">BehaviorDataset</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-924"><a href="#Task-924"><span class="linenos"> 924</span></a>        <span class="n">raw_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task-925"><a href="#Task-925"><span class="linenos"> 925</span></a>        <span class="n">apply_primary_function</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Task-926"><a href="#Task-926"><span class="linenos"> 926</span></a>        <span class="n">augment_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Task-927"><a href="#Task-927"><span class="linenos"> 927</span></a>        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
</span><span id="Task-928"><a href="#Task-928"><span class="linenos"> 928</span></a>        <span class="n">train_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task-929"><a href="#Task-929"><span class="linenos"> 929</span></a>        <span class="n">to_ram</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task-930"><a href="#Task-930"><span class="linenos"> 930</span></a>        <span class="n">embedding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task-931"><a href="#Task-931"><span class="linenos"> 931</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="Task-932"><a href="#Task-932"><span class="linenos"> 932</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-933"><a href="#Task-933"><span class="linenos"> 933</span></a><span class="sd">        Make a prediction with the Task model</span>
</span><span id="Task-934"><a href="#Task-934"><span class="linenos"> 934</span></a>
</span><span id="Task-935"><a href="#Task-935"><span class="linenos"> 935</span></a><span class="sd">        Parameters</span>
</span><span id="Task-936"><a href="#Task-936"><span class="linenos"> 936</span></a><span class="sd">        ----------</span>
</span><span id="Task-937"><a href="#Task-937"><span class="linenos"> 937</span></a><span class="sd">        data : torch.utils.data.DataLoader | dlc2action.data.dataset.BehaviorDataset | str, optional</span>
</span><span id="Task-938"><a href="#Task-938"><span class="linenos"> 938</span></a><span class="sd">            the data to evaluate on (if not provided, evaluate on the Task validation dataset)</span>
</span><span id="Task-939"><a href="#Task-939"><span class="linenos"> 939</span></a><span class="sd">        raw_output : bool, default False</span>
</span><span id="Task-940"><a href="#Task-940"><span class="linenos"> 940</span></a><span class="sd">            if `True`, the raw predicted probabilities are returned</span>
</span><span id="Task-941"><a href="#Task-941"><span class="linenos"> 941</span></a><span class="sd">        apply_primary_function : bool, default True</span>
</span><span id="Task-942"><a href="#Task-942"><span class="linenos"> 942</span></a><span class="sd">            if `True`, the primary predict function is applied (to map the model output into a shape corresponding to</span>
</span><span id="Task-943"><a href="#Task-943"><span class="linenos"> 943</span></a><span class="sd">            the input)</span>
</span><span id="Task-944"><a href="#Task-944"><span class="linenos"> 944</span></a><span class="sd">        augment_n : int, default 0</span>
</span><span id="Task-945"><a href="#Task-945"><span class="linenos"> 945</span></a><span class="sd">            the number of augmentations to average results over</span>
</span><span id="Task-946"><a href="#Task-946"><span class="linenos"> 946</span></a><span class="sd">        batch_size : int, default 32</span>
</span><span id="Task-947"><a href="#Task-947"><span class="linenos"> 947</span></a><span class="sd">            the batch size</span>
</span><span id="Task-948"><a href="#Task-948"><span class="linenos"> 948</span></a><span class="sd">        train_mode : bool, default False</span>
</span><span id="Task-949"><a href="#Task-949"><span class="linenos"> 949</span></a><span class="sd">            if `True`, the model is used in training mode (affects dropout and batch normalization layers)</span>
</span><span id="Task-950"><a href="#Task-950"><span class="linenos"> 950</span></a><span class="sd">        to_ram : bool, default False</span>
</span><span id="Task-951"><a href="#Task-951"><span class="linenos"> 951</span></a><span class="sd">            if `True`, the dataset will be loaded in RAM (this speeds up the calculations but can lead to crashes</span>
</span><span id="Task-952"><a href="#Task-952"><span class="linenos"> 952</span></a><span class="sd">            if the dataset is too large)</span>
</span><span id="Task-953"><a href="#Task-953"><span class="linenos"> 953</span></a><span class="sd">        embedding : bool, default False</span>
</span><span id="Task-954"><a href="#Task-954"><span class="linenos"> 954</span></a><span class="sd">            if `True`, the output of feature extractor is returned, ignoring the prediction module of the model</span>
</span><span id="Task-955"><a href="#Task-955"><span class="linenos"> 955</span></a>
</span><span id="Task-956"><a href="#Task-956"><span class="linenos"> 956</span></a><span class="sd">        Returns</span>
</span><span id="Task-957"><a href="#Task-957"><span class="linenos"> 957</span></a><span class="sd">        -------</span>
</span><span id="Task-958"><a href="#Task-958"><span class="linenos"> 958</span></a><span class="sd">        prediction : torch.Tensor</span>
</span><span id="Task-959"><a href="#Task-959"><span class="linenos"> 959</span></a><span class="sd">            a prediction for the input data</span>
</span><span id="Task-960"><a href="#Task-960"><span class="linenos"> 960</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-961"><a href="#Task-961"><span class="linenos"> 961</span></a>
</span><span id="Task-962"><a href="#Task-962"><span class="linenos"> 962</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">):</span>
</span><span id="Task-963"><a href="#Task-963"><span class="linenos"> 963</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">MyDataParallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
</span><span id="Task-964"><a href="#Task-964"><span class="linenos"> 964</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Task-965"><a href="#Task-965"><span class="linenos"> 965</span></a>        <span class="k">if</span> <span class="n">train_mode</span><span class="p">:</span>
</span><span id="Task-966"><a href="#Task-966"><span class="linenos"> 966</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="Task-967"><a href="#Task-967"><span class="linenos"> 967</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-968"><a href="#Task-968"><span class="linenos"> 968</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="Task-969"><a href="#Task-969"><span class="linenos"> 969</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Task-970"><a href="#Task-970"><span class="linenos"> 970</span></a>        <span class="k">if</span> <span class="n">embedding</span><span class="p">:</span>
</span><span id="Task-971"><a href="#Task-971"><span class="linenos"> 971</span></a>            <span class="n">raw_output</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Task-972"><a href="#Task-972"><span class="linenos"> 972</span></a>            <span class="n">apply_primary_function</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Task-973"><a href="#Task-973"><span class="linenos"> 973</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">DataLoader</span><span class="p">:</span>
</span><span id="Task-974"><a href="#Task-974"><span class="linenos"> 974</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataset</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="Task-975"><a href="#Task-975"><span class="linenos"> 975</span></a>            <span class="k">if</span> <span class="n">to_ram</span><span class="p">:</span>
</span><span id="Task-976"><a href="#Task-976"><span class="linenos"> 976</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;transferring dataset to RAM...&quot;</span><span class="p">)</span>
</span><span id="Task-977"><a href="#Task-977"><span class="linenos"> 977</span></a>                <span class="n">data</span><span class="o">.</span><span class="n">to_ram</span><span class="p">()</span>
</span><span id="Task-978"><a href="#Task-978"><span class="linenos"> 978</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="Task-979"><a href="#Task-979"><span class="linenos"> 979</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ssl_off</span><span class="p">()</span>
</span><span id="Task-980"><a href="#Task-980"><span class="linenos"> 980</span></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="Task-981"><a href="#Task-981"><span class="linenos"> 981</span></a>            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span id="Task-982"><a href="#Task-982"><span class="linenos"> 982</span></a>                <span class="nb">input</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Task-983"><a href="#Task-983"><span class="linenos"> 983</span></a>                <span class="n">predicted</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_prediction</span><span class="p">(</span>
</span><span id="Task-984"><a href="#Task-984"><span class="linenos"> 984</span></a>                    <span class="nb">input</span><span class="p">,</span>
</span><span id="Task-985"><a href="#Task-985"><span class="linenos"> 985</span></a>                    <span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">),</span>
</span><span id="Task-986"><a href="#Task-986"><span class="linenos"> 986</span></a>                    <span class="n">augment_n</span><span class="o">=</span><span class="n">augment_n</span><span class="p">,</span>
</span><span id="Task-987"><a href="#Task-987"><span class="linenos"> 987</span></a>                    <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span>
</span><span id="Task-988"><a href="#Task-988"><span class="linenos"> 988</span></a>                <span class="p">)</span>
</span><span id="Task-989"><a href="#Task-989"><span class="linenos"> 989</span></a>                <span class="k">if</span> <span class="n">apply_primary_function</span><span class="p">:</span>
</span><span id="Task-990"><a href="#Task-990"><span class="linenos"> 990</span></a>                    <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_predict_function</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="Task-991"><a href="#Task-991"><span class="linenos"> 991</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">raw_output</span><span class="p">:</span>
</span><span id="Task-992"><a href="#Task-992"><span class="linenos"> 992</span></a>                    <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_function</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="Task-993"><a href="#Task-993"><span class="linenos"> 993</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predicted</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
</span><span id="Task-994"><a href="#Task-994"><span class="linenos"> 994</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ssl_on</span><span class="p">()</span>
</span><span id="Task-995"><a href="#Task-995"><span class="linenos"> 995</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="Task-996"><a href="#Task-996"><span class="linenos"> 996</span></a>        <span class="k">return</span> <span class="n">output</span>
</span><span id="Task-997"><a href="#Task-997"><span class="linenos"> 997</span></a>
</span><span id="Task-998"><a href="#Task-998"><span class="linenos"> 998</span></a>    <span class="k">def</span> <span class="nf">dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BehaviorDataset</span><span class="p">:</span>
</span><span id="Task-999"><a href="#Task-999"><span class="linenos"> 999</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1000"><a href="#Task-1000"><span class="linenos">1000</span></a><span class="sd">        Get a dataset</span>
</span><span id="Task-1001"><a href="#Task-1001"><span class="linenos">1001</span></a>
</span><span id="Task-1002"><a href="#Task-1002"><span class="linenos">1002</span></a><span class="sd">        Parameters</span>
</span><span id="Task-1003"><a href="#Task-1003"><span class="linenos">1003</span></a><span class="sd">        ----------</span>
</span><span id="Task-1004"><a href="#Task-1004"><span class="linenos">1004</span></a><span class="sd">        mode : {&#39;train&#39;, &#39;val&#39;, &#39;test}</span>
</span><span id="Task-1005"><a href="#Task-1005"><span class="linenos">1005</span></a><span class="sd">            the dataset to get</span>
</span><span id="Task-1006"><a href="#Task-1006"><span class="linenos">1006</span></a>
</span><span id="Task-1007"><a href="#Task-1007"><span class="linenos">1007</span></a><span class="sd">        Returns</span>
</span><span id="Task-1008"><a href="#Task-1008"><span class="linenos">1008</span></a><span class="sd">        -------</span>
</span><span id="Task-1009"><a href="#Task-1009"><span class="linenos">1009</span></a><span class="sd">        dataset : dlc2action.data.dataset.BehaviorDataset</span>
</span><span id="Task-1010"><a href="#Task-1010"><span class="linenos">1010</span></a><span class="sd">            the dataset</span>
</span><span id="Task-1011"><a href="#Task-1011"><span class="linenos">1011</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1012"><a href="#Task-1012"><span class="linenos">1012</span></a>
</span><span id="Task-1013"><a href="#Task-1013"><span class="linenos">1013</span></a>        <span class="n">dataloader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
</span><span id="Task-1014"><a href="#Task-1014"><span class="linenos">1014</span></a>        <span class="k">if</span> <span class="n">dataloader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1015"><a href="#Task-1015"><span class="linenos">1015</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The length of the dataloader is 0!&quot;</span><span class="p">)</span>
</span><span id="Task-1016"><a href="#Task-1016"><span class="linenos">1016</span></a>        <span class="k">return</span> <span class="n">dataloader</span><span class="o">.</span><span class="n">dataset</span>
</span><span id="Task-1017"><a href="#Task-1017"><span class="linenos">1017</span></a>
</span><span id="Task-1018"><a href="#Task-1018"><span class="linenos">1018</span></a>    <span class="k">def</span> <span class="nf">dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;train&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataLoader</span><span class="p">:</span>
</span><span id="Task-1019"><a href="#Task-1019"><span class="linenos">1019</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1020"><a href="#Task-1020"><span class="linenos">1020</span></a><span class="sd">        Get a dataloader</span>
</span><span id="Task-1021"><a href="#Task-1021"><span class="linenos">1021</span></a>
</span><span id="Task-1022"><a href="#Task-1022"><span class="linenos">1022</span></a><span class="sd">        Parameters</span>
</span><span id="Task-1023"><a href="#Task-1023"><span class="linenos">1023</span></a><span class="sd">        ----------</span>
</span><span id="Task-1024"><a href="#Task-1024"><span class="linenos">1024</span></a><span class="sd">        mode : {&#39;train&#39;, &#39;val&#39;, &#39;test}</span>
</span><span id="Task-1025"><a href="#Task-1025"><span class="linenos">1025</span></a><span class="sd">            the dataset to get</span>
</span><span id="Task-1026"><a href="#Task-1026"><span class="linenos">1026</span></a>
</span><span id="Task-1027"><a href="#Task-1027"><span class="linenos">1027</span></a><span class="sd">        Returns</span>
</span><span id="Task-1028"><a href="#Task-1028"><span class="linenos">1028</span></a><span class="sd">        -------</span>
</span><span id="Task-1029"><a href="#Task-1029"><span class="linenos">1029</span></a><span class="sd">        dataloader : torch.utils.data.DataLoader</span>
</span><span id="Task-1030"><a href="#Task-1030"><span class="linenos">1030</span></a><span class="sd">            the dataloader</span>
</span><span id="Task-1031"><a href="#Task-1031"><span class="linenos">1031</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1032"><a href="#Task-1032"><span class="linenos">1032</span></a>
</span><span id="Task-1033"><a href="#Task-1033"><span class="linenos">1033</span></a>        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
</span><span id="Task-1034"><a href="#Task-1034"><span class="linenos">1034</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span>
</span><span id="Task-1035"><a href="#Task-1035"><span class="linenos">1035</span></a>        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span>
</span><span id="Task-1036"><a href="#Task-1036"><span class="linenos">1036</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span>
</span><span id="Task-1037"><a href="#Task-1037"><span class="linenos">1037</span></a>        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
</span><span id="Task-1038"><a href="#Task-1038"><span class="linenos">1038</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_dataloader</span>
</span><span id="Task-1039"><a href="#Task-1039"><span class="linenos">1039</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-1040"><a href="#Task-1040"><span class="linenos">1040</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Task-1041"><a href="#Task-1041"><span class="linenos">1041</span></a>                <span class="sa">f</span><span class="s1">&#39;The </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s1"> mode is not recognized, please choose from &quot;train&quot;, &quot;val&quot; or &quot;test&quot;&#39;</span>
</span><span id="Task-1042"><a href="#Task-1042"><span class="linenos">1042</span></a>            <span class="p">)</span>
</span><span id="Task-1043"><a href="#Task-1043"><span class="linenos">1043</span></a>
</span><span id="Task-1044"><a href="#Task-1044"><span class="linenos">1044</span></a>    <span class="k">def</span> <span class="nf">_get_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
</span><span id="Task-1045"><a href="#Task-1045"><span class="linenos">1045</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1046"><a href="#Task-1046"><span class="linenos">1046</span></a><span class="sd">        Get a dataset from a dataloader, a string (&#39;train&#39;, &#39;test&#39; or &#39;val&#39;) or `None` (default)</span>
</span><span id="Task-1047"><a href="#Task-1047"><span class="linenos">1047</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1048"><a href="#Task-1048"><span class="linenos">1048</span></a>
</span><span id="Task-1049"><a href="#Task-1049"><span class="linenos">1049</span></a>        <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1050"><a href="#Task-1050"><span class="linenos">1050</span></a>            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="s2">&quot;val&quot;</span><span class="p">)</span>
</span><span id="Task-1051"><a href="#Task-1051"><span class="linenos">1051</span></a>        <span class="k">elif</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]:</span>
</span><span id="Task-1052"><a href="#Task-1052"><span class="linenos">1052</span></a>            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="Task-1053"><a href="#Task-1053"><span class="linenos">1053</span></a>        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DataLoader</span><span class="p">:</span>
</span><span id="Task-1054"><a href="#Task-1054"><span class="linenos">1054</span></a>            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dataset</span>
</span><span id="Task-1055"><a href="#Task-1055"><span class="linenos">1055</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="ow">is</span> <span class="n">BehaviorDataset</span><span class="p">:</span>
</span><span id="Task-1056"><a href="#Task-1056"><span class="linenos">1056</span></a>            <span class="k">return</span> <span class="n">dataset</span>
</span><span id="Task-1057"><a href="#Task-1057"><span class="linenos">1057</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-1058"><a href="#Task-1058"><span class="linenos">1058</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2"> type of dataset is not recognized!&quot;</span><span class="p">)</span>
</span><span id="Task-1059"><a href="#Task-1059"><span class="linenos">1059</span></a>
</span><span id="Task-1060"><a href="#Task-1060"><span class="linenos">1060</span></a>    <span class="k">def</span> <span class="nf">_get_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
</span><span id="Task-1061"><a href="#Task-1061"><span class="linenos">1061</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1062"><a href="#Task-1062"><span class="linenos">1062</span></a><span class="sd">        Get a dataloader from a dataset, a string (&#39;train&#39;, &#39;test&#39; or &#39;val&#39;) or `None` (default)</span>
</span><span id="Task-1063"><a href="#Task-1063"><span class="linenos">1063</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1064"><a href="#Task-1064"><span class="linenos">1064</span></a>
</span><span id="Task-1065"><a href="#Task-1065"><span class="linenos">1065</span></a>        <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1066"><a href="#Task-1066"><span class="linenos">1066</span></a>            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span><span class="p">(</span><span class="s2">&quot;val&quot;</span><span class="p">)</span>
</span><span id="Task-1067"><a href="#Task-1067"><span class="linenos">1067</span></a>        <span class="k">elif</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]:</span>
</span><span id="Task-1068"><a href="#Task-1068"><span class="linenos">1068</span></a>            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="Task-1069"><a href="#Task-1069"><span class="linenos">1069</span></a>            <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1070"><a href="#Task-1070"><span class="linenos">1070</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The length of the dataloader is 0!&quot;</span><span class="p">)</span>
</span><span id="Task-1071"><a href="#Task-1071"><span class="linenos">1071</span></a>        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="ow">is</span> <span class="n">BehaviorDataset</span><span class="p">:</span>
</span><span id="Task-1072"><a href="#Task-1072"><span class="linenos">1072</span></a>            <span class="n">dataset</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="Task-1073"><a href="#Task-1073"><span class="linenos">1073</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DataLoader</span><span class="p">:</span>
</span><span id="Task-1074"><a href="#Task-1074"><span class="linenos">1074</span></a>            <span class="k">return</span> <span class="n">dataset</span>
</span><span id="Task-1075"><a href="#Task-1075"><span class="linenos">1075</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-1076"><a href="#Task-1076"><span class="linenos">1076</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2"> type of dataset is not recognized!&quot;</span><span class="p">)</span>
</span><span id="Task-1077"><a href="#Task-1077"><span class="linenos">1077</span></a>
</span><span id="Task-1078"><a href="#Task-1078"><span class="linenos">1078</span></a>    <span class="k">def</span> <span class="nf">generate_full_length_prediction</span><span class="p">(</span>
</span><span id="Task-1079"><a href="#Task-1079"><span class="linenos">1079</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">augment_n</span><span class="o">=</span><span class="mi">10</span>
</span><span id="Task-1080"><a href="#Task-1080"><span class="linenos">1080</span></a>    <span class="p">):</span>
</span><span id="Task-1081"><a href="#Task-1081"><span class="linenos">1081</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1082"><a href="#Task-1082"><span class="linenos">1082</span></a><span class="sd">        Compile a prediction for the original input sequences</span>
</span><span id="Task-1083"><a href="#Task-1083"><span class="linenos">1083</span></a>
</span><span id="Task-1084"><a href="#Task-1084"><span class="linenos">1084</span></a><span class="sd">        Parameters</span>
</span><span id="Task-1085"><a href="#Task-1085"><span class="linenos">1085</span></a><span class="sd">        ----------</span>
</span><span id="Task-1086"><a href="#Task-1086"><span class="linenos">1086</span></a><span class="sd">        dataset : BehaviorDataset, optional</span>
</span><span id="Task-1087"><a href="#Task-1087"><span class="linenos">1087</span></a><span class="sd">            the dataset to generate a prediction for (if `None`, generate for the validation dataset)</span>
</span><span id="Task-1088"><a href="#Task-1088"><span class="linenos">1088</span></a><span class="sd">        batch_size : int, default 32</span>
</span><span id="Task-1089"><a href="#Task-1089"><span class="linenos">1089</span></a><span class="sd">            the batch size</span>
</span><span id="Task-1090"><a href="#Task-1090"><span class="linenos">1090</span></a><span class="sd">        augment_n : int, default 10</span>
</span><span id="Task-1091"><a href="#Task-1091"><span class="linenos">1091</span></a><span class="sd">            the number of augmentations to average results over</span>
</span><span id="Task-1092"><a href="#Task-1092"><span class="linenos">1092</span></a>
</span><span id="Task-1093"><a href="#Task-1093"><span class="linenos">1093</span></a><span class="sd">        Returns</span>
</span><span id="Task-1094"><a href="#Task-1094"><span class="linenos">1094</span></a><span class="sd">        -------</span>
</span><span id="Task-1095"><a href="#Task-1095"><span class="linenos">1095</span></a><span class="sd">        prediction : dict</span>
</span><span id="Task-1096"><a href="#Task-1096"><span class="linenos">1096</span></a><span class="sd">            a nested dictionary where first level keys are video ids, second level keys are clip ids and values</span>
</span><span id="Task-1097"><a href="#Task-1097"><span class="linenos">1097</span></a><span class="sd">            are prediction tensors</span>
</span><span id="Task-1098"><a href="#Task-1098"><span class="linenos">1098</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1099"><a href="#Task-1099"><span class="linenos">1099</span></a>
</span><span id="Task-1100"><a href="#Task-1100"><span class="linenos">1100</span></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="Task-1101"><a href="#Task-1101"><span class="linenos">1101</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">BehaviorDataset</span><span class="p">):</span>
</span><span id="Task-1102"><a href="#Task-1102"><span class="linenos">1102</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="Task-1103"><a href="#Task-1103"><span class="linenos">1103</span></a>                <span class="sa">f</span><span class="s2">&quot;The dataset parameter has to be either None, string, &quot;</span>
</span><span id="Task-1104"><a href="#Task-1104"><span class="linenos">1104</span></a>                <span class="sa">f</span><span class="s2">&quot;BehaviorDataset or Dataloader, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task-1105"><a href="#Task-1105"><span class="linenos">1105</span></a>            <span class="p">)</span>
</span><span id="Task-1106"><a href="#Task-1106"><span class="linenos">1106</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
</span><span id="Task-1107"><a href="#Task-1107"><span class="linenos">1107</span></a>            <span class="n">dataset</span><span class="p">,</span>
</span><span id="Task-1108"><a href="#Task-1108"><span class="linenos">1108</span></a>            <span class="n">raw_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task-1109"><a href="#Task-1109"><span class="linenos">1109</span></a>            <span class="n">apply_primary_function</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task-1110"><a href="#Task-1110"><span class="linenos">1110</span></a>            <span class="n">augment_n</span><span class="o">=</span><span class="n">augment_n</span><span class="p">,</span>
</span><span id="Task-1111"><a href="#Task-1111"><span class="linenos">1111</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="Task-1112"><a href="#Task-1112"><span class="linenos">1112</span></a>        <span class="p">)</span>
</span><span id="Task-1113"><a href="#Task-1113"><span class="linenos">1113</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">generate_full_length_prediction</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="Task-1114"><a href="#Task-1114"><span class="linenos">1114</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Task-1115"><a href="#Task-1115"><span class="linenos">1115</span></a>            <span class="n">v_id</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Task-1116"><a href="#Task-1116"><span class="linenos">1116</span></a>                <span class="n">clip_id</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_predict_functions</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="Task-1117"><a href="#Task-1117"><span class="linenos">1117</span></a>                <span class="k">for</span> <span class="n">clip_id</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">video_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Task-1118"><a href="#Task-1118"><span class="linenos">1118</span></a>            <span class="p">}</span>
</span><span id="Task-1119"><a href="#Task-1119"><span class="linenos">1119</span></a>            <span class="k">for</span> <span class="n">v_id</span><span class="p">,</span> <span class="n">video_dict</span> <span class="ow">in</span> <span class="n">predicted</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Task-1120"><a href="#Task-1120"><span class="linenos">1120</span></a>        <span class="p">}</span>
</span><span id="Task-1121"><a href="#Task-1121"><span class="linenos">1121</span></a>        <span class="k">return</span> <span class="n">predicted</span>
</span><span id="Task-1122"><a href="#Task-1122"><span class="linenos">1122</span></a>
</span><span id="Task-1123"><a href="#Task-1123"><span class="linenos">1123</span></a>    <span class="k">def</span> <span class="nf">generate_submission</span><span class="p">(</span>
</span><span id="Task-1124"><a href="#Task-1124"><span class="linenos">1124</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">frame_number_map_file</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">augment_n</span><span class="o">=</span><span class="mi">10</span>
</span><span id="Task-1125"><a href="#Task-1125"><span class="linenos">1125</span></a>    <span class="p">):</span>
</span><span id="Task-1126"><a href="#Task-1126"><span class="linenos">1126</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1127"><a href="#Task-1127"><span class="linenos">1127</span></a><span class="sd">        Generate a MABe-22 style submission dictionary</span>
</span><span id="Task-1128"><a href="#Task-1128"><span class="linenos">1128</span></a>
</span><span id="Task-1129"><a href="#Task-1129"><span class="linenos">1129</span></a><span class="sd">        Parameters</span>
</span><span id="Task-1130"><a href="#Task-1130"><span class="linenos">1130</span></a><span class="sd">        ----------</span>
</span><span id="Task-1131"><a href="#Task-1131"><span class="linenos">1131</span></a><span class="sd">        dataset : BehaviorDataset, optional</span>
</span><span id="Task-1132"><a href="#Task-1132"><span class="linenos">1132</span></a><span class="sd">            the dataset to generate a prediction for (if `None`, generate for the validation dataset)</span>
</span><span id="Task-1133"><a href="#Task-1133"><span class="linenos">1133</span></a><span class="sd">        batch_size : int, default 32</span>
</span><span id="Task-1134"><a href="#Task-1134"><span class="linenos">1134</span></a><span class="sd">            the batch size</span>
</span><span id="Task-1135"><a href="#Task-1135"><span class="linenos">1135</span></a><span class="sd">        augment_n : int, default 10</span>
</span><span id="Task-1136"><a href="#Task-1136"><span class="linenos">1136</span></a><span class="sd">            the number of augmentations to average results over</span>
</span><span id="Task-1137"><a href="#Task-1137"><span class="linenos">1137</span></a>
</span><span id="Task-1138"><a href="#Task-1138"><span class="linenos">1138</span></a><span class="sd">        Returns</span>
</span><span id="Task-1139"><a href="#Task-1139"><span class="linenos">1139</span></a><span class="sd">        -------</span>
</span><span id="Task-1140"><a href="#Task-1140"><span class="linenos">1140</span></a><span class="sd">        submission : dict</span>
</span><span id="Task-1141"><a href="#Task-1141"><span class="linenos">1141</span></a><span class="sd">            a dictionary with frame number mapping and embeddings</span>
</span><span id="Task-1142"><a href="#Task-1142"><span class="linenos">1142</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1143"><a href="#Task-1143"><span class="linenos">1143</span></a>
</span><span id="Task-1144"><a href="#Task-1144"><span class="linenos">1144</span></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="Task-1145"><a href="#Task-1145"><span class="linenos">1145</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">BehaviorDataset</span><span class="p">):</span>
</span><span id="Task-1146"><a href="#Task-1146"><span class="linenos">1146</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="Task-1147"><a href="#Task-1147"><span class="linenos">1147</span></a>                <span class="sa">f</span><span class="s2">&quot;The dataset parameter has to be either None, string, &quot;</span>
</span><span id="Task-1148"><a href="#Task-1148"><span class="linenos">1148</span></a>                <span class="sa">f</span><span class="s2">&quot;BehaviorDataset or Dataloader, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task-1149"><a href="#Task-1149"><span class="linenos">1149</span></a>            <span class="p">)</span>
</span><span id="Task-1150"><a href="#Task-1150"><span class="linenos">1150</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
</span><span id="Task-1151"><a href="#Task-1151"><span class="linenos">1151</span></a>            <span class="n">dataset</span><span class="p">,</span>
</span><span id="Task-1152"><a href="#Task-1152"><span class="linenos">1152</span></a>            <span class="n">raw_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task-1153"><a href="#Task-1153"><span class="linenos">1153</span></a>            <span class="n">apply_primary_function</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task-1154"><a href="#Task-1154"><span class="linenos">1154</span></a>            <span class="n">augment_n</span><span class="o">=</span><span class="n">augment_n</span><span class="p">,</span>
</span><span id="Task-1155"><a href="#Task-1155"><span class="linenos">1155</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="Task-1156"><a href="#Task-1156"><span class="linenos">1156</span></a>            <span class="n">embedding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task-1157"><a href="#Task-1157"><span class="linenos">1157</span></a>        <span class="p">)</span>
</span><span id="Task-1158"><a href="#Task-1158"><span class="linenos">1158</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">generate_full_length_prediction</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="Task-1159"><a href="#Task-1159"><span class="linenos">1159</span></a>        <span class="n">frame_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">frame_number_map_file</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="Task-1160"><a href="#Task-1160"><span class="linenos">1160</span></a>        <span class="n">length</span> <span class="o">=</span> <span class="n">frame_map</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">frame_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="o">-</span><span class="mi">1</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Task-1161"><a href="#Task-1161"><span class="linenos">1161</span></a>        <span class="n">embeddings</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Task-1162"><a href="#Task-1162"><span class="linenos">1162</span></a>        <span class="k">for</span> <span class="n">video_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">predicted</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="Task-1163"><a href="#Task-1163"><span class="linenos">1163</span></a>            <span class="n">split</span> <span class="o">=</span> <span class="n">video_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
</span><span id="Task-1164"><a href="#Task-1164"><span class="linenos">1164</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">predicted</span><span class="p">[</span><span class="n">video_id</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Task-1165"><a href="#Task-1165"><span class="linenos">1165</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="Task-1166"><a href="#Task-1166"><span class="linenos">1166</span></a>                    <span class="s2">&quot;Generating submissions is only implemented for the mabe22 dataset!&quot;</span>
</span><span id="Task-1167"><a href="#Task-1167"><span class="linenos">1167</span></a>                <span class="p">)</span>
</span><span id="Task-1168"><a href="#Task-1168"><span class="linenos">1168</span></a>            <span class="k">if</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">frame_map</span><span class="p">:</span>
</span><span id="Task-1169"><a href="#Task-1169"><span class="linenos">1169</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> video is not in the frame map file&quot;</span><span class="p">)</span>
</span><span id="Task-1170"><a href="#Task-1170"><span class="linenos">1170</span></a>            <span class="n">v_id</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Task-1171"><a href="#Task-1171"><span class="linenos">1171</span></a>            <span class="n">clip_id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">predicted</span><span class="p">[</span><span class="n">video_id</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Task-1172"><a href="#Task-1172"><span class="linenos">1172</span></a>            <span class="k">if</span> <span class="n">embeddings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1173"><a href="#Task-1173"><span class="linenos">1173</span></a>                <span class="n">embeddings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">length</span><span class="p">,</span> <span class="n">predicted</span><span class="p">[</span><span class="n">video_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="Task-1174"><a href="#Task-1174"><span class="linenos">1174</span></a>            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">frame_map</span><span class="p">[</span><span class="n">v_id</span><span class="p">]</span>
</span><span id="Task-1175"><a href="#Task-1175"><span class="linenos">1175</span></a>            <span class="n">embeddings</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">predicted</span><span class="p">[</span><span class="n">video_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
</span><span id="Task-1176"><a href="#Task-1176"><span class="linenos">1176</span></a>            <span class="n">predicted</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">video_id</span><span class="p">)</span>
</span><span id="Task-1177"><a href="#Task-1177"><span class="linenos">1177</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Task-1178"><a href="#Task-1178"><span class="linenos">1178</span></a>            <span class="s2">&quot;frame_number_map&quot;</span><span class="p">:</span> <span class="n">frame_map</span><span class="p">,</span>
</span><span id="Task-1179"><a href="#Task-1179"><span class="linenos">1179</span></a>            <span class="s2">&quot;embeddings&quot;</span><span class="p">:</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
</span><span id="Task-1180"><a href="#Task-1180"><span class="linenos">1180</span></a>        <span class="p">}</span>
</span><span id="Task-1181"><a href="#Task-1181"><span class="linenos">1181</span></a>        <span class="k">return</span> <span class="n">predicted</span>
</span><span id="Task-1182"><a href="#Task-1182"><span class="linenos">1182</span></a>
</span><span id="Task-1183"><a href="#Task-1183"><span class="linenos">1183</span></a>    <span class="k">def</span> <span class="nf">_get_intervals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="Task-1184"><a href="#Task-1184"><span class="linenos">1184</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1185"><a href="#Task-1185"><span class="linenos">1185</span></a><span class="sd">        Get a list of True group beginning and end indices from a boolean tensor</span>
</span><span id="Task-1186"><a href="#Task-1186"><span class="linenos">1186</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1187"><a href="#Task-1187"><span class="linenos">1187</span></a>
</span><span id="Task-1188"><a href="#Task-1188"><span class="linenos">1188</span></a>        <span class="n">output</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique_consecutive</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Task-1189"><a href="#Task-1189"><span class="linenos">1189</span></a>        <span class="n">true_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Task-1190"><a href="#Task-1190"><span class="linenos">1190</span></a>        <span class="n">starts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
</span><span id="Task-1191"><a href="#Task-1191"><span class="linenos">1191</span></a>            <span class="p">[(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">true_indices</span><span class="p">]</span>
</span><span id="Task-1192"><a href="#Task-1192"><span class="linenos">1192</span></a>        <span class="p">)</span>
</span><span id="Task-1193"><a href="#Task-1193"><span class="linenos">1193</span></a>        <span class="n">ends</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
</span><span id="Task-1194"><a href="#Task-1194"><span class="linenos">1194</span></a>            <span class="p">[(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">true_indices</span><span class="p">]</span>
</span><span id="Task-1195"><a href="#Task-1195"><span class="linenos">1195</span></a>        <span class="p">)</span>
</span><span id="Task-1196"><a href="#Task-1196"><span class="linenos">1196</span></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">starts</span><span class="p">,</span> <span class="n">ends</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
</span><span id="Task-1197"><a href="#Task-1197"><span class="linenos">1197</span></a>
</span><span id="Task-1198"><a href="#Task-1198"><span class="linenos">1198</span></a>    <span class="k">def</span> <span class="nf">_smooth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">smooth_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="Task-1199"><a href="#Task-1199"><span class="linenos">1199</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1200"><a href="#Task-1200"><span class="linenos">1200</span></a><span class="sd">        Get rid of jittering in a non-exclusive classification tensor</span>
</span><span id="Task-1201"><a href="#Task-1201"><span class="linenos">1201</span></a>
</span><span id="Task-1202"><a href="#Task-1202"><span class="linenos">1202</span></a><span class="sd">        First, remove intervals of 0 shorter than `smooth_interval`. Then, remove intervals of 1 shorter than</span>
</span><span id="Task-1203"><a href="#Task-1203"><span class="linenos">1203</span></a><span class="sd">        `smooth_interval`.</span>
</span><span id="Task-1204"><a href="#Task-1204"><span class="linenos">1204</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1205"><a href="#Task-1205"><span class="linenos">1205</span></a>
</span><span id="Task-1206"><a href="#Task-1206"><span class="linenos">1206</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Task-1207"><a href="#Task-1207"><span class="linenos">1207</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="Task-1208"><a href="#Task-1208"><span class="linenos">1208</span></a>                <span class="n">intervals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_intervals</span><span class="p">(</span><span class="n">tensor</span><span class="p">[:,</span> <span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="Task-1209"><a href="#Task-1209"><span class="linenos">1209</span></a>                <span class="n">interval_lengths</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
</span><span id="Task-1210"><a href="#Task-1210"><span class="linenos">1210</span></a>                    <span class="p">[</span><span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">]</span>
</span><span id="Task-1211"><a href="#Task-1211"><span class="linenos">1211</span></a>                <span class="p">)</span>
</span><span id="Task-1212"><a href="#Task-1212"><span class="linenos">1212</span></a>                <span class="n">short_intervals</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="n">interval_lengths</span> <span class="o">&lt;=</span> <span class="n">smooth_interval</span><span class="p">]</span>
</span><span id="Task-1213"><a href="#Task-1213"><span class="linenos">1213</span></a>                <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">short_intervals</span><span class="p">:</span>
</span><span id="Task-1214"><a href="#Task-1214"><span class="linenos">1214</span></a>                    <span class="n">tensor</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Task-1215"><a href="#Task-1215"><span class="linenos">1215</span></a>                <span class="n">intervals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_intervals</span><span class="p">(</span><span class="n">tensor</span><span class="p">[:,</span> <span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Task-1216"><a href="#Task-1216"><span class="linenos">1216</span></a>                <span class="n">interval_lengths</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
</span><span id="Task-1217"><a href="#Task-1217"><span class="linenos">1217</span></a>                    <span class="p">[</span><span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">]</span>
</span><span id="Task-1218"><a href="#Task-1218"><span class="linenos">1218</span></a>                <span class="p">)</span>
</span><span id="Task-1219"><a href="#Task-1219"><span class="linenos">1219</span></a>                <span class="n">short_intervals</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="n">interval_lengths</span> <span class="o">&lt;=</span> <span class="n">smooth_interval</span><span class="p">]</span>
</span><span id="Task-1220"><a href="#Task-1220"><span class="linenos">1220</span></a>                <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">short_intervals</span><span class="p">:</span>
</span><span id="Task-1221"><a href="#Task-1221"><span class="linenos">1221</span></a>                    <span class="n">tensor</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Task-1222"><a href="#Task-1222"><span class="linenos">1222</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-1223"><a href="#Task-1223"><span class="linenos">1223</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tensor</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
</span><span id="Task-1224"><a href="#Task-1224"><span class="linenos">1224</span></a>                <span class="n">intervals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_intervals</span><span class="p">(</span><span class="n">tensor</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span>
</span><span id="Task-1225"><a href="#Task-1225"><span class="linenos">1225</span></a>                <span class="n">interval_lengths</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
</span><span id="Task-1226"><a href="#Task-1226"><span class="linenos">1226</span></a>                    <span class="p">[</span><span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">]</span>
</span><span id="Task-1227"><a href="#Task-1227"><span class="linenos">1227</span></a>                <span class="p">)</span>
</span><span id="Task-1228"><a href="#Task-1228"><span class="linenos">1228</span></a>                <span class="n">short_intervals</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="n">interval_lengths</span> <span class="o">&lt;=</span> <span class="n">smooth_interval</span><span class="p">]</span>
</span><span id="Task-1229"><a href="#Task-1229"><span class="linenos">1229</span></a>                <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">short_intervals</span><span class="p">:</span>
</span><span id="Task-1230"><a href="#Task-1230"><span class="linenos">1230</span></a>                    <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Task-1231"><a href="#Task-1231"><span class="linenos">1231</span></a>                        <span class="n">tensor</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">[</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="Task-1232"><a href="#Task-1232"><span class="linenos">1232</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Task-1233"><a href="#Task-1233"><span class="linenos">1233</span></a>                        <span class="n">tensor</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">[</span><span class="n">start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="Task-1234"><a href="#Task-1234"><span class="linenos">1234</span></a>        <span class="k">return</span> <span class="n">tensor</span>
</span><span id="Task-1235"><a href="#Task-1235"><span class="linenos">1235</span></a>
</span><span id="Task-1236"><a href="#Task-1236"><span class="linenos">1236</span></a>    <span class="k">def</span> <span class="nf">_visualize_results_label</span><span class="p">(</span>
</span><span id="Task-1237"><a href="#Task-1237"><span class="linenos">1237</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Task-1238"><a href="#Task-1238"><span class="linenos">1238</span></a>        <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Task-1239"><a href="#Task-1239"><span class="linenos">1239</span></a>        <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-1240"><a href="#Task-1240"><span class="linenos">1240</span></a>        <span class="n">add_legend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Task-1241"><a href="#Task-1241"><span class="linenos">1241</span></a>        <span class="n">ground_truth</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Task-1242"><a href="#Task-1242"><span class="linenos">1242</span></a>        <span class="n">hide_axes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task-1243"><a href="#Task-1243"><span class="linenos">1243</span></a>        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="Task-1244"><a href="#Task-1244"><span class="linenos">1244</span></a>        <span class="n">whole_video</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task-1245"><a href="#Task-1245"><span class="linenos">1245</span></a>        <span class="n">transparent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task-1246"><a href="#Task-1246"><span class="linenos">1246</span></a>        <span class="n">dataset</span><span class="p">:</span> <span class="n">BehaviorDataset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-1247"><a href="#Task-1247"><span class="linenos">1247</span></a>        <span class="n">smooth_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Task-1248"><a href="#Task-1248"><span class="linenos">1248</span></a>        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-1249"><a href="#Task-1249"><span class="linenos">1249</span></a>    <span class="p">):</span>
</span><span id="Task-1250"><a href="#Task-1250"><span class="linenos">1250</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1251"><a href="#Task-1251"><span class="linenos">1251</span></a><span class="sd">        Visualize random predictions</span>
</span><span id="Task-1252"><a href="#Task-1252"><span class="linenos">1252</span></a>
</span><span id="Task-1253"><a href="#Task-1253"><span class="linenos">1253</span></a><span class="sd">        Parameters</span>
</span><span id="Task-1254"><a href="#Task-1254"><span class="linenos">1254</span></a><span class="sd">        ----------</span>
</span><span id="Task-1255"><a href="#Task-1255"><span class="linenos">1255</span></a><span class="sd">        save_path : str, optional</span>
</span><span id="Task-1256"><a href="#Task-1256"><span class="linenos">1256</span></a><span class="sd">            the path where the plot will be saved</span>
</span><span id="Task-1257"><a href="#Task-1257"><span class="linenos">1257</span></a><span class="sd">        add_legend : bool, default True</span>
</span><span id="Task-1258"><a href="#Task-1258"><span class="linenos">1258</span></a><span class="sd">            if `True`, legend will be added to the plot</span>
</span><span id="Task-1259"><a href="#Task-1259"><span class="linenos">1259</span></a><span class="sd">        ground_truth : bool, default True</span>
</span><span id="Task-1260"><a href="#Task-1260"><span class="linenos">1260</span></a><span class="sd">            if `True`, ground truth will be added to the plot</span>
</span><span id="Task-1261"><a href="#Task-1261"><span class="linenos">1261</span></a><span class="sd">        colormap : str, default &#39;viridis&#39;</span>
</span><span id="Task-1262"><a href="#Task-1262"><span class="linenos">1262</span></a><span class="sd">            the `matplotlib` colormap to use</span>
</span><span id="Task-1263"><a href="#Task-1263"><span class="linenos">1263</span></a><span class="sd">        hide_axes : bool, default True</span>
</span><span id="Task-1264"><a href="#Task-1264"><span class="linenos">1264</span></a><span class="sd">            if `True`, the axes will be hidden on the plot</span>
</span><span id="Task-1265"><a href="#Task-1265"><span class="linenos">1265</span></a><span class="sd">        min_classes : int, default 1</span>
</span><span id="Task-1266"><a href="#Task-1266"><span class="linenos">1266</span></a><span class="sd">            the minimum number of classes in a displayed interval</span>
</span><span id="Task-1267"><a href="#Task-1267"><span class="linenos">1267</span></a><span class="sd">        width : float, default 10</span>
</span><span id="Task-1268"><a href="#Task-1268"><span class="linenos">1268</span></a><span class="sd">            the width of the plot</span>
</span><span id="Task-1269"><a href="#Task-1269"><span class="linenos">1269</span></a><span class="sd">        whole_video : bool, default False</span>
</span><span id="Task-1270"><a href="#Task-1270"><span class="linenos">1270</span></a><span class="sd">            if `True`, whole videos are plotted instead of segments</span>
</span><span id="Task-1271"><a href="#Task-1271"><span class="linenos">1271</span></a><span class="sd">        transparent : bool, default False</span>
</span><span id="Task-1272"><a href="#Task-1272"><span class="linenos">1272</span></a><span class="sd">            if `True`, the background on the plot is transparent</span>
</span><span id="Task-1273"><a href="#Task-1273"><span class="linenos">1273</span></a><span class="sd">        dataset : BehaviorDataset, optional</span>
</span><span id="Task-1274"><a href="#Task-1274"><span class="linenos">1274</span></a><span class="sd">            the dataset to make the prediction for (if not provided, the validation dataset is used)</span>
</span><span id="Task-1275"><a href="#Task-1275"><span class="linenos">1275</span></a><span class="sd">        drop_classes : set, optional</span>
</span><span id="Task-1276"><a href="#Task-1276"><span class="linenos">1276</span></a><span class="sd">            a set of class names to not be displayed</span>
</span><span id="Task-1277"><a href="#Task-1277"><span class="linenos">1277</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1278"><a href="#Task-1278"><span class="linenos">1278</span></a>
</span><span id="Task-1279"><a href="#Task-1279"><span class="linenos">1279</span></a>        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1280"><a href="#Task-1280"><span class="linenos">1280</span></a>            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="Task-1281"><a href="#Task-1281"><span class="linenos">1281</span></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="Task-1282"><a href="#Task-1282"><span class="linenos">1282</span></a>        <span class="n">inverse_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Task-1283"><a href="#Task-1283"><span class="linenos">1283</span></a>        <span class="n">label_ind</span> <span class="o">=</span> <span class="n">inverse_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
</span><span id="Task-1284"><a href="#Task-1284"><span class="linenos">1284</span></a>        <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">}</span>
</span><span id="Task-1285"><a href="#Task-1285"><span class="linenos">1285</span></a>        <span class="n">label_keys</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">]</span>
</span><span id="Task-1286"><a href="#Task-1286"><span class="linenos">1286</span></a>        <span class="n">color_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">]</span>
</span><span id="Task-1287"><a href="#Task-1287"><span class="linenos">1287</span></a>        <span class="k">if</span> <span class="n">whole_video</span><span class="p">:</span>
</span><span id="Task-1288"><a href="#Task-1288"><span class="linenos">1288</span></a>            <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_full_length_prediction</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="Task-1289"><a href="#Task-1289"><span class="linenos">1289</span></a>            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">predicted</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="Task-1290"><a href="#Task-1290"><span class="linenos">1290</span></a>        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Task-1291"><a href="#Task-1291"><span class="linenos">1291</span></a>        <span class="k">if</span> <span class="n">whole_video</span><span class="p">:</span>
</span><span id="Task-1292"><a href="#Task-1292"><span class="linenos">1292</span></a>            <span class="n">max_iter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span>
</span><span id="Task-1293"><a href="#Task-1293"><span class="linenos">1293</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-1294"><a href="#Task-1294"><span class="linenos">1294</span></a>            <span class="n">max_iter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span>
</span><span id="Task-1295"><a href="#Task-1295"><span class="linenos">1295</span></a>        <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Task-1296"><a href="#Task-1296"><span class="linenos">1296</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
</span><span id="Task-1297"><a href="#Task-1297"><span class="linenos">1297</span></a>            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Task-1298"><a href="#Task-1298"><span class="linenos">1298</span></a>            <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="n">max_iter</span><span class="p">:</span>
</span><span id="Task-1299"><a href="#Task-1299"><span class="linenos">1299</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="Task-1300"><a href="#Task-1300"><span class="linenos">1300</span></a>                    <span class="s2">&quot;Plotting is taking too many iterations; you should probably make some of the parameters less restrictive&quot;</span>
</span><span id="Task-1301"><a href="#Task-1301"><span class="linenos">1301</span></a>                <span class="p">)</span>
</span><span id="Task-1302"><a href="#Task-1302"><span class="linenos">1302</span></a>            <span class="k">if</span> <span class="n">whole_video</span><span class="p">:</span>
</span><span id="Task-1303"><a href="#Task-1303"><span class="linenos">1303</span></a>                <span class="n">i</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Task-1304"><a href="#Task-1304"><span class="linenos">1304</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="n">predicted</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
</span><span id="Task-1305"><a href="#Task-1305"><span class="linenos">1305</span></a>                <span class="n">keys_i</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">prediction</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="Task-1306"><a href="#Task-1306"><span class="linenos">1306</span></a>                <span class="n">j</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys_i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Task-1307"><a href="#Task-1307"><span class="linenos">1307</span></a>                <span class="n">full_p</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="n">keys_i</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
</span><span id="Task-1308"><a href="#Task-1308"><span class="linenos">1308</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="n">keys_i</span><span class="p">[</span><span class="n">j</span><span class="p">]][</span><span class="n">label_ind</span><span class="p">]</span>
</span><span id="Task-1309"><a href="#Task-1309"><span class="linenos">1309</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Task-1310"><a href="#Task-1310"><span class="linenos">1310</span></a>                <span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="Task-1311"><a href="#Task-1311"><span class="linenos">1311</span></a>                <span class="n">i</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Task-1312"><a href="#Task-1312"><span class="linenos">1312</span></a>                <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
</span><span id="Task-1313"><a href="#Task-1313"><span class="linenos">1313</span></a>                    <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
</span><span id="Task-1314"><a href="#Task-1314"><span class="linenos">1314</span></a>                        <span class="k">break</span>
</span><span id="Task-1315"><a href="#Task-1315"><span class="linenos">1315</span></a>                <span class="n">input_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Task-1316"><a href="#Task-1316"><span class="linenos">1316</span></a>                <span class="n">prediction</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_prediction</span><span class="p">(</span>
</span><span id="Task-1317"><a href="#Task-1317"><span class="linenos">1317</span></a>                    <span class="n">input_data</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">),</span> <span class="n">augment_n</span><span class="o">=</span><span class="mi">5</span>
</span><span id="Task-1318"><a href="#Task-1318"><span class="linenos">1318</span></a>                <span class="p">)</span>
</span><span id="Task-1319"><a href="#Task-1319"><span class="linenos">1319</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_predict_functions</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
</span><span id="Task-1320"><a href="#Task-1320"><span class="linenos">1320</span></a>                <span class="n">j</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Task-1321"><a href="#Task-1321"><span class="linenos">1321</span></a>                <span class="n">full_p</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="Task-1322"><a href="#Task-1322"><span class="linenos">1322</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">label_ind</span><span class="p">]</span>
</span><span id="Task-1323"><a href="#Task-1323"><span class="linenos">1323</span></a>            <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">in</span> <span class="n">label_keys</span><span class="p">]</span>
</span><span id="Task-1324"><a href="#Task-1324"><span class="linenos">1324</span></a>            <span class="n">ok</span> <span class="o">=</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">classes</span>
</span><span id="Task-1325"><a href="#Task-1325"><span class="linenos">1325</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="Task-1326"><a href="#Task-1326"><span class="linenos">1326</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
</span><span id="Task-1327"><a href="#Task-1327"><span class="linenos">1327</span></a>            <span class="n">c_i</span> <span class="o">=</span> <span class="n">label_keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
</span><span id="Task-1328"><a href="#Task-1328"><span class="linenos">1328</span></a>            <span class="n">output</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique_consecutive</span><span class="p">(</span>
</span><span id="Task-1329"><a href="#Task-1329"><span class="linenos">1329</span></a>                <span class="n">prediction</span> <span class="o">==</span> <span class="n">c</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span>
</span><span id="Task-1330"><a href="#Task-1330"><span class="linenos">1330</span></a>            <span class="p">)</span>
</span><span id="Task-1331"><a href="#Task-1331"><span class="linenos">1331</span></a>            <span class="n">long_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Task-1332"><a href="#Task-1332"><span class="linenos">1332</span></a>            <span class="n">res_indices_start</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task-1333"><a href="#Task-1333"><span class="linenos">1333</span></a>                <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_indices</span>
</span><span id="Task-1334"><a href="#Task-1334"><span class="linenos">1334</span></a>            <span class="p">]</span>
</span><span id="Task-1335"><a href="#Task-1335"><span class="linenos">1335</span></a>            <span class="n">res_indices_end</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task-1336"><a href="#Task-1336"><span class="linenos">1336</span></a>                <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="Task-1337"><a href="#Task-1337"><span class="linenos">1337</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_indices</span>
</span><span id="Task-1338"><a href="#Task-1338"><span class="linenos">1338</span></a>            <span class="p">]</span>
</span><span id="Task-1339"><a href="#Task-1339"><span class="linenos">1339</span></a>            <span class="n">res_indices_len</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task-1340"><a href="#Task-1340"><span class="linenos">1340</span></a>                <span class="n">end</span> <span class="o">-</span> <span class="n">start</span> <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">res_indices_start</span><span class="p">,</span> <span class="n">res_indices_end</span><span class="p">)</span>
</span><span id="Task-1341"><a href="#Task-1341"><span class="linenos">1341</span></a>            <span class="p">]</span>
</span><span id="Task-1342"><a href="#Task-1342"><span class="linenos">1342</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">broken_barh</span><span class="p">(</span>
</span><span id="Task-1343"><a href="#Task-1343"><span class="linenos">1343</span></a>                <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">res_indices_start</span><span class="p">,</span> <span class="n">res_indices_len</span><span class="p">)),</span>
</span><span id="Task-1344"><a href="#Task-1344"><span class="linenos">1344</span></a>                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="Task-1345"><a href="#Task-1345"><span class="linenos">1345</span></a>                <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)],</span>
</span><span id="Task-1346"><a href="#Task-1346"><span class="linenos">1346</span></a>                <span class="n">facecolors</span><span class="o">=</span><span class="n">color_list</span><span class="p">[</span><span class="n">c_i</span><span class="p">],</span>
</span><span id="Task-1347"><a href="#Task-1347"><span class="linenos">1347</span></a>            <span class="p">)</span>
</span><span id="Task-1348"><a href="#Task-1348"><span class="linenos">1348</span></a>        <span class="k">if</span> <span class="n">ground_truth</span><span class="p">:</span>
</span><span id="Task-1349"><a href="#Task-1349"><span class="linenos">1349</span></a>            <span class="n">gt</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">label_ind</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Task-1350"><a href="#Task-1350"><span class="linenos">1350</span></a>            <span class="n">classes_gt</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">gt</span><span class="p">)</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">in</span> <span class="n">label_keys</span><span class="p">]</span>
</span><span id="Task-1351"><a href="#Task-1351"><span class="linenos">1351</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">classes_gt</span><span class="p">:</span>
</span><span id="Task-1352"><a href="#Task-1352"><span class="linenos">1352</span></a>                <span class="n">c_i</span> <span class="o">=</span> <span class="n">label_keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
</span><span id="Task-1353"><a href="#Task-1353"><span class="linenos">1353</span></a>                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
</span><span id="Task-1354"><a href="#Task-1354"><span class="linenos">1354</span></a>                    <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Task-1355"><a href="#Task-1355"><span class="linenos">1355</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Task-1356"><a href="#Task-1356"><span class="linenos">1356</span></a>                    <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span>
</span><span id="Task-1357"><a href="#Task-1357"><span class="linenos">1357</span></a>                <span class="n">output</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique_consecutive</span><span class="p">(</span>
</span><span id="Task-1358"><a href="#Task-1358"><span class="linenos">1358</span></a>                    <span class="n">gt</span> <span class="o">==</span> <span class="n">c</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span>
</span><span id="Task-1359"><a href="#Task-1359"><span class="linenos">1359</span></a>                <span class="p">)</span>
</span><span id="Task-1360"><a href="#Task-1360"><span class="linenos">1360</span></a>                <span class="n">long_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">output</span> <span class="o">*</span> <span class="p">(</span><span class="n">counts</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Task-1361"><a href="#Task-1361"><span class="linenos">1361</span></a>                <span class="n">res_indices_start</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task-1362"><a href="#Task-1362"><span class="linenos">1362</span></a>                    <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="Task-1363"><a href="#Task-1363"><span class="linenos">1363</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_indices</span>
</span><span id="Task-1364"><a href="#Task-1364"><span class="linenos">1364</span></a>                <span class="p">]</span>
</span><span id="Task-1365"><a href="#Task-1365"><span class="linenos">1365</span></a>                <span class="n">res_indices_end</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task-1366"><a href="#Task-1366"><span class="linenos">1366</span></a>                    <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="Task-1367"><a href="#Task-1367"><span class="linenos">1367</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_indices</span>
</span><span id="Task-1368"><a href="#Task-1368"><span class="linenos">1368</span></a>                <span class="p">]</span>
</span><span id="Task-1369"><a href="#Task-1369"><span class="linenos">1369</span></a>                <span class="n">res_indices_len</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task-1370"><a href="#Task-1370"><span class="linenos">1370</span></a>                    <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="Task-1371"><a href="#Task-1371"><span class="linenos">1371</span></a>                    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">res_indices_start</span><span class="p">,</span> <span class="n">res_indices_end</span><span class="p">)</span>
</span><span id="Task-1372"><a href="#Task-1372"><span class="linenos">1372</span></a>                <span class="p">]</span>
</span><span id="Task-1373"><a href="#Task-1373"><span class="linenos">1373</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">broken_barh</span><span class="p">(</span>
</span><span id="Task-1374"><a href="#Task-1374"><span class="linenos">1374</span></a>                    <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">res_indices_start</span><span class="p">,</span> <span class="n">res_indices_len</span><span class="p">)),</span>
</span><span id="Task-1375"><a href="#Task-1375"><span class="linenos">1375</span></a>                    <span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="Task-1376"><a href="#Task-1376"><span class="linenos">1376</span></a>                    <span class="n">facecolors</span><span class="o">=</span><span class="n">color_list</span><span class="p">[</span><span class="n">c_i</span><span class="p">],</span>
</span><span id="Task-1377"><a href="#Task-1377"><span class="linenos">1377</span></a>                    <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
</span><span id="Task-1378"><a href="#Task-1378"><span class="linenos">1378</span></a>                <span class="p">)</span>
</span><span id="Task-1379"><a href="#Task-1379"><span class="linenos">1379</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_compute</span><span class="p">(</span>
</span><span id="Task-1380"><a href="#Task-1380"><span class="linenos">1380</span></a>            <span class="n">main_target</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
</span><span id="Task-1381"><a href="#Task-1381"><span class="linenos">1381</span></a>            <span class="n">predicted</span><span class="o">=</span><span class="n">full_p</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
</span><span id="Task-1382"><a href="#Task-1382"><span class="linenos">1382</span></a>            <span class="n">ssl_targets</span><span class="o">=</span><span class="p">[],</span>
</span><span id="Task-1383"><a href="#Task-1383"><span class="linenos">1383</span></a>            <span class="n">ssl_predicted</span><span class="o">=</span><span class="p">[],</span>
</span><span id="Task-1384"><a href="#Task-1384"><span class="linenos">1384</span></a>            <span class="n">skip_loss</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task-1385"><a href="#Task-1385"><span class="linenos">1385</span></a>        <span class="p">)</span>
</span><span id="Task-1386"><a href="#Task-1386"><span class="linenos">1386</span></a>        <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_metrics</span><span class="p">()</span>
</span><span id="Task-1387"><a href="#Task-1387"><span class="linenos">1387</span></a>        <span class="k">if</span> <span class="n">smooth_interval</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Task-1388"><a href="#Task-1388"><span class="linenos">1388</span></a>            <span class="n">smoothed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smooth</span><span class="p">(</span><span class="n">full_p</span><span class="p">,</span> <span class="n">smooth_interval</span><span class="o">=</span><span class="n">smooth_interval</span><span class="p">)[</span>
</span><span id="Task-1389"><a href="#Task-1389"><span class="linenos">1389</span></a>                <span class="n">label_ind</span><span class="p">,</span> <span class="p">:</span>
</span><span id="Task-1390"><a href="#Task-1390"><span class="linenos">1390</span></a>            <span class="p">]</span>
</span><span id="Task-1391"><a href="#Task-1391"><span class="linenos">1391</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
</span><span id="Task-1392"><a href="#Task-1392"><span class="linenos">1392</span></a>                <span class="n">c_i</span> <span class="o">=</span> <span class="n">label_keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
</span><span id="Task-1393"><a href="#Task-1393"><span class="linenos">1393</span></a>                <span class="n">output</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique_consecutive</span><span class="p">(</span>
</span><span id="Task-1394"><a href="#Task-1394"><span class="linenos">1394</span></a>                    <span class="n">smoothed</span> <span class="o">==</span> <span class="n">c</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span>
</span><span id="Task-1395"><a href="#Task-1395"><span class="linenos">1395</span></a>                <span class="p">)</span>
</span><span id="Task-1396"><a href="#Task-1396"><span class="linenos">1396</span></a>                <span class="n">long_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Task-1397"><a href="#Task-1397"><span class="linenos">1397</span></a>                <span class="n">res_indices_start</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task-1398"><a href="#Task-1398"><span class="linenos">1398</span></a>                    <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="Task-1399"><a href="#Task-1399"><span class="linenos">1399</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_indices</span>
</span><span id="Task-1400"><a href="#Task-1400"><span class="linenos">1400</span></a>                <span class="p">]</span>
</span><span id="Task-1401"><a href="#Task-1401"><span class="linenos">1401</span></a>                <span class="n">res_indices_end</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task-1402"><a href="#Task-1402"><span class="linenos">1402</span></a>                    <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="Task-1403"><a href="#Task-1403"><span class="linenos">1403</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_indices</span>
</span><span id="Task-1404"><a href="#Task-1404"><span class="linenos">1404</span></a>                <span class="p">]</span>
</span><span id="Task-1405"><a href="#Task-1405"><span class="linenos">1405</span></a>                <span class="n">res_indices_len</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task-1406"><a href="#Task-1406"><span class="linenos">1406</span></a>                    <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="Task-1407"><a href="#Task-1407"><span class="linenos">1407</span></a>                    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">res_indices_start</span><span class="p">,</span> <span class="n">res_indices_end</span><span class="p">)</span>
</span><span id="Task-1408"><a href="#Task-1408"><span class="linenos">1408</span></a>                <span class="p">]</span>
</span><span id="Task-1409"><a href="#Task-1409"><span class="linenos">1409</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">broken_barh</span><span class="p">(</span>
</span><span id="Task-1410"><a href="#Task-1410"><span class="linenos">1410</span></a>                    <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">res_indices_start</span><span class="p">,</span> <span class="n">res_indices_len</span><span class="p">)),</span>
</span><span id="Task-1411"><a href="#Task-1411"><span class="linenos">1411</span></a>                    <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="Task-1412"><a href="#Task-1412"><span class="linenos">1412</span></a>                    <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)],</span>
</span><span id="Task-1413"><a href="#Task-1413"><span class="linenos">1413</span></a>                    <span class="n">facecolors</span><span class="o">=</span><span class="n">color_list</span><span class="p">[</span><span class="n">c_i</span><span class="p">],</span>
</span><span id="Task-1414"><a href="#Task-1414"><span class="linenos">1414</span></a>                <span class="p">)</span>
</span><span id="Task-1415"><a href="#Task-1415"><span class="linenos">1415</span></a>        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="Task-1416"><a href="#Task-1416"><span class="linenos">1416</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
</span><span id="Task-1417"><a href="#Task-1417"><span class="linenos">1417</span></a>            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">label_ind</span><span class="p">)):</span>
</span><span id="Task-1418"><a href="#Task-1418"><span class="linenos">1418</span></a>                <span class="n">metrics</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="Task-1419"><a href="#Task-1419"><span class="linenos">1419</span></a>        <span class="n">title</span> <span class="o">=</span> <span class="p">[</span><span class="n">title</span><span class="p">]</span>
</span><span id="Task-1420"><a href="#Task-1420"><span class="linenos">1420</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Task-1421"><a href="#Task-1421"><span class="linenos">1421</span></a>            <span class="n">title</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Task-1422"><a href="#Task-1422"><span class="linenos">1422</span></a>        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</span><span id="Task-1423"><a href="#Task-1423"><span class="linenos">1423</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">ground_truth</span><span class="p">:</span>
</span><span id="Task-1424"><a href="#Task-1424"><span class="linenos">1424</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Task-1425"><a href="#Task-1425"><span class="linenos">1425</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-1426"><a href="#Task-1426"><span class="linenos">1426</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span><span id="Task-1427"><a href="#Task-1427"><span class="linenos">1427</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span> <span class="s2">&quot;ground truth&quot;</span><span class="p">])</span>
</span><span id="Task-1428"><a href="#Task-1428"><span class="linenos">1428</span></a>        <span class="k">if</span> <span class="n">add_legend</span><span class="p">:</span>
</span><span id="Task-1429"><a href="#Task-1429"><span class="linenos">1429</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="Task-1430"><a href="#Task-1430"><span class="linenos">1430</span></a>        <span class="k">if</span> <span class="n">hide_axes</span><span class="p">:</span>
</span><span id="Task-1431"><a href="#Task-1431"><span class="linenos">1431</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="Task-1432"><a href="#Task-1432"><span class="linenos">1432</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</span><span id="Task-1433"><a href="#Task-1433"><span class="linenos">1433</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction</span><span class="p">)))</span>
</span><span id="Task-1434"><a href="#Task-1434"><span class="linenos">1434</span></a>        <span class="k">if</span> <span class="n">save_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1435"><a href="#Task-1435"><span class="linenos">1435</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="n">transparent</span><span class="p">)</span>
</span><span id="Task-1436"><a href="#Task-1436"><span class="linenos">1436</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="Task-1437"><a href="#Task-1437"><span class="linenos">1437</span></a>
</span><span id="Task-1438"><a href="#Task-1438"><span class="linenos">1438</span></a>    <span class="k">def</span> <span class="nf">visualize_results</span><span class="p">(</span>
</span><span id="Task-1439"><a href="#Task-1439"><span class="linenos">1439</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Task-1440"><a href="#Task-1440"><span class="linenos">1440</span></a>        <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-1441"><a href="#Task-1441"><span class="linenos">1441</span></a>        <span class="n">add_legend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Task-1442"><a href="#Task-1442"><span class="linenos">1442</span></a>        <span class="n">ground_truth</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Task-1443"><a href="#Task-1443"><span class="linenos">1443</span></a>        <span class="n">colormap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
</span><span id="Task-1444"><a href="#Task-1444"><span class="linenos">1444</span></a>        <span class="n">hide_axes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task-1445"><a href="#Task-1445"><span class="linenos">1445</span></a>        <span class="n">min_classes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="Task-1446"><a href="#Task-1446"><span class="linenos">1446</span></a>        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="Task-1447"><a href="#Task-1447"><span class="linenos">1447</span></a>        <span class="n">whole_video</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task-1448"><a href="#Task-1448"><span class="linenos">1448</span></a>        <span class="n">transparent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task-1449"><a href="#Task-1449"><span class="linenos">1449</span></a>        <span class="n">dataset</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">BehaviorDataset</span><span class="p">,</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-1450"><a href="#Task-1450"><span class="linenos">1450</span></a>        <span class="n">drop_classes</span><span class="p">:</span> <span class="n">Set</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-1451"><a href="#Task-1451"><span class="linenos">1451</span></a>        <span class="n">search_classes</span><span class="p">:</span> <span class="n">Set</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-1452"><a href="#Task-1452"><span class="linenos">1452</span></a>        <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="Task-1453"><a href="#Task-1453"><span class="linenos">1453</span></a>        <span class="n">smooth_interval_prediction</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-1454"><a href="#Task-1454"><span class="linenos">1454</span></a>        <span class="n">behavior_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-1455"><a href="#Task-1455"><span class="linenos">1455</span></a>    <span class="p">):</span>
</span><span id="Task-1456"><a href="#Task-1456"><span class="linenos">1456</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1457"><a href="#Task-1457"><span class="linenos">1457</span></a><span class="sd">        Visualize random predictions</span>
</span><span id="Task-1458"><a href="#Task-1458"><span class="linenos">1458</span></a>
</span><span id="Task-1459"><a href="#Task-1459"><span class="linenos">1459</span></a><span class="sd">        Parameters</span>
</span><span id="Task-1460"><a href="#Task-1460"><span class="linenos">1460</span></a><span class="sd">        ----------</span>
</span><span id="Task-1461"><a href="#Task-1461"><span class="linenos">1461</span></a><span class="sd">        save_path : str, optional</span>
</span><span id="Task-1462"><a href="#Task-1462"><span class="linenos">1462</span></a><span class="sd">            the path where the plot will be saved</span>
</span><span id="Task-1463"><a href="#Task-1463"><span class="linenos">1463</span></a><span class="sd">        add_legend : bool, default True</span>
</span><span id="Task-1464"><a href="#Task-1464"><span class="linenos">1464</span></a><span class="sd">            if `True`, legend will be added to the plot</span>
</span><span id="Task-1465"><a href="#Task-1465"><span class="linenos">1465</span></a><span class="sd">        ground_truth : bool, default True</span>
</span><span id="Task-1466"><a href="#Task-1466"><span class="linenos">1466</span></a><span class="sd">            if `True`, ground truth will be added to the plot</span>
</span><span id="Task-1467"><a href="#Task-1467"><span class="linenos">1467</span></a><span class="sd">        colormap : str, default &#39;Accent&#39;</span>
</span><span id="Task-1468"><a href="#Task-1468"><span class="linenos">1468</span></a><span class="sd">            the `matplotlib` colormap to use</span>
</span><span id="Task-1469"><a href="#Task-1469"><span class="linenos">1469</span></a><span class="sd">        hide_axes : bool, default True</span>
</span><span id="Task-1470"><a href="#Task-1470"><span class="linenos">1470</span></a><span class="sd">            if `True`, the axes will be hidden on the plot</span>
</span><span id="Task-1471"><a href="#Task-1471"><span class="linenos">1471</span></a><span class="sd">        min_classes : int, default 1</span>
</span><span id="Task-1472"><a href="#Task-1472"><span class="linenos">1472</span></a><span class="sd">            the minimum number of classes in a displayed interval</span>
</span><span id="Task-1473"><a href="#Task-1473"><span class="linenos">1473</span></a><span class="sd">        width : float, default 10</span>
</span><span id="Task-1474"><a href="#Task-1474"><span class="linenos">1474</span></a><span class="sd">            the width of the plot</span>
</span><span id="Task-1475"><a href="#Task-1475"><span class="linenos">1475</span></a><span class="sd">        whole_video : bool, default False</span>
</span><span id="Task-1476"><a href="#Task-1476"><span class="linenos">1476</span></a><span class="sd">            if `True`, whole videos are plotted instead of segments</span>
</span><span id="Task-1477"><a href="#Task-1477"><span class="linenos">1477</span></a><span class="sd">        transparent : bool, default False</span>
</span><span id="Task-1478"><a href="#Task-1478"><span class="linenos">1478</span></a><span class="sd">            if `True`, the background on the plot is transparent</span>
</span><span id="Task-1479"><a href="#Task-1479"><span class="linenos">1479</span></a><span class="sd">        dataset : BehaviorDataset | DataLoader | str | None, optional</span>
</span><span id="Task-1480"><a href="#Task-1480"><span class="linenos">1480</span></a><span class="sd">            the dataset to make the prediction for (if not provided, the validation dataset is used)</span>
</span><span id="Task-1481"><a href="#Task-1481"><span class="linenos">1481</span></a><span class="sd">        drop_classes : set, optional</span>
</span><span id="Task-1482"><a href="#Task-1482"><span class="linenos">1482</span></a><span class="sd">            a set of class names to not be displayed</span>
</span><span id="Task-1483"><a href="#Task-1483"><span class="linenos">1483</span></a><span class="sd">        search_classes : set, optional</span>
</span><span id="Task-1484"><a href="#Task-1484"><span class="linenos">1484</span></a><span class="sd">            if given, only intervals where at least one of the classes is in ground truth will be shown</span>
</span><span id="Task-1485"><a href="#Task-1485"><span class="linenos">1485</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1486"><a href="#Task-1486"><span class="linenos">1486</span></a>
</span><span id="Task-1487"><a href="#Task-1487"><span class="linenos">1487</span></a>        <span class="k">if</span> <span class="n">drop_classes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1488"><a href="#Task-1488"><span class="linenos">1488</span></a>            <span class="n">drop_classes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Task-1489"><a href="#Task-1489"><span class="linenos">1489</span></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="Task-1490"><a href="#Task-1490"><span class="linenos">1490</span></a>        <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">annotation_class</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;exclusive_classification&quot;</span><span class="p">:</span>
</span><span id="Task-1491"><a href="#Task-1491"><span class="linenos">1491</span></a>            <span class="n">exclusive</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Task-1492"><a href="#Task-1492"><span class="linenos">1492</span></a>        <span class="k">elif</span> <span class="n">dataset</span><span class="o">.</span><span class="n">annotation_class</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;nonexclusive_classification&quot;</span><span class="p">:</span>
</span><span id="Task-1493"><a href="#Task-1493"><span class="linenos">1493</span></a>            <span class="n">exclusive</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Task-1494"><a href="#Task-1494"><span class="linenos">1494</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-1495"><a href="#Task-1495"><span class="linenos">1495</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="Task-1496"><a href="#Task-1496"><span class="linenos">1496</span></a>                <span class="sa">f</span><span class="s2">&quot;Results visualisation is not implemented for </span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">annotation_class</span><span class="p">()</span> <span class="si">}</span><span class="s2"> datasets!&quot;</span>
</span><span id="Task-1497"><a href="#Task-1497"><span class="linenos">1497</span></a>            <span class="p">)</span>
</span><span id="Task-1498"><a href="#Task-1498"><span class="linenos">1498</span></a>        <span class="k">if</span> <span class="n">exclusive</span><span class="p">:</span>
</span><span id="Task-1499"><a href="#Task-1499"><span class="linenos">1499</span></a>            <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Task-1500"><a href="#Task-1500"><span class="linenos">1500</span></a>                <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
</span><span id="Task-1501"><a href="#Task-1501"><span class="linenos">1501</span></a>                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Task-1502"><a href="#Task-1502"><span class="linenos">1502</span></a>                <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">drop_classes</span>
</span><span id="Task-1503"><a href="#Task-1503"><span class="linenos">1503</span></a>            <span class="p">}</span>
</span><span id="Task-1504"><a href="#Task-1504"><span class="linenos">1504</span></a>            <span class="n">labels</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="o">-</span><span class="mi">100</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">})</span>
</span><span id="Task-1505"><a href="#Task-1505"><span class="linenos">1505</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-1506"><a href="#Task-1506"><span class="linenos">1506</span></a>            <span class="n">inverse_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Task-1507"><a href="#Task-1507"><span class="linenos">1507</span></a>            <span class="k">if</span> <span class="n">behavior_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1508"><a href="#Task-1508"><span class="linenos">1508</span></a>                <span class="n">behavior_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inverse_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Task-1509"><a href="#Task-1509"><span class="linenos">1509</span></a>            <span class="n">label_ind</span> <span class="o">=</span> <span class="n">inverse_dict</span><span class="p">[</span><span class="n">behavior_name</span><span class="p">]</span>
</span><span id="Task-1510"><a href="#Task-1510"><span class="linenos">1510</span></a>            <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">}</span>
</span><span id="Task-1511"><a href="#Task-1511"><span class="linenos">1511</span></a>        <span class="n">label_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">labels</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
</span><span id="Task-1512"><a href="#Task-1512"><span class="linenos">1512</span></a>        <span class="k">if</span> <span class="n">search_classes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1513"><a href="#Task-1513"><span class="linenos">1513</span></a>            <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Task-1514"><a href="#Task-1514"><span class="linenos">1514</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-1515"><a href="#Task-1515"><span class="linenos">1515</span></a>            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Task-1516"><a href="#Task-1516"><span class="linenos">1516</span></a>        <span class="n">classes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Task-1517"><a href="#Task-1517"><span class="linenos">1517</span></a>        <span class="k">if</span> <span class="n">whole_video</span><span class="p">:</span>
</span><span id="Task-1518"><a href="#Task-1518"><span class="linenos">1518</span></a>            <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_full_length_prediction</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="Task-1519"><a href="#Task-1519"><span class="linenos">1519</span></a>            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">predicted</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="Task-1520"><a href="#Task-1520"><span class="linenos">1520</span></a>        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Task-1521"><a href="#Task-1521"><span class="linenos">1521</span></a>        <span class="k">if</span> <span class="n">whole_video</span><span class="p">:</span>
</span><span id="Task-1522"><a href="#Task-1522"><span class="linenos">1522</span></a>            <span class="n">max_iter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
</span><span id="Task-1523"><a href="#Task-1523"><span class="linenos">1523</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-1524"><a href="#Task-1524"><span class="linenos">1524</span></a>            <span class="n">max_iter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
</span><span id="Task-1525"><a href="#Task-1525"><span class="linenos">1525</span></a>        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_classes</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
</span><span id="Task-1526"><a href="#Task-1526"><span class="linenos">1526</span></a>            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Task-1527"><a href="#Task-1527"><span class="linenos">1527</span></a>            <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="n">max_iter</span><span class="p">:</span>
</span><span id="Task-1528"><a href="#Task-1528"><span class="linenos">1528</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="Task-1529"><a href="#Task-1529"><span class="linenos">1529</span></a>                    <span class="s2">&quot;Plotting is taking too many iterations; you should probably make some of the parameters less restrictive&quot;</span>
</span><span id="Task-1530"><a href="#Task-1530"><span class="linenos">1530</span></a>                <span class="p">)</span>
</span><span id="Task-1531"><a href="#Task-1531"><span class="linenos">1531</span></a>            <span class="k">if</span> <span class="n">whole_video</span><span class="p">:</span>
</span><span id="Task-1532"><a href="#Task-1532"><span class="linenos">1532</span></a>                <span class="n">i</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Task-1533"><a href="#Task-1533"><span class="linenos">1533</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="n">predicted</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
</span><span id="Task-1534"><a href="#Task-1534"><span class="linenos">1534</span></a>                <span class="n">keys_i</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">prediction</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="Task-1535"><a href="#Task-1535"><span class="linenos">1535</span></a>                <span class="n">j</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys_i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Task-1536"><a href="#Task-1536"><span class="linenos">1536</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="n">keys_i</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
</span><span id="Task-1537"><a href="#Task-1537"><span class="linenos">1537</span></a>                <span class="n">key1</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="Task-1538"><a href="#Task-1538"><span class="linenos">1538</span></a>                <span class="n">key2</span> <span class="o">=</span> <span class="n">keys_i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="Task-1539"><a href="#Task-1539"><span class="linenos">1539</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Task-1540"><a href="#Task-1540"><span class="linenos">1540</span></a>                <span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="Task-1541"><a href="#Task-1541"><span class="linenos">1541</span></a>                <span class="n">i</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Task-1542"><a href="#Task-1542"><span class="linenos">1542</span></a>                <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
</span><span id="Task-1543"><a href="#Task-1543"><span class="linenos">1543</span></a>                    <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
</span><span id="Task-1544"><a href="#Task-1544"><span class="linenos">1544</span></a>                        <span class="k">break</span>
</span><span id="Task-1545"><a href="#Task-1545"><span class="linenos">1545</span></a>                <span class="nb">input</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Task-1546"><a href="#Task-1546"><span class="linenos">1546</span></a>                <span class="n">prediction</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_prediction</span><span class="p">(</span>
</span><span id="Task-1547"><a href="#Task-1547"><span class="linenos">1547</span></a>                    <span class="nb">input</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">),</span> <span class="n">augment_n</span><span class="o">=</span><span class="mi">5</span>
</span><span id="Task-1548"><a href="#Task-1548"><span class="linenos">1548</span></a>                <span class="p">)</span>
</span><span id="Task-1549"><a href="#Task-1549"><span class="linenos">1549</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_predict_functions</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
</span><span id="Task-1550"><a href="#Task-1550"><span class="linenos">1550</span></a>                <span class="n">j</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Task-1551"><a href="#Task-1551"><span class="linenos">1551</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="Task-1552"><a href="#Task-1552"><span class="linenos">1552</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">exclusive</span><span class="p">:</span>
</span><span id="Task-1553"><a href="#Task-1553"><span class="linenos">1553</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="n">label_ind</span><span class="p">]</span>
</span><span id="Task-1554"><a href="#Task-1554"><span class="linenos">1554</span></a>            <span class="k">if</span> <span class="n">smooth_interval_prediction</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Task-1555"><a href="#Task-1555"><span class="linenos">1555</span></a>                <span class="n">unsmoothed_prediction</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
</span><span id="Task-1556"><a href="#Task-1556"><span class="linenos">1556</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smooth</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">smooth_interval_prediction</span><span class="p">)</span>
</span><span id="Task-1557"><a href="#Task-1557"><span class="linenos">1557</span></a>                <span class="n">height</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="Task-1558"><a href="#Task-1558"><span class="linenos">1558</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Task-1559"><a href="#Task-1559"><span class="linenos">1559</span></a>                <span class="n">height</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="Task-1560"><a href="#Task-1560"><span class="linenos">1560</span></a>            <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task-1561"><a href="#Task-1561"><span class="linenos">1561</span></a>                <span class="n">labels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">label_keys</span>
</span><span id="Task-1562"><a href="#Task-1562"><span class="linenos">1562</span></a>            <span class="p">]</span>
</span><span id="Task-1563"><a href="#Task-1563"><span class="linenos">1563</span></a>            <span class="k">if</span> <span class="n">search_classes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1564"><a href="#Task-1564"><span class="linenos">1564</span></a>                <span class="n">ok</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">x</span> <span class="ow">in</span> <span class="n">classes</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">search_classes</span><span class="p">])</span>
</span><span id="Task-1565"><a href="#Task-1565"><span class="linenos">1565</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="Task-1566"><a href="#Task-1566"><span class="linenos">1566</span></a>        <span class="n">color_list</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="n">lut</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span><span class="o">.</span><span class="n">colors</span>
</span><span id="Task-1567"><a href="#Task-1567"><span class="linenos">1567</span></a>
</span><span id="Task-1568"><a href="#Task-1568"><span class="linenos">1568</span></a>        <span class="k">def</span> <span class="nf">_plot_prediction</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">set_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="Task-1569"><a href="#Task-1569"><span class="linenos">1569</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">label_keys</span><span class="p">:</span>
</span><span id="Task-1570"><a href="#Task-1570"><span class="linenos">1570</span></a>                <span class="n">c_i</span> <span class="o">=</span> <span class="n">label_keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
</span><span id="Task-1571"><a href="#Task-1571"><span class="linenos">1571</span></a>                <span class="n">output</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique_consecutive</span><span class="p">(</span>
</span><span id="Task-1572"><a href="#Task-1572"><span class="linenos">1572</span></a>                    <span class="n">prediction</span> <span class="o">==</span> <span class="n">c</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span>
</span><span id="Task-1573"><a href="#Task-1573"><span class="linenos">1573</span></a>                <span class="p">)</span>
</span><span id="Task-1574"><a href="#Task-1574"><span class="linenos">1574</span></a>                <span class="n">long_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Task-1575"><a href="#Task-1575"><span class="linenos">1575</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">long_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Task-1576"><a href="#Task-1576"><span class="linenos">1576</span></a>                    <span class="k">continue</span>
</span><span id="Task-1577"><a href="#Task-1577"><span class="linenos">1577</span></a>                <span class="n">res_indices_start</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task-1578"><a href="#Task-1578"><span class="linenos">1578</span></a>                    <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="Task-1579"><a href="#Task-1579"><span class="linenos">1579</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_indices</span>
</span><span id="Task-1580"><a href="#Task-1580"><span class="linenos">1580</span></a>                <span class="p">]</span>
</span><span id="Task-1581"><a href="#Task-1581"><span class="linenos">1581</span></a>                <span class="n">res_indices_end</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task-1582"><a href="#Task-1582"><span class="linenos">1582</span></a>                    <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="Task-1583"><a href="#Task-1583"><span class="linenos">1583</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_indices</span>
</span><span id="Task-1584"><a href="#Task-1584"><span class="linenos">1584</span></a>                <span class="p">]</span>
</span><span id="Task-1585"><a href="#Task-1585"><span class="linenos">1585</span></a>                <span class="n">res_indices_len</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task-1586"><a href="#Task-1586"><span class="linenos">1586</span></a>                    <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="Task-1587"><a href="#Task-1587"><span class="linenos">1587</span></a>                    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">res_indices_start</span><span class="p">,</span> <span class="n">res_indices_end</span><span class="p">)</span>
</span><span id="Task-1588"><a href="#Task-1588"><span class="linenos">1588</span></a>                <span class="p">]</span>
</span><span id="Task-1589"><a href="#Task-1589"><span class="linenos">1589</span></a>                <span class="k">if</span> <span class="n">set_labels</span><span class="p">:</span>
</span><span id="Task-1590"><a href="#Task-1590"><span class="linenos">1590</span></a>                    <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span>
</span><span id="Task-1591"><a href="#Task-1591"><span class="linenos">1591</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Task-1592"><a href="#Task-1592"><span class="linenos">1592</span></a>                    <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Task-1593"><a href="#Task-1593"><span class="linenos">1593</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">broken_barh</span><span class="p">(</span>
</span><span id="Task-1594"><a href="#Task-1594"><span class="linenos">1594</span></a>                    <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">res_indices_start</span><span class="p">,</span> <span class="n">res_indices_len</span><span class="p">)),</span>
</span><span id="Task-1595"><a href="#Task-1595"><span class="linenos">1595</span></a>                    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="Task-1596"><a href="#Task-1596"><span class="linenos">1596</span></a>                    <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
</span><span id="Task-1597"><a href="#Task-1597"><span class="linenos">1597</span></a>                    <span class="n">facecolors</span><span class="o">=</span><span class="n">color_list</span><span class="p">[</span><span class="n">c_i</span><span class="p">],</span>
</span><span id="Task-1598"><a href="#Task-1598"><span class="linenos">1598</span></a>                <span class="p">)</span>
</span><span id="Task-1599"><a href="#Task-1599"><span class="linenos">1599</span></a>
</span><span id="Task-1600"><a href="#Task-1600"><span class="linenos">1600</span></a>        <span class="k">if</span> <span class="n">smooth_interval_prediction</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Task-1601"><a href="#Task-1601"><span class="linenos">1601</span></a>            <span class="n">_plot_prediction</span><span class="p">(</span><span class="n">unsmoothed_prediction</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="Task-1602"><a href="#Task-1602"><span class="linenos">1602</span></a>            <span class="n">_plot_prediction</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">set_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Task-1603"><a href="#Task-1603"><span class="linenos">1603</span></a>            <span class="n">gt_height</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="Task-1604"><a href="#Task-1604"><span class="linenos">1604</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-1605"><a href="#Task-1605"><span class="linenos">1605</span></a>            <span class="n">_plot_prediction</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="Task-1606"><a href="#Task-1606"><span class="linenos">1606</span></a>            <span class="n">gt_height</span> <span class="o">=</span> <span class="mf">1.5</span>
</span><span id="Task-1607"><a href="#Task-1607"><span class="linenos">1607</span></a>        <span class="k">if</span> <span class="n">ground_truth</span><span class="p">:</span>
</span><span id="Task-1608"><a href="#Task-1608"><span class="linenos">1608</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">whole_video</span><span class="p">:</span>
</span><span id="Task-1609"><a href="#Task-1609"><span class="linenos">1609</span></a>                <span class="n">gt</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Task-1610"><a href="#Task-1610"><span class="linenos">1610</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Task-1611"><a href="#Task-1611"><span class="linenos">1611</span></a>                <span class="n">gt</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">generate_full_length_gt</span><span class="p">()[</span><span class="n">key1</span><span class="p">][</span><span class="n">key2</span><span class="p">]</span>
</span><span id="Task-1612"><a href="#Task-1612"><span class="linenos">1612</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">label_keys</span><span class="p">:</span>
</span><span id="Task-1613"><a href="#Task-1613"><span class="linenos">1613</span></a>                <span class="n">c_i</span> <span class="o">=</span> <span class="n">label_keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
</span><span id="Task-1614"><a href="#Task-1614"><span class="linenos">1614</span></a>                <span class="k">if</span> <span class="n">labels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
</span><span id="Task-1615"><a href="#Task-1615"><span class="linenos">1615</span></a>                    <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Task-1616"><a href="#Task-1616"><span class="linenos">1616</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Task-1617"><a href="#Task-1617"><span class="linenos">1617</span></a>                    <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span>
</span><span id="Task-1618"><a href="#Task-1618"><span class="linenos">1618</span></a>                <span class="n">output</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique_consecutive</span><span class="p">(</span>
</span><span id="Task-1619"><a href="#Task-1619"><span class="linenos">1619</span></a>                    <span class="n">gt</span> <span class="o">==</span> <span class="n">c</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span>
</span><span id="Task-1620"><a href="#Task-1620"><span class="linenos">1620</span></a>                <span class="p">)</span>
</span><span id="Task-1621"><a href="#Task-1621"><span class="linenos">1621</span></a>                <span class="n">long_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Task-1622"><a href="#Task-1622"><span class="linenos">1622</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">long_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Task-1623"><a href="#Task-1623"><span class="linenos">1623</span></a>                    <span class="k">continue</span>
</span><span id="Task-1624"><a href="#Task-1624"><span class="linenos">1624</span></a>                <span class="n">res_indices_start</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task-1625"><a href="#Task-1625"><span class="linenos">1625</span></a>                    <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="Task-1626"><a href="#Task-1626"><span class="linenos">1626</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_indices</span>
</span><span id="Task-1627"><a href="#Task-1627"><span class="linenos">1627</span></a>                <span class="p">]</span>
</span><span id="Task-1628"><a href="#Task-1628"><span class="linenos">1628</span></a>                <span class="n">res_indices_end</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task-1629"><a href="#Task-1629"><span class="linenos">1629</span></a>                    <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="Task-1630"><a href="#Task-1630"><span class="linenos">1630</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_indices</span>
</span><span id="Task-1631"><a href="#Task-1631"><span class="linenos">1631</span></a>                <span class="p">]</span>
</span><span id="Task-1632"><a href="#Task-1632"><span class="linenos">1632</span></a>                <span class="n">res_indices_len</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task-1633"><a href="#Task-1633"><span class="linenos">1633</span></a>                    <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="Task-1634"><a href="#Task-1634"><span class="linenos">1634</span></a>                    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">res_indices_start</span><span class="p">,</span> <span class="n">res_indices_end</span><span class="p">)</span>
</span><span id="Task-1635"><a href="#Task-1635"><span class="linenos">1635</span></a>                <span class="p">]</span>
</span><span id="Task-1636"><a href="#Task-1636"><span class="linenos">1636</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">broken_barh</span><span class="p">(</span>
</span><span id="Task-1637"><a href="#Task-1637"><span class="linenos">1637</span></a>                    <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">res_indices_start</span><span class="p">,</span> <span class="n">res_indices_len</span><span class="p">)),</span>
</span><span id="Task-1638"><a href="#Task-1638"><span class="linenos">1638</span></a>                    <span class="p">(</span><span class="n">gt_height</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="Task-1639"><a href="#Task-1639"><span class="linenos">1639</span></a>                    <span class="n">facecolors</span><span class="o">=</span><span class="n">color_list</span><span class="p">[</span><span class="n">c_i</span><span class="p">]</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&quot;unknown&quot;</span> <span class="k">else</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span>
</span><span id="Task-1640"><a href="#Task-1640"><span class="linenos">1640</span></a>                    <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
</span><span id="Task-1641"><a href="#Task-1641"><span class="linenos">1641</span></a>                <span class="p">)</span>
</span><span id="Task-1642"><a href="#Task-1642"><span class="linenos">1642</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">ground_truth</span><span class="p">:</span>
</span><span id="Task-1643"><a href="#Task-1643"><span class="linenos">1643</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Task-1644"><a href="#Task-1644"><span class="linenos">1644</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-1645"><a href="#Task-1645"><span class="linenos">1645</span></a>            <span class="k">if</span> <span class="n">smooth_interval_prediction</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Task-1646"><a href="#Task-1646"><span class="linenos">1646</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">])</span>
</span><span id="Task-1647"><a href="#Task-1647"><span class="linenos">1647</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span> <span class="s2">&quot;smoothed&quot;</span><span class="p">,</span> <span class="s2">&quot;ground truth&quot;</span><span class="p">])</span>
</span><span id="Task-1648"><a href="#Task-1648"><span class="linenos">1648</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Task-1649"><a href="#Task-1649"><span class="linenos">1649</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span><span id="Task-1650"><a href="#Task-1650"><span class="linenos">1650</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span> <span class="s2">&quot;ground truth&quot;</span><span class="p">])</span>
</span><span id="Task-1651"><a href="#Task-1651"><span class="linenos">1651</span></a>        <span class="k">if</span> <span class="n">add_legend</span><span class="p">:</span>
</span><span id="Task-1652"><a href="#Task-1652"><span class="linenos">1652</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
</span><span id="Task-1653"><a href="#Task-1653"><span class="linenos">1653</span></a>        <span class="k">if</span> <span class="n">hide_axes</span><span class="p">:</span>
</span><span id="Task-1654"><a href="#Task-1654"><span class="linenos">1654</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="Task-1655"><a href="#Task-1655"><span class="linenos">1655</span></a>        <span class="k">if</span> <span class="n">save_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1656"><a href="#Task-1656"><span class="linenos">1656</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="n">transparent</span><span class="p">)</span>
</span><span id="Task-1657"><a href="#Task-1657"><span class="linenos">1657</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="Task-1658"><a href="#Task-1658"><span class="linenos">1658</span></a>
</span><span id="Task-1659"><a href="#Task-1659"><span class="linenos">1659</span></a>    <span class="k">def</span> <span class="nf">set_ssl_transformations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ssl_transformations</span><span class="p">):</span>
</span><span id="Task-1660"><a href="#Task-1660"><span class="linenos">1660</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">set_ssl_transformations</span><span class="p">(</span><span class="n">ssl_transformations</span><span class="p">)</span>
</span><span id="Task-1661"><a href="#Task-1661"><span class="linenos">1661</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1662"><a href="#Task-1662"><span class="linenos">1662</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">set_ssl_transformations</span><span class="p">(</span><span class="n">ssl_transformations</span><span class="p">)</span>
</span><span id="Task-1663"><a href="#Task-1663"><span class="linenos">1663</span></a>
</span><span id="Task-1664"><a href="#Task-1664"><span class="linenos">1664</span></a>    <span class="k">def</span> <span class="nf">set_ssl_losses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ssl_losses</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1665"><a href="#Task-1665"><span class="linenos">1665</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1666"><a href="#Task-1666"><span class="linenos">1666</span></a><span class="sd">        Set SSL losses</span>
</span><span id="Task-1667"><a href="#Task-1667"><span class="linenos">1667</span></a>
</span><span id="Task-1668"><a href="#Task-1668"><span class="linenos">1668</span></a><span class="sd">        Parameters</span>
</span><span id="Task-1669"><a href="#Task-1669"><span class="linenos">1669</span></a><span class="sd">        ----------</span>
</span><span id="Task-1670"><a href="#Task-1670"><span class="linenos">1670</span></a><span class="sd">        ssl_losses : list</span>
</span><span id="Task-1671"><a href="#Task-1671"><span class="linenos">1671</span></a><span class="sd">            a list of callable SSL losses</span>
</span><span id="Task-1672"><a href="#Task-1672"><span class="linenos">1672</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1673"><a href="#Task-1673"><span class="linenos">1673</span></a>
</span><span id="Task-1674"><a href="#Task-1674"><span class="linenos">1674</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ssl_losses</span> <span class="o">=</span> <span class="n">ssl_losses</span>
</span><span id="Task-1675"><a href="#Task-1675"><span class="linenos">1675</span></a>
</span><span id="Task-1676"><a href="#Task-1676"><span class="linenos">1676</span></a>    <span class="k">def</span> <span class="nf">set_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1677"><a href="#Task-1677"><span class="linenos">1677</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1678"><a href="#Task-1678"><span class="linenos">1678</span></a><span class="sd">        Set the log file</span>
</span><span id="Task-1679"><a href="#Task-1679"><span class="linenos">1679</span></a>
</span><span id="Task-1680"><a href="#Task-1680"><span class="linenos">1680</span></a><span class="sd">        Parameters</span>
</span><span id="Task-1681"><a href="#Task-1681"><span class="linenos">1681</span></a><span class="sd">        ----------</span>
</span><span id="Task-1682"><a href="#Task-1682"><span class="linenos">1682</span></a><span class="sd">        log: str</span>
</span><span id="Task-1683"><a href="#Task-1683"><span class="linenos">1683</span></a><span class="sd">            the mew log file path</span>
</span><span id="Task-1684"><a href="#Task-1684"><span class="linenos">1684</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1685"><a href="#Task-1685"><span class="linenos">1685</span></a>
</span><span id="Task-1686"><a href="#Task-1686"><span class="linenos">1686</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="n">log</span>
</span><span id="Task-1687"><a href="#Task-1687"><span class="linenos">1687</span></a>
</span><span id="Task-1688"><a href="#Task-1688"><span class="linenos">1688</span></a>    <span class="k">def</span> <span class="nf">set_keep_target_none</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep_target_none</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1689"><a href="#Task-1689"><span class="linenos">1689</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1690"><a href="#Task-1690"><span class="linenos">1690</span></a><span class="sd">        Set the keep_target_none parameter of the transformer</span>
</span><span id="Task-1691"><a href="#Task-1691"><span class="linenos">1691</span></a>
</span><span id="Task-1692"><a href="#Task-1692"><span class="linenos">1692</span></a><span class="sd">        Parameters</span>
</span><span id="Task-1693"><a href="#Task-1693"><span class="linenos">1693</span></a><span class="sd">        ----------</span>
</span><span id="Task-1694"><a href="#Task-1694"><span class="linenos">1694</span></a><span class="sd">        keep_target_none : list</span>
</span><span id="Task-1695"><a href="#Task-1695"><span class="linenos">1695</span></a><span class="sd">            a list of bool values</span>
</span><span id="Task-1696"><a href="#Task-1696"><span class="linenos">1696</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1697"><a href="#Task-1697"><span class="linenos">1697</span></a>
</span><span id="Task-1698"><a href="#Task-1698"><span class="linenos">1698</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">keep_target_none</span> <span class="o">=</span> <span class="n">keep_target_none</span>
</span><span id="Task-1699"><a href="#Task-1699"><span class="linenos">1699</span></a>
</span><span id="Task-1700"><a href="#Task-1700"><span class="linenos">1700</span></a>    <span class="k">def</span> <span class="nf">set_generate_ssl_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generate_ssl_input</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1701"><a href="#Task-1701"><span class="linenos">1701</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1702"><a href="#Task-1702"><span class="linenos">1702</span></a><span class="sd">        Set the generate_ssl_input parameter of the transformer</span>
</span><span id="Task-1703"><a href="#Task-1703"><span class="linenos">1703</span></a>
</span><span id="Task-1704"><a href="#Task-1704"><span class="linenos">1704</span></a><span class="sd">        Parameters</span>
</span><span id="Task-1705"><a href="#Task-1705"><span class="linenos">1705</span></a><span class="sd">        ----------</span>
</span><span id="Task-1706"><a href="#Task-1706"><span class="linenos">1706</span></a><span class="sd">        generate_ssl_input : list</span>
</span><span id="Task-1707"><a href="#Task-1707"><span class="linenos">1707</span></a><span class="sd">            a list of bool values</span>
</span><span id="Task-1708"><a href="#Task-1708"><span class="linenos">1708</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1709"><a href="#Task-1709"><span class="linenos">1709</span></a>
</span><span id="Task-1710"><a href="#Task-1710"><span class="linenos">1710</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">generate_ssl_input</span> <span class="o">=</span> <span class="n">generate_ssl_input</span>
</span><span id="Task-1711"><a href="#Task-1711"><span class="linenos">1711</span></a>
</span><span id="Task-1712"><a href="#Task-1712"><span class="linenos">1712</span></a>    <span class="k">def</span> <span class="nf">set_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1713"><a href="#Task-1713"><span class="linenos">1713</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1714"><a href="#Task-1714"><span class="linenos">1714</span></a><span class="sd">        Set a new model</span>
</span><span id="Task-1715"><a href="#Task-1715"><span class="linenos">1715</span></a>
</span><span id="Task-1716"><a href="#Task-1716"><span class="linenos">1716</span></a><span class="sd">        Parameters</span>
</span><span id="Task-1717"><a href="#Task-1717"><span class="linenos">1717</span></a><span class="sd">        ----------</span>
</span><span id="Task-1718"><a href="#Task-1718"><span class="linenos">1718</span></a><span class="sd">        model: Model</span>
</span><span id="Task-1719"><a href="#Task-1719"><span class="linenos">1719</span></a><span class="sd">            the new model</span>
</span><span id="Task-1720"><a href="#Task-1720"><span class="linenos">1720</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1721"><a href="#Task-1721"><span class="linenos">1721</span></a>
</span><span id="Task-1722"><a href="#Task-1722"><span class="linenos">1722</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Task-1723"><a href="#Task-1723"><span class="linenos">1723</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="Task-1724"><a href="#Task-1724"><span class="linenos">1724</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_class</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
</span><span id="Task-1725"><a href="#Task-1725"><span class="linenos">1725</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">process_labels</span><span class="p">:</span>
</span><span id="Task-1726"><a href="#Task-1726"><span class="linenos">1726</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_behaviors</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</span><span id="Task-1727"><a href="#Task-1727"><span class="linenos">1727</span></a>
</span><span id="Task-1728"><a href="#Task-1728"><span class="linenos">1728</span></a>    <span class="k">def</span> <span class="nf">set_dataloaders</span><span class="p">(</span>
</span><span id="Task-1729"><a href="#Task-1729"><span class="linenos">1729</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Task-1730"><a href="#Task-1730"><span class="linenos">1730</span></a>        <span class="n">train_dataloader</span><span class="p">:</span> <span class="n">DataLoader</span><span class="p">,</span>
</span><span id="Task-1731"><a href="#Task-1731"><span class="linenos">1731</span></a>        <span class="n">val_dataloader</span><span class="p">:</span> <span class="n">DataLoader</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-1732"><a href="#Task-1732"><span class="linenos">1732</span></a>        <span class="n">test_dataloader</span><span class="p">:</span> <span class="n">DataLoader</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-1733"><a href="#Task-1733"><span class="linenos">1733</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1734"><a href="#Task-1734"><span class="linenos">1734</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1735"><a href="#Task-1735"><span class="linenos">1735</span></a><span class="sd">        Set new dataloaders</span>
</span><span id="Task-1736"><a href="#Task-1736"><span class="linenos">1736</span></a>
</span><span id="Task-1737"><a href="#Task-1737"><span class="linenos">1737</span></a><span class="sd">        Parameters</span>
</span><span id="Task-1738"><a href="#Task-1738"><span class="linenos">1738</span></a><span class="sd">        ----------</span>
</span><span id="Task-1739"><a href="#Task-1739"><span class="linenos">1739</span></a><span class="sd">        train_dataloader: torch.utils.data.DataLoader</span>
</span><span id="Task-1740"><a href="#Task-1740"><span class="linenos">1740</span></a><span class="sd">            the new train dataloader</span>
</span><span id="Task-1741"><a href="#Task-1741"><span class="linenos">1741</span></a><span class="sd">        val_dataloader : torch.utils.data.DataLoader</span>
</span><span id="Task-1742"><a href="#Task-1742"><span class="linenos">1742</span></a><span class="sd">            the new validation dataloader</span>
</span><span id="Task-1743"><a href="#Task-1743"><span class="linenos">1743</span></a><span class="sd">        test_dataloader : torch.utils.data.DataLoader</span>
</span><span id="Task-1744"><a href="#Task-1744"><span class="linenos">1744</span></a><span class="sd">            the new test dataloader</span>
</span><span id="Task-1745"><a href="#Task-1745"><span class="linenos">1745</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1746"><a href="#Task-1746"><span class="linenos">1746</span></a>
</span><span id="Task-1747"><a href="#Task-1747"><span class="linenos">1747</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">train_dataloader</span>
</span><span id="Task-1748"><a href="#Task-1748"><span class="linenos">1748</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span> <span class="o">=</span> <span class="n">val_dataloader</span>
</span><span id="Task-1749"><a href="#Task-1749"><span class="linenos">1749</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_dataloader</span> <span class="o">=</span> <span class="n">test_dataloader</span>
</span><span id="Task-1750"><a href="#Task-1750"><span class="linenos">1750</span></a>
</span><span id="Task-1751"><a href="#Task-1751"><span class="linenos">1751</span></a>    <span class="k">def</span> <span class="nf">set_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1752"><a href="#Task-1752"><span class="linenos">1752</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1753"><a href="#Task-1753"><span class="linenos">1753</span></a><span class="sd">        Set new loss function</span>
</span><span id="Task-1754"><a href="#Task-1754"><span class="linenos">1754</span></a>
</span><span id="Task-1755"><a href="#Task-1755"><span class="linenos">1755</span></a><span class="sd">        Parameters</span>
</span><span id="Task-1756"><a href="#Task-1756"><span class="linenos">1756</span></a><span class="sd">        ----------</span>
</span><span id="Task-1757"><a href="#Task-1757"><span class="linenos">1757</span></a><span class="sd">        loss: callable</span>
</span><span id="Task-1758"><a href="#Task-1758"><span class="linenos">1758</span></a><span class="sd">            the new loss function</span>
</span><span id="Task-1759"><a href="#Task-1759"><span class="linenos">1759</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1760"><a href="#Task-1760"><span class="linenos">1760</span></a>
</span><span id="Task-1761"><a href="#Task-1761"><span class="linenos">1761</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span>
</span><span id="Task-1762"><a href="#Task-1762"><span class="linenos">1762</span></a>
</span><span id="Task-1763"><a href="#Task-1763"><span class="linenos">1763</span></a>    <span class="k">def</span> <span class="nf">set_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1764"><a href="#Task-1764"><span class="linenos">1764</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1765"><a href="#Task-1765"><span class="linenos">1765</span></a><span class="sd">        Set new metric</span>
</span><span id="Task-1766"><a href="#Task-1766"><span class="linenos">1766</span></a>
</span><span id="Task-1767"><a href="#Task-1767"><span class="linenos">1767</span></a><span class="sd">        Parameters</span>
</span><span id="Task-1768"><a href="#Task-1768"><span class="linenos">1768</span></a><span class="sd">        ----------</span>
</span><span id="Task-1769"><a href="#Task-1769"><span class="linenos">1769</span></a><span class="sd">        metrics : dict</span>
</span><span id="Task-1770"><a href="#Task-1770"><span class="linenos">1770</span></a><span class="sd">            the new metric dictionary</span>
</span><span id="Task-1771"><a href="#Task-1771"><span class="linenos">1771</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1772"><a href="#Task-1772"><span class="linenos">1772</span></a>
</span><span id="Task-1773"><a href="#Task-1773"><span class="linenos">1773</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics</span>
</span><span id="Task-1774"><a href="#Task-1774"><span class="linenos">1774</span></a>
</span><span id="Task-1775"><a href="#Task-1775"><span class="linenos">1775</span></a>    <span class="k">def</span> <span class="nf">set_transformer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transformer</span><span class="p">:</span> <span class="n">Transformer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1776"><a href="#Task-1776"><span class="linenos">1776</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1777"><a href="#Task-1777"><span class="linenos">1777</span></a><span class="sd">        Set a new transformer</span>
</span><span id="Task-1778"><a href="#Task-1778"><span class="linenos">1778</span></a>
</span><span id="Task-1779"><a href="#Task-1779"><span class="linenos">1779</span></a><span class="sd">        Parameters</span>
</span><span id="Task-1780"><a href="#Task-1780"><span class="linenos">1780</span></a><span class="sd">        ----------</span>
</span><span id="Task-1781"><a href="#Task-1781"><span class="linenos">1781</span></a><span class="sd">        transformer: Transformer</span>
</span><span id="Task-1782"><a href="#Task-1782"><span class="linenos">1782</span></a><span class="sd">            the new transformer</span>
</span><span id="Task-1783"><a href="#Task-1783"><span class="linenos">1783</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1784"><a href="#Task-1784"><span class="linenos">1784</span></a>
</span><span id="Task-1785"><a href="#Task-1785"><span class="linenos">1785</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="o">=</span> <span class="n">transformer</span>
</span><span id="Task-1786"><a href="#Task-1786"><span class="linenos">1786</span></a>
</span><span id="Task-1787"><a href="#Task-1787"><span class="linenos">1787</span></a>    <span class="k">def</span> <span class="nf">set_predict_functions</span><span class="p">(</span>
</span><span id="Task-1788"><a href="#Task-1788"><span class="linenos">1788</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">primary_predict_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">predict_function</span><span class="p">:</span> <span class="n">Callable</span>
</span><span id="Task-1789"><a href="#Task-1789"><span class="linenos">1789</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1790"><a href="#Task-1790"><span class="linenos">1790</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1791"><a href="#Task-1791"><span class="linenos">1791</span></a><span class="sd">        Set new predict functions</span>
</span><span id="Task-1792"><a href="#Task-1792"><span class="linenos">1792</span></a>
</span><span id="Task-1793"><a href="#Task-1793"><span class="linenos">1793</span></a><span class="sd">        Parameters</span>
</span><span id="Task-1794"><a href="#Task-1794"><span class="linenos">1794</span></a><span class="sd">        ----------</span>
</span><span id="Task-1795"><a href="#Task-1795"><span class="linenos">1795</span></a><span class="sd">        primary_predict_function : callable</span>
</span><span id="Task-1796"><a href="#Task-1796"><span class="linenos">1796</span></a><span class="sd">            the new primary predict function</span>
</span><span id="Task-1797"><a href="#Task-1797"><span class="linenos">1797</span></a><span class="sd">        predict_function : callable</span>
</span><span id="Task-1798"><a href="#Task-1798"><span class="linenos">1798</span></a><span class="sd">            the new predict function</span>
</span><span id="Task-1799"><a href="#Task-1799"><span class="linenos">1799</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1800"><a href="#Task-1800"><span class="linenos">1800</span></a>
</span><span id="Task-1801"><a href="#Task-1801"><span class="linenos">1801</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">primary_predict_function</span> <span class="o">=</span> <span class="n">primary_predict_function</span>
</span><span id="Task-1802"><a href="#Task-1802"><span class="linenos">1802</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">predict_function</span> <span class="o">=</span> <span class="n">predict_function</span>
</span><span id="Task-1803"><a href="#Task-1803"><span class="linenos">1803</span></a>
</span><span id="Task-1804"><a href="#Task-1804"><span class="linenos">1804</span></a>    <span class="k">def</span> <span class="nf">_set_pseudolabels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Task-1805"><a href="#Task-1805"><span class="linenos">1805</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1806"><a href="#Task-1806"><span class="linenos">1806</span></a><span class="sd">        Set pseudolabels</span>
</span><span id="Task-1807"><a href="#Task-1807"><span class="linenos">1807</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1808"><a href="#Task-1808"><span class="linenos">1808</span></a>
</span><span id="Task-1809"><a href="#Task-1809"><span class="linenos">1809</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">set_unlabeled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Task-1810"><a href="#Task-1810"><span class="linenos">1810</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
</span><span id="Task-1811"><a href="#Task-1811"><span class="linenos">1811</span></a>            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">),</span>
</span><span id="Task-1812"><a href="#Task-1812"><span class="linenos">1812</span></a>            <span class="n">raw_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Task-1813"><a href="#Task-1813"><span class="linenos">1813</span></a>            <span class="n">augment_n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">augment_val</span><span class="p">,</span>
</span><span id="Task-1814"><a href="#Task-1814"><span class="linenos">1814</span></a>            <span class="n">ssl_off</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task-1815"><a href="#Task-1815"><span class="linenos">1815</span></a>        <span class="p">)</span>
</span><span id="Task-1816"><a href="#Task-1816"><span class="linenos">1816</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">set_annotation</span><span class="p">(</span><span class="n">predicted</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>
</span><span id="Task-1817"><a href="#Task-1817"><span class="linenos">1817</span></a>
</span><span id="Task-1818"><a href="#Task-1818"><span class="linenos">1818</span></a>    <span class="k">def</span> <span class="nf">_alpha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
</span><span id="Task-1819"><a href="#Task-1819"><span class="linenos">1819</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1820"><a href="#Task-1820"><span class="linenos">1820</span></a><span class="sd">        Get the current pseudolabeling alpha parameter</span>
</span><span id="Task-1821"><a href="#Task-1821"><span class="linenos">1821</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1822"><a href="#Task-1822"><span class="linenos">1822</span></a>
</span><span id="Task-1823"><a href="#Task-1823"><span class="linenos">1823</span></a>        <span class="k">if</span> <span class="n">epoch</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T1</span><span class="p">:</span>
</span><span id="Task-1824"><a href="#Task-1824"><span class="linenos">1824</span></a>            <span class="k">return</span> <span class="mi">0</span>
</span><span id="Task-1825"><a href="#Task-1825"><span class="linenos">1825</span></a>        <span class="k">elif</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">T2</span><span class="p">:</span>
</span><span id="Task-1826"><a href="#Task-1826"><span class="linenos">1826</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_f</span> <span class="o">*</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">T1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">T1</span><span class="p">)</span>
</span><span id="Task-1827"><a href="#Task-1827"><span class="linenos">1827</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task-1828"><a href="#Task-1828"><span class="linenos">1828</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_f</span>
</span><span id="Task-1829"><a href="#Task-1829"><span class="linenos">1829</span></a>
</span><span id="Task-1830"><a href="#Task-1830"><span class="linenos">1830</span></a>    <span class="k">def</span> <span class="nf">count_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bouts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="Task-1831"><a href="#Task-1831"><span class="linenos">1831</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1832"><a href="#Task-1832"><span class="linenos">1832</span></a><span class="sd">        Get a dictionary of class counts in different modes</span>
</span><span id="Task-1833"><a href="#Task-1833"><span class="linenos">1833</span></a>
</span><span id="Task-1834"><a href="#Task-1834"><span class="linenos">1834</span></a><span class="sd">        Parameters</span>
</span><span id="Task-1835"><a href="#Task-1835"><span class="linenos">1835</span></a><span class="sd">        ----------</span>
</span><span id="Task-1836"><a href="#Task-1836"><span class="linenos">1836</span></a><span class="sd">        bouts : bool, default False</span>
</span><span id="Task-1837"><a href="#Task-1837"><span class="linenos">1837</span></a><span class="sd">            if `True`, instead of frame counts segment counts are returned</span>
</span><span id="Task-1838"><a href="#Task-1838"><span class="linenos">1838</span></a>
</span><span id="Task-1839"><a href="#Task-1839"><span class="linenos">1839</span></a><span class="sd">        Returns</span>
</span><span id="Task-1840"><a href="#Task-1840"><span class="linenos">1840</span></a><span class="sd">        -------</span>
</span><span id="Task-1841"><a href="#Task-1841"><span class="linenos">1841</span></a><span class="sd">        class_counts : dict</span>
</span><span id="Task-1842"><a href="#Task-1842"><span class="linenos">1842</span></a><span class="sd">            a dictionary where first-level keys are &quot;train&quot;, &quot;val&quot; and &quot;test&quot;, second-level keys are</span>
</span><span id="Task-1843"><a href="#Task-1843"><span class="linenos">1843</span></a><span class="sd">            class names and values are class counts (in frames)</span>
</span><span id="Task-1844"><a href="#Task-1844"><span class="linenos">1844</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1845"><a href="#Task-1845"><span class="linenos">1845</span></a>
</span><span id="Task-1846"><a href="#Task-1846"><span class="linenos">1846</span></a>        <span class="n">class_counts</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Task-1847"><a href="#Task-1847"><span class="linenos">1847</span></a>        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]:</span>
</span><span id="Task-1848"><a href="#Task-1848"><span class="linenos">1848</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Task-1849"><a href="#Task-1849"><span class="linenos">1849</span></a>                <span class="n">class_counts</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">count_classes</span><span class="p">(</span><span class="n">bouts</span><span class="p">)</span>
</span><span id="Task-1850"><a href="#Task-1850"><span class="linenos">1850</span></a>            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="Task-1851"><a href="#Task-1851"><span class="linenos">1851</span></a>                <span class="n">class_counts</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
</span><span id="Task-1852"><a href="#Task-1852"><span class="linenos">1852</span></a>        <span class="k">return</span> <span class="n">class_counts</span>
</span><span id="Task-1853"><a href="#Task-1853"><span class="linenos">1853</span></a>
</span><span id="Task-1854"><a href="#Task-1854"><span class="linenos">1854</span></a>    <span class="k">def</span> <span class="nf">behaviors_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="Task-1855"><a href="#Task-1855"><span class="linenos">1855</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1856"><a href="#Task-1856"><span class="linenos">1856</span></a><span class="sd">        Get a behavior dictionary</span>
</span><span id="Task-1857"><a href="#Task-1857"><span class="linenos">1857</span></a>
</span><span id="Task-1858"><a href="#Task-1858"><span class="linenos">1858</span></a><span class="sd">        Keys are label indices and values are label names.</span>
</span><span id="Task-1859"><a href="#Task-1859"><span class="linenos">1859</span></a>
</span><span id="Task-1860"><a href="#Task-1860"><span class="linenos">1860</span></a><span class="sd">        Returns</span>
</span><span id="Task-1861"><a href="#Task-1861"><span class="linenos">1861</span></a><span class="sd">        -------</span>
</span><span id="Task-1862"><a href="#Task-1862"><span class="linenos">1862</span></a><span class="sd">        behaviors_dict : dict</span>
</span><span id="Task-1863"><a href="#Task-1863"><span class="linenos">1863</span></a><span class="sd">            behavior dictionary</span>
</span><span id="Task-1864"><a href="#Task-1864"><span class="linenos">1864</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1865"><a href="#Task-1865"><span class="linenos">1865</span></a>
</span><span id="Task-1866"><a href="#Task-1866"><span class="linenos">1866</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">()</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span>
</span><span id="Task-1867"><a href="#Task-1867"><span class="linenos">1867</span></a>
</span><span id="Task-1868"><a href="#Task-1868"><span class="linenos">1868</span></a>    <span class="k">def</span> <span class="nf">update_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1869"><a href="#Task-1869"><span class="linenos">1869</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1870"><a href="#Task-1870"><span class="linenos">1870</span></a><span class="sd">        Update training parameters from a dictionary</span>
</span><span id="Task-1871"><a href="#Task-1871"><span class="linenos">1871</span></a>
</span><span id="Task-1872"><a href="#Task-1872"><span class="linenos">1872</span></a><span class="sd">        Parameters</span>
</span><span id="Task-1873"><a href="#Task-1873"><span class="linenos">1873</span></a><span class="sd">        ----------</span>
</span><span id="Task-1874"><a href="#Task-1874"><span class="linenos">1874</span></a><span class="sd">        parameters : dict</span>
</span><span id="Task-1875"><a href="#Task-1875"><span class="linenos">1875</span></a><span class="sd">            the update dictionary</span>
</span><span id="Task-1876"><a href="#Task-1876"><span class="linenos">1876</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1877"><a href="#Task-1877"><span class="linenos">1877</span></a>
</span><span id="Task-1878"><a href="#Task-1878"><span class="linenos">1878</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lr&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
</span><span id="Task-1879"><a href="#Task-1879"><span class="linenos">1879</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parallel&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">)</span>
</span><span id="Task-1880"><a href="#Task-1880"><span class="linenos">1880</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
</span><span id="Task-1881"><a href="#Task-1881"><span class="linenos">1881</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
</span><span id="Task-1882"><a href="#Task-1882"><span class="linenos">1882</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Task-1883"><a href="#Task-1883"><span class="linenos">1883</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
</span><span id="Task-1884"><a href="#Task-1884"><span class="linenos">1884</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
</span><span id="Task-1885"><a href="#Task-1885"><span class="linenos">1885</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">augment_train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;augment_train&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">augment_train</span><span class="p">))</span>
</span><span id="Task-1886"><a href="#Task-1886"><span class="linenos">1886</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">augment_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;augment_val&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">augment_val</span><span class="p">))</span>
</span><span id="Task-1887"><a href="#Task-1887"><span class="linenos">1887</span></a>        <span class="n">ssl_weights</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ssl_weights&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_weights</span><span class="p">)</span>
</span><span id="Task-1888"><a href="#Task-1888"><span class="linenos">1888</span></a>        <span class="k">if</span> <span class="n">ssl_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1889"><a href="#Task-1889"><span class="linenos">1889</span></a>            <span class="n">ssl_weights</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_losses</span><span class="p">]</span>
</span><span id="Task-1890"><a href="#Task-1890"><span class="linenos">1890</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ssl_weights</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
</span><span id="Task-1891"><a href="#Task-1891"><span class="linenos">1891</span></a>            <span class="n">ssl_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">ssl_weights</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_losses</span><span class="p">]</span>
</span><span id="Task-1892"><a href="#Task-1892"><span class="linenos">1892</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ssl_weights</span> <span class="o">=</span> <span class="n">ssl_weights</span>
</span><span id="Task-1893"><a href="#Task-1893"><span class="linenos">1893</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_epochs</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_epochs&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">)</span>
</span><span id="Task-1894"><a href="#Task-1894"><span class="linenos">1894</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_save_epochs</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="Task-1895"><a href="#Task-1895"><span class="linenos">1895</span></a>            <span class="s2">&quot;model_save_epochs&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_epochs</span>
</span><span id="Task-1896"><a href="#Task-1896"><span class="linenos">1896</span></a>        <span class="p">)</span>
</span><span id="Task-1897"><a href="#Task-1897"><span class="linenos">1897</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_save_path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">)</span>
</span><span id="Task-1898"><a href="#Task-1898"><span class="linenos">1898</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pseudolabel</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pseudolabel&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudolabel</span><span class="p">)</span>
</span><span id="Task-1899"><a href="#Task-1899"><span class="linenos">1899</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">T1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pseudolabel_start&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T1</span><span class="p">))</span>
</span><span id="Task-1900"><a href="#Task-1900"><span class="linenos">1900</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">T2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;alpha_growth_stop&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T2</span><span class="p">))</span>
</span><span id="Task-1901"><a href="#Task-1901"><span class="linenos">1901</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;correction_interval&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">))</span>
</span><span id="Task-1902"><a href="#Task-1902"><span class="linenos">1902</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_f</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pseudolabel_alpha_f&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_f</span><span class="p">)</span>
</span><span id="Task-1903"><a href="#Task-1903"><span class="linenos">1903</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;log_file&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">)</span>
</span><span id="Task-1904"><a href="#Task-1904"><span class="linenos">1904</span></a>
</span><span id="Task-1905"><a href="#Task-1905"><span class="linenos">1905</span></a>    <span class="k">def</span> <span class="nf">generate_uncertainty_score</span><span class="p">(</span>
</span><span id="Task-1906"><a href="#Task-1906"><span class="linenos">1906</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Task-1907"><a href="#Task-1907"><span class="linenos">1907</span></a>        <span class="n">classes</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
</span><span id="Task-1908"><a href="#Task-1908"><span class="linenos">1908</span></a>        <span class="n">augment_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Task-1909"><a href="#Task-1909"><span class="linenos">1909</span></a>        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
</span><span id="Task-1910"><a href="#Task-1910"><span class="linenos">1910</span></a>        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;least_confidence&quot;</span><span class="p">,</span>
</span><span id="Task-1911"><a href="#Task-1911"><span class="linenos">1911</span></a>        <span class="n">predicted</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-1912"><a href="#Task-1912"><span class="linenos">1912</span></a>        <span class="n">behaviors_dict</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task-1913"><a href="#Task-1913"><span class="linenos">1913</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="Task-1914"><a href="#Task-1914"><span class="linenos">1914</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1915"><a href="#Task-1915"><span class="linenos">1915</span></a><span class="sd">        Generate frame-wise scores for active learning</span>
</span><span id="Task-1916"><a href="#Task-1916"><span class="linenos">1916</span></a>
</span><span id="Task-1917"><a href="#Task-1917"><span class="linenos">1917</span></a><span class="sd">        Parameters</span>
</span><span id="Task-1918"><a href="#Task-1918"><span class="linenos">1918</span></a><span class="sd">        ----------</span>
</span><span id="Task-1919"><a href="#Task-1919"><span class="linenos">1919</span></a><span class="sd">        classes : list</span>
</span><span id="Task-1920"><a href="#Task-1920"><span class="linenos">1920</span></a><span class="sd">            a list of class names or indices; their confidence scores will be computed separately and stacked</span>
</span><span id="Task-1921"><a href="#Task-1921"><span class="linenos">1921</span></a><span class="sd">        augment_n : int, default 0</span>
</span><span id="Task-1922"><a href="#Task-1922"><span class="linenos">1922</span></a><span class="sd">            the number of augmentations to average over</span>
</span><span id="Task-1923"><a href="#Task-1923"><span class="linenos">1923</span></a><span class="sd">        batch_size : int, default 32</span>
</span><span id="Task-1924"><a href="#Task-1924"><span class="linenos">1924</span></a><span class="sd">            the batch size</span>
</span><span id="Task-1925"><a href="#Task-1925"><span class="linenos">1925</span></a><span class="sd">        method : {&quot;least_confidence&quot;, &quot;entropy&quot;}</span>
</span><span id="Task-1926"><a href="#Task-1926"><span class="linenos">1926</span></a><span class="sd">            the method used to calculate the scores from the probability predictions (`&quot;least_confidence&quot;`: `1 - p_i` if</span>
</span><span id="Task-1927"><a href="#Task-1927"><span class="linenos">1927</span></a><span class="sd">            `p_i &gt; 0.5` or `p_i` if `p_i &lt; 0.5`; `&quot;entropy&quot;`: `- p_i * log(p_i) - (1 - p_i) * log(1 - p_i)`)</span>
</span><span id="Task-1928"><a href="#Task-1928"><span class="linenos">1928</span></a>
</span><span id="Task-1929"><a href="#Task-1929"><span class="linenos">1929</span></a><span class="sd">        Returns</span>
</span><span id="Task-1930"><a href="#Task-1930"><span class="linenos">1930</span></a><span class="sd">        -------</span>
</span><span id="Task-1931"><a href="#Task-1931"><span class="linenos">1931</span></a><span class="sd">        score_dicts : dict</span>
</span><span id="Task-1932"><a href="#Task-1932"><span class="linenos">1932</span></a><span class="sd">            a nested dictionary where first level keys are video ids, second level keys are clip ids and values</span>
</span><span id="Task-1933"><a href="#Task-1933"><span class="linenos">1933</span></a><span class="sd">            are score tensors</span>
</span><span id="Task-1934"><a href="#Task-1934"><span class="linenos">1934</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-1935"><a href="#Task-1935"><span class="linenos">1935</span></a>
</span><span id="Task-1936"><a href="#Task-1936"><span class="linenos">1936</span></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
</span><span id="Task-1937"><a href="#Task-1937"><span class="linenos">1937</span></a>        <span class="k">if</span> <span class="n">behaviors_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1938"><a href="#Task-1938"><span class="linenos">1938</span></a>            <span class="n">behaviors_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span>
</span><span id="Task-1939"><a href="#Task-1939"><span class="linenos">1939</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">BehaviorDataset</span><span class="p">):</span>
</span><span id="Task-1940"><a href="#Task-1940"><span class="linenos">1940</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="Task-1941"><a href="#Task-1941"><span class="linenos">1941</span></a>                <span class="sa">f</span><span class="s2">&quot;The dataset parameter has to be either None, string, &quot;</span>
</span><span id="Task-1942"><a href="#Task-1942"><span class="linenos">1942</span></a>                <span class="sa">f</span><span class="s2">&quot;BehaviorDataset or Dataloader, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task-1943"><a href="#Task-1943"><span class="linenos">1943</span></a>            <span class="p">)</span>
</span><span id="Task-1944"><a href="#Task-1944"><span class="linenos">1944</span></a>        <span class="k">if</span> <span class="n">predicted</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task-1945"><a href="#Task-1945"><span class="linenos">1945</span></a>            <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
</span><span id="Task-1946"><a href="#Task-1946"><span class="linenos">1946</span></a>                <span class="n">dataset</span><span class="p">,</span>
</span><span id="Task-1947"><a href="#Task-1947"><span class="linenos">1947</span></a>                <span class="n">raw_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task-1948"><a href="#Task-1948"><span class="linenos">1948</span></a>                <span class="n">apply_primary_function</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task-1949"><a href="#Task-1949"><span class="linenos">1949</span></a>                <span class="n">augment_n</span><span class="o">=</span><span class="n">augment_n</span><span class="p">,</span>
</span><span id="Task-1950"><a href="#Task-1950"><span class="linenos">1950</span></a>                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="Task-1951"><a href="#Task-1951"><span class="linenos">1951</span></a>            <span class="p">)</span>
</span><span id="Task-1952"><a href="#Task-1952"><span class="linenos">1952</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">generate_full_length_prediction</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="Task-1953"><a href="#Task-1953"><span class="linenos">1953</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">classes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Task-1954"><a href="#Task-1954"><span class="linenos">1954</span></a>            <span class="n">behaviors_dict_inverse</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">behaviors_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Task-1955"><a href="#Task-1955"><span class="linenos">1955</span></a>            <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">behaviors_dict_inverse</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">]</span>
</span><span id="Task-1956"><a href="#Task-1956"><span class="linenos">1956</span></a>        <span class="k">for</span> <span class="n">v_id</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">predicted</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Task-1957"><a href="#Task-1957"><span class="linenos">1957</span></a>            <span class="k">for</span> <span class="n">clip_id</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Task-1958"><a href="#Task-1958"><span class="linenos">1958</span></a>                <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;least_confidence&quot;</span><span class="p">:</span>
</span><span id="Task-1959"><a href="#Task-1959"><span class="linenos">1959</span></a>                    <span class="n">predicted</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">][</span><span class="n">vv</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">vv</span><span class="p">[</span><span class="n">vv</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">]</span>
</span><span id="Task-1960"><a href="#Task-1960"><span class="linenos">1960</span></a>                <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;entropy&quot;</span><span class="p">:</span>
</span><span id="Task-1961"><a href="#Task-1961"><span class="linenos">1961</span></a>                    <span class="n">predicted</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">][</span><span class="n">vv</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Task-1962"><a href="#Task-1962"><span class="linenos">1962</span></a>                        <span class="o">-</span><span class="n">vv</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">vv</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">vv</span><span class="p">)</span>
</span><span id="Task-1963"><a href="#Task-1963"><span class="linenos">1963</span></a>                    <span class="p">)[</span><span class="n">vv</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">100</span><span class="p">]</span>
</span><span id="Task-1964"><a href="#Task-1964"><span class="linenos">1964</span></a>                <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
</span><span id="Task-1965"><a href="#Task-1965"><span class="linenos">1965</span></a>                    <span class="n">predicted</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">vv</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Task-1966"><a href="#Task-1966"><span class="linenos">1966</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Task-1967"><a href="#Task-1967"><span class="linenos">1967</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Task-1968"><a href="#Task-1968"><span class="linenos">1968</span></a>                        <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> method is not recognized; please choose from [&#39;least_confidence&#39;, &#39;entropy&#39;]&quot;</span>
</span><span id="Task-1969"><a href="#Task-1969"><span class="linenos">1969</span></a>                    <span class="p">)</span>
</span><span id="Task-1970"><a href="#Task-1970"><span class="linenos">1970</span></a>                <span class="n">predicted</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">][</span><span class="n">vv</span> <span class="o">==</span> <span class="o">-</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Task-1971"><a href="#Task-1971"><span class="linenos">1971</span></a>
</span><span id="Task-1972"><a href="#Task-1972"><span class="linenos">1972</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Task-1973"><a href="#Task-1973"><span class="linenos">1973</span></a>            <span class="n">v_id</span><span class="p">:</span> <span class="p">{</span><span class="n">clip_id</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">classes</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">clip_id</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">video_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Task-1974"><a href="#Task-1974"><span class="linenos">1974</span></a>            <span class="k">for</span> <span class="n">v_id</span><span class="p">,</span> <span class="n">video_dict</span> <span class="ow">in</span> <span class="n">predicted</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Task-1975"><a href="#Task-1975"><span class="linenos">1975</span></a>        <span class="p">}</span>
</span><span id="Task-1976"><a href="#Task-1976"><span class="linenos">1976</span></a>        <span class="k">return</span> <span class="n">predicted</span>
</span><span id="Task-1977"><a href="#Task-1977"><span class="linenos">1977</span></a>
</span><span id="Task-1978"><a href="#Task-1978"><span class="linenos">1978</span></a>    <span class="k">def</span> <span class="nf">generate_bald_score</span><span class="p">(</span>
</span><span id="Task-1979"><a href="#Task-1979"><span class="linenos">1979</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Task-1980"><a href="#Task-1980"><span class="linenos">1980</span></a>        <span class="n">classes</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
</span><span id="Task-1981"><a href="#Task-1981"><span class="linenos">1981</span></a>        <span class="n">augment_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Task-1982"><a href="#Task-1982"><span class="linenos">1982</span></a>        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
</span><span id="Task-1983"><a href="#Task-1983"><span class="linenos">1983</span></a>        <span class="n">num_models</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="Task-1984"><a href="#Task-1984"><span class="linenos">1984</span></a>        <span class="n">kernel_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
</span><span id="Task-1985"><a href="#Task-1985"><span class="linenos">1985</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="Task-1986"><a href="#Task-1986"><span class="linenos">1986</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task-1987"><a href="#Task-1987"><span class="linenos">1987</span></a><span class="sd">        Generate frame-wise Bayesian Active Learning by Disagreement scores for active learning</span>
</span><span id="Task-1988"><a href="#Task-1988"><span class="linenos">1988</span></a>
</span><span id="Task-1989"><a href="#Task-1989"><span class="linenos">1989</span></a><span class="sd">        Parameters</span>
</span><span id="Task-1990"><a href="#Task-1990"><span class="linenos">1990</span></a><span class="sd">        ----------</span>
</span><span id="Task-1991"><a href="#Task-1991"><span class="linenos">1991</span></a><span class="sd">        classes : list</span>
</span><span id="Task-1992"><a href="#Task-1992"><span class="linenos">1992</span></a><span class="sd">            a list of class names or indices; their confidence scores will be computed separately and stacked</span>
</span><span id="Task-1993"><a href="#Task-1993"><span class="linenos">1993</span></a><span class="sd">        augment_n : int, default 0</span>
</span><span id="Task-1994"><a href="#Task-1994"><span class="linenos">1994</span></a><span class="sd">            the number of augmentations to average over</span>
</span><span id="Task-1995"><a href="#Task-1995"><span class="linenos">1995</span></a><span class="sd">        batch_size : int, default 32</span>
</span><span id="Task-1996"><a href="#Task-1996"><span class="linenos">1996</span></a><span class="sd">            the batch size</span>
</span><span id="Task-1997"><a href="#Task-1997"><span class="linenos">1997</span></a><span class="sd">        num_models : int, default 10</span>
</span><span id="Task-1998"><a href="#Task-1998"><span class="linenos">1998</span></a><span class="sd">            the number of dropout masks to apply</span>
</span><span id="Task-1999"><a href="#Task-1999"><span class="linenos">1999</span></a><span class="sd">        kernel_size : int, default 11</span>
</span><span id="Task-2000"><a href="#Task-2000"><span class="linenos">2000</span></a><span class="sd">            the size of the smoothing gaussian kernel</span>
</span><span id="Task-2001"><a href="#Task-2001"><span class="linenos">2001</span></a>
</span><span id="Task-2002"><a href="#Task-2002"><span class="linenos">2002</span></a><span class="sd">        Returns</span>
</span><span id="Task-2003"><a href="#Task-2003"><span class="linenos">2003</span></a><span class="sd">        -------</span>
</span><span id="Task-2004"><a href="#Task-2004"><span class="linenos">2004</span></a><span class="sd">        score_dicts : dict</span>
</span><span id="Task-2005"><a href="#Task-2005"><span class="linenos">2005</span></a><span class="sd">            a nested dictionary where first level keys are video ids, second level keys are clip ids and values</span>
</span><span id="Task-2006"><a href="#Task-2006"><span class="linenos">2006</span></a><span class="sd">            are score tensors</span>
</span><span id="Task-2007"><a href="#Task-2007"><span class="linenos">2007</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task-2008"><a href="#Task-2008"><span class="linenos">2008</span></a>
</span><span id="Task-2009"><a href="#Task-2009"><span class="linenos">2009</span></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
</span><span id="Task-2010"><a href="#Task-2010"><span class="linenos">2010</span></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="Task-2011"><a href="#Task-2011"><span class="linenos">2011</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">BehaviorDataset</span><span class="p">):</span>
</span><span id="Task-2012"><a href="#Task-2012"><span class="linenos">2012</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="Task-2013"><a href="#Task-2013"><span class="linenos">2013</span></a>                <span class="sa">f</span><span class="s2">&quot;The dataset parameter has to be either None, string, &quot;</span>
</span><span id="Task-2014"><a href="#Task-2014"><span class="linenos">2014</span></a>                <span class="sa">f</span><span class="s2">&quot;BehaviorDataset or Dataloader, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task-2015"><a href="#Task-2015"><span class="linenos">2015</span></a>            <span class="p">)</span>
</span><span id="Task-2016"><a href="#Task-2016"><span class="linenos">2016</span></a>        <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Task-2017"><a href="#Task-2017"><span class="linenos">2017</span></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">):</span>
</span><span id="Task-2018"><a href="#Task-2018"><span class="linenos">2018</span></a>            <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
</span><span id="Task-2019"><a href="#Task-2019"><span class="linenos">2019</span></a>                <span class="n">dataset</span><span class="p">,</span>
</span><span id="Task-2020"><a href="#Task-2020"><span class="linenos">2020</span></a>                <span class="n">raw_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task-2021"><a href="#Task-2021"><span class="linenos">2021</span></a>                <span class="n">apply_primary_function</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task-2022"><a href="#Task-2022"><span class="linenos">2022</span></a>                <span class="n">augment_n</span><span class="o">=</span><span class="n">augment_n</span><span class="p">,</span>
</span><span id="Task-2023"><a href="#Task-2023"><span class="linenos">2023</span></a>                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="Task-2024"><a href="#Task-2024"><span class="linenos">2024</span></a>                <span class="n">train_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task-2025"><a href="#Task-2025"><span class="linenos">2025</span></a>            <span class="p">)</span>
</span><span id="Task-2026"><a href="#Task-2026"><span class="linenos">2026</span></a>            <span class="n">predicted</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">generate_full_length_prediction</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="Task-2027"><a href="#Task-2027"><span class="linenos">2027</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">classes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Task-2028"><a href="#Task-2028"><span class="linenos">2028</span></a>                <span class="n">behaviors_dict_inverse</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Task-2029"><a href="#Task-2029"><span class="linenos">2029</span></a>                    <span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Task-2030"><a href="#Task-2030"><span class="linenos">2030</span></a>                <span class="p">}</span>
</span><span id="Task-2031"><a href="#Task-2031"><span class="linenos">2031</span></a>                <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">behaviors_dict_inverse</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">]</span>
</span><span id="Task-2032"><a href="#Task-2032"><span class="linenos">2032</span></a>            <span class="k">for</span> <span class="n">v_id</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">predicted</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Task-2033"><a href="#Task-2033"><span class="linenos">2033</span></a>                <span class="k">for</span> <span class="n">clip_id</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Task-2034"><a href="#Task-2034"><span class="linenos">2034</span></a>                    <span class="n">vv</span><span class="p">[</span><span class="n">vv</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vv</span><span class="p">[</span><span class="n">vv</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">100</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">int</span><span class="p">()</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
</span><span id="Task-2035"><a href="#Task-2035"><span class="linenos">2035</span></a>                    <span class="n">predicted</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">vv</span>
</span><span id="Task-2036"><a href="#Task-2036"><span class="linenos">2036</span></a>            <span class="n">predicted</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Task-2037"><a href="#Task-2037"><span class="linenos">2037</span></a>                <span class="n">v_id</span><span class="p">:</span> <span class="p">{</span><span class="n">clip_id</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">classes</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">clip_id</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">video_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Task-2038"><a href="#Task-2038"><span class="linenos">2038</span></a>                <span class="k">for</span> <span class="n">v_id</span><span class="p">,</span> <span class="n">video_dict</span> <span class="ow">in</span> <span class="n">predicted</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Task-2039"><a href="#Task-2039"><span class="linenos">2039</span></a>            <span class="p">}</span>
</span><span id="Task-2040"><a href="#Task-2040"><span class="linenos">2040</span></a>            <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="Task-2041"><a href="#Task-2041"><span class="linenos">2041</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">v_id</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">v_id</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
</span><span id="Task-2042"><a href="#Task-2042"><span class="linenos">2042</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">kernel_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">kernel_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Task-2043"><a href="#Task-2043"><span class="linenos">2043</span></a>        <span class="n">gauss</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">))</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">1</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="p">]</span>
</span><span id="Task-2044"><a href="#Task-2044"><span class="linenos">2044</span></a>        <span class="n">gauss</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">gauss</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">gauss</span><span class="p">]</span>
</span><span id="Task-2045"><a href="#Task-2045"><span class="linenos">2045</span></a>        <span class="n">kernel</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">([[</span><span class="n">gauss</span><span class="p">]])</span>
</span><span id="Task-2046"><a href="#Task-2046"><span class="linenos">2046</span></a>        <span class="k">for</span> <span class="n">v_id</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="Task-2047"><a href="#Task-2047"><span class="linenos">2047</span></a>            <span class="k">for</span> <span class="n">clip_id</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">v_id</span><span class="p">]:</span>
</span><span id="Task-2048"><a href="#Task-2048"><span class="linenos">2048</span></a>                <span class="n">consensus</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Task-2049"><a href="#Task-2049"><span class="linenos">2049</span></a>                    <span class="p">(</span>
</span><span id="Task-2050"><a href="#Task-2050"><span class="linenos">2050</span></a>                        <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
</span><span id="Task-2051"><a href="#Task-2051"><span class="linenos">2051</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span>
</span><span id="Task-2052"><a href="#Task-2052"><span class="linenos">2052</span></a>                        <span class="p">)</span>
</span><span id="Task-2053"><a href="#Task-2053"><span class="linenos">2053</span></a>                        <span class="o">&gt;</span> <span class="mf">0.5</span>
</span><span id="Task-2054"><a href="#Task-2054"><span class="linenos">2054</span></a>                    <span class="p">)</span>
</span><span id="Task-2055"><a href="#Task-2055"><span class="linenos">2055</span></a>                    <span class="o">.</span><span class="n">int</span><span class="p">()</span>
</span><span id="Task-2056"><a href="#Task-2056"><span class="linenos">2056</span></a>                    <span class="o">.</span><span class="n">float</span><span class="p">()</span>
</span><span id="Task-2057"><a href="#Task-2057"><span class="linenos">2057</span></a>                <span class="p">)</span>
</span><span id="Task-2058"><a href="#Task-2058"><span class="linenos">2058</span></a>                <span class="n">consensus</span><span class="p">[</span><span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>
</span><span id="Task-2059"><a href="#Task-2059"><span class="linenos">2059</span></a>                <span class="n">result</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">consensus</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Task-2060"><a href="#Task-2060"><span class="linenos">2060</span></a>                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">:</span>
</span><span id="Task-2061"><a href="#Task-2061"><span class="linenos">2061</span></a>                    <span class="n">result</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">!=</span> <span class="n">consensus</span><span class="p">)</span><span class="o">.</span><span class="n">int</span><span class="p">()</span>
</span><span id="Task-2062"><a href="#Task-2062"><span class="linenos">2062</span></a>                <span class="n">result</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">num_models</span>
</span><span id="Task-2063"><a href="#Task-2063"><span class="linenos">2063</span></a>                <span class="n">res</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Task-2064"><a href="#Task-2064"><span class="linenos">2064</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)):</span>
</span><span id="Task-2065"><a href="#Task-2065"><span class="linenos">2065</span></a>                    <span class="n">res</span><span class="p">[</span>
</span><span id="Task-2066"><a href="#Task-2066"><span class="linenos">2066</span></a>                        <span class="n">i</span><span class="p">,</span> <span class="n">floor</span><span class="p">(</span><span class="n">kernel_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="n">floor</span><span class="p">(</span><span class="n">kernel_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="Task-2067"><a href="#Task-2067"><span class="linenos">2067</span></a>                    <span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">conv1d</span><span class="p">(</span>
</span><span id="Task-2068"><a href="#Task-2068"><span class="linenos">2068</span></a>                        <span class="n">result</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">kernel</span>
</span><span id="Task-2069"><a href="#Task-2069"><span class="linenos">2069</span></a>                    <span class="p">)[</span>
</span><span id="Task-2070"><a href="#Task-2070"><span class="linenos">2070</span></a>                        <span class="mi">0</span><span class="p">,</span> <span class="o">...</span>
</span><span id="Task-2071"><a href="#Task-2071"><span class="linenos">2071</span></a>                    <span class="p">]</span>
</span><span id="Task-2072"><a href="#Task-2072"><span class="linenos">2072</span></a>                <span class="n">result</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
</span><span id="Task-2073"><a href="#Task-2073"><span class="linenos">2073</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="Task-2074"><a href="#Task-2074"><span class="linenos">2074</span></a>
</span><span id="Task-2075"><a href="#Task-2075"><span class="linenos">2075</span></a>    <span class="k">def</span> <span class="nf">get_normalization_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="Task-2076"><a href="#Task-2076"><span class="linenos">2076</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">stats</span>
</span></pre></div>


            <div class="docstring"><p>A universal trainer class that performs training, evaluation and prediction for all types of tasks and data</p>
</div>


                            <div id="Task.__init__" class="classattr">
                                        <input id="Task.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Task</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">train_dataloader</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataloader</span><span class="o">.</span><span class="n">DataLoader</span>,</span><span class="param">	<span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">dlc2action</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">Model</span><span class="p">]</span>,</span><span class="param">	<span class="n">loss</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">num_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">transformer</span><span class="p">:</span> <span class="n">dlc2action</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">base_transformer</span><span class="o">.</span><span class="n">Transformer</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">ssl_losses</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">ssl_weights</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span>,</span><span class="param">	<span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">val_dataloader</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataloader</span><span class="o">.</span><span class="n">DataLoader</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">test_dataloader</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataloader</span><span class="o">.</span><span class="n">DataLoader</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">optimizer</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">Optimizer</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cuda&#39;</span>,</span><span class="param">	<span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">log_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">augment_train</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">augment_val</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">validation_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">predict_function</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">primary_predict_function</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">exclusive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">ignore_tags</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span>,</span><span class="param">	<span class="n">model_save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">model_save_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>,</span><span class="param">	<span class="n">pseudolabel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">pseudolabel_start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>,</span><span class="param">	<span class="n">correction_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>,</span><span class="param">	<span class="n">pseudolabel_alpha_f</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">3</span>,</span><span class="param">	<span class="n">alpha_growth_stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">600</span>,</span><span class="param">	<span class="n">parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">skip_metrics</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="Task.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.__init__-74"><a href="#Task.__init__-74"><span class="linenos"> 74</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="Task.__init__-75"><a href="#Task.__init__-75"><span class="linenos"> 75</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Task.__init__-76"><a href="#Task.__init__-76"><span class="linenos"> 76</span></a>        <span class="n">train_dataloader</span><span class="p">:</span> <span class="n">DataLoader</span><span class="p">,</span>
</span><span id="Task.__init__-77"><a href="#Task.__init__-77"><span class="linenos"> 77</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Model</span><span class="p">],</span>
</span><span id="Task.__init__-78"><a href="#Task.__init__-78"><span class="linenos"> 78</span></a>        <span class="n">loss</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="nb">float</span><span class="p">],</span>
</span><span id="Task.__init__-79"><a href="#Task.__init__-79"><span class="linenos"> 79</span></a>        <span class="n">num_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Task.__init__-80"><a href="#Task.__init__-80"><span class="linenos"> 80</span></a>        <span class="n">transformer</span><span class="p">:</span> <span class="n">Transformer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.__init__-81"><a href="#Task.__init__-81"><span class="linenos"> 81</span></a>        <span class="n">ssl_losses</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.__init__-82"><a href="#Task.__init__-82"><span class="linenos"> 82</span></a>        <span class="n">ssl_weights</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.__init__-83"><a href="#Task.__init__-83"><span class="linenos"> 83</span></a>        <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span>
</span><span id="Task.__init__-84"><a href="#Task.__init__-84"><span class="linenos"> 84</span></a>        <span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.__init__-85"><a href="#Task.__init__-85"><span class="linenos"> 85</span></a>        <span class="n">val_dataloader</span><span class="p">:</span> <span class="n">DataLoader</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.__init__-86"><a href="#Task.__init__-86"><span class="linenos"> 86</span></a>        <span class="n">test_dataloader</span><span class="p">:</span> <span class="n">DataLoader</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.__init__-87"><a href="#Task.__init__-87"><span class="linenos"> 87</span></a>        <span class="n">optimizer</span><span class="p">:</span> <span class="n">Optimizer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.__init__-88"><a href="#Task.__init__-88"><span class="linenos"> 88</span></a>        <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span><span class="p">,</span>
</span><span id="Task.__init__-89"><a href="#Task.__init__-89"><span class="linenos"> 89</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Task.__init__-90"><a href="#Task.__init__-90"><span class="linenos"> 90</span></a>        <span class="n">log_file</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.__init__-91"><a href="#Task.__init__-91"><span class="linenos"> 91</span></a>        <span class="n">augment_train</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="Task.__init__-92"><a href="#Task.__init__-92"><span class="linenos"> 92</span></a>        <span class="n">augment_val</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Task.__init__-93"><a href="#Task.__init__-93"><span class="linenos"> 93</span></a>        <span class="n">validation_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="Task.__init__-94"><a href="#Task.__init__-94"><span class="linenos"> 94</span></a>        <span class="n">predict_function</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.__init__-95"><a href="#Task.__init__-95"><span class="linenos"> 95</span></a>        <span class="n">primary_predict_function</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.__init__-96"><a href="#Task.__init__-96"><span class="linenos"> 96</span></a>        <span class="n">exclusive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Task.__init__-97"><a href="#Task.__init__-97"><span class="linenos"> 97</span></a>        <span class="n">ignore_tags</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Task.__init__-98"><a href="#Task.__init__-98"><span class="linenos"> 98</span></a>        <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="Task.__init__-99"><a href="#Task.__init__-99"><span class="linenos"> 99</span></a>        <span class="n">model_save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.__init__-100"><a href="#Task.__init__-100"><span class="linenos">100</span></a>        <span class="n">model_save_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="Task.__init__-101"><a href="#Task.__init__-101"><span class="linenos">101</span></a>        <span class="n">pseudolabel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task.__init__-102"><a href="#Task.__init__-102"><span class="linenos">102</span></a>        <span class="n">pseudolabel_start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
</span><span id="Task.__init__-103"><a href="#Task.__init__-103"><span class="linenos">103</span></a>        <span class="n">correction_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="Task.__init__-104"><a href="#Task.__init__-104"><span class="linenos">104</span></a>        <span class="n">pseudolabel_alpha_f</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="Task.__init__-105"><a href="#Task.__init__-105"><span class="linenos">105</span></a>        <span class="n">alpha_growth_stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">600</span><span class="p">,</span>
</span><span id="Task.__init__-106"><a href="#Task.__init__-106"><span class="linenos">106</span></a>        <span class="n">parallel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task.__init__-107"><a href="#Task.__init__-107"><span class="linenos">107</span></a>        <span class="n">skip_metrics</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.__init__-108"><a href="#Task.__init__-108"><span class="linenos">108</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.__init__-109"><a href="#Task.__init__-109"><span class="linenos">109</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.__init__-110"><a href="#Task.__init__-110"><span class="linenos">110</span></a><span class="sd">        Parameters</span>
</span><span id="Task.__init__-111"><a href="#Task.__init__-111"><span class="linenos">111</span></a><span class="sd">        ----------</span>
</span><span id="Task.__init__-112"><a href="#Task.__init__-112"><span class="linenos">112</span></a><span class="sd">        train_dataloader : torch.utils.data.DataLoader</span>
</span><span id="Task.__init__-113"><a href="#Task.__init__-113"><span class="linenos">113</span></a><span class="sd">            a training dataloader</span>
</span><span id="Task.__init__-114"><a href="#Task.__init__-114"><span class="linenos">114</span></a><span class="sd">        model : dlc2action.model.base_model.Model</span>
</span><span id="Task.__init__-115"><a href="#Task.__init__-115"><span class="linenos">115</span></a><span class="sd">            a model</span>
</span><span id="Task.__init__-116"><a href="#Task.__init__-116"><span class="linenos">116</span></a><span class="sd">        loss : callable</span>
</span><span id="Task.__init__-117"><a href="#Task.__init__-117"><span class="linenos">117</span></a><span class="sd">            a loss function</span>
</span><span id="Task.__init__-118"><a href="#Task.__init__-118"><span class="linenos">118</span></a><span class="sd">        num_epochs : int, default 0</span>
</span><span id="Task.__init__-119"><a href="#Task.__init__-119"><span class="linenos">119</span></a><span class="sd">            the number of epochs</span>
</span><span id="Task.__init__-120"><a href="#Task.__init__-120"><span class="linenos">120</span></a><span class="sd">        transformer : dlc2action.transformer.base_transformer.Transformer, optional</span>
</span><span id="Task.__init__-121"><a href="#Task.__init__-121"><span class="linenos">121</span></a><span class="sd">            a transformer</span>
</span><span id="Task.__init__-122"><a href="#Task.__init__-122"><span class="linenos">122</span></a><span class="sd">        ssl_losses : list, optional</span>
</span><span id="Task.__init__-123"><a href="#Task.__init__-123"><span class="linenos">123</span></a><span class="sd">            a list of SSL losses</span>
</span><span id="Task.__init__-124"><a href="#Task.__init__-124"><span class="linenos">124</span></a><span class="sd">        ssl_weights : list, optional</span>
</span><span id="Task.__init__-125"><a href="#Task.__init__-125"><span class="linenos">125</span></a><span class="sd">            a list of SSL weights (if not provided initializes to 1)</span>
</span><span id="Task.__init__-126"><a href="#Task.__init__-126"><span class="linenos">126</span></a><span class="sd">        lr : float, default 1e-3</span>
</span><span id="Task.__init__-127"><a href="#Task.__init__-127"><span class="linenos">127</span></a><span class="sd">            learning rate</span>
</span><span id="Task.__init__-128"><a href="#Task.__init__-128"><span class="linenos">128</span></a><span class="sd">        metrics : dict, optional</span>
</span><span id="Task.__init__-129"><a href="#Task.__init__-129"><span class="linenos">129</span></a><span class="sd">            a list of metric functions</span>
</span><span id="Task.__init__-130"><a href="#Task.__init__-130"><span class="linenos">130</span></a><span class="sd">        val_dataloader : torch.utils.data.DataLoader, optional</span>
</span><span id="Task.__init__-131"><a href="#Task.__init__-131"><span class="linenos">131</span></a><span class="sd">            a validation dataloader</span>
</span><span id="Task.__init__-132"><a href="#Task.__init__-132"><span class="linenos">132</span></a><span class="sd">        optimizer : torch.optim.Optimizer, optional</span>
</span><span id="Task.__init__-133"><a href="#Task.__init__-133"><span class="linenos">133</span></a><span class="sd">            an optimizer (`Adam` by default)</span>
</span><span id="Task.__init__-134"><a href="#Task.__init__-134"><span class="linenos">134</span></a><span class="sd">        device : str, default &#39;cuda&#39;</span>
</span><span id="Task.__init__-135"><a href="#Task.__init__-135"><span class="linenos">135</span></a><span class="sd">            the device to train the model on</span>
</span><span id="Task.__init__-136"><a href="#Task.__init__-136"><span class="linenos">136</span></a><span class="sd">        verbose : bool, default True</span>
</span><span id="Task.__init__-137"><a href="#Task.__init__-137"><span class="linenos">137</span></a><span class="sd">            if `True`, the process is described in standard output</span>
</span><span id="Task.__init__-138"><a href="#Task.__init__-138"><span class="linenos">138</span></a><span class="sd">        log_file : str, optional</span>
</span><span id="Task.__init__-139"><a href="#Task.__init__-139"><span class="linenos">139</span></a><span class="sd">            the path to a text file where the process will be logged</span>
</span><span id="Task.__init__-140"><a href="#Task.__init__-140"><span class="linenos">140</span></a><span class="sd">        augment_train : {1, 0}</span>
</span><span id="Task.__init__-141"><a href="#Task.__init__-141"><span class="linenos">141</span></a><span class="sd">            number of augmentations to apply at training</span>
</span><span id="Task.__init__-142"><a href="#Task.__init__-142"><span class="linenos">142</span></a><span class="sd">        augment_val : int, default 0</span>
</span><span id="Task.__init__-143"><a href="#Task.__init__-143"><span class="linenos">143</span></a><span class="sd">            number of augmentations to apply at validation</span>
</span><span id="Task.__init__-144"><a href="#Task.__init__-144"><span class="linenos">144</span></a><span class="sd">        validation_interval : int, default 1</span>
</span><span id="Task.__init__-145"><a href="#Task.__init__-145"><span class="linenos">145</span></a><span class="sd">            every time this number of epochs passes, validation metrics are computed</span>
</span><span id="Task.__init__-146"><a href="#Task.__init__-146"><span class="linenos">146</span></a><span class="sd">        predict_function : callable, optional</span>
</span><span id="Task.__init__-147"><a href="#Task.__init__-147"><span class="linenos">147</span></a><span class="sd">            a function that maps probabilities to class predictions (if not provided, a default is generated)</span>
</span><span id="Task.__init__-148"><a href="#Task.__init__-148"><span class="linenos">148</span></a><span class="sd">        primary_predict_function : callable, optional</span>
</span><span id="Task.__init__-149"><a href="#Task.__init__-149"><span class="linenos">149</span></a><span class="sd">            a function that maps model output to probabilities (if not provided, initialized as identity)</span>
</span><span id="Task.__init__-150"><a href="#Task.__init__-150"><span class="linenos">150</span></a><span class="sd">        exclusive : bool, default True</span>
</span><span id="Task.__init__-151"><a href="#Task.__init__-151"><span class="linenos">151</span></a><span class="sd">            set to False for multi-label classification</span>
</span><span id="Task.__init__-152"><a href="#Task.__init__-152"><span class="linenos">152</span></a><span class="sd">        ignore_tags : bool, default False</span>
</span><span id="Task.__init__-153"><a href="#Task.__init__-153"><span class="linenos">153</span></a><span class="sd">            if `True`, samples with different meta tags will be mixed in batches</span>
</span><span id="Task.__init__-154"><a href="#Task.__init__-154"><span class="linenos">154</span></a><span class="sd">        threshold : float, default 0.5</span>
</span><span id="Task.__init__-155"><a href="#Task.__init__-155"><span class="linenos">155</span></a><span class="sd">            the threshold used for multi-label classification default prediction function</span>
</span><span id="Task.__init__-156"><a href="#Task.__init__-156"><span class="linenos">156</span></a><span class="sd">        model_save_path : str, optional</span>
</span><span id="Task.__init__-157"><a href="#Task.__init__-157"><span class="linenos">157</span></a><span class="sd">            the path to the folder where model checkpoints will be saved (checkpoints will not be saved if the path</span>
</span><span id="Task.__init__-158"><a href="#Task.__init__-158"><span class="linenos">158</span></a><span class="sd">            is not provided)</span>
</span><span id="Task.__init__-159"><a href="#Task.__init__-159"><span class="linenos">159</span></a><span class="sd">        model_save_epochs : int, default 5</span>
</span><span id="Task.__init__-160"><a href="#Task.__init__-160"><span class="linenos">160</span></a><span class="sd">            the interval for saving the model checkpoints (the last epoch is always saved)</span>
</span><span id="Task.__init__-161"><a href="#Task.__init__-161"><span class="linenos">161</span></a><span class="sd">        pseudolabel : bool, default False</span>
</span><span id="Task.__init__-162"><a href="#Task.__init__-162"><span class="linenos">162</span></a><span class="sd">            if True, the pseudolabeling procedure will be applied</span>
</span><span id="Task.__init__-163"><a href="#Task.__init__-163"><span class="linenos">163</span></a><span class="sd">        pseudolabel_start : int, default 100</span>
</span><span id="Task.__init__-164"><a href="#Task.__init__-164"><span class="linenos">164</span></a><span class="sd">            pseudolabeling starts after this epoch</span>
</span><span id="Task.__init__-165"><a href="#Task.__init__-165"><span class="linenos">165</span></a><span class="sd">        correction_interval : int, default 1</span>
</span><span id="Task.__init__-166"><a href="#Task.__init__-166"><span class="linenos">166</span></a><span class="sd">            after this number of epochs, if the pseudolabeling is on, the model is trained on the labeled data and</span>
</span><span id="Task.__init__-167"><a href="#Task.__init__-167"><span class="linenos">167</span></a><span class="sd">            new pseudolabels are generated</span>
</span><span id="Task.__init__-168"><a href="#Task.__init__-168"><span class="linenos">168</span></a><span class="sd">        pseudolabel_alpha_f : float, default 3</span>
</span><span id="Task.__init__-169"><a href="#Task.__init__-169"><span class="linenos">169</span></a><span class="sd">            the maximum value of pseudolabeling alpha</span>
</span><span id="Task.__init__-170"><a href="#Task.__init__-170"><span class="linenos">170</span></a><span class="sd">        alpha_growth_stop : int, default 600</span>
</span><span id="Task.__init__-171"><a href="#Task.__init__-171"><span class="linenos">171</span></a><span class="sd">            pseudolabeling alpha stops growing after this epoch</span>
</span><span id="Task.__init__-172"><a href="#Task.__init__-172"><span class="linenos">172</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.__init__-173"><a href="#Task.__init__-173"><span class="linenos">173</span></a>
</span><span id="Task.__init__-174"><a href="#Task.__init__-174"><span class="linenos">174</span></a>        <span class="c1"># pseudolabeling might be buggy right now -- not using it!</span>
</span><span id="Task.__init__-175"><a href="#Task.__init__-175"><span class="linenos">175</span></a>        <span class="k">if</span> <span class="n">skip_metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.__init__-176"><a href="#Task.__init__-176"><span class="linenos">176</span></a>            <span class="n">skip_metrics</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Task.__init__-177"><a href="#Task.__init__-177"><span class="linenos">177</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">train_dataloader</span>
</span><span id="Task.__init__-178"><a href="#Task.__init__-178"><span class="linenos">178</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span> <span class="o">=</span> <span class="n">val_dataloader</span>
</span><span id="Task.__init__-179"><a href="#Task.__init__-179"><span class="linenos">179</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_dataloader</span> <span class="o">=</span> <span class="n">test_dataloader</span>
</span><span id="Task.__init__-180"><a href="#Task.__init__-180"><span class="linenos">180</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="o">=</span> <span class="n">transformer</span>
</span><span id="Task.__init__-181"><a href="#Task.__init__-181"><span class="linenos">181</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_epochs</span> <span class="o">=</span> <span class="n">num_epochs</span>
</span><span id="Task.__init__-182"><a href="#Task.__init__-182"><span class="linenos">182</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">skip_metrics</span> <span class="o">=</span> <span class="n">skip_metrics</span>
</span><span id="Task.__init__-183"><a href="#Task.__init__-183"><span class="linenos">183</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
</span><span id="Task.__init__-184"><a href="#Task.__init__-184"><span class="linenos">184</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">augment_train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">augment_train</span><span class="p">)</span>
</span><span id="Task.__init__-185"><a href="#Task.__init__-185"><span class="linenos">185</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">augment_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">augment_val</span><span class="p">)</span>
</span><span id="Task.__init__-186"><a href="#Task.__init__-186"><span class="linenos">186</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_tags</span> <span class="o">=</span> <span class="n">ignore_tags</span>
</span><span id="Task.__init__-187"><a href="#Task.__init__-187"><span class="linenos">187</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validation_interval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">validation_interval</span><span class="p">)</span>
</span><span id="Task.__init__-188"><a href="#Task.__init__-188"><span class="linenos">188</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="n">log_file</span>
</span><span id="Task.__init__-189"><a href="#Task.__init__-189"><span class="linenos">189</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span>
</span><span id="Task.__init__-190"><a href="#Task.__init__-190"><span class="linenos">190</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span> <span class="o">=</span> <span class="n">model_save_path</span>
</span><span id="Task.__init__-191"><a href="#Task.__init__-191"><span class="linenos">191</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_save_epochs</span> <span class="o">=</span> <span class="n">model_save_epochs</span>
</span><span id="Task.__init__-192"><a href="#Task.__init__-192"><span class="linenos">192</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Task.__init__-193"><a href="#Task.__init__-193"><span class="linenos">193</span></a>
</span><span id="Task.__init__-194"><a href="#Task.__init__-194"><span class="linenos">194</span></a>        <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.__init__-195"><a href="#Task.__init__-195"><span class="linenos">195</span></a>            <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Task.__init__-196"><a href="#Task.__init__-196"><span class="linenos">196</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics</span>
</span><span id="Task.__init__-197"><a href="#Task.__init__-197"><span class="linenos">197</span></a>
</span><span id="Task.__init__-198"><a href="#Task.__init__-198"><span class="linenos">198</span></a>        <span class="k">if</span> <span class="n">optimizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.__init__-199"><a href="#Task.__init__-199"><span class="linenos">199</span></a>            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span>
</span><span id="Task.__init__-200"><a href="#Task.__init__-200"><span class="linenos">200</span></a>
</span><span id="Task.__init__-201"><a href="#Task.__init__-201"><span class="linenos">201</span></a>        <span class="k">if</span> <span class="n">ssl_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.__init__-202"><a href="#Task.__init__-202"><span class="linenos">202</span></a>            <span class="n">ssl_weights</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ssl_losses</span><span class="p">]</span>
</span><span id="Task.__init__-203"><a href="#Task.__init__-203"><span class="linenos">203</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ssl_weights</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
</span><span id="Task.__init__-204"><a href="#Task.__init__-204"><span class="linenos">204</span></a>            <span class="n">ssl_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">ssl_weights</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ssl_losses</span><span class="p">]</span>
</span><span id="Task.__init__-205"><a href="#Task.__init__-205"><span class="linenos">205</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ssl_weights</span> <span class="o">=</span> <span class="n">ssl_weights</span>
</span><span id="Task.__init__-206"><a href="#Task.__init__-206"><span class="linenos">206</span></a>
</span><span id="Task.__init__-207"><a href="#Task.__init__-207"><span class="linenos">207</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_class</span> <span class="o">=</span> <span class="n">optimizer</span>
</span><span id="Task.__init__-208"><a href="#Task.__init__-208"><span class="linenos">208</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span>
</span><span id="Task.__init__-209"><a href="#Task.__init__-209"><span class="linenos">209</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
</span><span id="Task.__init__-210"><a href="#Task.__init__-210"><span class="linenos">210</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">LoadedModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
</span><span id="Task.__init__-211"><a href="#Task.__init__-211"><span class="linenos">211</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task.__init__-212"><a href="#Task.__init__-212"><span class="linenos">212</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">set_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="Task.__init__-213"><a href="#Task.__init__-213"><span class="linenos">213</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="n">parallel</span>
</span><span id="Task.__init__-214"><a href="#Task.__init__-214"><span class="linenos">214</span></a>
</span><span id="Task.__init__-215"><a href="#Task.__init__-215"><span class="linenos">215</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.__init__-216"><a href="#Task.__init__-216"><span class="linenos">216</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">augment_val</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Task.__init__-217"><a href="#Task.__init__-217"><span class="linenos">217</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">augment_train</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Task.__init__-218"><a href="#Task.__init__-218"><span class="linenos">218</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="o">=</span> <span class="n">EmptyTransformer</span><span class="p">()</span>
</span><span id="Task.__init__-219"><a href="#Task.__init__-219"><span class="linenos">219</span></a>
</span><span id="Task.__init__-220"><a href="#Task.__init__-220"><span class="linenos">220</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">augment_train</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Task.__init__-221"><a href="#Task.__init__-221"><span class="linenos">221</span></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="Task.__init__-222"><a href="#Task.__init__-222"><span class="linenos">222</span></a>                <span class="s1">&#39;The &quot;augment_train&quot; parameter is too large -&gt; setting it to 1.&#39;</span>
</span><span id="Task.__init__-223"><a href="#Task.__init__-223"><span class="linenos">223</span></a>            <span class="p">)</span>
</span><span id="Task.__init__-224"><a href="#Task.__init__-224"><span class="linenos">224</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">augment_train</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Task.__init__-225"><a href="#Task.__init__-225"><span class="linenos">225</span></a>
</span><span id="Task.__init__-226"><a href="#Task.__init__-226"><span class="linenos">226</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Task.__init__-227"><a href="#Task.__init__-227"><span class="linenos">227</span></a>            <span class="k">if</span> <span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
</span><span id="Task.__init__-228"><a href="#Task.__init__-228"><span class="linenos">228</span></a>                <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
</span><span id="Task.__init__-229"><a href="#Task.__init__-229"><span class="linenos">229</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="Task.__init__-230"><a href="#Task.__init__-230"><span class="linenos">230</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="Task.__init__-231"><a href="#Task.__init__-231"><span class="linenos">231</span></a>            <span class="k">raise</span> <span class="p">(</span><span class="s2">&quot;The format of the device is incorrect&quot;</span><span class="p">)</span>
</span><span id="Task.__init__-232"><a href="#Task.__init__-232"><span class="linenos">232</span></a>
</span><span id="Task.__init__-233"><a href="#Task.__init__-233"><span class="linenos">233</span></a>        <span class="k">if</span> <span class="n">ssl_losses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.__init__-234"><a href="#Task.__init__-234"><span class="linenos">234</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ssl_losses</span> <span class="o">=</span> <span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Task.__init__-235"><a href="#Task.__init__-235"><span class="linenos">235</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task.__init__-236"><a href="#Task.__init__-236"><span class="linenos">236</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ssl_losses</span> <span class="o">=</span> <span class="n">ssl_losses</span>
</span><span id="Task.__init__-237"><a href="#Task.__init__-237"><span class="linenos">237</span></a>
</span><span id="Task.__init__-238"><a href="#Task.__init__-238"><span class="linenos">238</span></a>        <span class="k">if</span> <span class="n">primary_predict_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.__init__-239"><a href="#Task.__init__-239"><span class="linenos">239</span></a>            <span class="k">if</span> <span class="n">exclusive</span><span class="p">:</span>
</span><span id="Task.__init__-240"><a href="#Task.__init__-240"><span class="linenos">240</span></a>                <span class="n">primary_predict_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Softmax</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Task.__init__-241"><a href="#Task.__init__-241"><span class="linenos">241</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Task.__init__-242"><a href="#Task.__init__-242"><span class="linenos">242</span></a>                <span class="n">primary_predict_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="Task.__init__-243"><a href="#Task.__init__-243"><span class="linenos">243</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">primary_predict_function</span> <span class="o">=</span> <span class="n">primary_predict_function</span>
</span><span id="Task.__init__-244"><a href="#Task.__init__-244"><span class="linenos">244</span></a>
</span><span id="Task.__init__-245"><a href="#Task.__init__-245"><span class="linenos">245</span></a>        <span class="k">if</span> <span class="n">predict_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.__init__-246"><a href="#Task.__init__-246"><span class="linenos">246</span></a>            <span class="k">if</span> <span class="n">exclusive</span><span class="p">:</span>
</span><span id="Task.__init__-247"><a href="#Task.__init__-247"><span class="linenos">247</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">predict_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Task.__init__-248"><a href="#Task.__init__-248"><span class="linenos">248</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Task.__init__-249"><a href="#Task.__init__-249"><span class="linenos">249</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">predict_function</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">int</span><span class="p">()</span>
</span><span id="Task.__init__-250"><a href="#Task.__init__-250"><span class="linenos">250</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task.__init__-251"><a href="#Task.__init__-251"><span class="linenos">251</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">predict_function</span> <span class="o">=</span> <span class="n">predict_function</span>
</span><span id="Task.__init__-252"><a href="#Task.__init__-252"><span class="linenos">252</span></a>
</span><span id="Task.__init__-253"><a href="#Task.__init__-253"><span class="linenos">253</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pseudolabel</span> <span class="o">=</span> <span class="n">pseudolabel</span>
</span><span id="Task.__init__-254"><a href="#Task.__init__-254"><span class="linenos">254</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_f</span> <span class="o">=</span> <span class="n">pseudolabel_alpha_f</span>
</span><span id="Task.__init__-255"><a href="#Task.__init__-255"><span class="linenos">255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">T2</span> <span class="o">=</span> <span class="n">alpha_growth_stop</span>
</span><span id="Task.__init__-256"><a href="#Task.__init__-256"><span class="linenos">256</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">T1</span> <span class="o">=</span> <span class="n">pseudolabel_start</span>
</span><span id="Task.__init__-257"><a href="#Task.__init__-257"><span class="linenos">257</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">correction_interval</span>
</span><span id="Task.__init__-258"><a href="#Task.__init__-258"><span class="linenos">258</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">T2</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T1</span><span class="p">:</span>
</span><span id="Task.__init__-259"><a href="#Task.__init__-259"><span class="linenos">259</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Task.__init__-260"><a href="#Task.__init__-260"><span class="linenos">260</span></a>                <span class="sa">f</span><span class="s2">&quot;The pseudolabel_start parameter has to be smaller than alpha_growth_stop; got &quot;</span>
</span><span id="Task.__init__-261"><a href="#Task.__init__-261"><span class="linenos">261</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pseudolabel_start</span><span class="si">=}</span><span class="s2"> and </span><span class="si">{</span><span class="n">alpha_growth_stop</span><span class="si">=}</span><span class="s2">&quot;</span>
</span><span id="Task.__init__-262"><a href="#Task.__init__-262"><span class="linenos">262</span></a>            <span class="p">)</span>
</span><span id="Task.__init__-263"><a href="#Task.__init__-263"><span class="linenos">263</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decision_thresholds</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()]</span>
</span></pre></div>


            <div class="docstring"><h2 id="parameters">Parameters</h2>

<p>train_dataloader : torch.utils.data.DataLoader
    a training dataloader
model : <a href="../model/base_model.html#Model">dlc2action.model.base_model.Model</a>
    a model
loss : callable
    a loss function
num_epochs : int, default 0
    the number of epochs
transformer : <a href="../transformer/base_transformer.html#Transformer">dlc2action.transformer.base_transformer.Transformer</a>, optional
    a transformer
ssl_losses : list, optional
    a list of SSL losses
ssl_weights : list, optional
    a list of SSL weights (if not provided initializes to 1)
lr : float, default 1e-3
    learning rate
metrics : dict, optional
    a list of metric functions
val_dataloader : torch.utils.data.DataLoader, optional
    a validation dataloader
optimizer : torch.optim.Optimizer, optional
    an optimizer (<code>Adam</code> by default)
device : str, default 'cuda'
    the device to train the model on
verbose : bool, default True
    if <code>True</code>, the process is described in standard output
log_file : str, optional
    the path to a text file where the process will be logged
augment_train : {1, 0}
    number of augmentations to apply at training
augment_val : int, default 0
    number of augmentations to apply at validation
validation_interval : int, default 1
    every time this number of epochs passes, validation metrics are computed
predict_function : callable, optional
    a function that maps probabilities to class predictions (if not provided, a default is generated)
primary_predict_function : callable, optional
    a function that maps model output to probabilities (if not provided, initialized as identity)
exclusive : bool, default True
    set to False for multi-label classification
ignore_tags : bool, default False
    if <code>True</code>, samples with different meta tags will be mixed in batches
threshold : float, default 0.5
    the threshold used for multi-label classification default prediction function
model_save_path : str, optional
    the path to the folder where model checkpoints will be saved (checkpoints will not be saved if the path
    is not provided)
model_save_epochs : int, default 5
    the interval for saving the model checkpoints (the last epoch is always saved)
pseudolabel : bool, default False
    if True, the pseudolabeling procedure will be applied
pseudolabel_start : int, default 100
    pseudolabeling starts after this epoch
correction_interval : int, default 1
    after this number of epochs, if the pseudolabeling is on, the model is trained on the labeled data and
    new pseudolabels are generated
pseudolabel_alpha_f : float, default 3
    the maximum value of pseudolabeling alpha
alpha_growth_stop : int, default 600
    pseudolabeling alpha stops growing after this epoch</p>
</div>


                            </div>
                            <div id="Task.save_checkpoint" class="classattr">
                                        <input id="Task.save_checkpoint-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_checkpoint</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">checkpoint_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Task.save_checkpoint-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.save_checkpoint"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.save_checkpoint-265"><a href="#Task.save_checkpoint-265"><span class="linenos">265</span></a>    <span class="k">def</span> <span class="nf">save_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.save_checkpoint-266"><a href="#Task.save_checkpoint-266"><span class="linenos">266</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.save_checkpoint-267"><a href="#Task.save_checkpoint-267"><span class="linenos">267</span></a><span class="sd">        Save a general checkpoint</span>
</span><span id="Task.save_checkpoint-268"><a href="#Task.save_checkpoint-268"><span class="linenos">268</span></a>
</span><span id="Task.save_checkpoint-269"><a href="#Task.save_checkpoint-269"><span class="linenos">269</span></a><span class="sd">        Parameters</span>
</span><span id="Task.save_checkpoint-270"><a href="#Task.save_checkpoint-270"><span class="linenos">270</span></a><span class="sd">        ----------</span>
</span><span id="Task.save_checkpoint-271"><a href="#Task.save_checkpoint-271"><span class="linenos">271</span></a><span class="sd">        checkpoint_path : str</span>
</span><span id="Task.save_checkpoint-272"><a href="#Task.save_checkpoint-272"><span class="linenos">272</span></a><span class="sd">            the path where the checkpoint will be saved</span>
</span><span id="Task.save_checkpoint-273"><a href="#Task.save_checkpoint-273"><span class="linenos">273</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.save_checkpoint-274"><a href="#Task.save_checkpoint-274"><span class="linenos">274</span></a>
</span><span id="Task.save_checkpoint-275"><a href="#Task.save_checkpoint-275"><span class="linenos">275</span></a>        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
</span><span id="Task.save_checkpoint-276"><a href="#Task.save_checkpoint-276"><span class="linenos">276</span></a>            <span class="p">{</span>
</span><span id="Task.save_checkpoint-277"><a href="#Task.save_checkpoint-277"><span class="linenos">277</span></a>                <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span>
</span><span id="Task.save_checkpoint-278"><a href="#Task.save_checkpoint-278"><span class="linenos">278</span></a>                <span class="s2">&quot;model_state_dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
</span><span id="Task.save_checkpoint-279"><a href="#Task.save_checkpoint-279"><span class="linenos">279</span></a>                <span class="s2">&quot;optimizer_state_dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
</span><span id="Task.save_checkpoint-280"><a href="#Task.save_checkpoint-280"><span class="linenos">280</span></a>            <span class="p">},</span>
</span><span id="Task.save_checkpoint-281"><a href="#Task.save_checkpoint-281"><span class="linenos">281</span></a>            <span class="n">checkpoint_path</span><span class="p">,</span>
</span><span id="Task.save_checkpoint-282"><a href="#Task.save_checkpoint-282"><span class="linenos">282</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save a general checkpoint</p>

<h2 id="parameters">Parameters</h2>

<p>checkpoint_path : str
    the path where the checkpoint will be saved</p>
</div>


                            </div>
                            <div id="Task.load_from_checkpoint" class="classattr">
                                        <input id="Task.load_from_checkpoint-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load_from_checkpoint</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">checkpoint_path</span>,</span><span class="param">	<span class="n">only_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">load_strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Task.load_from_checkpoint-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.load_from_checkpoint"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.load_from_checkpoint-284"><a href="#Task.load_from_checkpoint-284"><span class="linenos">284</span></a>    <span class="k">def</span> <span class="nf">load_from_checkpoint</span><span class="p">(</span>
</span><span id="Task.load_from_checkpoint-285"><a href="#Task.load_from_checkpoint-285"><span class="linenos">285</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">only_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">load_strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Task.load_from_checkpoint-286"><a href="#Task.load_from_checkpoint-286"><span class="linenos">286</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.load_from_checkpoint-287"><a href="#Task.load_from_checkpoint-287"><span class="linenos">287</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.load_from_checkpoint-288"><a href="#Task.load_from_checkpoint-288"><span class="linenos">288</span></a><span class="sd">        Load from a checkpoint</span>
</span><span id="Task.load_from_checkpoint-289"><a href="#Task.load_from_checkpoint-289"><span class="linenos">289</span></a>
</span><span id="Task.load_from_checkpoint-290"><a href="#Task.load_from_checkpoint-290"><span class="linenos">290</span></a><span class="sd">        Parameters</span>
</span><span id="Task.load_from_checkpoint-291"><a href="#Task.load_from_checkpoint-291"><span class="linenos">291</span></a><span class="sd">        ----------</span>
</span><span id="Task.load_from_checkpoint-292"><a href="#Task.load_from_checkpoint-292"><span class="linenos">292</span></a><span class="sd">        checkpoint_path : str</span>
</span><span id="Task.load_from_checkpoint-293"><a href="#Task.load_from_checkpoint-293"><span class="linenos">293</span></a><span class="sd">            the path to the checkpoint</span>
</span><span id="Task.load_from_checkpoint-294"><a href="#Task.load_from_checkpoint-294"><span class="linenos">294</span></a><span class="sd">        only_model : bool, default False</span>
</span><span id="Task.load_from_checkpoint-295"><a href="#Task.load_from_checkpoint-295"><span class="linenos">295</span></a><span class="sd">            if `True`, only the model state dictionary will be loaded (and not the epoch and the optimizer state</span>
</span><span id="Task.load_from_checkpoint-296"><a href="#Task.load_from_checkpoint-296"><span class="linenos">296</span></a><span class="sd">            dictionary)</span>
</span><span id="Task.load_from_checkpoint-297"><a href="#Task.load_from_checkpoint-297"><span class="linenos">297</span></a><span class="sd">        load_strict : bool, default True</span>
</span><span id="Task.load_from_checkpoint-298"><a href="#Task.load_from_checkpoint-298"><span class="linenos">298</span></a><span class="sd">            if `True`, any inconsistencies in state dictionaries are regarded as errors</span>
</span><span id="Task.load_from_checkpoint-299"><a href="#Task.load_from_checkpoint-299"><span class="linenos">299</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.load_from_checkpoint-300"><a href="#Task.load_from_checkpoint-300"><span class="linenos">300</span></a>
</span><span id="Task.load_from_checkpoint-301"><a href="#Task.load_from_checkpoint-301"><span class="linenos">301</span></a>        <span class="k">if</span> <span class="n">checkpoint_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.load_from_checkpoint-302"><a href="#Task.load_from_checkpoint-302"><span class="linenos">302</span></a>            <span class="k">return</span>
</span><span id="Task.load_from_checkpoint-303"><a href="#Task.load_from_checkpoint-303"><span class="linenos">303</span></a>        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Task.load_from_checkpoint-304"><a href="#Task.load_from_checkpoint-304"><span class="linenos">304</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Task.load_from_checkpoint-305"><a href="#Task.load_from_checkpoint-305"><span class="linenos">305</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;model_state_dict&quot;</span><span class="p">],</span> <span class="n">strict</span><span class="o">=</span><span class="n">load_strict</span><span class="p">)</span>
</span><span id="Task.load_from_checkpoint-306"><a href="#Task.load_from_checkpoint-306"><span class="linenos">306</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">only_model</span><span class="p">:</span>
</span><span id="Task.load_from_checkpoint-307"><a href="#Task.load_from_checkpoint-307"><span class="linenos">307</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;optimizer_state_dict&quot;</span><span class="p">])</span>
</span><span id="Task.load_from_checkpoint-308"><a href="#Task.load_from_checkpoint-308"><span class="linenos">308</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Load from a checkpoint</p>

<h2 id="parameters">Parameters</h2>

<p>checkpoint_path : str
    the path to the checkpoint
only_model : bool, default False
    if <code>True</code>, only the model state dictionary will be loaded (and not the epoch and the optimizer state
    dictionary)
load_strict : bool, default True
    if <code>True</code>, any inconsistencies in state dictionaries are regarded as errors</p>
</div>


                            </div>
                            <div id="Task.save_model" class="classattr">
                                        <input id="Task.save_model-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_model</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Task.save_model-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.save_model"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.save_model-310"><a href="#Task.save_model-310"><span class="linenos">310</span></a>    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.save_model-311"><a href="#Task.save_model-311"><span class="linenos">311</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.save_model-312"><a href="#Task.save_model-312"><span class="linenos">312</span></a><span class="sd">        Save the model state dictionary</span>
</span><span id="Task.save_model-313"><a href="#Task.save_model-313"><span class="linenos">313</span></a>
</span><span id="Task.save_model-314"><a href="#Task.save_model-314"><span class="linenos">314</span></a><span class="sd">        Parameters</span>
</span><span id="Task.save_model-315"><a href="#Task.save_model-315"><span class="linenos">315</span></a><span class="sd">        ----------</span>
</span><span id="Task.save_model-316"><a href="#Task.save_model-316"><span class="linenos">316</span></a><span class="sd">        save_path : str</span>
</span><span id="Task.save_model-317"><a href="#Task.save_model-317"><span class="linenos">317</span></a><span class="sd">            the path where the state will be saved</span>
</span><span id="Task.save_model-318"><a href="#Task.save_model-318"><span class="linenos">318</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.save_model-319"><a href="#Task.save_model-319"><span class="linenos">319</span></a>
</span><span id="Task.save_model-320"><a href="#Task.save_model-320"><span class="linenos">320</span></a>        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">save_path</span><span class="p">)</span>
</span><span id="Task.save_model-321"><a href="#Task.save_model-321"><span class="linenos">321</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;saved the model successfully&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save the model state dictionary</p>

<h2 id="parameters">Parameters</h2>

<p>save_path : str
    the path where the state will be saved</p>
</div>


                            </div>
                            <div id="Task.train" class="classattr">
                                        <input id="Task.train-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">train</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">trial</span><span class="p">:</span> <span class="n">optuna</span><span class="o">.</span><span class="n">trial</span><span class="o">.</span><span class="n">_trial</span><span class="o">.</span><span class="n">Trial</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">optimized_metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">to_ram</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">autostop_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>,</span><span class="param">	<span class="n">autostop_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span>,</span><span class="param">	<span class="n">autostop_metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">main_task_on</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">ssl_on</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">temporal_subsampling_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">loading_bar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="n">Tuple</span>:</span></span>

                <label class="view-source-button" for="Task.train-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.train"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.train-602"><a href="#Task.train-602"><span class="linenos">602</span></a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span>
</span><span id="Task.train-603"><a href="#Task.train-603"><span class="linenos">603</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Task.train-604"><a href="#Task.train-604"><span class="linenos">604</span></a>        <span class="n">trial</span><span class="p">:</span> <span class="n">Trial</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.train-605"><a href="#Task.train-605"><span class="linenos">605</span></a>        <span class="n">optimized_metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.train-606"><a href="#Task.train-606"><span class="linenos">606</span></a>        <span class="n">to_ram</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task.train-607"><a href="#Task.train-607"><span class="linenos">607</span></a>        <span class="n">autostop_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
</span><span id="Task.train-608"><a href="#Task.train-608"><span class="linenos">608</span></a>        <span class="n">autostop_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span>
</span><span id="Task.train-609"><a href="#Task.train-609"><span class="linenos">609</span></a>        <span class="n">autostop_metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.train-610"><a href="#Task.train-610"><span class="linenos">610</span></a>        <span class="n">main_task_on</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Task.train-611"><a href="#Task.train-611"><span class="linenos">611</span></a>        <span class="n">ssl_on</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Task.train-612"><a href="#Task.train-612"><span class="linenos">612</span></a>        <span class="n">temporal_subsampling_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.train-613"><a href="#Task.train-613"><span class="linenos">613</span></a>        <span class="n">loading_bar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task.train-614"><a href="#Task.train-614"><span class="linenos">614</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
</span><span id="Task.train-615"><a href="#Task.train-615"><span class="linenos">615</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.train-616"><a href="#Task.train-616"><span class="linenos">616</span></a><span class="sd">        Train the task and return a log of epoch-average loss and metric</span>
</span><span id="Task.train-617"><a href="#Task.train-617"><span class="linenos">617</span></a>
</span><span id="Task.train-618"><a href="#Task.train-618"><span class="linenos">618</span></a><span class="sd">        You can use the autostop parameters to finish training when the parameters are not improving. It will be</span>
</span><span id="Task.train-619"><a href="#Task.train-619"><span class="linenos">619</span></a><span class="sd">        stopped if the average value of `autostop_metric` over the last `autostop_interval` epochs is smaller than</span>
</span><span id="Task.train-620"><a href="#Task.train-620"><span class="linenos">620</span></a><span class="sd">        the average over the previous `autostop_interval` epochs + `autostop_threshold`. For example, if the</span>
</span><span id="Task.train-621"><a href="#Task.train-621"><span class="linenos">621</span></a><span class="sd">        current epoch is 120 and `autostop_interval` is 50, the averages over epochs 70-120 and 20-70 will be compared.</span>
</span><span id="Task.train-622"><a href="#Task.train-622"><span class="linenos">622</span></a>
</span><span id="Task.train-623"><a href="#Task.train-623"><span class="linenos">623</span></a><span class="sd">        Parameters</span>
</span><span id="Task.train-624"><a href="#Task.train-624"><span class="linenos">624</span></a><span class="sd">        ----------</span>
</span><span id="Task.train-625"><a href="#Task.train-625"><span class="linenos">625</span></a><span class="sd">        trial : Trial</span>
</span><span id="Task.train-626"><a href="#Task.train-626"><span class="linenos">626</span></a><span class="sd">            an `optuna` trial (for hyperparameter searches)</span>
</span><span id="Task.train-627"><a href="#Task.train-627"><span class="linenos">627</span></a><span class="sd">        optimized_metric : str</span>
</span><span id="Task.train-628"><a href="#Task.train-628"><span class="linenos">628</span></a><span class="sd">            the name of the metric being optimized (for hyperparameter searches)</span>
</span><span id="Task.train-629"><a href="#Task.train-629"><span class="linenos">629</span></a><span class="sd">        to_ram : bool, default False</span>
</span><span id="Task.train-630"><a href="#Task.train-630"><span class="linenos">630</span></a><span class="sd">            if `True`, the dataset will be loaded in RAM (this speeds up the calculations but can lead to crashes</span>
</span><span id="Task.train-631"><a href="#Task.train-631"><span class="linenos">631</span></a><span class="sd">            if the dataset is too large)</span>
</span><span id="Task.train-632"><a href="#Task.train-632"><span class="linenos">632</span></a><span class="sd">        autostop_interval : int, default 50</span>
</span><span id="Task.train-633"><a href="#Task.train-633"><span class="linenos">633</span></a><span class="sd">            the number of epochs to average the autostop metric over</span>
</span><span id="Task.train-634"><a href="#Task.train-634"><span class="linenos">634</span></a><span class="sd">        autostop_threshold : float, default 0.001</span>
</span><span id="Task.train-635"><a href="#Task.train-635"><span class="linenos">635</span></a><span class="sd">            the autostop difference threshold</span>
</span><span id="Task.train-636"><a href="#Task.train-636"><span class="linenos">636</span></a><span class="sd">        autostop_metric : str, optional</span>
</span><span id="Task.train-637"><a href="#Task.train-637"><span class="linenos">637</span></a><span class="sd">            the autostop metric (can be any one of the tracked metrics of `&#39;loss&#39;`)</span>
</span><span id="Task.train-638"><a href="#Task.train-638"><span class="linenos">638</span></a><span class="sd">        main_task_on : bool, default True</span>
</span><span id="Task.train-639"><a href="#Task.train-639"><span class="linenos">639</span></a><span class="sd">            if `False`, the main task (action segmentation) will not be used in training</span>
</span><span id="Task.train-640"><a href="#Task.train-640"><span class="linenos">640</span></a><span class="sd">        ssl_on : bool, default True</span>
</span><span id="Task.train-641"><a href="#Task.train-641"><span class="linenos">641</span></a><span class="sd">            if `False`, the SSL task will not be used in training</span>
</span><span id="Task.train-642"><a href="#Task.train-642"><span class="linenos">642</span></a>
</span><span id="Task.train-643"><a href="#Task.train-643"><span class="linenos">643</span></a><span class="sd">        Returns</span>
</span><span id="Task.train-644"><a href="#Task.train-644"><span class="linenos">644</span></a><span class="sd">        -------</span>
</span><span id="Task.train-645"><a href="#Task.train-645"><span class="linenos">645</span></a><span class="sd">        loss_log: list</span>
</span><span id="Task.train-646"><a href="#Task.train-646"><span class="linenos">646</span></a><span class="sd">            a list of float loss function values for each epoch</span>
</span><span id="Task.train-647"><a href="#Task.train-647"><span class="linenos">647</span></a><span class="sd">        metrics_log: dict</span>
</span><span id="Task.train-648"><a href="#Task.train-648"><span class="linenos">648</span></a><span class="sd">            a dictionary of metric value logs (first-level keys are &#39;train&#39; and &#39;val&#39;, second-level keys are metric</span>
</span><span id="Task.train-649"><a href="#Task.train-649"><span class="linenos">649</span></a><span class="sd">            names, values are lists of function values)</span>
</span><span id="Task.train-650"><a href="#Task.train-650"><span class="linenos">650</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.train-651"><a href="#Task.train-651"><span class="linenos">651</span></a>
</span><span id="Task.train-652"><a href="#Task.train-652"><span class="linenos">652</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">):</span>
</span><span id="Task.train-653"><a href="#Task.train-653"><span class="linenos">653</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">MyDataParallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
</span><span id="Task.train-654"><a href="#Task.train-654"><span class="linenos">654</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Task.train-655"><a href="#Task.train-655"><span class="linenos">655</span></a>        <span class="k">assert</span> <span class="n">autostop_metric</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;loss&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>
</span><span id="Task.train-656"><a href="#Task.train-656"><span class="linenos">656</span></a>        <span class="n">autostop_interval</span> <span class="o">//=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_interval</span>
</span><span id="Task.train-657"><a href="#Task.train-657"><span class="linenos">657</span></a>        <span class="k">if</span> <span class="n">trial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">optimized_metric</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.train-658"><a href="#Task.train-658"><span class="linenos">658</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Task.train-659"><a href="#Task.train-659"><span class="linenos">659</span></a>                <span class="s2">&quot;You need to provide the optimized metric name (optimized_metric parameter) &quot;</span>
</span><span id="Task.train-660"><a href="#Task.train-660"><span class="linenos">660</span></a>                <span class="s2">&quot;for optuna pruning to work!&quot;</span>
</span><span id="Task.train-661"><a href="#Task.train-661"><span class="linenos">661</span></a>            <span class="p">)</span>
</span><span id="Task.train-662"><a href="#Task.train-662"><span class="linenos">662</span></a>        <span class="k">if</span> <span class="n">to_ram</span><span class="p">:</span>
</span><span id="Task.train-663"><a href="#Task.train-663"><span class="linenos">663</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;transferring datasets to RAM...&quot;</span><span class="p">)</span>
</span><span id="Task.train-664"><a href="#Task.train-664"><span class="linenos">664</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">to_ram</span><span class="p">()</span>
</span><span id="Task.train-665"><a href="#Task.train-665"><span class="linenos">665</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Task.train-666"><a href="#Task.train-666"><span class="linenos">666</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">to_ram</span><span class="p">()</span>
</span><span id="Task.train-667"><a href="#Task.train-667"><span class="linenos">667</span></a>        <span class="n">loss_log</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="Task.train-668"><a href="#Task.train-668"><span class="linenos">668</span></a>        <span class="n">metrics_log</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[]),</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[])}</span>
</span><span id="Task.train-669"><a href="#Task.train-669"><span class="linenos">669</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">main_task_on</span><span class="p">:</span>
</span><span id="Task.train-670"><a href="#Task.train-670"><span class="linenos">670</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">main_task_off</span><span class="p">()</span>
</span><span id="Task.train-671"><a href="#Task.train-671"><span class="linenos">671</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">ssl_on</span><span class="p">:</span>
</span><span id="Task.train-672"><a href="#Task.train-672"><span class="linenos">672</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ssl_off</span><span class="p">()</span>
</span><span id="Task.train-673"><a href="#Task.train-673"><span class="linenos">673</span></a>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">:</span>
</span><span id="Task.train-674"><a href="#Task.train-674"><span class="linenos">674</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Task.train-675"><a href="#Task.train-675"><span class="linenos">675</span></a>            <span class="n">unlabeled</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Task.train-676"><a href="#Task.train-676"><span class="linenos">676</span></a>            <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Task.train-677"><a href="#Task.train-677"><span class="linenos">677</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudolabel</span><span class="p">:</span>
</span><span id="Task.train-678"><a href="#Task.train-678"><span class="linenos">678</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T1</span><span class="p">:</span>
</span><span id="Task.train-679"><a href="#Task.train-679"><span class="linenos">679</span></a>                    <span class="n">unlabeled</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">T1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">!=</span> <span class="mi">0</span>
</span><span id="Task.train-680"><a href="#Task.train-680"><span class="linenos">680</span></a>                    <span class="k">if</span> <span class="n">unlabeled</span><span class="p">:</span>
</span><span id="Task.train-681"><a href="#Task.train-681"><span class="linenos">681</span></a>                        <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alpha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
</span><span id="Task.train-682"><a href="#Task.train-682"><span class="linenos">682</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Task.train-683"><a href="#Task.train-683"><span class="linenos">683</span></a>                    <span class="n">unlabeled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Task.train-684"><a href="#Task.train-684"><span class="linenos">684</span></a>            <span class="n">epoch_loss</span><span class="p">,</span> <span class="n">epoch_ssl_loss</span><span class="p">,</span> <span class="n">epoch_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_epoch</span><span class="p">(</span>
</span><span id="Task.train-685"><a href="#Task.train-685"><span class="linenos">685</span></a>                <span class="n">dataloader</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span><span class="p">,</span>
</span><span id="Task.train-686"><a href="#Task.train-686"><span class="linenos">686</span></a>                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">,</span>
</span><span id="Task.train-687"><a href="#Task.train-687"><span class="linenos">687</span></a>                <span class="n">augment_n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">augment_train</span><span class="p">,</span>
</span><span id="Task.train-688"><a href="#Task.train-688"><span class="linenos">688</span></a>                <span class="n">unlabeled</span><span class="o">=</span><span class="n">unlabeled</span><span class="p">,</span>
</span><span id="Task.train-689"><a href="#Task.train-689"><span class="linenos">689</span></a>                <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
</span><span id="Task.train-690"><a href="#Task.train-690"><span class="linenos">690</span></a>                <span class="n">temporal_subsampling_size</span><span class="o">=</span><span class="n">temporal_subsampling_size</span><span class="p">,</span>
</span><span id="Task.train-691"><a href="#Task.train-691"><span class="linenos">691</span></a>                <span class="n">verbose</span><span class="o">=</span><span class="n">loading_bar</span><span class="p">,</span>
</span><span id="Task.train-692"><a href="#Task.train-692"><span class="linenos">692</span></a>            <span class="p">)</span>
</span><span id="Task.train-693"><a href="#Task.train-693"><span class="linenos">693</span></a>            <span class="n">loss_log</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_loss</span><span class="p">)</span>
</span><span id="Task.train-694"><a href="#Task.train-694"><span class="linenos">694</span></a>            <span class="n">epoch_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="si">}</span><span class="s2">]&quot;</span>
</span><span id="Task.train-695"><a href="#Task.train-695"><span class="linenos">695</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudolabel</span><span class="p">:</span>
</span><span id="Task.train-696"><a href="#Task.train-696"><span class="linenos">696</span></a>                <span class="k">if</span> <span class="n">unlabeled</span><span class="p">:</span>
</span><span id="Task.train-697"><a href="#Task.train-697"><span class="linenos">697</span></a>                    <span class="n">epoch_string</span> <span class="o">+=</span> <span class="s2">&quot; (unlabeled)&quot;</span>
</span><span id="Task.train-698"><a href="#Task.train-698"><span class="linenos">698</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Task.train-699"><a href="#Task.train-699"><span class="linenos">699</span></a>                    <span class="n">epoch_string</span> <span class="o">+=</span> <span class="s2">&quot; (labeled)&quot;</span>
</span><span id="Task.train-700"><a href="#Task.train-700"><span class="linenos">700</span></a>            <span class="n">epoch_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;: loss </span><span class="si">{</span><span class="n">epoch_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task.train-701"><a href="#Task.train-701"><span class="linenos">701</span></a>
</span><span id="Task.train-702"><a href="#Task.train-702"><span class="linenos">702</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">epoch_ssl_loss</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Task.train-703"><a href="#Task.train-703"><span class="linenos">703</span></a>                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">epoch_ssl_loss</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="Task.train-704"><a href="#Task.train-704"><span class="linenos">704</span></a>                    <span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;ssl_loss_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="Task.train-705"><a href="#Task.train-705"><span class="linenos">705</span></a>                    <span class="n">epoch_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, ssl_loss_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task.train-706"><a href="#Task.train-706"><span class="linenos">706</span></a>
</span><span id="Task.train-707"><a href="#Task.train-707"><span class="linenos">707</span></a>            <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">epoch_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="Task.train-708"><a href="#Task.train-708"><span class="linenos">708</span></a>                <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_metrics</span><span class="p">:</span>
</span><span id="Task.train-709"><a href="#Task.train-709"><span class="linenos">709</span></a>                    <span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">][</span><span class="n">metric_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_value</span><span class="p">)</span>
</span><span id="Task.train-710"><a href="#Task.train-710"><span class="linenos">710</span></a>                    <span class="n">epoch_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">metric_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task.train-711"><a href="#Task.train-711"><span class="linenos">711</span></a>
</span><span id="Task.train-712"><a href="#Task.train-712"><span class="linenos">712</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="Task.train-713"><a href="#Task.train-713"><span class="linenos">713</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="Task.train-714"><a href="#Task.train-714"><span class="linenos">714</span></a>                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_interval</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="Task.train-715"><a href="#Task.train-715"><span class="linenos">715</span></a>            <span class="p">):</span>
</span><span id="Task.train-716"><a href="#Task.train-716"><span class="linenos">716</span></a>                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="Task.train-717"><a href="#Task.train-717"><span class="linenos">717</span></a>                    <span class="n">epoch_string</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="Task.train-718"><a href="#Task.train-718"><span class="linenos">718</span></a>                    <span class="p">(</span>
</span><span id="Task.train-719"><a href="#Task.train-719"><span class="linenos">719</span></a>                        <span class="n">val_epoch_loss</span><span class="p">,</span>
</span><span id="Task.train-720"><a href="#Task.train-720"><span class="linenos">720</span></a>                        <span class="n">val_epoch_ssl_loss</span><span class="p">,</span>
</span><span id="Task.train-721"><a href="#Task.train-721"><span class="linenos">721</span></a>                        <span class="n">val_epoch_metrics</span><span class="p">,</span>
</span><span id="Task.train-722"><a href="#Task.train-722"><span class="linenos">722</span></a>                    <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_epoch</span><span class="p">(</span>
</span><span id="Task.train-723"><a href="#Task.train-723"><span class="linenos">723</span></a>                        <span class="n">dataloader</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span><span class="p">,</span>
</span><span id="Task.train-724"><a href="#Task.train-724"><span class="linenos">724</span></a>                        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;val&quot;</span><span class="p">,</span>
</span><span id="Task.train-725"><a href="#Task.train-725"><span class="linenos">725</span></a>                        <span class="n">augment_n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">augment_val</span><span class="p">,</span>
</span><span id="Task.train-726"><a href="#Task.train-726"><span class="linenos">726</span></a>                    <span class="p">)</span>
</span><span id="Task.train-727"><a href="#Task.train-727"><span class="linenos">727</span></a>                    <span class="n">loss_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_epoch_loss</span><span class="p">)</span>
</span><span id="Task.train-728"><a href="#Task.train-728"><span class="linenos">728</span></a>                    <span class="n">epoch_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;validation: loss </span><span class="si">{</span><span class="n">val_epoch_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task.train-729"><a href="#Task.train-729"><span class="linenos">729</span></a>
</span><span id="Task.train-730"><a href="#Task.train-730"><span class="linenos">730</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_epoch_ssl_loss</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Task.train-731"><a href="#Task.train-731"><span class="linenos">731</span></a>                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">val_epoch_ssl_loss</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="Task.train-732"><a href="#Task.train-732"><span class="linenos">732</span></a>                            <span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;ssl_loss_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="Task.train-733"><a href="#Task.train-733"><span class="linenos">733</span></a>                            <span class="n">epoch_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, ssl_loss_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task.train-734"><a href="#Task.train-734"><span class="linenos">734</span></a>
</span><span id="Task.train-735"><a href="#Task.train-735"><span class="linenos">735</span></a>                    <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">val_epoch_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="Task.train-736"><a href="#Task.train-736"><span class="linenos">736</span></a>                        <span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="n">metric_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_value</span><span class="p">)</span>
</span><span id="Task.train-737"><a href="#Task.train-737"><span class="linenos">737</span></a>                        <span class="n">epoch_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">metric_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task.train-738"><a href="#Task.train-738"><span class="linenos">738</span></a>
</span><span id="Task.train-739"><a href="#Task.train-739"><span class="linenos">739</span></a>                <span class="k">if</span> <span class="n">trial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.train-740"><a href="#Task.train-740"><span class="linenos">740</span></a>                    <span class="k">if</span> <span class="n">optimized_metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]:</span>
</span><span id="Task.train-741"><a href="#Task.train-741"><span class="linenos">741</span></a>                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Task.train-742"><a href="#Task.train-742"><span class="linenos">742</span></a>                            <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">optimized_metric</span><span class="si">}</span><span class="s2"> metric set for optimization is not being logged!&quot;</span>
</span><span id="Task.train-743"><a href="#Task.train-743"><span class="linenos">743</span></a>                        <span class="p">)</span>
</span><span id="Task.train-744"><a href="#Task.train-744"><span class="linenos">744</span></a>                    <span class="n">trial</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="n">optimized_metric</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
</span><span id="Task.train-745"><a href="#Task.train-745"><span class="linenos">745</span></a>                    <span class="k">if</span> <span class="n">trial</span><span class="o">.</span><span class="n">should_prune</span><span class="p">():</span>
</span><span id="Task.train-746"><a href="#Task.train-746"><span class="linenos">746</span></a>                        <span class="k">raise</span> <span class="n">TrialPruned</span><span class="p">()</span>
</span><span id="Task.train-747"><a href="#Task.train-747"><span class="linenos">747</span></a>
</span><span id="Task.train-748"><a href="#Task.train-748"><span class="linenos">748</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Task.train-749"><a href="#Task.train-749"><span class="linenos">749</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">epoch_string</span><span class="p">)</span>
</span><span id="Task.train-750"><a href="#Task.train-750"><span class="linenos">750</span></a>
</span><span id="Task.train-751"><a href="#Task.train-751"><span class="linenos">751</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.train-752"><a href="#Task.train-752"><span class="linenos">752</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="Task.train-753"><a href="#Task.train-753"><span class="linenos">753</span></a>                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">epoch_string</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Task.train-754"><a href="#Task.train-754"><span class="linenos">754</span></a>
</span><span id="Task.train-755"><a href="#Task.train-755"><span class="linenos">755</span></a>            <span class="n">save_condition</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Task.train-756"><a href="#Task.train-756"><span class="linenos">756</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_epochs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="Task.train-757"><a href="#Task.train-757"><span class="linenos">757</span></a>                <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_epochs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="Task.train-758"><a href="#Task.train-758"><span class="linenos">758</span></a>            <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">)</span>
</span><span id="Task.train-759"><a href="#Task.train-759"><span class="linenos">759</span></a>
</span><span id="Task.train-760"><a href="#Task.train-760"><span class="linenos">760</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">save_condition</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.train-761"><a href="#Task.train-761"><span class="linenos">761</span></a>                <span class="n">epoch_s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">)))</span>
</span><span id="Task.train-762"><a href="#Task.train-762"><span class="linenos">762</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">save_checkpoint</span><span class="p">(</span>
</span><span id="Task.train-763"><a href="#Task.train-763"><span class="linenos">763</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;epoch</span><span class="si">{</span><span class="n">epoch_s</span><span class="si">}</span><span class="s2">.pt&quot;</span><span class="p">)</span>
</span><span id="Task.train-764"><a href="#Task.train-764"><span class="linenos">764</span></a>                <span class="p">)</span>
</span><span id="Task.train-765"><a href="#Task.train-765"><span class="linenos">765</span></a>
</span><span id="Task.train-766"><a href="#Task.train-766"><span class="linenos">766</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudolabel</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">unlabeled</span><span class="p">:</span>
</span><span id="Task.train-767"><a href="#Task.train-767"><span class="linenos">767</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_set_pseudolabels</span><span class="p">()</span>
</span><span id="Task.train-768"><a href="#Task.train-768"><span class="linenos">768</span></a>
</span><span id="Task.train-769"><a href="#Task.train-769"><span class="linenos">769</span></a>            <span class="k">if</span> <span class="n">autostop_metric</span> <span class="o">==</span> <span class="s2">&quot;loss&quot;</span><span class="p">:</span>
</span><span id="Task.train-770"><a href="#Task.train-770"><span class="linenos">770</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">loss_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">autostop_interval</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Task.train-771"><a href="#Task.train-771"><span class="linenos">771</span></a>                    <span class="k">if</span> <span class="p">(</span>
</span><span id="Task.train-772"><a href="#Task.train-772"><span class="linenos">772</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="o">-</span><span class="n">autostop_interval</span><span class="p">:])</span>
</span><span id="Task.train-773"><a href="#Task.train-773"><span class="linenos">773</span></a>                        <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
</span><span id="Task.train-774"><a href="#Task.train-774"><span class="linenos">774</span></a>                            <span class="n">loss_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">autostop_interval</span> <span class="p">:</span> <span class="o">-</span><span class="n">autostop_interval</span><span class="p">]</span>
</span><span id="Task.train-775"><a href="#Task.train-775"><span class="linenos">775</span></a>                        <span class="p">)</span>
</span><span id="Task.train-776"><a href="#Task.train-776"><span class="linenos">776</span></a>                        <span class="o">+</span> <span class="n">autostop_threshold</span>
</span><span id="Task.train-777"><a href="#Task.train-777"><span class="linenos">777</span></a>                    <span class="p">):</span>
</span><span id="Task.train-778"><a href="#Task.train-778"><span class="linenos">778</span></a>                        <span class="k">break</span>
</span><span id="Task.train-779"><a href="#Task.train-779"><span class="linenos">779</span></a>            <span class="k">elif</span> <span class="n">autostop_metric</span> <span class="ow">in</span> <span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]:</span>
</span><span id="Task.train-780"><a href="#Task.train-780"><span class="linenos">780</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="n">autostop_metric</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">autostop_interval</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Task.train-781"><a href="#Task.train-781"><span class="linenos">781</span></a>                    <span class="k">if</span> <span class="p">(</span>
</span><span id="Task.train-782"><a href="#Task.train-782"><span class="linenos">782</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
</span><span id="Task.train-783"><a href="#Task.train-783"><span class="linenos">783</span></a>                            <span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="n">autostop_metric</span><span class="p">][</span><span class="o">-</span><span class="n">autostop_interval</span><span class="p">:]</span>
</span><span id="Task.train-784"><a href="#Task.train-784"><span class="linenos">784</span></a>                        <span class="p">)</span>
</span><span id="Task.train-785"><a href="#Task.train-785"><span class="linenos">785</span></a>                        <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
</span><span id="Task.train-786"><a href="#Task.train-786"><span class="linenos">786</span></a>                            <span class="n">metrics_log</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="n">autostop_metric</span><span class="p">][</span>
</span><span id="Task.train-787"><a href="#Task.train-787"><span class="linenos">787</span></a>                                <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">autostop_interval</span> <span class="p">:</span> <span class="o">-</span><span class="n">autostop_interval</span>
</span><span id="Task.train-788"><a href="#Task.train-788"><span class="linenos">788</span></a>                            <span class="p">]</span>
</span><span id="Task.train-789"><a href="#Task.train-789"><span class="linenos">789</span></a>                        <span class="p">)</span>
</span><span id="Task.train-790"><a href="#Task.train-790"><span class="linenos">790</span></a>                        <span class="o">+</span> <span class="n">autostop_threshold</span>
</span><span id="Task.train-791"><a href="#Task.train-791"><span class="linenos">791</span></a>                    <span class="p">):</span>
</span><span id="Task.train-792"><a href="#Task.train-792"><span class="linenos">792</span></a>                        <span class="k">break</span>
</span><span id="Task.train-793"><a href="#Task.train-793"><span class="linenos">793</span></a>
</span><span id="Task.train-794"><a href="#Task.train-794"><span class="linenos">794</span></a>        <span class="n">metrics_log</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metrics_log</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Task.train-795"><a href="#Task.train-795"><span class="linenos">795</span></a>
</span><span id="Task.train-796"><a href="#Task.train-796"><span class="linenos">796</span></a>        <span class="k">return</span> <span class="n">loss_log</span><span class="p">,</span> <span class="n">metrics_log</span>
</span></pre></div>


            <div class="docstring"><p>Train the task and return a log of epoch-average loss and metric</p>

<p>You can use the autostop parameters to finish training when the parameters are not improving. It will be
stopped if the average value of <code>autostop_metric</code> over the last <code>autostop_interval</code> epochs is smaller than
the average over the previous <code>autostop_interval</code> epochs + <code>autostop_threshold</code>. For example, if the
current epoch is 120 and <code>autostop_interval</code> is 50, the averages over epochs 70-120 and 20-70 will be compared.</p>

<h2 id="parameters">Parameters</h2>

<p>trial : Trial
    an <code>optuna</code> trial (for hyperparameter searches)
optimized_metric : str
    the name of the metric being optimized (for hyperparameter searches)
to_ram : bool, default False
    if <code>True</code>, the dataset will be loaded in RAM (this speeds up the calculations but can lead to crashes
    if the dataset is too large)
autostop_interval : int, default 50
    the number of epochs to average the autostop metric over
autostop_threshold : float, default 0.001
    the autostop difference threshold
autostop_metric : str, optional
    the autostop metric (can be any one of the tracked metrics of <code>'loss'</code>)
main_task_on : bool, default True
    if <code>False</code>, the main task (action segmentation) will not be used in training
ssl_on : bool, default True
    if <code>False</code>, the SSL task will not be used in training</p>

<h2 id="returns">Returns</h2>

<p>loss_log: list
    a list of float loss function values for each epoch
metrics_log: dict
    a dictionary of metric value logs (first-level keys are 'train' and 'val', second-level keys are metric
    names, values are lists of function values)</p>
</div>


                            </div>
                            <div id="Task.evaluate_prediction" class="classattr">
                                        <input id="Task.evaluate_prediction-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">evaluate_prediction</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">prediction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span>,</span><span class="param">	<span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataloader</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span> <span class="n">dlc2action</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">BehaviorDataset</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span></span><span class="return-annotation">) -> <span class="n">Tuple</span>:</span></span>

                <label class="view-source-button" for="Task.evaluate_prediction-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.evaluate_prediction"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.evaluate_prediction-798"><a href="#Task.evaluate_prediction-798"><span class="linenos">798</span></a>    <span class="k">def</span> <span class="nf">evaluate_prediction</span><span class="p">(</span>
</span><span id="Task.evaluate_prediction-799"><a href="#Task.evaluate_prediction-799"><span class="linenos">799</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Task.evaluate_prediction-800"><a href="#Task.evaluate_prediction-800"><span class="linenos">800</span></a>        <span class="n">prediction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span>
</span><span id="Task.evaluate_prediction-801"><a href="#Task.evaluate_prediction-801"><span class="linenos">801</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">DataLoader</span><span class="p">,</span> <span class="n">BehaviorDataset</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.evaluate_prediction-802"><a href="#Task.evaluate_prediction-802"><span class="linenos">802</span></a>        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
</span><span id="Task.evaluate_prediction-803"><a href="#Task.evaluate_prediction-803"><span class="linenos">803</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
</span><span id="Task.evaluate_prediction-804"><a href="#Task.evaluate_prediction-804"><span class="linenos">804</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.evaluate_prediction-805"><a href="#Task.evaluate_prediction-805"><span class="linenos">805</span></a><span class="sd">        Compute metrics for a prediction</span>
</span><span id="Task.evaluate_prediction-806"><a href="#Task.evaluate_prediction-806"><span class="linenos">806</span></a>
</span><span id="Task.evaluate_prediction-807"><a href="#Task.evaluate_prediction-807"><span class="linenos">807</span></a><span class="sd">        Parameters</span>
</span><span id="Task.evaluate_prediction-808"><a href="#Task.evaluate_prediction-808"><span class="linenos">808</span></a><span class="sd">        ----------</span>
</span><span id="Task.evaluate_prediction-809"><a href="#Task.evaluate_prediction-809"><span class="linenos">809</span></a><span class="sd">        prediction : torch.Tensor</span>
</span><span id="Task.evaluate_prediction-810"><a href="#Task.evaluate_prediction-810"><span class="linenos">810</span></a><span class="sd">            the prediction</span>
</span><span id="Task.evaluate_prediction-811"><a href="#Task.evaluate_prediction-811"><span class="linenos">811</span></a><span class="sd">        data : torch.utils.data.DataLoader | dlc2action.data.dataset.BehaviorDataset, optional</span>
</span><span id="Task.evaluate_prediction-812"><a href="#Task.evaluate_prediction-812"><span class="linenos">812</span></a><span class="sd">            the data the prediction was made for (if not provided, take the validation dataset)</span>
</span><span id="Task.evaluate_prediction-813"><a href="#Task.evaluate_prediction-813"><span class="linenos">813</span></a><span class="sd">        batch_size : int, default 32</span>
</span><span id="Task.evaluate_prediction-814"><a href="#Task.evaluate_prediction-814"><span class="linenos">814</span></a><span class="sd">            the batch size</span>
</span><span id="Task.evaluate_prediction-815"><a href="#Task.evaluate_prediction-815"><span class="linenos">815</span></a>
</span><span id="Task.evaluate_prediction-816"><a href="#Task.evaluate_prediction-816"><span class="linenos">816</span></a><span class="sd">        Returns</span>
</span><span id="Task.evaluate_prediction-817"><a href="#Task.evaluate_prediction-817"><span class="linenos">817</span></a><span class="sd">        -------</span>
</span><span id="Task.evaluate_prediction-818"><a href="#Task.evaluate_prediction-818"><span class="linenos">818</span></a><span class="sd">        loss : float</span>
</span><span id="Task.evaluate_prediction-819"><a href="#Task.evaluate_prediction-819"><span class="linenos">819</span></a><span class="sd">            the average value of the loss function</span>
</span><span id="Task.evaluate_prediction-820"><a href="#Task.evaluate_prediction-820"><span class="linenos">820</span></a><span class="sd">        metric : dict</span>
</span><span id="Task.evaluate_prediction-821"><a href="#Task.evaluate_prediction-821"><span class="linenos">821</span></a><span class="sd">            a dictionary of average values of metric functions</span>
</span><span id="Task.evaluate_prediction-822"><a href="#Task.evaluate_prediction-822"><span class="linenos">822</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.evaluate_prediction-823"><a href="#Task.evaluate_prediction-823"><span class="linenos">823</span></a>
</span><span id="Task.evaluate_prediction-824"><a href="#Task.evaluate_prediction-824"><span class="linenos">824</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">DataLoader</span><span class="p">:</span>
</span><span id="Task.evaluate_prediction-825"><a href="#Task.evaluate_prediction-825"><span class="linenos">825</span></a>            <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataset</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="Task.evaluate_prediction-826"><a href="#Task.evaluate_prediction-826"><span class="linenos">826</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="Task.evaluate_prediction-827"><a href="#Task.evaluate_prediction-827"><span class="linenos">827</span></a>        <span class="n">epoch_loss</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Task.evaluate_prediction-828"><a href="#Task.evaluate_prediction-828"><span class="linenos">828</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="Task.evaluate_prediction-829"><a href="#Task.evaluate_prediction-829"><span class="linenos">829</span></a>            <span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">())</span>
</span><span id="Task.evaluate_prediction-830"><a href="#Task.evaluate_prediction-830"><span class="linenos">830</span></a>            <span class="n">length</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">len_segment</span><span class="p">()</span>
</span><span id="Task.evaluate_prediction-831"><a href="#Task.evaluate_prediction-831"><span class="linenos">831</span></a>            <span class="n">coords</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">annotation_store</span><span class="o">.</span><span class="n">get_original_coordinates</span><span class="p">()</span>
</span><span id="Task.evaluate_prediction-832"><a href="#Task.evaluate_prediction-832"><span class="linenos">832</span></a>            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="Task.evaluate_prediction-833"><a href="#Task.evaluate_prediction-833"><span class="linenos">833</span></a>                <span class="n">main_target</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span>
</span><span id="Task.evaluate_prediction-834"><a href="#Task.evaluate_prediction-834"><span class="linenos">834</span></a>                <span class="n">pr_coords</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]]</span>
</span><span id="Task.evaluate_prediction-835"><a href="#Task.evaluate_prediction-835"><span class="linenos">835</span></a>                <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">pr_coords</span><span class="p">),</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span>
</span><span id="Task.evaluate_prediction-836"><a href="#Task.evaluate_prediction-836"><span class="linenos">836</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pr_coords</span><span class="p">):</span>
</span><span id="Task.evaluate_prediction-837"><a href="#Task.evaluate_prediction-837"><span class="linenos">837</span></a>                    <span class="n">video_id</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">input_store</span><span class="o">.</span><span class="n">get_video_id</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span id="Task.evaluate_prediction-838"><a href="#Task.evaluate_prediction-838"><span class="linenos">838</span></a>                    <span class="n">clip_id</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">input_store</span><span class="o">.</span><span class="n">get_clip_id</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span id="Task.evaluate_prediction-839"><a href="#Task.evaluate_prediction-839"><span class="linenos">839</span></a>                    <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">input_store</span><span class="o">.</span><span class="n">get_clip_start_end</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span id="Task.evaluate_prediction-840"><a href="#Task.evaluate_prediction-840"><span class="linenos">840</span></a>                    <span class="n">predicted</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="n">video_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">][</span>
</span><span id="Task.evaluate_prediction-841"><a href="#Task.evaluate_prediction-841"><span class="linenos">841</span></a>                        <span class="p">:,</span> <span class="n">start</span><span class="p">:</span><span class="n">end</span>
</span><span id="Task.evaluate_prediction-842"><a href="#Task.evaluate_prediction-842"><span class="linenos">842</span></a>                    <span class="p">]</span>
</span><span id="Task.evaluate_prediction-843"><a href="#Task.evaluate_prediction-843"><span class="linenos">843</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_compute</span><span class="p">(</span>
</span><span id="Task.evaluate_prediction-844"><a href="#Task.evaluate_prediction-844"><span class="linenos">844</span></a>                    <span class="p">[],</span>
</span><span id="Task.evaluate_prediction-845"><a href="#Task.evaluate_prediction-845"><span class="linenos">845</span></a>                    <span class="p">[],</span>
</span><span id="Task.evaluate_prediction-846"><a href="#Task.evaluate_prediction-846"><span class="linenos">846</span></a>                    <span class="n">predicted</span><span class="p">,</span>
</span><span id="Task.evaluate_prediction-847"><a href="#Task.evaluate_prediction-847"><span class="linenos">847</span></a>                    <span class="n">main_target</span><span class="p">,</span>
</span><span id="Task.evaluate_prediction-848"><a href="#Task.evaluate_prediction-848"><span class="linenos">848</span></a>                    <span class="n">skip_loss</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task.evaluate_prediction-849"><a href="#Task.evaluate_prediction-849"><span class="linenos">849</span></a>                    <span class="n">tag</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">),</span>
</span><span id="Task.evaluate_prediction-850"><a href="#Task.evaluate_prediction-850"><span class="linenos">850</span></a>                    <span class="n">apply_primary_function</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Task.evaluate_prediction-851"><a href="#Task.evaluate_prediction-851"><span class="linenos">851</span></a>                <span class="p">)</span>
</span><span id="Task.evaluate_prediction-852"><a href="#Task.evaluate_prediction-852"><span class="linenos">852</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task.evaluate_prediction-853"><a href="#Task.evaluate_prediction-853"><span class="linenos">853</span></a>            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="Task.evaluate_prediction-854"><a href="#Task.evaluate_prediction-854"><span class="linenos">854</span></a>                <span class="n">main_target</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span>
</span><span id="Task.evaluate_prediction-855"><a href="#Task.evaluate_prediction-855"><span class="linenos">855</span></a>                <span class="n">predicted</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]]</span>
</span><span id="Task.evaluate_prediction-856"><a href="#Task.evaluate_prediction-856"><span class="linenos">856</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_compute</span><span class="p">(</span>
</span><span id="Task.evaluate_prediction-857"><a href="#Task.evaluate_prediction-857"><span class="linenos">857</span></a>                    <span class="p">[],</span>
</span><span id="Task.evaluate_prediction-858"><a href="#Task.evaluate_prediction-858"><span class="linenos">858</span></a>                    <span class="p">[],</span>
</span><span id="Task.evaluate_prediction-859"><a href="#Task.evaluate_prediction-859"><span class="linenos">859</span></a>                    <span class="n">predicted</span><span class="p">,</span>
</span><span id="Task.evaluate_prediction-860"><a href="#Task.evaluate_prediction-860"><span class="linenos">860</span></a>                    <span class="n">main_target</span><span class="p">,</span>
</span><span id="Task.evaluate_prediction-861"><a href="#Task.evaluate_prediction-861"><span class="linenos">861</span></a>                    <span class="n">skip_loss</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task.evaluate_prediction-862"><a href="#Task.evaluate_prediction-862"><span class="linenos">862</span></a>                    <span class="n">tag</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">),</span>
</span><span id="Task.evaluate_prediction-863"><a href="#Task.evaluate_prediction-863"><span class="linenos">863</span></a>                    <span class="n">apply_primary_function</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Task.evaluate_prediction-864"><a href="#Task.evaluate_prediction-864"><span class="linenos">864</span></a>                <span class="p">)</span>
</span><span id="Task.evaluate_prediction-865"><a href="#Task.evaluate_prediction-865"><span class="linenos">865</span></a>        <span class="n">epoch_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_metrics</span><span class="p">()</span>
</span><span id="Task.evaluate_prediction-866"><a href="#Task.evaluate_prediction-866"><span class="linenos">866</span></a>        <span class="n">strings</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task.evaluate_prediction-867"><a href="#Task.evaluate_prediction-867"><span class="linenos">867</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">metric_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task.evaluate_prediction-868"><a href="#Task.evaluate_prediction-868"><span class="linenos">868</span></a>            <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_value</span> <span class="ow">in</span> <span class="n">epoch_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Task.evaluate_prediction-869"><a href="#Task.evaluate_prediction-869"><span class="linenos">869</span></a>        <span class="p">]</span>
</span><span id="Task.evaluate_prediction-870"><a href="#Task.evaluate_prediction-870"><span class="linenos">870</span></a>        <span class="n">val_string</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">strings</span><span class="p">))</span>
</span><span id="Task.evaluate_prediction-871"><a href="#Task.evaluate_prediction-871"><span class="linenos">871</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">val_string</span><span class="p">)</span>
</span><span id="Task.evaluate_prediction-872"><a href="#Task.evaluate_prediction-872"><span class="linenos">872</span></a>        <span class="k">return</span> <span class="n">epoch_loss</span><span class="p">,</span> <span class="n">epoch_metrics</span>
</span></pre></div>


            <div class="docstring"><p>Compute metrics for a prediction</p>

<h2 id="parameters">Parameters</h2>

<p>prediction : torch.Tensor
    the prediction
data : torch.utils.data.DataLoader | <a href="../data/dataset.html#BehaviorDataset">dlc2action.data.dataset.BehaviorDataset</a>, optional
    the data the prediction was made for (if not provided, take the validation dataset)
batch_size : int, default 32
    the batch size</p>

<h2 id="returns">Returns</h2>

<p>loss : float
    the average value of the loss function
metric : dict
    a dictionary of average values of metric functions</p>
</div>


                            </div>
                            <div id="Task.evaluate" class="classattr">
                                        <input id="Task.evaluate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">evaluate</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataloader</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span> <span class="n">dlc2action</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">BehaviorDataset</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">augment_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span>,</span><span class="param">	<span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">) -> <span class="n">Tuple</span>:</span></span>

                <label class="view-source-button" for="Task.evaluate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.evaluate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.evaluate-874"><a href="#Task.evaluate-874"><span class="linenos">874</span></a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span>
</span><span id="Task.evaluate-875"><a href="#Task.evaluate-875"><span class="linenos">875</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Task.evaluate-876"><a href="#Task.evaluate-876"><span class="linenos">876</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">DataLoader</span><span class="p">,</span> <span class="n">BehaviorDataset</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.evaluate-877"><a href="#Task.evaluate-877"><span class="linenos">877</span></a>        <span class="n">augment_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Task.evaluate-878"><a href="#Task.evaluate-878"><span class="linenos">878</span></a>        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
</span><span id="Task.evaluate-879"><a href="#Task.evaluate-879"><span class="linenos">879</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Task.evaluate-880"><a href="#Task.evaluate-880"><span class="linenos">880</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
</span><span id="Task.evaluate-881"><a href="#Task.evaluate-881"><span class="linenos">881</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.evaluate-882"><a href="#Task.evaluate-882"><span class="linenos">882</span></a><span class="sd">        Evaluate the Task model</span>
</span><span id="Task.evaluate-883"><a href="#Task.evaluate-883"><span class="linenos">883</span></a>
</span><span id="Task.evaluate-884"><a href="#Task.evaluate-884"><span class="linenos">884</span></a><span class="sd">        Parameters</span>
</span><span id="Task.evaluate-885"><a href="#Task.evaluate-885"><span class="linenos">885</span></a><span class="sd">        ----------</span>
</span><span id="Task.evaluate-886"><a href="#Task.evaluate-886"><span class="linenos">886</span></a><span class="sd">        data : torch.utils.data.DataLoader | dlc2action.data.dataset.BehaviorDataset, optional</span>
</span><span id="Task.evaluate-887"><a href="#Task.evaluate-887"><span class="linenos">887</span></a><span class="sd">            the data to evaluate on (if not provided, evaluate on the Task validation dataset)</span>
</span><span id="Task.evaluate-888"><a href="#Task.evaluate-888"><span class="linenos">888</span></a><span class="sd">        augment_n : int, default 0</span>
</span><span id="Task.evaluate-889"><a href="#Task.evaluate-889"><span class="linenos">889</span></a><span class="sd">            the number of augmentations to average results over</span>
</span><span id="Task.evaluate-890"><a href="#Task.evaluate-890"><span class="linenos">890</span></a><span class="sd">        batch_size : int, default 32</span>
</span><span id="Task.evaluate-891"><a href="#Task.evaluate-891"><span class="linenos">891</span></a><span class="sd">            the batch size</span>
</span><span id="Task.evaluate-892"><a href="#Task.evaluate-892"><span class="linenos">892</span></a><span class="sd">        verbose : bool, default True</span>
</span><span id="Task.evaluate-893"><a href="#Task.evaluate-893"><span class="linenos">893</span></a><span class="sd">            if True, the process is reported to standard output</span>
</span><span id="Task.evaluate-894"><a href="#Task.evaluate-894"><span class="linenos">894</span></a>
</span><span id="Task.evaluate-895"><a href="#Task.evaluate-895"><span class="linenos">895</span></a><span class="sd">        Returns</span>
</span><span id="Task.evaluate-896"><a href="#Task.evaluate-896"><span class="linenos">896</span></a><span class="sd">        -------</span>
</span><span id="Task.evaluate-897"><a href="#Task.evaluate-897"><span class="linenos">897</span></a><span class="sd">        loss : float</span>
</span><span id="Task.evaluate-898"><a href="#Task.evaluate-898"><span class="linenos">898</span></a><span class="sd">            the average value of the loss function</span>
</span><span id="Task.evaluate-899"><a href="#Task.evaluate-899"><span class="linenos">899</span></a><span class="sd">        ssl_loss : float</span>
</span><span id="Task.evaluate-900"><a href="#Task.evaluate-900"><span class="linenos">900</span></a><span class="sd">            the average value of the SSL loss function</span>
</span><span id="Task.evaluate-901"><a href="#Task.evaluate-901"><span class="linenos">901</span></a><span class="sd">        metric : dict</span>
</span><span id="Task.evaluate-902"><a href="#Task.evaluate-902"><span class="linenos">902</span></a><span class="sd">            a dictionary of average values of metric functions</span>
</span><span id="Task.evaluate-903"><a href="#Task.evaluate-903"><span class="linenos">903</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.evaluate-904"><a href="#Task.evaluate-904"><span class="linenos">904</span></a>
</span><span id="Task.evaluate-905"><a href="#Task.evaluate-905"><span class="linenos">905</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">):</span>
</span><span id="Task.evaluate-906"><a href="#Task.evaluate-906"><span class="linenos">906</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">MyDataParallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
</span><span id="Task.evaluate-907"><a href="#Task.evaluate-907"><span class="linenos">907</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Task.evaluate-908"><a href="#Task.evaluate-908"><span class="linenos">908</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">DataLoader</span><span class="p">:</span>
</span><span id="Task.evaluate-909"><a href="#Task.evaluate-909"><span class="linenos">909</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataset</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="Task.evaluate-910"><a href="#Task.evaluate-910"><span class="linenos">910</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="Task.evaluate-911"><a href="#Task.evaluate-911"><span class="linenos">911</span></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="Task.evaluate-912"><a href="#Task.evaluate-912"><span class="linenos">912</span></a>            <span class="n">epoch_loss</span><span class="p">,</span> <span class="n">epoch_ssl_loss</span><span class="p">,</span> <span class="n">epoch_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_epoch</span><span class="p">(</span>
</span><span id="Task.evaluate-913"><a href="#Task.evaluate-913"><span class="linenos">913</span></a>                <span class="n">dataloader</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="n">augment_n</span><span class="o">=</span><span class="n">augment_n</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
</span><span id="Task.evaluate-914"><a href="#Task.evaluate-914"><span class="linenos">914</span></a>            <span class="p">)</span>
</span><span id="Task.evaluate-915"><a href="#Task.evaluate-915"><span class="linenos">915</span></a>        <span class="n">val_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;loss </span><span class="si">{</span><span class="n">epoch_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task.evaluate-916"><a href="#Task.evaluate-916"><span class="linenos">916</span></a>        <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">epoch_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="Task.evaluate-917"><a href="#Task.evaluate-917"><span class="linenos">917</span></a>            <span class="n">val_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">metric_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task.evaluate-918"><a href="#Task.evaluate-918"><span class="linenos">918</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">val_string</span><span class="p">)</span>
</span><span id="Task.evaluate-919"><a href="#Task.evaluate-919"><span class="linenos">919</span></a>        <span class="k">return</span> <span class="n">epoch_loss</span><span class="p">,</span> <span class="n">epoch_ssl_loss</span><span class="p">,</span> <span class="n">epoch_metrics</span>
</span></pre></div>


            <div class="docstring"><p>Evaluate the Task model</p>

<h2 id="parameters">Parameters</h2>

<p>data : torch.utils.data.DataLoader | <a href="../data/dataset.html#BehaviorDataset">dlc2action.data.dataset.BehaviorDataset</a>, optional
    the data to evaluate on (if not provided, evaluate on the Task validation dataset)
augment_n : int, default 0
    the number of augmentations to average results over
batch_size : int, default 32
    the batch size
verbose : bool, default True
    if True, the process is reported to standard output</p>

<h2 id="returns">Returns</h2>

<p>loss : float
    the average value of the loss function
ssl_loss : float
    the average value of the SSL loss function
metric : dict
    a dictionary of average values of metric functions</p>
</div>


                            </div>
                            <div id="Task.predict" class="classattr">
                                        <input id="Task.predict-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">predict</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataloader</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span> <span class="n">dlc2action</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">BehaviorDataset</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">raw_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">apply_primary_function</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">augment_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span>,</span><span class="param">	<span class="n">train_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">to_ram</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">embedding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="Task.predict-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.predict"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.predict-921"><a href="#Task.predict-921"><span class="linenos">921</span></a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span>
</span><span id="Task.predict-922"><a href="#Task.predict-922"><span class="linenos">922</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Task.predict-923"><a href="#Task.predict-923"><span class="linenos">923</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">DataLoader</span><span class="p">,</span> <span class="n">BehaviorDataset</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.predict-924"><a href="#Task.predict-924"><span class="linenos">924</span></a>        <span class="n">raw_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task.predict-925"><a href="#Task.predict-925"><span class="linenos">925</span></a>        <span class="n">apply_primary_function</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Task.predict-926"><a href="#Task.predict-926"><span class="linenos">926</span></a>        <span class="n">augment_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Task.predict-927"><a href="#Task.predict-927"><span class="linenos">927</span></a>        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
</span><span id="Task.predict-928"><a href="#Task.predict-928"><span class="linenos">928</span></a>        <span class="n">train_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task.predict-929"><a href="#Task.predict-929"><span class="linenos">929</span></a>        <span class="n">to_ram</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task.predict-930"><a href="#Task.predict-930"><span class="linenos">930</span></a>        <span class="n">embedding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task.predict-931"><a href="#Task.predict-931"><span class="linenos">931</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="Task.predict-932"><a href="#Task.predict-932"><span class="linenos">932</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.predict-933"><a href="#Task.predict-933"><span class="linenos">933</span></a><span class="sd">        Make a prediction with the Task model</span>
</span><span id="Task.predict-934"><a href="#Task.predict-934"><span class="linenos">934</span></a>
</span><span id="Task.predict-935"><a href="#Task.predict-935"><span class="linenos">935</span></a><span class="sd">        Parameters</span>
</span><span id="Task.predict-936"><a href="#Task.predict-936"><span class="linenos">936</span></a><span class="sd">        ----------</span>
</span><span id="Task.predict-937"><a href="#Task.predict-937"><span class="linenos">937</span></a><span class="sd">        data : torch.utils.data.DataLoader | dlc2action.data.dataset.BehaviorDataset | str, optional</span>
</span><span id="Task.predict-938"><a href="#Task.predict-938"><span class="linenos">938</span></a><span class="sd">            the data to evaluate on (if not provided, evaluate on the Task validation dataset)</span>
</span><span id="Task.predict-939"><a href="#Task.predict-939"><span class="linenos">939</span></a><span class="sd">        raw_output : bool, default False</span>
</span><span id="Task.predict-940"><a href="#Task.predict-940"><span class="linenos">940</span></a><span class="sd">            if `True`, the raw predicted probabilities are returned</span>
</span><span id="Task.predict-941"><a href="#Task.predict-941"><span class="linenos">941</span></a><span class="sd">        apply_primary_function : bool, default True</span>
</span><span id="Task.predict-942"><a href="#Task.predict-942"><span class="linenos">942</span></a><span class="sd">            if `True`, the primary predict function is applied (to map the model output into a shape corresponding to</span>
</span><span id="Task.predict-943"><a href="#Task.predict-943"><span class="linenos">943</span></a><span class="sd">            the input)</span>
</span><span id="Task.predict-944"><a href="#Task.predict-944"><span class="linenos">944</span></a><span class="sd">        augment_n : int, default 0</span>
</span><span id="Task.predict-945"><a href="#Task.predict-945"><span class="linenos">945</span></a><span class="sd">            the number of augmentations to average results over</span>
</span><span id="Task.predict-946"><a href="#Task.predict-946"><span class="linenos">946</span></a><span class="sd">        batch_size : int, default 32</span>
</span><span id="Task.predict-947"><a href="#Task.predict-947"><span class="linenos">947</span></a><span class="sd">            the batch size</span>
</span><span id="Task.predict-948"><a href="#Task.predict-948"><span class="linenos">948</span></a><span class="sd">        train_mode : bool, default False</span>
</span><span id="Task.predict-949"><a href="#Task.predict-949"><span class="linenos">949</span></a><span class="sd">            if `True`, the model is used in training mode (affects dropout and batch normalization layers)</span>
</span><span id="Task.predict-950"><a href="#Task.predict-950"><span class="linenos">950</span></a><span class="sd">        to_ram : bool, default False</span>
</span><span id="Task.predict-951"><a href="#Task.predict-951"><span class="linenos">951</span></a><span class="sd">            if `True`, the dataset will be loaded in RAM (this speeds up the calculations but can lead to crashes</span>
</span><span id="Task.predict-952"><a href="#Task.predict-952"><span class="linenos">952</span></a><span class="sd">            if the dataset is too large)</span>
</span><span id="Task.predict-953"><a href="#Task.predict-953"><span class="linenos">953</span></a><span class="sd">        embedding : bool, default False</span>
</span><span id="Task.predict-954"><a href="#Task.predict-954"><span class="linenos">954</span></a><span class="sd">            if `True`, the output of feature extractor is returned, ignoring the prediction module of the model</span>
</span><span id="Task.predict-955"><a href="#Task.predict-955"><span class="linenos">955</span></a>
</span><span id="Task.predict-956"><a href="#Task.predict-956"><span class="linenos">956</span></a><span class="sd">        Returns</span>
</span><span id="Task.predict-957"><a href="#Task.predict-957"><span class="linenos">957</span></a><span class="sd">        -------</span>
</span><span id="Task.predict-958"><a href="#Task.predict-958"><span class="linenos">958</span></a><span class="sd">        prediction : torch.Tensor</span>
</span><span id="Task.predict-959"><a href="#Task.predict-959"><span class="linenos">959</span></a><span class="sd">            a prediction for the input data</span>
</span><span id="Task.predict-960"><a href="#Task.predict-960"><span class="linenos">960</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.predict-961"><a href="#Task.predict-961"><span class="linenos">961</span></a>
</span><span id="Task.predict-962"><a href="#Task.predict-962"><span class="linenos">962</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">):</span>
</span><span id="Task.predict-963"><a href="#Task.predict-963"><span class="linenos">963</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">MyDataParallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
</span><span id="Task.predict-964"><a href="#Task.predict-964"><span class="linenos">964</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Task.predict-965"><a href="#Task.predict-965"><span class="linenos">965</span></a>        <span class="k">if</span> <span class="n">train_mode</span><span class="p">:</span>
</span><span id="Task.predict-966"><a href="#Task.predict-966"><span class="linenos">966</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="Task.predict-967"><a href="#Task.predict-967"><span class="linenos">967</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task.predict-968"><a href="#Task.predict-968"><span class="linenos">968</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="Task.predict-969"><a href="#Task.predict-969"><span class="linenos">969</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Task.predict-970"><a href="#Task.predict-970"><span class="linenos">970</span></a>        <span class="k">if</span> <span class="n">embedding</span><span class="p">:</span>
</span><span id="Task.predict-971"><a href="#Task.predict-971"><span class="linenos">971</span></a>            <span class="n">raw_output</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Task.predict-972"><a href="#Task.predict-972"><span class="linenos">972</span></a>            <span class="n">apply_primary_function</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Task.predict-973"><a href="#Task.predict-973"><span class="linenos">973</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">DataLoader</span><span class="p">:</span>
</span><span id="Task.predict-974"><a href="#Task.predict-974"><span class="linenos">974</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataset</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="Task.predict-975"><a href="#Task.predict-975"><span class="linenos">975</span></a>            <span class="k">if</span> <span class="n">to_ram</span><span class="p">:</span>
</span><span id="Task.predict-976"><a href="#Task.predict-976"><span class="linenos">976</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;transferring dataset to RAM...&quot;</span><span class="p">)</span>
</span><span id="Task.predict-977"><a href="#Task.predict-977"><span class="linenos">977</span></a>                <span class="n">data</span><span class="o">.</span><span class="n">to_ram</span><span class="p">()</span>
</span><span id="Task.predict-978"><a href="#Task.predict-978"><span class="linenos">978</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="Task.predict-979"><a href="#Task.predict-979"><span class="linenos">979</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ssl_off</span><span class="p">()</span>
</span><span id="Task.predict-980"><a href="#Task.predict-980"><span class="linenos">980</span></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="Task.predict-981"><a href="#Task.predict-981"><span class="linenos">981</span></a>            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span id="Task.predict-982"><a href="#Task.predict-982"><span class="linenos">982</span></a>                <span class="nb">input</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Task.predict-983"><a href="#Task.predict-983"><span class="linenos">983</span></a>                <span class="n">predicted</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_prediction</span><span class="p">(</span>
</span><span id="Task.predict-984"><a href="#Task.predict-984"><span class="linenos">984</span></a>                    <span class="nb">input</span><span class="p">,</span>
</span><span id="Task.predict-985"><a href="#Task.predict-985"><span class="linenos">985</span></a>                    <span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">),</span>
</span><span id="Task.predict-986"><a href="#Task.predict-986"><span class="linenos">986</span></a>                    <span class="n">augment_n</span><span class="o">=</span><span class="n">augment_n</span><span class="p">,</span>
</span><span id="Task.predict-987"><a href="#Task.predict-987"><span class="linenos">987</span></a>                    <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span>
</span><span id="Task.predict-988"><a href="#Task.predict-988"><span class="linenos">988</span></a>                <span class="p">)</span>
</span><span id="Task.predict-989"><a href="#Task.predict-989"><span class="linenos">989</span></a>                <span class="k">if</span> <span class="n">apply_primary_function</span><span class="p">:</span>
</span><span id="Task.predict-990"><a href="#Task.predict-990"><span class="linenos">990</span></a>                    <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_predict_function</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="Task.predict-991"><a href="#Task.predict-991"><span class="linenos">991</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">raw_output</span><span class="p">:</span>
</span><span id="Task.predict-992"><a href="#Task.predict-992"><span class="linenos">992</span></a>                    <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_function</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="Task.predict-993"><a href="#Task.predict-993"><span class="linenos">993</span></a>                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predicted</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
</span><span id="Task.predict-994"><a href="#Task.predict-994"><span class="linenos">994</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ssl_on</span><span class="p">()</span>
</span><span id="Task.predict-995"><a href="#Task.predict-995"><span class="linenos">995</span></a>        <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="Task.predict-996"><a href="#Task.predict-996"><span class="linenos">996</span></a>        <span class="k">return</span> <span class="n">output</span>
</span></pre></div>


            <div class="docstring"><p>Make a prediction with the Task model</p>

<h2 id="parameters">Parameters</h2>

<p>data : torch.utils.data.DataLoader | <a href="../data/dataset.html#BehaviorDataset">dlc2action.data.dataset.BehaviorDataset</a> | str, optional
    the data to evaluate on (if not provided, evaluate on the Task validation dataset)
raw_output : bool, default False
    if <code>True</code>, the raw predicted probabilities are returned
apply_primary_function : bool, default True
    if <code>True</code>, the primary predict function is applied (to map the model output into a shape corresponding to
    the input)
augment_n : int, default 0
    the number of augmentations to average results over
batch_size : int, default 32
    the batch size
train_mode : bool, default False
    if <code>True</code>, the model is used in training mode (affects dropout and batch normalization layers)
to_ram : bool, default False
    if <code>True</code>, the dataset will be loaded in RAM (this speeds up the calculations but can lead to crashes
    if the dataset is too large)
embedding : bool, default False
    if <code>True</code>, the output of feature extractor is returned, ignoring the prediction module of the model</p>

<h2 id="returns">Returns</h2>

<p>prediction : torch.Tensor
    a prediction for the input data</p>
</div>


                            </div>
                            <div id="Task.dataset" class="classattr">
                                        <input id="Task.dataset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">dataset</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;train&#39;</span></span><span class="return-annotation">) -> <span class="n">dlc2action</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">BehaviorDataset</span>:</span></span>

                <label class="view-source-button" for="Task.dataset-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.dataset"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.dataset-998"><a href="#Task.dataset-998"><span class="linenos"> 998</span></a>    <span class="k">def</span> <span class="nf">dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BehaviorDataset</span><span class="p">:</span>
</span><span id="Task.dataset-999"><a href="#Task.dataset-999"><span class="linenos"> 999</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.dataset-1000"><a href="#Task.dataset-1000"><span class="linenos">1000</span></a><span class="sd">        Get a dataset</span>
</span><span id="Task.dataset-1001"><a href="#Task.dataset-1001"><span class="linenos">1001</span></a>
</span><span id="Task.dataset-1002"><a href="#Task.dataset-1002"><span class="linenos">1002</span></a><span class="sd">        Parameters</span>
</span><span id="Task.dataset-1003"><a href="#Task.dataset-1003"><span class="linenos">1003</span></a><span class="sd">        ----------</span>
</span><span id="Task.dataset-1004"><a href="#Task.dataset-1004"><span class="linenos">1004</span></a><span class="sd">        mode : {&#39;train&#39;, &#39;val&#39;, &#39;test}</span>
</span><span id="Task.dataset-1005"><a href="#Task.dataset-1005"><span class="linenos">1005</span></a><span class="sd">            the dataset to get</span>
</span><span id="Task.dataset-1006"><a href="#Task.dataset-1006"><span class="linenos">1006</span></a>
</span><span id="Task.dataset-1007"><a href="#Task.dataset-1007"><span class="linenos">1007</span></a><span class="sd">        Returns</span>
</span><span id="Task.dataset-1008"><a href="#Task.dataset-1008"><span class="linenos">1008</span></a><span class="sd">        -------</span>
</span><span id="Task.dataset-1009"><a href="#Task.dataset-1009"><span class="linenos">1009</span></a><span class="sd">        dataset : dlc2action.data.dataset.BehaviorDataset</span>
</span><span id="Task.dataset-1010"><a href="#Task.dataset-1010"><span class="linenos">1010</span></a><span class="sd">            the dataset</span>
</span><span id="Task.dataset-1011"><a href="#Task.dataset-1011"><span class="linenos">1011</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.dataset-1012"><a href="#Task.dataset-1012"><span class="linenos">1012</span></a>
</span><span id="Task.dataset-1013"><a href="#Task.dataset-1013"><span class="linenos">1013</span></a>        <span class="n">dataloader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
</span><span id="Task.dataset-1014"><a href="#Task.dataset-1014"><span class="linenos">1014</span></a>        <span class="k">if</span> <span class="n">dataloader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.dataset-1015"><a href="#Task.dataset-1015"><span class="linenos">1015</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The length of the dataloader is 0!&quot;</span><span class="p">)</span>
</span><span id="Task.dataset-1016"><a href="#Task.dataset-1016"><span class="linenos">1016</span></a>        <span class="k">return</span> <span class="n">dataloader</span><span class="o">.</span><span class="n">dataset</span>
</span></pre></div>


            <div class="docstring"><p>Get a dataset</p>

<h2 id="parameters">Parameters</h2>

<p>mode : {'train', 'val', 'test}
    the dataset to get</p>

<h2 id="returns">Returns</h2>

<p>dataset : <a href="../data/dataset.html#BehaviorDataset">dlc2action.data.dataset.BehaviorDataset</a>
    the dataset</p>
</div>


                            </div>
                            <div id="Task.dataloader" class="classattr">
                                        <input id="Task.dataloader-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">dataloader</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;train&#39;</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataloader</span><span class="o">.</span><span class="n">DataLoader</span>:</span></span>

                <label class="view-source-button" for="Task.dataloader-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.dataloader"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.dataloader-1018"><a href="#Task.dataloader-1018"><span class="linenos">1018</span></a>    <span class="k">def</span> <span class="nf">dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;train&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataLoader</span><span class="p">:</span>
</span><span id="Task.dataloader-1019"><a href="#Task.dataloader-1019"><span class="linenos">1019</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.dataloader-1020"><a href="#Task.dataloader-1020"><span class="linenos">1020</span></a><span class="sd">        Get a dataloader</span>
</span><span id="Task.dataloader-1021"><a href="#Task.dataloader-1021"><span class="linenos">1021</span></a>
</span><span id="Task.dataloader-1022"><a href="#Task.dataloader-1022"><span class="linenos">1022</span></a><span class="sd">        Parameters</span>
</span><span id="Task.dataloader-1023"><a href="#Task.dataloader-1023"><span class="linenos">1023</span></a><span class="sd">        ----------</span>
</span><span id="Task.dataloader-1024"><a href="#Task.dataloader-1024"><span class="linenos">1024</span></a><span class="sd">        mode : {&#39;train&#39;, &#39;val&#39;, &#39;test}</span>
</span><span id="Task.dataloader-1025"><a href="#Task.dataloader-1025"><span class="linenos">1025</span></a><span class="sd">            the dataset to get</span>
</span><span id="Task.dataloader-1026"><a href="#Task.dataloader-1026"><span class="linenos">1026</span></a>
</span><span id="Task.dataloader-1027"><a href="#Task.dataloader-1027"><span class="linenos">1027</span></a><span class="sd">        Returns</span>
</span><span id="Task.dataloader-1028"><a href="#Task.dataloader-1028"><span class="linenos">1028</span></a><span class="sd">        -------</span>
</span><span id="Task.dataloader-1029"><a href="#Task.dataloader-1029"><span class="linenos">1029</span></a><span class="sd">        dataloader : torch.utils.data.DataLoader</span>
</span><span id="Task.dataloader-1030"><a href="#Task.dataloader-1030"><span class="linenos">1030</span></a><span class="sd">            the dataloader</span>
</span><span id="Task.dataloader-1031"><a href="#Task.dataloader-1031"><span class="linenos">1031</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.dataloader-1032"><a href="#Task.dataloader-1032"><span class="linenos">1032</span></a>
</span><span id="Task.dataloader-1033"><a href="#Task.dataloader-1033"><span class="linenos">1033</span></a>        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;train&quot;</span><span class="p">:</span>
</span><span id="Task.dataloader-1034"><a href="#Task.dataloader-1034"><span class="linenos">1034</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span>
</span><span id="Task.dataloader-1035"><a href="#Task.dataloader-1035"><span class="linenos">1035</span></a>        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span>
</span><span id="Task.dataloader-1036"><a href="#Task.dataloader-1036"><span class="linenos">1036</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span>
</span><span id="Task.dataloader-1037"><a href="#Task.dataloader-1037"><span class="linenos">1037</span></a>        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
</span><span id="Task.dataloader-1038"><a href="#Task.dataloader-1038"><span class="linenos">1038</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_dataloader</span>
</span><span id="Task.dataloader-1039"><a href="#Task.dataloader-1039"><span class="linenos">1039</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task.dataloader-1040"><a href="#Task.dataloader-1040"><span class="linenos">1040</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Task.dataloader-1041"><a href="#Task.dataloader-1041"><span class="linenos">1041</span></a>                <span class="sa">f</span><span class="s1">&#39;The </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s1"> mode is not recognized, please choose from &quot;train&quot;, &quot;val&quot; or &quot;test&quot;&#39;</span>
</span><span id="Task.dataloader-1042"><a href="#Task.dataloader-1042"><span class="linenos">1042</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get a dataloader</p>

<h2 id="parameters">Parameters</h2>

<p>mode : {'train', 'val', 'test}
    the dataset to get</p>

<h2 id="returns">Returns</h2>

<p>dataloader : torch.utils.data.DataLoader
    the dataloader</p>
</div>


                            </div>
                            <div id="Task.generate_full_length_prediction" class="classattr">
                                        <input id="Task.generate_full_length_prediction-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_full_length_prediction</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">dataset</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span>, </span><span class="param"><span class="n">augment_n</span><span class="o">=</span><span class="mi">10</span></span>)</span>

                <label class="view-source-button" for="Task.generate_full_length_prediction-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.generate_full_length_prediction"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.generate_full_length_prediction-1078"><a href="#Task.generate_full_length_prediction-1078"><span class="linenos">1078</span></a>    <span class="k">def</span> <span class="nf">generate_full_length_prediction</span><span class="p">(</span>
</span><span id="Task.generate_full_length_prediction-1079"><a href="#Task.generate_full_length_prediction-1079"><span class="linenos">1079</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">augment_n</span><span class="o">=</span><span class="mi">10</span>
</span><span id="Task.generate_full_length_prediction-1080"><a href="#Task.generate_full_length_prediction-1080"><span class="linenos">1080</span></a>    <span class="p">):</span>
</span><span id="Task.generate_full_length_prediction-1081"><a href="#Task.generate_full_length_prediction-1081"><span class="linenos">1081</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.generate_full_length_prediction-1082"><a href="#Task.generate_full_length_prediction-1082"><span class="linenos">1082</span></a><span class="sd">        Compile a prediction for the original input sequences</span>
</span><span id="Task.generate_full_length_prediction-1083"><a href="#Task.generate_full_length_prediction-1083"><span class="linenos">1083</span></a>
</span><span id="Task.generate_full_length_prediction-1084"><a href="#Task.generate_full_length_prediction-1084"><span class="linenos">1084</span></a><span class="sd">        Parameters</span>
</span><span id="Task.generate_full_length_prediction-1085"><a href="#Task.generate_full_length_prediction-1085"><span class="linenos">1085</span></a><span class="sd">        ----------</span>
</span><span id="Task.generate_full_length_prediction-1086"><a href="#Task.generate_full_length_prediction-1086"><span class="linenos">1086</span></a><span class="sd">        dataset : BehaviorDataset, optional</span>
</span><span id="Task.generate_full_length_prediction-1087"><a href="#Task.generate_full_length_prediction-1087"><span class="linenos">1087</span></a><span class="sd">            the dataset to generate a prediction for (if `None`, generate for the validation dataset)</span>
</span><span id="Task.generate_full_length_prediction-1088"><a href="#Task.generate_full_length_prediction-1088"><span class="linenos">1088</span></a><span class="sd">        batch_size : int, default 32</span>
</span><span id="Task.generate_full_length_prediction-1089"><a href="#Task.generate_full_length_prediction-1089"><span class="linenos">1089</span></a><span class="sd">            the batch size</span>
</span><span id="Task.generate_full_length_prediction-1090"><a href="#Task.generate_full_length_prediction-1090"><span class="linenos">1090</span></a><span class="sd">        augment_n : int, default 10</span>
</span><span id="Task.generate_full_length_prediction-1091"><a href="#Task.generate_full_length_prediction-1091"><span class="linenos">1091</span></a><span class="sd">            the number of augmentations to average results over</span>
</span><span id="Task.generate_full_length_prediction-1092"><a href="#Task.generate_full_length_prediction-1092"><span class="linenos">1092</span></a>
</span><span id="Task.generate_full_length_prediction-1093"><a href="#Task.generate_full_length_prediction-1093"><span class="linenos">1093</span></a><span class="sd">        Returns</span>
</span><span id="Task.generate_full_length_prediction-1094"><a href="#Task.generate_full_length_prediction-1094"><span class="linenos">1094</span></a><span class="sd">        -------</span>
</span><span id="Task.generate_full_length_prediction-1095"><a href="#Task.generate_full_length_prediction-1095"><span class="linenos">1095</span></a><span class="sd">        prediction : dict</span>
</span><span id="Task.generate_full_length_prediction-1096"><a href="#Task.generate_full_length_prediction-1096"><span class="linenos">1096</span></a><span class="sd">            a nested dictionary where first level keys are video ids, second level keys are clip ids and values</span>
</span><span id="Task.generate_full_length_prediction-1097"><a href="#Task.generate_full_length_prediction-1097"><span class="linenos">1097</span></a><span class="sd">            are prediction tensors</span>
</span><span id="Task.generate_full_length_prediction-1098"><a href="#Task.generate_full_length_prediction-1098"><span class="linenos">1098</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.generate_full_length_prediction-1099"><a href="#Task.generate_full_length_prediction-1099"><span class="linenos">1099</span></a>
</span><span id="Task.generate_full_length_prediction-1100"><a href="#Task.generate_full_length_prediction-1100"><span class="linenos">1100</span></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="Task.generate_full_length_prediction-1101"><a href="#Task.generate_full_length_prediction-1101"><span class="linenos">1101</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">BehaviorDataset</span><span class="p">):</span>
</span><span id="Task.generate_full_length_prediction-1102"><a href="#Task.generate_full_length_prediction-1102"><span class="linenos">1102</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="Task.generate_full_length_prediction-1103"><a href="#Task.generate_full_length_prediction-1103"><span class="linenos">1103</span></a>                <span class="sa">f</span><span class="s2">&quot;The dataset parameter has to be either None, string, &quot;</span>
</span><span id="Task.generate_full_length_prediction-1104"><a href="#Task.generate_full_length_prediction-1104"><span class="linenos">1104</span></a>                <span class="sa">f</span><span class="s2">&quot;BehaviorDataset or Dataloader, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task.generate_full_length_prediction-1105"><a href="#Task.generate_full_length_prediction-1105"><span class="linenos">1105</span></a>            <span class="p">)</span>
</span><span id="Task.generate_full_length_prediction-1106"><a href="#Task.generate_full_length_prediction-1106"><span class="linenos">1106</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
</span><span id="Task.generate_full_length_prediction-1107"><a href="#Task.generate_full_length_prediction-1107"><span class="linenos">1107</span></a>            <span class="n">dataset</span><span class="p">,</span>
</span><span id="Task.generate_full_length_prediction-1108"><a href="#Task.generate_full_length_prediction-1108"><span class="linenos">1108</span></a>            <span class="n">raw_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task.generate_full_length_prediction-1109"><a href="#Task.generate_full_length_prediction-1109"><span class="linenos">1109</span></a>            <span class="n">apply_primary_function</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task.generate_full_length_prediction-1110"><a href="#Task.generate_full_length_prediction-1110"><span class="linenos">1110</span></a>            <span class="n">augment_n</span><span class="o">=</span><span class="n">augment_n</span><span class="p">,</span>
</span><span id="Task.generate_full_length_prediction-1111"><a href="#Task.generate_full_length_prediction-1111"><span class="linenos">1111</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="Task.generate_full_length_prediction-1112"><a href="#Task.generate_full_length_prediction-1112"><span class="linenos">1112</span></a>        <span class="p">)</span>
</span><span id="Task.generate_full_length_prediction-1113"><a href="#Task.generate_full_length_prediction-1113"><span class="linenos">1113</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">generate_full_length_prediction</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="Task.generate_full_length_prediction-1114"><a href="#Task.generate_full_length_prediction-1114"><span class="linenos">1114</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Task.generate_full_length_prediction-1115"><a href="#Task.generate_full_length_prediction-1115"><span class="linenos">1115</span></a>            <span class="n">v_id</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Task.generate_full_length_prediction-1116"><a href="#Task.generate_full_length_prediction-1116"><span class="linenos">1116</span></a>                <span class="n">clip_id</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_predict_functions</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="Task.generate_full_length_prediction-1117"><a href="#Task.generate_full_length_prediction-1117"><span class="linenos">1117</span></a>                <span class="k">for</span> <span class="n">clip_id</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">video_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Task.generate_full_length_prediction-1118"><a href="#Task.generate_full_length_prediction-1118"><span class="linenos">1118</span></a>            <span class="p">}</span>
</span><span id="Task.generate_full_length_prediction-1119"><a href="#Task.generate_full_length_prediction-1119"><span class="linenos">1119</span></a>            <span class="k">for</span> <span class="n">v_id</span><span class="p">,</span> <span class="n">video_dict</span> <span class="ow">in</span> <span class="n">predicted</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Task.generate_full_length_prediction-1120"><a href="#Task.generate_full_length_prediction-1120"><span class="linenos">1120</span></a>        <span class="p">}</span>
</span><span id="Task.generate_full_length_prediction-1121"><a href="#Task.generate_full_length_prediction-1121"><span class="linenos">1121</span></a>        <span class="k">return</span> <span class="n">predicted</span>
</span></pre></div>


            <div class="docstring"><p>Compile a prediction for the original input sequences</p>

<h2 id="parameters">Parameters</h2>

<p>dataset : BehaviorDataset, optional
    the dataset to generate a prediction for (if <code>None</code>, generate for the validation dataset)
batch_size : int, default 32
    the batch size
augment_n : int, default 10
    the number of augmentations to average results over</p>

<h2 id="returns">Returns</h2>

<p>prediction : dict
    a nested dictionary where first level keys are video ids, second level keys are clip ids and values
    are prediction tensors</p>
</div>


                            </div>
                            <div id="Task.generate_submission" class="classattr">
                                        <input id="Task.generate_submission-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_submission</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">frame_number_map_file</span>,</span><span class="param">	<span class="n">dataset</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span>,</span><span class="param">	<span class="n">augment_n</span><span class="o">=</span><span class="mi">10</span></span>)</span>

                <label class="view-source-button" for="Task.generate_submission-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.generate_submission"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.generate_submission-1123"><a href="#Task.generate_submission-1123"><span class="linenos">1123</span></a>    <span class="k">def</span> <span class="nf">generate_submission</span><span class="p">(</span>
</span><span id="Task.generate_submission-1124"><a href="#Task.generate_submission-1124"><span class="linenos">1124</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">frame_number_map_file</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">augment_n</span><span class="o">=</span><span class="mi">10</span>
</span><span id="Task.generate_submission-1125"><a href="#Task.generate_submission-1125"><span class="linenos">1125</span></a>    <span class="p">):</span>
</span><span id="Task.generate_submission-1126"><a href="#Task.generate_submission-1126"><span class="linenos">1126</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.generate_submission-1127"><a href="#Task.generate_submission-1127"><span class="linenos">1127</span></a><span class="sd">        Generate a MABe-22 style submission dictionary</span>
</span><span id="Task.generate_submission-1128"><a href="#Task.generate_submission-1128"><span class="linenos">1128</span></a>
</span><span id="Task.generate_submission-1129"><a href="#Task.generate_submission-1129"><span class="linenos">1129</span></a><span class="sd">        Parameters</span>
</span><span id="Task.generate_submission-1130"><a href="#Task.generate_submission-1130"><span class="linenos">1130</span></a><span class="sd">        ----------</span>
</span><span id="Task.generate_submission-1131"><a href="#Task.generate_submission-1131"><span class="linenos">1131</span></a><span class="sd">        dataset : BehaviorDataset, optional</span>
</span><span id="Task.generate_submission-1132"><a href="#Task.generate_submission-1132"><span class="linenos">1132</span></a><span class="sd">            the dataset to generate a prediction for (if `None`, generate for the validation dataset)</span>
</span><span id="Task.generate_submission-1133"><a href="#Task.generate_submission-1133"><span class="linenos">1133</span></a><span class="sd">        batch_size : int, default 32</span>
</span><span id="Task.generate_submission-1134"><a href="#Task.generate_submission-1134"><span class="linenos">1134</span></a><span class="sd">            the batch size</span>
</span><span id="Task.generate_submission-1135"><a href="#Task.generate_submission-1135"><span class="linenos">1135</span></a><span class="sd">        augment_n : int, default 10</span>
</span><span id="Task.generate_submission-1136"><a href="#Task.generate_submission-1136"><span class="linenos">1136</span></a><span class="sd">            the number of augmentations to average results over</span>
</span><span id="Task.generate_submission-1137"><a href="#Task.generate_submission-1137"><span class="linenos">1137</span></a>
</span><span id="Task.generate_submission-1138"><a href="#Task.generate_submission-1138"><span class="linenos">1138</span></a><span class="sd">        Returns</span>
</span><span id="Task.generate_submission-1139"><a href="#Task.generate_submission-1139"><span class="linenos">1139</span></a><span class="sd">        -------</span>
</span><span id="Task.generate_submission-1140"><a href="#Task.generate_submission-1140"><span class="linenos">1140</span></a><span class="sd">        submission : dict</span>
</span><span id="Task.generate_submission-1141"><a href="#Task.generate_submission-1141"><span class="linenos">1141</span></a><span class="sd">            a dictionary with frame number mapping and embeddings</span>
</span><span id="Task.generate_submission-1142"><a href="#Task.generate_submission-1142"><span class="linenos">1142</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.generate_submission-1143"><a href="#Task.generate_submission-1143"><span class="linenos">1143</span></a>
</span><span id="Task.generate_submission-1144"><a href="#Task.generate_submission-1144"><span class="linenos">1144</span></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="Task.generate_submission-1145"><a href="#Task.generate_submission-1145"><span class="linenos">1145</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">BehaviorDataset</span><span class="p">):</span>
</span><span id="Task.generate_submission-1146"><a href="#Task.generate_submission-1146"><span class="linenos">1146</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="Task.generate_submission-1147"><a href="#Task.generate_submission-1147"><span class="linenos">1147</span></a>                <span class="sa">f</span><span class="s2">&quot;The dataset parameter has to be either None, string, &quot;</span>
</span><span id="Task.generate_submission-1148"><a href="#Task.generate_submission-1148"><span class="linenos">1148</span></a>                <span class="sa">f</span><span class="s2">&quot;BehaviorDataset or Dataloader, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task.generate_submission-1149"><a href="#Task.generate_submission-1149"><span class="linenos">1149</span></a>            <span class="p">)</span>
</span><span id="Task.generate_submission-1150"><a href="#Task.generate_submission-1150"><span class="linenos">1150</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
</span><span id="Task.generate_submission-1151"><a href="#Task.generate_submission-1151"><span class="linenos">1151</span></a>            <span class="n">dataset</span><span class="p">,</span>
</span><span id="Task.generate_submission-1152"><a href="#Task.generate_submission-1152"><span class="linenos">1152</span></a>            <span class="n">raw_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task.generate_submission-1153"><a href="#Task.generate_submission-1153"><span class="linenos">1153</span></a>            <span class="n">apply_primary_function</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task.generate_submission-1154"><a href="#Task.generate_submission-1154"><span class="linenos">1154</span></a>            <span class="n">augment_n</span><span class="o">=</span><span class="n">augment_n</span><span class="p">,</span>
</span><span id="Task.generate_submission-1155"><a href="#Task.generate_submission-1155"><span class="linenos">1155</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="Task.generate_submission-1156"><a href="#Task.generate_submission-1156"><span class="linenos">1156</span></a>            <span class="n">embedding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task.generate_submission-1157"><a href="#Task.generate_submission-1157"><span class="linenos">1157</span></a>        <span class="p">)</span>
</span><span id="Task.generate_submission-1158"><a href="#Task.generate_submission-1158"><span class="linenos">1158</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">generate_full_length_prediction</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="Task.generate_submission-1159"><a href="#Task.generate_submission-1159"><span class="linenos">1159</span></a>        <span class="n">frame_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">frame_number_map_file</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="Task.generate_submission-1160"><a href="#Task.generate_submission-1160"><span class="linenos">1160</span></a>        <span class="n">length</span> <span class="o">=</span> <span class="n">frame_map</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">frame_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="o">-</span><span class="mi">1</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Task.generate_submission-1161"><a href="#Task.generate_submission-1161"><span class="linenos">1161</span></a>        <span class="n">embeddings</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Task.generate_submission-1162"><a href="#Task.generate_submission-1162"><span class="linenos">1162</span></a>        <span class="k">for</span> <span class="n">video_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">predicted</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="Task.generate_submission-1163"><a href="#Task.generate_submission-1163"><span class="linenos">1163</span></a>            <span class="n">split</span> <span class="o">=</span> <span class="n">video_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
</span><span id="Task.generate_submission-1164"><a href="#Task.generate_submission-1164"><span class="linenos">1164</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">predicted</span><span class="p">[</span><span class="n">video_id</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Task.generate_submission-1165"><a href="#Task.generate_submission-1165"><span class="linenos">1165</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="Task.generate_submission-1166"><a href="#Task.generate_submission-1166"><span class="linenos">1166</span></a>                    <span class="s2">&quot;Generating submissions is only implemented for the mabe22 dataset!&quot;</span>
</span><span id="Task.generate_submission-1167"><a href="#Task.generate_submission-1167"><span class="linenos">1167</span></a>                <span class="p">)</span>
</span><span id="Task.generate_submission-1168"><a href="#Task.generate_submission-1168"><span class="linenos">1168</span></a>            <span class="k">if</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">frame_map</span><span class="p">:</span>
</span><span id="Task.generate_submission-1169"><a href="#Task.generate_submission-1169"><span class="linenos">1169</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> video is not in the frame map file&quot;</span><span class="p">)</span>
</span><span id="Task.generate_submission-1170"><a href="#Task.generate_submission-1170"><span class="linenos">1170</span></a>            <span class="n">v_id</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Task.generate_submission-1171"><a href="#Task.generate_submission-1171"><span class="linenos">1171</span></a>            <span class="n">clip_id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">predicted</span><span class="p">[</span><span class="n">video_id</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Task.generate_submission-1172"><a href="#Task.generate_submission-1172"><span class="linenos">1172</span></a>            <span class="k">if</span> <span class="n">embeddings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.generate_submission-1173"><a href="#Task.generate_submission-1173"><span class="linenos">1173</span></a>                <span class="n">embeddings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">length</span><span class="p">,</span> <span class="n">predicted</span><span class="p">[</span><span class="n">video_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="Task.generate_submission-1174"><a href="#Task.generate_submission-1174"><span class="linenos">1174</span></a>            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">frame_map</span><span class="p">[</span><span class="n">v_id</span><span class="p">]</span>
</span><span id="Task.generate_submission-1175"><a href="#Task.generate_submission-1175"><span class="linenos">1175</span></a>            <span class="n">embeddings</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">predicted</span><span class="p">[</span><span class="n">video_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
</span><span id="Task.generate_submission-1176"><a href="#Task.generate_submission-1176"><span class="linenos">1176</span></a>            <span class="n">predicted</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">video_id</span><span class="p">)</span>
</span><span id="Task.generate_submission-1177"><a href="#Task.generate_submission-1177"><span class="linenos">1177</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Task.generate_submission-1178"><a href="#Task.generate_submission-1178"><span class="linenos">1178</span></a>            <span class="s2">&quot;frame_number_map&quot;</span><span class="p">:</span> <span class="n">frame_map</span><span class="p">,</span>
</span><span id="Task.generate_submission-1179"><a href="#Task.generate_submission-1179"><span class="linenos">1179</span></a>            <span class="s2">&quot;embeddings&quot;</span><span class="p">:</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
</span><span id="Task.generate_submission-1180"><a href="#Task.generate_submission-1180"><span class="linenos">1180</span></a>        <span class="p">}</span>
</span><span id="Task.generate_submission-1181"><a href="#Task.generate_submission-1181"><span class="linenos">1181</span></a>        <span class="k">return</span> <span class="n">predicted</span>
</span></pre></div>


            <div class="docstring"><p>Generate a MABe-22 style submission dictionary</p>

<h2 id="parameters">Parameters</h2>

<p>dataset : BehaviorDataset, optional
    the dataset to generate a prediction for (if <code>None</code>, generate for the validation dataset)
batch_size : int, default 32
    the batch size
augment_n : int, default 10
    the number of augmentations to average results over</p>

<h2 id="returns">Returns</h2>

<p>submission : dict
    a dictionary with frame number mapping and embeddings</p>
</div>


                            </div>
                            <div id="Task.visualize_results" class="classattr">
                                        <input id="Task.visualize_results-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">visualize_results</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">add_legend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">ground_truth</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">colormap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span>,</span><span class="param">	<span class="n">hide_axes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">min_classes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>,</span><span class="param">	<span class="n">whole_video</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">transparent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">dataset</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">dlc2action</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">BehaviorDataset</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataloader</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">drop_classes</span><span class="p">:</span> <span class="n">Set</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">search_classes</span><span class="p">:</span> <span class="n">Set</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">smooth_interval_prediction</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">behavior_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="Task.visualize_results-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.visualize_results"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.visualize_results-1438"><a href="#Task.visualize_results-1438"><span class="linenos">1438</span></a>    <span class="k">def</span> <span class="nf">visualize_results</span><span class="p">(</span>
</span><span id="Task.visualize_results-1439"><a href="#Task.visualize_results-1439"><span class="linenos">1439</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Task.visualize_results-1440"><a href="#Task.visualize_results-1440"><span class="linenos">1440</span></a>        <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.visualize_results-1441"><a href="#Task.visualize_results-1441"><span class="linenos">1441</span></a>        <span class="n">add_legend</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Task.visualize_results-1442"><a href="#Task.visualize_results-1442"><span class="linenos">1442</span></a>        <span class="n">ground_truth</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Task.visualize_results-1443"><a href="#Task.visualize_results-1443"><span class="linenos">1443</span></a>        <span class="n">colormap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
</span><span id="Task.visualize_results-1444"><a href="#Task.visualize_results-1444"><span class="linenos">1444</span></a>        <span class="n">hide_axes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task.visualize_results-1445"><a href="#Task.visualize_results-1445"><span class="linenos">1445</span></a>        <span class="n">min_classes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="Task.visualize_results-1446"><a href="#Task.visualize_results-1446"><span class="linenos">1446</span></a>        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="Task.visualize_results-1447"><a href="#Task.visualize_results-1447"><span class="linenos">1447</span></a>        <span class="n">whole_video</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task.visualize_results-1448"><a href="#Task.visualize_results-1448"><span class="linenos">1448</span></a>        <span class="n">transparent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Task.visualize_results-1449"><a href="#Task.visualize_results-1449"><span class="linenos">1449</span></a>        <span class="n">dataset</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">BehaviorDataset</span><span class="p">,</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.visualize_results-1450"><a href="#Task.visualize_results-1450"><span class="linenos">1450</span></a>        <span class="n">drop_classes</span><span class="p">:</span> <span class="n">Set</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.visualize_results-1451"><a href="#Task.visualize_results-1451"><span class="linenos">1451</span></a>        <span class="n">search_classes</span><span class="p">:</span> <span class="n">Set</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.visualize_results-1452"><a href="#Task.visualize_results-1452"><span class="linenos">1452</span></a>        <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="Task.visualize_results-1453"><a href="#Task.visualize_results-1453"><span class="linenos">1453</span></a>        <span class="n">smooth_interval_prediction</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.visualize_results-1454"><a href="#Task.visualize_results-1454"><span class="linenos">1454</span></a>        <span class="n">behavior_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.visualize_results-1455"><a href="#Task.visualize_results-1455"><span class="linenos">1455</span></a>    <span class="p">):</span>
</span><span id="Task.visualize_results-1456"><a href="#Task.visualize_results-1456"><span class="linenos">1456</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.visualize_results-1457"><a href="#Task.visualize_results-1457"><span class="linenos">1457</span></a><span class="sd">        Visualize random predictions</span>
</span><span id="Task.visualize_results-1458"><a href="#Task.visualize_results-1458"><span class="linenos">1458</span></a>
</span><span id="Task.visualize_results-1459"><a href="#Task.visualize_results-1459"><span class="linenos">1459</span></a><span class="sd">        Parameters</span>
</span><span id="Task.visualize_results-1460"><a href="#Task.visualize_results-1460"><span class="linenos">1460</span></a><span class="sd">        ----------</span>
</span><span id="Task.visualize_results-1461"><a href="#Task.visualize_results-1461"><span class="linenos">1461</span></a><span class="sd">        save_path : str, optional</span>
</span><span id="Task.visualize_results-1462"><a href="#Task.visualize_results-1462"><span class="linenos">1462</span></a><span class="sd">            the path where the plot will be saved</span>
</span><span id="Task.visualize_results-1463"><a href="#Task.visualize_results-1463"><span class="linenos">1463</span></a><span class="sd">        add_legend : bool, default True</span>
</span><span id="Task.visualize_results-1464"><a href="#Task.visualize_results-1464"><span class="linenos">1464</span></a><span class="sd">            if `True`, legend will be added to the plot</span>
</span><span id="Task.visualize_results-1465"><a href="#Task.visualize_results-1465"><span class="linenos">1465</span></a><span class="sd">        ground_truth : bool, default True</span>
</span><span id="Task.visualize_results-1466"><a href="#Task.visualize_results-1466"><span class="linenos">1466</span></a><span class="sd">            if `True`, ground truth will be added to the plot</span>
</span><span id="Task.visualize_results-1467"><a href="#Task.visualize_results-1467"><span class="linenos">1467</span></a><span class="sd">        colormap : str, default &#39;Accent&#39;</span>
</span><span id="Task.visualize_results-1468"><a href="#Task.visualize_results-1468"><span class="linenos">1468</span></a><span class="sd">            the `matplotlib` colormap to use</span>
</span><span id="Task.visualize_results-1469"><a href="#Task.visualize_results-1469"><span class="linenos">1469</span></a><span class="sd">        hide_axes : bool, default True</span>
</span><span id="Task.visualize_results-1470"><a href="#Task.visualize_results-1470"><span class="linenos">1470</span></a><span class="sd">            if `True`, the axes will be hidden on the plot</span>
</span><span id="Task.visualize_results-1471"><a href="#Task.visualize_results-1471"><span class="linenos">1471</span></a><span class="sd">        min_classes : int, default 1</span>
</span><span id="Task.visualize_results-1472"><a href="#Task.visualize_results-1472"><span class="linenos">1472</span></a><span class="sd">            the minimum number of classes in a displayed interval</span>
</span><span id="Task.visualize_results-1473"><a href="#Task.visualize_results-1473"><span class="linenos">1473</span></a><span class="sd">        width : float, default 10</span>
</span><span id="Task.visualize_results-1474"><a href="#Task.visualize_results-1474"><span class="linenos">1474</span></a><span class="sd">            the width of the plot</span>
</span><span id="Task.visualize_results-1475"><a href="#Task.visualize_results-1475"><span class="linenos">1475</span></a><span class="sd">        whole_video : bool, default False</span>
</span><span id="Task.visualize_results-1476"><a href="#Task.visualize_results-1476"><span class="linenos">1476</span></a><span class="sd">            if `True`, whole videos are plotted instead of segments</span>
</span><span id="Task.visualize_results-1477"><a href="#Task.visualize_results-1477"><span class="linenos">1477</span></a><span class="sd">        transparent : bool, default False</span>
</span><span id="Task.visualize_results-1478"><a href="#Task.visualize_results-1478"><span class="linenos">1478</span></a><span class="sd">            if `True`, the background on the plot is transparent</span>
</span><span id="Task.visualize_results-1479"><a href="#Task.visualize_results-1479"><span class="linenos">1479</span></a><span class="sd">        dataset : BehaviorDataset | DataLoader | str | None, optional</span>
</span><span id="Task.visualize_results-1480"><a href="#Task.visualize_results-1480"><span class="linenos">1480</span></a><span class="sd">            the dataset to make the prediction for (if not provided, the validation dataset is used)</span>
</span><span id="Task.visualize_results-1481"><a href="#Task.visualize_results-1481"><span class="linenos">1481</span></a><span class="sd">        drop_classes : set, optional</span>
</span><span id="Task.visualize_results-1482"><a href="#Task.visualize_results-1482"><span class="linenos">1482</span></a><span class="sd">            a set of class names to not be displayed</span>
</span><span id="Task.visualize_results-1483"><a href="#Task.visualize_results-1483"><span class="linenos">1483</span></a><span class="sd">        search_classes : set, optional</span>
</span><span id="Task.visualize_results-1484"><a href="#Task.visualize_results-1484"><span class="linenos">1484</span></a><span class="sd">            if given, only intervals where at least one of the classes is in ground truth will be shown</span>
</span><span id="Task.visualize_results-1485"><a href="#Task.visualize_results-1485"><span class="linenos">1485</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.visualize_results-1486"><a href="#Task.visualize_results-1486"><span class="linenos">1486</span></a>
</span><span id="Task.visualize_results-1487"><a href="#Task.visualize_results-1487"><span class="linenos">1487</span></a>        <span class="k">if</span> <span class="n">drop_classes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.visualize_results-1488"><a href="#Task.visualize_results-1488"><span class="linenos">1488</span></a>            <span class="n">drop_classes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Task.visualize_results-1489"><a href="#Task.visualize_results-1489"><span class="linenos">1489</span></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="Task.visualize_results-1490"><a href="#Task.visualize_results-1490"><span class="linenos">1490</span></a>        <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">annotation_class</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;exclusive_classification&quot;</span><span class="p">:</span>
</span><span id="Task.visualize_results-1491"><a href="#Task.visualize_results-1491"><span class="linenos">1491</span></a>            <span class="n">exclusive</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Task.visualize_results-1492"><a href="#Task.visualize_results-1492"><span class="linenos">1492</span></a>        <span class="k">elif</span> <span class="n">dataset</span><span class="o">.</span><span class="n">annotation_class</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;nonexclusive_classification&quot;</span><span class="p">:</span>
</span><span id="Task.visualize_results-1493"><a href="#Task.visualize_results-1493"><span class="linenos">1493</span></a>            <span class="n">exclusive</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Task.visualize_results-1494"><a href="#Task.visualize_results-1494"><span class="linenos">1494</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task.visualize_results-1495"><a href="#Task.visualize_results-1495"><span class="linenos">1495</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="Task.visualize_results-1496"><a href="#Task.visualize_results-1496"><span class="linenos">1496</span></a>                <span class="sa">f</span><span class="s2">&quot;Results visualisation is not implemented for </span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">annotation_class</span><span class="p">()</span> <span class="si">}</span><span class="s2"> datasets!&quot;</span>
</span><span id="Task.visualize_results-1497"><a href="#Task.visualize_results-1497"><span class="linenos">1497</span></a>            <span class="p">)</span>
</span><span id="Task.visualize_results-1498"><a href="#Task.visualize_results-1498"><span class="linenos">1498</span></a>        <span class="k">if</span> <span class="n">exclusive</span><span class="p">:</span>
</span><span id="Task.visualize_results-1499"><a href="#Task.visualize_results-1499"><span class="linenos">1499</span></a>            <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Task.visualize_results-1500"><a href="#Task.visualize_results-1500"><span class="linenos">1500</span></a>                <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
</span><span id="Task.visualize_results-1501"><a href="#Task.visualize_results-1501"><span class="linenos">1501</span></a>                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Task.visualize_results-1502"><a href="#Task.visualize_results-1502"><span class="linenos">1502</span></a>                <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">drop_classes</span>
</span><span id="Task.visualize_results-1503"><a href="#Task.visualize_results-1503"><span class="linenos">1503</span></a>            <span class="p">}</span>
</span><span id="Task.visualize_results-1504"><a href="#Task.visualize_results-1504"><span class="linenos">1504</span></a>            <span class="n">labels</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="o">-</span><span class="mi">100</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">})</span>
</span><span id="Task.visualize_results-1505"><a href="#Task.visualize_results-1505"><span class="linenos">1505</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task.visualize_results-1506"><a href="#Task.visualize_results-1506"><span class="linenos">1506</span></a>            <span class="n">inverse_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Task.visualize_results-1507"><a href="#Task.visualize_results-1507"><span class="linenos">1507</span></a>            <span class="k">if</span> <span class="n">behavior_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.visualize_results-1508"><a href="#Task.visualize_results-1508"><span class="linenos">1508</span></a>                <span class="n">behavior_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inverse_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Task.visualize_results-1509"><a href="#Task.visualize_results-1509"><span class="linenos">1509</span></a>            <span class="n">label_ind</span> <span class="o">=</span> <span class="n">inverse_dict</span><span class="p">[</span><span class="n">behavior_name</span><span class="p">]</span>
</span><span id="Task.visualize_results-1510"><a href="#Task.visualize_results-1510"><span class="linenos">1510</span></a>            <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">}</span>
</span><span id="Task.visualize_results-1511"><a href="#Task.visualize_results-1511"><span class="linenos">1511</span></a>        <span class="n">label_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">labels</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
</span><span id="Task.visualize_results-1512"><a href="#Task.visualize_results-1512"><span class="linenos">1512</span></a>        <span class="k">if</span> <span class="n">search_classes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.visualize_results-1513"><a href="#Task.visualize_results-1513"><span class="linenos">1513</span></a>            <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Task.visualize_results-1514"><a href="#Task.visualize_results-1514"><span class="linenos">1514</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task.visualize_results-1515"><a href="#Task.visualize_results-1515"><span class="linenos">1515</span></a>            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Task.visualize_results-1516"><a href="#Task.visualize_results-1516"><span class="linenos">1516</span></a>        <span class="n">classes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Task.visualize_results-1517"><a href="#Task.visualize_results-1517"><span class="linenos">1517</span></a>        <span class="k">if</span> <span class="n">whole_video</span><span class="p">:</span>
</span><span id="Task.visualize_results-1518"><a href="#Task.visualize_results-1518"><span class="linenos">1518</span></a>            <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_full_length_prediction</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="Task.visualize_results-1519"><a href="#Task.visualize_results-1519"><span class="linenos">1519</span></a>            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">predicted</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="Task.visualize_results-1520"><a href="#Task.visualize_results-1520"><span class="linenos">1520</span></a>        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Task.visualize_results-1521"><a href="#Task.visualize_results-1521"><span class="linenos">1521</span></a>        <span class="k">if</span> <span class="n">whole_video</span><span class="p">:</span>
</span><span id="Task.visualize_results-1522"><a href="#Task.visualize_results-1522"><span class="linenos">1522</span></a>            <span class="n">max_iter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
</span><span id="Task.visualize_results-1523"><a href="#Task.visualize_results-1523"><span class="linenos">1523</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task.visualize_results-1524"><a href="#Task.visualize_results-1524"><span class="linenos">1524</span></a>            <span class="n">max_iter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
</span><span id="Task.visualize_results-1525"><a href="#Task.visualize_results-1525"><span class="linenos">1525</span></a>        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_classes</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
</span><span id="Task.visualize_results-1526"><a href="#Task.visualize_results-1526"><span class="linenos">1526</span></a>            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Task.visualize_results-1527"><a href="#Task.visualize_results-1527"><span class="linenos">1527</span></a>            <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="n">max_iter</span><span class="p">:</span>
</span><span id="Task.visualize_results-1528"><a href="#Task.visualize_results-1528"><span class="linenos">1528</span></a>                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="Task.visualize_results-1529"><a href="#Task.visualize_results-1529"><span class="linenos">1529</span></a>                    <span class="s2">&quot;Plotting is taking too many iterations; you should probably make some of the parameters less restrictive&quot;</span>
</span><span id="Task.visualize_results-1530"><a href="#Task.visualize_results-1530"><span class="linenos">1530</span></a>                <span class="p">)</span>
</span><span id="Task.visualize_results-1531"><a href="#Task.visualize_results-1531"><span class="linenos">1531</span></a>            <span class="k">if</span> <span class="n">whole_video</span><span class="p">:</span>
</span><span id="Task.visualize_results-1532"><a href="#Task.visualize_results-1532"><span class="linenos">1532</span></a>                <span class="n">i</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Task.visualize_results-1533"><a href="#Task.visualize_results-1533"><span class="linenos">1533</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="n">predicted</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
</span><span id="Task.visualize_results-1534"><a href="#Task.visualize_results-1534"><span class="linenos">1534</span></a>                <span class="n">keys_i</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">prediction</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="Task.visualize_results-1535"><a href="#Task.visualize_results-1535"><span class="linenos">1535</span></a>                <span class="n">j</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys_i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Task.visualize_results-1536"><a href="#Task.visualize_results-1536"><span class="linenos">1536</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="n">keys_i</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
</span><span id="Task.visualize_results-1537"><a href="#Task.visualize_results-1537"><span class="linenos">1537</span></a>                <span class="n">key1</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="Task.visualize_results-1538"><a href="#Task.visualize_results-1538"><span class="linenos">1538</span></a>                <span class="n">key2</span> <span class="o">=</span> <span class="n">keys_i</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="Task.visualize_results-1539"><a href="#Task.visualize_results-1539"><span class="linenos">1539</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Task.visualize_results-1540"><a href="#Task.visualize_results-1540"><span class="linenos">1540</span></a>                <span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="Task.visualize_results-1541"><a href="#Task.visualize_results-1541"><span class="linenos">1541</span></a>                <span class="n">i</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Task.visualize_results-1542"><a href="#Task.visualize_results-1542"><span class="linenos">1542</span></a>                <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
</span><span id="Task.visualize_results-1543"><a href="#Task.visualize_results-1543"><span class="linenos">1543</span></a>                    <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
</span><span id="Task.visualize_results-1544"><a href="#Task.visualize_results-1544"><span class="linenos">1544</span></a>                        <span class="k">break</span>
</span><span id="Task.visualize_results-1545"><a href="#Task.visualize_results-1545"><span class="linenos">1545</span></a>                <span class="nb">input</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Task.visualize_results-1546"><a href="#Task.visualize_results-1546"><span class="linenos">1546</span></a>                <span class="n">prediction</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_prediction</span><span class="p">(</span>
</span><span id="Task.visualize_results-1547"><a href="#Task.visualize_results-1547"><span class="linenos">1547</span></a>                    <span class="nb">input</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tag&quot;</span><span class="p">),</span> <span class="n">augment_n</span><span class="o">=</span><span class="mi">5</span>
</span><span id="Task.visualize_results-1548"><a href="#Task.visualize_results-1548"><span class="linenos">1548</span></a>                <span class="p">)</span>
</span><span id="Task.visualize_results-1549"><a href="#Task.visualize_results-1549"><span class="linenos">1549</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_predict_functions</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
</span><span id="Task.visualize_results-1550"><a href="#Task.visualize_results-1550"><span class="linenos">1550</span></a>                <span class="n">j</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Task.visualize_results-1551"><a href="#Task.visualize_results-1551"><span class="linenos">1551</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="Task.visualize_results-1552"><a href="#Task.visualize_results-1552"><span class="linenos">1552</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">exclusive</span><span class="p">:</span>
</span><span id="Task.visualize_results-1553"><a href="#Task.visualize_results-1553"><span class="linenos">1553</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="p">[</span><span class="n">label_ind</span><span class="p">]</span>
</span><span id="Task.visualize_results-1554"><a href="#Task.visualize_results-1554"><span class="linenos">1554</span></a>            <span class="k">if</span> <span class="n">smooth_interval_prediction</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Task.visualize_results-1555"><a href="#Task.visualize_results-1555"><span class="linenos">1555</span></a>                <span class="n">unsmoothed_prediction</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
</span><span id="Task.visualize_results-1556"><a href="#Task.visualize_results-1556"><span class="linenos">1556</span></a>                <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smooth</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">smooth_interval_prediction</span><span class="p">)</span>
</span><span id="Task.visualize_results-1557"><a href="#Task.visualize_results-1557"><span class="linenos">1557</span></a>                <span class="n">height</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="Task.visualize_results-1558"><a href="#Task.visualize_results-1558"><span class="linenos">1558</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Task.visualize_results-1559"><a href="#Task.visualize_results-1559"><span class="linenos">1559</span></a>                <span class="n">height</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="Task.visualize_results-1560"><a href="#Task.visualize_results-1560"><span class="linenos">1560</span></a>            <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task.visualize_results-1561"><a href="#Task.visualize_results-1561"><span class="linenos">1561</span></a>                <span class="n">labels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">label_keys</span>
</span><span id="Task.visualize_results-1562"><a href="#Task.visualize_results-1562"><span class="linenos">1562</span></a>            <span class="p">]</span>
</span><span id="Task.visualize_results-1563"><a href="#Task.visualize_results-1563"><span class="linenos">1563</span></a>            <span class="k">if</span> <span class="n">search_classes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.visualize_results-1564"><a href="#Task.visualize_results-1564"><span class="linenos">1564</span></a>                <span class="n">ok</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">x</span> <span class="ow">in</span> <span class="n">classes</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">search_classes</span><span class="p">])</span>
</span><span id="Task.visualize_results-1565"><a href="#Task.visualize_results-1565"><span class="linenos">1565</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="Task.visualize_results-1566"><a href="#Task.visualize_results-1566"><span class="linenos">1566</span></a>        <span class="n">color_list</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="n">lut</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span><span class="o">.</span><span class="n">colors</span>
</span><span id="Task.visualize_results-1567"><a href="#Task.visualize_results-1567"><span class="linenos">1567</span></a>
</span><span id="Task.visualize_results-1568"><a href="#Task.visualize_results-1568"><span class="linenos">1568</span></a>        <span class="k">def</span> <span class="nf">_plot_prediction</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">set_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="Task.visualize_results-1569"><a href="#Task.visualize_results-1569"><span class="linenos">1569</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">label_keys</span><span class="p">:</span>
</span><span id="Task.visualize_results-1570"><a href="#Task.visualize_results-1570"><span class="linenos">1570</span></a>                <span class="n">c_i</span> <span class="o">=</span> <span class="n">label_keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
</span><span id="Task.visualize_results-1571"><a href="#Task.visualize_results-1571"><span class="linenos">1571</span></a>                <span class="n">output</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique_consecutive</span><span class="p">(</span>
</span><span id="Task.visualize_results-1572"><a href="#Task.visualize_results-1572"><span class="linenos">1572</span></a>                    <span class="n">prediction</span> <span class="o">==</span> <span class="n">c</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span>
</span><span id="Task.visualize_results-1573"><a href="#Task.visualize_results-1573"><span class="linenos">1573</span></a>                <span class="p">)</span>
</span><span id="Task.visualize_results-1574"><a href="#Task.visualize_results-1574"><span class="linenos">1574</span></a>                <span class="n">long_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Task.visualize_results-1575"><a href="#Task.visualize_results-1575"><span class="linenos">1575</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">long_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Task.visualize_results-1576"><a href="#Task.visualize_results-1576"><span class="linenos">1576</span></a>                    <span class="k">continue</span>
</span><span id="Task.visualize_results-1577"><a href="#Task.visualize_results-1577"><span class="linenos">1577</span></a>                <span class="n">res_indices_start</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task.visualize_results-1578"><a href="#Task.visualize_results-1578"><span class="linenos">1578</span></a>                    <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="Task.visualize_results-1579"><a href="#Task.visualize_results-1579"><span class="linenos">1579</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_indices</span>
</span><span id="Task.visualize_results-1580"><a href="#Task.visualize_results-1580"><span class="linenos">1580</span></a>                <span class="p">]</span>
</span><span id="Task.visualize_results-1581"><a href="#Task.visualize_results-1581"><span class="linenos">1581</span></a>                <span class="n">res_indices_end</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task.visualize_results-1582"><a href="#Task.visualize_results-1582"><span class="linenos">1582</span></a>                    <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="Task.visualize_results-1583"><a href="#Task.visualize_results-1583"><span class="linenos">1583</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_indices</span>
</span><span id="Task.visualize_results-1584"><a href="#Task.visualize_results-1584"><span class="linenos">1584</span></a>                <span class="p">]</span>
</span><span id="Task.visualize_results-1585"><a href="#Task.visualize_results-1585"><span class="linenos">1585</span></a>                <span class="n">res_indices_len</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task.visualize_results-1586"><a href="#Task.visualize_results-1586"><span class="linenos">1586</span></a>                    <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="Task.visualize_results-1587"><a href="#Task.visualize_results-1587"><span class="linenos">1587</span></a>                    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">res_indices_start</span><span class="p">,</span> <span class="n">res_indices_end</span><span class="p">)</span>
</span><span id="Task.visualize_results-1588"><a href="#Task.visualize_results-1588"><span class="linenos">1588</span></a>                <span class="p">]</span>
</span><span id="Task.visualize_results-1589"><a href="#Task.visualize_results-1589"><span class="linenos">1589</span></a>                <span class="k">if</span> <span class="n">set_labels</span><span class="p">:</span>
</span><span id="Task.visualize_results-1590"><a href="#Task.visualize_results-1590"><span class="linenos">1590</span></a>                    <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span>
</span><span id="Task.visualize_results-1591"><a href="#Task.visualize_results-1591"><span class="linenos">1591</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Task.visualize_results-1592"><a href="#Task.visualize_results-1592"><span class="linenos">1592</span></a>                    <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Task.visualize_results-1593"><a href="#Task.visualize_results-1593"><span class="linenos">1593</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">broken_barh</span><span class="p">(</span>
</span><span id="Task.visualize_results-1594"><a href="#Task.visualize_results-1594"><span class="linenos">1594</span></a>                    <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">res_indices_start</span><span class="p">,</span> <span class="n">res_indices_len</span><span class="p">)),</span>
</span><span id="Task.visualize_results-1595"><a href="#Task.visualize_results-1595"><span class="linenos">1595</span></a>                    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="Task.visualize_results-1596"><a href="#Task.visualize_results-1596"><span class="linenos">1596</span></a>                    <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
</span><span id="Task.visualize_results-1597"><a href="#Task.visualize_results-1597"><span class="linenos">1597</span></a>                    <span class="n">facecolors</span><span class="o">=</span><span class="n">color_list</span><span class="p">[</span><span class="n">c_i</span><span class="p">],</span>
</span><span id="Task.visualize_results-1598"><a href="#Task.visualize_results-1598"><span class="linenos">1598</span></a>                <span class="p">)</span>
</span><span id="Task.visualize_results-1599"><a href="#Task.visualize_results-1599"><span class="linenos">1599</span></a>
</span><span id="Task.visualize_results-1600"><a href="#Task.visualize_results-1600"><span class="linenos">1600</span></a>        <span class="k">if</span> <span class="n">smooth_interval_prediction</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Task.visualize_results-1601"><a href="#Task.visualize_results-1601"><span class="linenos">1601</span></a>            <span class="n">_plot_prediction</span><span class="p">(</span><span class="n">unsmoothed_prediction</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="Task.visualize_results-1602"><a href="#Task.visualize_results-1602"><span class="linenos">1602</span></a>            <span class="n">_plot_prediction</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">set_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Task.visualize_results-1603"><a href="#Task.visualize_results-1603"><span class="linenos">1603</span></a>            <span class="n">gt_height</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="Task.visualize_results-1604"><a href="#Task.visualize_results-1604"><span class="linenos">1604</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task.visualize_results-1605"><a href="#Task.visualize_results-1605"><span class="linenos">1605</span></a>            <span class="n">_plot_prediction</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="Task.visualize_results-1606"><a href="#Task.visualize_results-1606"><span class="linenos">1606</span></a>            <span class="n">gt_height</span> <span class="o">=</span> <span class="mf">1.5</span>
</span><span id="Task.visualize_results-1607"><a href="#Task.visualize_results-1607"><span class="linenos">1607</span></a>        <span class="k">if</span> <span class="n">ground_truth</span><span class="p">:</span>
</span><span id="Task.visualize_results-1608"><a href="#Task.visualize_results-1608"><span class="linenos">1608</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">whole_video</span><span class="p">:</span>
</span><span id="Task.visualize_results-1609"><a href="#Task.visualize_results-1609"><span class="linenos">1609</span></a>                <span class="n">gt</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Task.visualize_results-1610"><a href="#Task.visualize_results-1610"><span class="linenos">1610</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Task.visualize_results-1611"><a href="#Task.visualize_results-1611"><span class="linenos">1611</span></a>                <span class="n">gt</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">generate_full_length_gt</span><span class="p">()[</span><span class="n">key1</span><span class="p">][</span><span class="n">key2</span><span class="p">]</span>
</span><span id="Task.visualize_results-1612"><a href="#Task.visualize_results-1612"><span class="linenos">1612</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">label_keys</span><span class="p">:</span>
</span><span id="Task.visualize_results-1613"><a href="#Task.visualize_results-1613"><span class="linenos">1613</span></a>                <span class="n">c_i</span> <span class="o">=</span> <span class="n">label_keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
</span><span id="Task.visualize_results-1614"><a href="#Task.visualize_results-1614"><span class="linenos">1614</span></a>                <span class="k">if</span> <span class="n">labels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
</span><span id="Task.visualize_results-1615"><a href="#Task.visualize_results-1615"><span class="linenos">1615</span></a>                    <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Task.visualize_results-1616"><a href="#Task.visualize_results-1616"><span class="linenos">1616</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Task.visualize_results-1617"><a href="#Task.visualize_results-1617"><span class="linenos">1617</span></a>                    <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span>
</span><span id="Task.visualize_results-1618"><a href="#Task.visualize_results-1618"><span class="linenos">1618</span></a>                <span class="n">output</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique_consecutive</span><span class="p">(</span>
</span><span id="Task.visualize_results-1619"><a href="#Task.visualize_results-1619"><span class="linenos">1619</span></a>                    <span class="n">gt</span> <span class="o">==</span> <span class="n">c</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span>
</span><span id="Task.visualize_results-1620"><a href="#Task.visualize_results-1620"><span class="linenos">1620</span></a>                <span class="p">)</span>
</span><span id="Task.visualize_results-1621"><a href="#Task.visualize_results-1621"><span class="linenos">1621</span></a>                <span class="n">long_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">output</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Task.visualize_results-1622"><a href="#Task.visualize_results-1622"><span class="linenos">1622</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">long_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Task.visualize_results-1623"><a href="#Task.visualize_results-1623"><span class="linenos">1623</span></a>                    <span class="k">continue</span>
</span><span id="Task.visualize_results-1624"><a href="#Task.visualize_results-1624"><span class="linenos">1624</span></a>                <span class="n">res_indices_start</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task.visualize_results-1625"><a href="#Task.visualize_results-1625"><span class="linenos">1625</span></a>                    <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="Task.visualize_results-1626"><a href="#Task.visualize_results-1626"><span class="linenos">1626</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_indices</span>
</span><span id="Task.visualize_results-1627"><a href="#Task.visualize_results-1627"><span class="linenos">1627</span></a>                <span class="p">]</span>
</span><span id="Task.visualize_results-1628"><a href="#Task.visualize_results-1628"><span class="linenos">1628</span></a>                <span class="n">res_indices_end</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task.visualize_results-1629"><a href="#Task.visualize_results-1629"><span class="linenos">1629</span></a>                    <span class="p">(</span><span class="n">indices</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="Task.visualize_results-1630"><a href="#Task.visualize_results-1630"><span class="linenos">1630</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">long_indices</span>
</span><span id="Task.visualize_results-1631"><a href="#Task.visualize_results-1631"><span class="linenos">1631</span></a>                <span class="p">]</span>
</span><span id="Task.visualize_results-1632"><a href="#Task.visualize_results-1632"><span class="linenos">1632</span></a>                <span class="n">res_indices_len</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Task.visualize_results-1633"><a href="#Task.visualize_results-1633"><span class="linenos">1633</span></a>                    <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="Task.visualize_results-1634"><a href="#Task.visualize_results-1634"><span class="linenos">1634</span></a>                    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">res_indices_start</span><span class="p">,</span> <span class="n">res_indices_end</span><span class="p">)</span>
</span><span id="Task.visualize_results-1635"><a href="#Task.visualize_results-1635"><span class="linenos">1635</span></a>                <span class="p">]</span>
</span><span id="Task.visualize_results-1636"><a href="#Task.visualize_results-1636"><span class="linenos">1636</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">broken_barh</span><span class="p">(</span>
</span><span id="Task.visualize_results-1637"><a href="#Task.visualize_results-1637"><span class="linenos">1637</span></a>                    <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">res_indices_start</span><span class="p">,</span> <span class="n">res_indices_len</span><span class="p">)),</span>
</span><span id="Task.visualize_results-1638"><a href="#Task.visualize_results-1638"><span class="linenos">1638</span></a>                    <span class="p">(</span><span class="n">gt_height</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="Task.visualize_results-1639"><a href="#Task.visualize_results-1639"><span class="linenos">1639</span></a>                    <span class="n">facecolors</span><span class="o">=</span><span class="n">color_list</span><span class="p">[</span><span class="n">c_i</span><span class="p">]</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&quot;unknown&quot;</span> <span class="k">else</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span>
</span><span id="Task.visualize_results-1640"><a href="#Task.visualize_results-1640"><span class="linenos">1640</span></a>                    <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
</span><span id="Task.visualize_results-1641"><a href="#Task.visualize_results-1641"><span class="linenos">1641</span></a>                <span class="p">)</span>
</span><span id="Task.visualize_results-1642"><a href="#Task.visualize_results-1642"><span class="linenos">1642</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">ground_truth</span><span class="p">:</span>
</span><span id="Task.visualize_results-1643"><a href="#Task.visualize_results-1643"><span class="linenos">1643</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Task.visualize_results-1644"><a href="#Task.visualize_results-1644"><span class="linenos">1644</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Task.visualize_results-1645"><a href="#Task.visualize_results-1645"><span class="linenos">1645</span></a>            <span class="k">if</span> <span class="n">smooth_interval_prediction</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Task.visualize_results-1646"><a href="#Task.visualize_results-1646"><span class="linenos">1646</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">])</span>
</span><span id="Task.visualize_results-1647"><a href="#Task.visualize_results-1647"><span class="linenos">1647</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span> <span class="s2">&quot;smoothed&quot;</span><span class="p">,</span> <span class="s2">&quot;ground truth&quot;</span><span class="p">])</span>
</span><span id="Task.visualize_results-1648"><a href="#Task.visualize_results-1648"><span class="linenos">1648</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Task.visualize_results-1649"><a href="#Task.visualize_results-1649"><span class="linenos">1649</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span><span id="Task.visualize_results-1650"><a href="#Task.visualize_results-1650"><span class="linenos">1650</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span> <span class="s2">&quot;ground truth&quot;</span><span class="p">])</span>
</span><span id="Task.visualize_results-1651"><a href="#Task.visualize_results-1651"><span class="linenos">1651</span></a>        <span class="k">if</span> <span class="n">add_legend</span><span class="p">:</span>
</span><span id="Task.visualize_results-1652"><a href="#Task.visualize_results-1652"><span class="linenos">1652</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
</span><span id="Task.visualize_results-1653"><a href="#Task.visualize_results-1653"><span class="linenos">1653</span></a>        <span class="k">if</span> <span class="n">hide_axes</span><span class="p">:</span>
</span><span id="Task.visualize_results-1654"><a href="#Task.visualize_results-1654"><span class="linenos">1654</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</span><span id="Task.visualize_results-1655"><a href="#Task.visualize_results-1655"><span class="linenos">1655</span></a>        <span class="k">if</span> <span class="n">save_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.visualize_results-1656"><a href="#Task.visualize_results-1656"><span class="linenos">1656</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="n">transparent</span><span class="p">)</span>
</span><span id="Task.visualize_results-1657"><a href="#Task.visualize_results-1657"><span class="linenos">1657</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Visualize random predictions</p>

<h2 id="parameters">Parameters</h2>

<p>save_path : str, optional
    the path where the plot will be saved
add_legend : bool, default True
    if <code>True</code>, legend will be added to the plot
ground_truth : bool, default True
    if <code>True</code>, ground truth will be added to the plot
colormap : str, default 'Accent'
    the <code>matplotlib</code> colormap to use
hide_axes : bool, default True
    if <code>True</code>, the axes will be hidden on the plot
min_classes : int, default 1
    the minimum number of classes in a displayed interval
width : float, default 10
    the width of the plot
whole_video : bool, default False
    if <code>True</code>, whole videos are plotted instead of segments
transparent : bool, default False
    if <code>True</code>, the background on the plot is transparent
dataset : BehaviorDataset | DataLoader | str | None, optional
    the dataset to make the prediction for (if not provided, the validation dataset is used)
drop_classes : set, optional
    a set of class names to not be displayed
search_classes : set, optional
    if given, only intervals where at least one of the classes is in ground truth will be shown</p>
</div>


                            </div>
                            <div id="Task.set_ssl_transformations" class="classattr">
                                        <input id="Task.set_ssl_transformations-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_ssl_transformations</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">ssl_transformations</span></span>)</span>

                <label class="view-source-button" for="Task.set_ssl_transformations-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.set_ssl_transformations"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.set_ssl_transformations-1659"><a href="#Task.set_ssl_transformations-1659"><span class="linenos">1659</span></a>    <span class="k">def</span> <span class="nf">set_ssl_transformations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ssl_transformations</span><span class="p">):</span>
</span><span id="Task.set_ssl_transformations-1660"><a href="#Task.set_ssl_transformations-1660"><span class="linenos">1660</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">set_ssl_transformations</span><span class="p">(</span><span class="n">ssl_transformations</span><span class="p">)</span>
</span><span id="Task.set_ssl_transformations-1661"><a href="#Task.set_ssl_transformations-1661"><span class="linenos">1661</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.set_ssl_transformations-1662"><a href="#Task.set_ssl_transformations-1662"><span class="linenos">1662</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">set_ssl_transformations</span><span class="p">(</span><span class="n">ssl_transformations</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="Task.set_ssl_losses" class="classattr">
                                        <input id="Task.set_ssl_losses-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_ssl_losses</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">ssl_losses</span><span class="p">:</span> <span class="nb">list</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Task.set_ssl_losses-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.set_ssl_losses"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.set_ssl_losses-1664"><a href="#Task.set_ssl_losses-1664"><span class="linenos">1664</span></a>    <span class="k">def</span> <span class="nf">set_ssl_losses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ssl_losses</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.set_ssl_losses-1665"><a href="#Task.set_ssl_losses-1665"><span class="linenos">1665</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.set_ssl_losses-1666"><a href="#Task.set_ssl_losses-1666"><span class="linenos">1666</span></a><span class="sd">        Set SSL losses</span>
</span><span id="Task.set_ssl_losses-1667"><a href="#Task.set_ssl_losses-1667"><span class="linenos">1667</span></a>
</span><span id="Task.set_ssl_losses-1668"><a href="#Task.set_ssl_losses-1668"><span class="linenos">1668</span></a><span class="sd">        Parameters</span>
</span><span id="Task.set_ssl_losses-1669"><a href="#Task.set_ssl_losses-1669"><span class="linenos">1669</span></a><span class="sd">        ----------</span>
</span><span id="Task.set_ssl_losses-1670"><a href="#Task.set_ssl_losses-1670"><span class="linenos">1670</span></a><span class="sd">        ssl_losses : list</span>
</span><span id="Task.set_ssl_losses-1671"><a href="#Task.set_ssl_losses-1671"><span class="linenos">1671</span></a><span class="sd">            a list of callable SSL losses</span>
</span><span id="Task.set_ssl_losses-1672"><a href="#Task.set_ssl_losses-1672"><span class="linenos">1672</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.set_ssl_losses-1673"><a href="#Task.set_ssl_losses-1673"><span class="linenos">1673</span></a>
</span><span id="Task.set_ssl_losses-1674"><a href="#Task.set_ssl_losses-1674"><span class="linenos">1674</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ssl_losses</span> <span class="o">=</span> <span class="n">ssl_losses</span>
</span></pre></div>


            <div class="docstring"><p>Set SSL losses</p>

<h2 id="parameters">Parameters</h2>

<p>ssl_losses : list
    a list of callable SSL losses</p>
</div>


                            </div>
                            <div id="Task.set_log" class="classattr">
                                        <input id="Task.set_log-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_log</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">log</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Task.set_log-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.set_log"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.set_log-1676"><a href="#Task.set_log-1676"><span class="linenos">1676</span></a>    <span class="k">def</span> <span class="nf">set_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.set_log-1677"><a href="#Task.set_log-1677"><span class="linenos">1677</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.set_log-1678"><a href="#Task.set_log-1678"><span class="linenos">1678</span></a><span class="sd">        Set the log file</span>
</span><span id="Task.set_log-1679"><a href="#Task.set_log-1679"><span class="linenos">1679</span></a>
</span><span id="Task.set_log-1680"><a href="#Task.set_log-1680"><span class="linenos">1680</span></a><span class="sd">        Parameters</span>
</span><span id="Task.set_log-1681"><a href="#Task.set_log-1681"><span class="linenos">1681</span></a><span class="sd">        ----------</span>
</span><span id="Task.set_log-1682"><a href="#Task.set_log-1682"><span class="linenos">1682</span></a><span class="sd">        log: str</span>
</span><span id="Task.set_log-1683"><a href="#Task.set_log-1683"><span class="linenos">1683</span></a><span class="sd">            the mew log file path</span>
</span><span id="Task.set_log-1684"><a href="#Task.set_log-1684"><span class="linenos">1684</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.set_log-1685"><a href="#Task.set_log-1685"><span class="linenos">1685</span></a>
</span><span id="Task.set_log-1686"><a href="#Task.set_log-1686"><span class="linenos">1686</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="n">log</span>
</span></pre></div>


            <div class="docstring"><p>Set the log file</p>

<h2 id="parameters">Parameters</h2>

<p>log: str
    the mew log file path</p>
</div>


                            </div>
                            <div id="Task.set_keep_target_none" class="classattr">
                                        <input id="Task.set_keep_target_none-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_keep_target_none</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">keep_target_none</span><span class="p">:</span> <span class="n">List</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Task.set_keep_target_none-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.set_keep_target_none"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.set_keep_target_none-1688"><a href="#Task.set_keep_target_none-1688"><span class="linenos">1688</span></a>    <span class="k">def</span> <span class="nf">set_keep_target_none</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep_target_none</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.set_keep_target_none-1689"><a href="#Task.set_keep_target_none-1689"><span class="linenos">1689</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.set_keep_target_none-1690"><a href="#Task.set_keep_target_none-1690"><span class="linenos">1690</span></a><span class="sd">        Set the keep_target_none parameter of the transformer</span>
</span><span id="Task.set_keep_target_none-1691"><a href="#Task.set_keep_target_none-1691"><span class="linenos">1691</span></a>
</span><span id="Task.set_keep_target_none-1692"><a href="#Task.set_keep_target_none-1692"><span class="linenos">1692</span></a><span class="sd">        Parameters</span>
</span><span id="Task.set_keep_target_none-1693"><a href="#Task.set_keep_target_none-1693"><span class="linenos">1693</span></a><span class="sd">        ----------</span>
</span><span id="Task.set_keep_target_none-1694"><a href="#Task.set_keep_target_none-1694"><span class="linenos">1694</span></a><span class="sd">        keep_target_none : list</span>
</span><span id="Task.set_keep_target_none-1695"><a href="#Task.set_keep_target_none-1695"><span class="linenos">1695</span></a><span class="sd">            a list of bool values</span>
</span><span id="Task.set_keep_target_none-1696"><a href="#Task.set_keep_target_none-1696"><span class="linenos">1696</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.set_keep_target_none-1697"><a href="#Task.set_keep_target_none-1697"><span class="linenos">1697</span></a>
</span><span id="Task.set_keep_target_none-1698"><a href="#Task.set_keep_target_none-1698"><span class="linenos">1698</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">keep_target_none</span> <span class="o">=</span> <span class="n">keep_target_none</span>
</span></pre></div>


            <div class="docstring"><p>Set the keep_target_none parameter of the transformer</p>

<h2 id="parameters">Parameters</h2>

<p>keep_target_none : list
    a list of bool values</p>
</div>


                            </div>
                            <div id="Task.set_generate_ssl_input" class="classattr">
                                        <input id="Task.set_generate_ssl_input-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_generate_ssl_input</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">generate_ssl_input</span><span class="p">:</span> <span class="nb">list</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Task.set_generate_ssl_input-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.set_generate_ssl_input"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.set_generate_ssl_input-1700"><a href="#Task.set_generate_ssl_input-1700"><span class="linenos">1700</span></a>    <span class="k">def</span> <span class="nf">set_generate_ssl_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generate_ssl_input</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.set_generate_ssl_input-1701"><a href="#Task.set_generate_ssl_input-1701"><span class="linenos">1701</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.set_generate_ssl_input-1702"><a href="#Task.set_generate_ssl_input-1702"><span class="linenos">1702</span></a><span class="sd">        Set the generate_ssl_input parameter of the transformer</span>
</span><span id="Task.set_generate_ssl_input-1703"><a href="#Task.set_generate_ssl_input-1703"><span class="linenos">1703</span></a>
</span><span id="Task.set_generate_ssl_input-1704"><a href="#Task.set_generate_ssl_input-1704"><span class="linenos">1704</span></a><span class="sd">        Parameters</span>
</span><span id="Task.set_generate_ssl_input-1705"><a href="#Task.set_generate_ssl_input-1705"><span class="linenos">1705</span></a><span class="sd">        ----------</span>
</span><span id="Task.set_generate_ssl_input-1706"><a href="#Task.set_generate_ssl_input-1706"><span class="linenos">1706</span></a><span class="sd">        generate_ssl_input : list</span>
</span><span id="Task.set_generate_ssl_input-1707"><a href="#Task.set_generate_ssl_input-1707"><span class="linenos">1707</span></a><span class="sd">            a list of bool values</span>
</span><span id="Task.set_generate_ssl_input-1708"><a href="#Task.set_generate_ssl_input-1708"><span class="linenos">1708</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.set_generate_ssl_input-1709"><a href="#Task.set_generate_ssl_input-1709"><span class="linenos">1709</span></a>
</span><span id="Task.set_generate_ssl_input-1710"><a href="#Task.set_generate_ssl_input-1710"><span class="linenos">1710</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">generate_ssl_input</span> <span class="o">=</span> <span class="n">generate_ssl_input</span>
</span></pre></div>


            <div class="docstring"><p>Set the generate_ssl_input parameter of the transformer</p>

<h2 id="parameters">Parameters</h2>

<p>generate_ssl_input : list
    a list of bool values</p>
</div>


                            </div>
                            <div id="Task.set_model" class="classattr">
                                        <input id="Task.set_model-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_model</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">model</span><span class="p">:</span> <span class="n">dlc2action</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">base_model</span><span class="o">.</span><span class="n">Model</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Task.set_model-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.set_model"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.set_model-1712"><a href="#Task.set_model-1712"><span class="linenos">1712</span></a>    <span class="k">def</span> <span class="nf">set_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.set_model-1713"><a href="#Task.set_model-1713"><span class="linenos">1713</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.set_model-1714"><a href="#Task.set_model-1714"><span class="linenos">1714</span></a><span class="sd">        Set a new model</span>
</span><span id="Task.set_model-1715"><a href="#Task.set_model-1715"><span class="linenos">1715</span></a>
</span><span id="Task.set_model-1716"><a href="#Task.set_model-1716"><span class="linenos">1716</span></a><span class="sd">        Parameters</span>
</span><span id="Task.set_model-1717"><a href="#Task.set_model-1717"><span class="linenos">1717</span></a><span class="sd">        ----------</span>
</span><span id="Task.set_model-1718"><a href="#Task.set_model-1718"><span class="linenos">1718</span></a><span class="sd">        model: Model</span>
</span><span id="Task.set_model-1719"><a href="#Task.set_model-1719"><span class="linenos">1719</span></a><span class="sd">            the new model</span>
</span><span id="Task.set_model-1720"><a href="#Task.set_model-1720"><span class="linenos">1720</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.set_model-1721"><a href="#Task.set_model-1721"><span class="linenos">1721</span></a>
</span><span id="Task.set_model-1722"><a href="#Task.set_model-1722"><span class="linenos">1722</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Task.set_model-1723"><a href="#Task.set_model-1723"><span class="linenos">1723</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="Task.set_model-1724"><a href="#Task.set_model-1724"><span class="linenos">1724</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_class</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
</span><span id="Task.set_model-1725"><a href="#Task.set_model-1725"><span class="linenos">1725</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">process_labels</span><span class="p">:</span>
</span><span id="Task.set_model-1726"><a href="#Task.set_model-1726"><span class="linenos">1726</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_behaviors</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</span></pre></div>


            <div class="docstring"><p>Set a new model</p>

<h2 id="parameters">Parameters</h2>

<p>model: Model
    the new model</p>
</div>


                            </div>
                            <div id="Task.set_dataloaders" class="classattr">
                                        <input id="Task.set_dataloaders-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_dataloaders</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">train_dataloader</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataloader</span><span class="o">.</span><span class="n">DataLoader</span>,</span><span class="param">	<span class="n">val_dataloader</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataloader</span><span class="o">.</span><span class="n">DataLoader</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">test_dataloader</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataloader</span><span class="o">.</span><span class="n">DataLoader</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Task.set_dataloaders-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.set_dataloaders"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.set_dataloaders-1728"><a href="#Task.set_dataloaders-1728"><span class="linenos">1728</span></a>    <span class="k">def</span> <span class="nf">set_dataloaders</span><span class="p">(</span>
</span><span id="Task.set_dataloaders-1729"><a href="#Task.set_dataloaders-1729"><span class="linenos">1729</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Task.set_dataloaders-1730"><a href="#Task.set_dataloaders-1730"><span class="linenos">1730</span></a>        <span class="n">train_dataloader</span><span class="p">:</span> <span class="n">DataLoader</span><span class="p">,</span>
</span><span id="Task.set_dataloaders-1731"><a href="#Task.set_dataloaders-1731"><span class="linenos">1731</span></a>        <span class="n">val_dataloader</span><span class="p">:</span> <span class="n">DataLoader</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.set_dataloaders-1732"><a href="#Task.set_dataloaders-1732"><span class="linenos">1732</span></a>        <span class="n">test_dataloader</span><span class="p">:</span> <span class="n">DataLoader</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.set_dataloaders-1733"><a href="#Task.set_dataloaders-1733"><span class="linenos">1733</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.set_dataloaders-1734"><a href="#Task.set_dataloaders-1734"><span class="linenos">1734</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.set_dataloaders-1735"><a href="#Task.set_dataloaders-1735"><span class="linenos">1735</span></a><span class="sd">        Set new dataloaders</span>
</span><span id="Task.set_dataloaders-1736"><a href="#Task.set_dataloaders-1736"><span class="linenos">1736</span></a>
</span><span id="Task.set_dataloaders-1737"><a href="#Task.set_dataloaders-1737"><span class="linenos">1737</span></a><span class="sd">        Parameters</span>
</span><span id="Task.set_dataloaders-1738"><a href="#Task.set_dataloaders-1738"><span class="linenos">1738</span></a><span class="sd">        ----------</span>
</span><span id="Task.set_dataloaders-1739"><a href="#Task.set_dataloaders-1739"><span class="linenos">1739</span></a><span class="sd">        train_dataloader: torch.utils.data.DataLoader</span>
</span><span id="Task.set_dataloaders-1740"><a href="#Task.set_dataloaders-1740"><span class="linenos">1740</span></a><span class="sd">            the new train dataloader</span>
</span><span id="Task.set_dataloaders-1741"><a href="#Task.set_dataloaders-1741"><span class="linenos">1741</span></a><span class="sd">        val_dataloader : torch.utils.data.DataLoader</span>
</span><span id="Task.set_dataloaders-1742"><a href="#Task.set_dataloaders-1742"><span class="linenos">1742</span></a><span class="sd">            the new validation dataloader</span>
</span><span id="Task.set_dataloaders-1743"><a href="#Task.set_dataloaders-1743"><span class="linenos">1743</span></a><span class="sd">        test_dataloader : torch.utils.data.DataLoader</span>
</span><span id="Task.set_dataloaders-1744"><a href="#Task.set_dataloaders-1744"><span class="linenos">1744</span></a><span class="sd">            the new test dataloader</span>
</span><span id="Task.set_dataloaders-1745"><a href="#Task.set_dataloaders-1745"><span class="linenos">1745</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.set_dataloaders-1746"><a href="#Task.set_dataloaders-1746"><span class="linenos">1746</span></a>
</span><span id="Task.set_dataloaders-1747"><a href="#Task.set_dataloaders-1747"><span class="linenos">1747</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">train_dataloader</span>
</span><span id="Task.set_dataloaders-1748"><a href="#Task.set_dataloaders-1748"><span class="linenos">1748</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span> <span class="o">=</span> <span class="n">val_dataloader</span>
</span><span id="Task.set_dataloaders-1749"><a href="#Task.set_dataloaders-1749"><span class="linenos">1749</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_dataloader</span> <span class="o">=</span> <span class="n">test_dataloader</span>
</span></pre></div>


            <div class="docstring"><p>Set new dataloaders</p>

<h2 id="parameters">Parameters</h2>

<p>train_dataloader: torch.utils.data.DataLoader
    the new train dataloader
val_dataloader : torch.utils.data.DataLoader
    the new validation dataloader
test_dataloader : torch.utils.data.DataLoader
    the new test dataloader</p>
</div>


                            </div>
                            <div id="Task.set_loss" class="classattr">
                                        <input id="Task.set_loss-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_loss</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">loss</span><span class="p">:</span> <span class="n">Callable</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Task.set_loss-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.set_loss"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.set_loss-1751"><a href="#Task.set_loss-1751"><span class="linenos">1751</span></a>    <span class="k">def</span> <span class="nf">set_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.set_loss-1752"><a href="#Task.set_loss-1752"><span class="linenos">1752</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.set_loss-1753"><a href="#Task.set_loss-1753"><span class="linenos">1753</span></a><span class="sd">        Set new loss function</span>
</span><span id="Task.set_loss-1754"><a href="#Task.set_loss-1754"><span class="linenos">1754</span></a>
</span><span id="Task.set_loss-1755"><a href="#Task.set_loss-1755"><span class="linenos">1755</span></a><span class="sd">        Parameters</span>
</span><span id="Task.set_loss-1756"><a href="#Task.set_loss-1756"><span class="linenos">1756</span></a><span class="sd">        ----------</span>
</span><span id="Task.set_loss-1757"><a href="#Task.set_loss-1757"><span class="linenos">1757</span></a><span class="sd">        loss: callable</span>
</span><span id="Task.set_loss-1758"><a href="#Task.set_loss-1758"><span class="linenos">1758</span></a><span class="sd">            the new loss function</span>
</span><span id="Task.set_loss-1759"><a href="#Task.set_loss-1759"><span class="linenos">1759</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.set_loss-1760"><a href="#Task.set_loss-1760"><span class="linenos">1760</span></a>
</span><span id="Task.set_loss-1761"><a href="#Task.set_loss-1761"><span class="linenos">1761</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span>
</span></pre></div>


            <div class="docstring"><p>Set new loss function</p>

<h2 id="parameters">Parameters</h2>

<p>loss: callable
    the new loss function</p>
</div>


                            </div>
                            <div id="Task.set_metrics" class="classattr">
                                        <input id="Task.set_metrics-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_metrics</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">metrics</span><span class="p">:</span> <span class="nb">dict</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Task.set_metrics-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.set_metrics"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.set_metrics-1763"><a href="#Task.set_metrics-1763"><span class="linenos">1763</span></a>    <span class="k">def</span> <span class="nf">set_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.set_metrics-1764"><a href="#Task.set_metrics-1764"><span class="linenos">1764</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.set_metrics-1765"><a href="#Task.set_metrics-1765"><span class="linenos">1765</span></a><span class="sd">        Set new metric</span>
</span><span id="Task.set_metrics-1766"><a href="#Task.set_metrics-1766"><span class="linenos">1766</span></a>
</span><span id="Task.set_metrics-1767"><a href="#Task.set_metrics-1767"><span class="linenos">1767</span></a><span class="sd">        Parameters</span>
</span><span id="Task.set_metrics-1768"><a href="#Task.set_metrics-1768"><span class="linenos">1768</span></a><span class="sd">        ----------</span>
</span><span id="Task.set_metrics-1769"><a href="#Task.set_metrics-1769"><span class="linenos">1769</span></a><span class="sd">        metrics : dict</span>
</span><span id="Task.set_metrics-1770"><a href="#Task.set_metrics-1770"><span class="linenos">1770</span></a><span class="sd">            the new metric dictionary</span>
</span><span id="Task.set_metrics-1771"><a href="#Task.set_metrics-1771"><span class="linenos">1771</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.set_metrics-1772"><a href="#Task.set_metrics-1772"><span class="linenos">1772</span></a>
</span><span id="Task.set_metrics-1773"><a href="#Task.set_metrics-1773"><span class="linenos">1773</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics</span>
</span></pre></div>


            <div class="docstring"><p>Set new metric</p>

<h2 id="parameters">Parameters</h2>

<p>metrics : dict
    the new metric dictionary</p>
</div>


                            </div>
                            <div id="Task.set_transformer" class="classattr">
                                        <input id="Task.set_transformer-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_transformer</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">transformer</span><span class="p">:</span> <span class="n">dlc2action</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">base_transformer</span><span class="o">.</span><span class="n">Transformer</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Task.set_transformer-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.set_transformer"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.set_transformer-1775"><a href="#Task.set_transformer-1775"><span class="linenos">1775</span></a>    <span class="k">def</span> <span class="nf">set_transformer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transformer</span><span class="p">:</span> <span class="n">Transformer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.set_transformer-1776"><a href="#Task.set_transformer-1776"><span class="linenos">1776</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.set_transformer-1777"><a href="#Task.set_transformer-1777"><span class="linenos">1777</span></a><span class="sd">        Set a new transformer</span>
</span><span id="Task.set_transformer-1778"><a href="#Task.set_transformer-1778"><span class="linenos">1778</span></a>
</span><span id="Task.set_transformer-1779"><a href="#Task.set_transformer-1779"><span class="linenos">1779</span></a><span class="sd">        Parameters</span>
</span><span id="Task.set_transformer-1780"><a href="#Task.set_transformer-1780"><span class="linenos">1780</span></a><span class="sd">        ----------</span>
</span><span id="Task.set_transformer-1781"><a href="#Task.set_transformer-1781"><span class="linenos">1781</span></a><span class="sd">        transformer: Transformer</span>
</span><span id="Task.set_transformer-1782"><a href="#Task.set_transformer-1782"><span class="linenos">1782</span></a><span class="sd">            the new transformer</span>
</span><span id="Task.set_transformer-1783"><a href="#Task.set_transformer-1783"><span class="linenos">1783</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.set_transformer-1784"><a href="#Task.set_transformer-1784"><span class="linenos">1784</span></a>
</span><span id="Task.set_transformer-1785"><a href="#Task.set_transformer-1785"><span class="linenos">1785</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="o">=</span> <span class="n">transformer</span>
</span></pre></div>


            <div class="docstring"><p>Set a new transformer</p>

<h2 id="parameters">Parameters</h2>

<p>transformer: Transformer
    the new transformer</p>
</div>


                            </div>
                            <div id="Task.set_predict_functions" class="classattr">
                                        <input id="Task.set_predict_functions-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_predict_functions</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">primary_predict_function</span><span class="p">:</span> <span class="n">Callable</span>,</span><span class="param">	<span class="n">predict_function</span><span class="p">:</span> <span class="n">Callable</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Task.set_predict_functions-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.set_predict_functions"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.set_predict_functions-1787"><a href="#Task.set_predict_functions-1787"><span class="linenos">1787</span></a>    <span class="k">def</span> <span class="nf">set_predict_functions</span><span class="p">(</span>
</span><span id="Task.set_predict_functions-1788"><a href="#Task.set_predict_functions-1788"><span class="linenos">1788</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">primary_predict_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">predict_function</span><span class="p">:</span> <span class="n">Callable</span>
</span><span id="Task.set_predict_functions-1789"><a href="#Task.set_predict_functions-1789"><span class="linenos">1789</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.set_predict_functions-1790"><a href="#Task.set_predict_functions-1790"><span class="linenos">1790</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.set_predict_functions-1791"><a href="#Task.set_predict_functions-1791"><span class="linenos">1791</span></a><span class="sd">        Set new predict functions</span>
</span><span id="Task.set_predict_functions-1792"><a href="#Task.set_predict_functions-1792"><span class="linenos">1792</span></a>
</span><span id="Task.set_predict_functions-1793"><a href="#Task.set_predict_functions-1793"><span class="linenos">1793</span></a><span class="sd">        Parameters</span>
</span><span id="Task.set_predict_functions-1794"><a href="#Task.set_predict_functions-1794"><span class="linenos">1794</span></a><span class="sd">        ----------</span>
</span><span id="Task.set_predict_functions-1795"><a href="#Task.set_predict_functions-1795"><span class="linenos">1795</span></a><span class="sd">        primary_predict_function : callable</span>
</span><span id="Task.set_predict_functions-1796"><a href="#Task.set_predict_functions-1796"><span class="linenos">1796</span></a><span class="sd">            the new primary predict function</span>
</span><span id="Task.set_predict_functions-1797"><a href="#Task.set_predict_functions-1797"><span class="linenos">1797</span></a><span class="sd">        predict_function : callable</span>
</span><span id="Task.set_predict_functions-1798"><a href="#Task.set_predict_functions-1798"><span class="linenos">1798</span></a><span class="sd">            the new predict function</span>
</span><span id="Task.set_predict_functions-1799"><a href="#Task.set_predict_functions-1799"><span class="linenos">1799</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.set_predict_functions-1800"><a href="#Task.set_predict_functions-1800"><span class="linenos">1800</span></a>
</span><span id="Task.set_predict_functions-1801"><a href="#Task.set_predict_functions-1801"><span class="linenos">1801</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">primary_predict_function</span> <span class="o">=</span> <span class="n">primary_predict_function</span>
</span><span id="Task.set_predict_functions-1802"><a href="#Task.set_predict_functions-1802"><span class="linenos">1802</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">predict_function</span> <span class="o">=</span> <span class="n">predict_function</span>
</span></pre></div>


            <div class="docstring"><p>Set new predict functions</p>

<h2 id="parameters">Parameters</h2>

<p>primary_predict_function : callable
    the new primary predict function
predict_function : callable
    the new predict function</p>
</div>


                            </div>
                            <div id="Task.count_classes" class="classattr">
                                        <input id="Task.count_classes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">count_classes</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">bouts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="n">Dict</span>:</span></span>

                <label class="view-source-button" for="Task.count_classes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.count_classes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.count_classes-1830"><a href="#Task.count_classes-1830"><span class="linenos">1830</span></a>    <span class="k">def</span> <span class="nf">count_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bouts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="Task.count_classes-1831"><a href="#Task.count_classes-1831"><span class="linenos">1831</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.count_classes-1832"><a href="#Task.count_classes-1832"><span class="linenos">1832</span></a><span class="sd">        Get a dictionary of class counts in different modes</span>
</span><span id="Task.count_classes-1833"><a href="#Task.count_classes-1833"><span class="linenos">1833</span></a>
</span><span id="Task.count_classes-1834"><a href="#Task.count_classes-1834"><span class="linenos">1834</span></a><span class="sd">        Parameters</span>
</span><span id="Task.count_classes-1835"><a href="#Task.count_classes-1835"><span class="linenos">1835</span></a><span class="sd">        ----------</span>
</span><span id="Task.count_classes-1836"><a href="#Task.count_classes-1836"><span class="linenos">1836</span></a><span class="sd">        bouts : bool, default False</span>
</span><span id="Task.count_classes-1837"><a href="#Task.count_classes-1837"><span class="linenos">1837</span></a><span class="sd">            if `True`, instead of frame counts segment counts are returned</span>
</span><span id="Task.count_classes-1838"><a href="#Task.count_classes-1838"><span class="linenos">1838</span></a>
</span><span id="Task.count_classes-1839"><a href="#Task.count_classes-1839"><span class="linenos">1839</span></a><span class="sd">        Returns</span>
</span><span id="Task.count_classes-1840"><a href="#Task.count_classes-1840"><span class="linenos">1840</span></a><span class="sd">        -------</span>
</span><span id="Task.count_classes-1841"><a href="#Task.count_classes-1841"><span class="linenos">1841</span></a><span class="sd">        class_counts : dict</span>
</span><span id="Task.count_classes-1842"><a href="#Task.count_classes-1842"><span class="linenos">1842</span></a><span class="sd">            a dictionary where first-level keys are &quot;train&quot;, &quot;val&quot; and &quot;test&quot;, second-level keys are</span>
</span><span id="Task.count_classes-1843"><a href="#Task.count_classes-1843"><span class="linenos">1843</span></a><span class="sd">            class names and values are class counts (in frames)</span>
</span><span id="Task.count_classes-1844"><a href="#Task.count_classes-1844"><span class="linenos">1844</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.count_classes-1845"><a href="#Task.count_classes-1845"><span class="linenos">1845</span></a>
</span><span id="Task.count_classes-1846"><a href="#Task.count_classes-1846"><span class="linenos">1846</span></a>        <span class="n">class_counts</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Task.count_classes-1847"><a href="#Task.count_classes-1847"><span class="linenos">1847</span></a>        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]:</span>
</span><span id="Task.count_classes-1848"><a href="#Task.count_classes-1848"><span class="linenos">1848</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Task.count_classes-1849"><a href="#Task.count_classes-1849"><span class="linenos">1849</span></a>                <span class="n">class_counts</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">count_classes</span><span class="p">(</span><span class="n">bouts</span><span class="p">)</span>
</span><span id="Task.count_classes-1850"><a href="#Task.count_classes-1850"><span class="linenos">1850</span></a>            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="Task.count_classes-1851"><a href="#Task.count_classes-1851"><span class="linenos">1851</span></a>                <span class="n">class_counts</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
</span><span id="Task.count_classes-1852"><a href="#Task.count_classes-1852"><span class="linenos">1852</span></a>        <span class="k">return</span> <span class="n">class_counts</span>
</span></pre></div>


            <div class="docstring"><p>Get a dictionary of class counts in different modes</p>

<h2 id="parameters">Parameters</h2>

<p>bouts : bool, default False
    if <code>True</code>, instead of frame counts segment counts are returned</p>

<h2 id="returns">Returns</h2>

<p>class_counts : dict
    a dictionary where first-level keys are "train", "val" and "test", second-level keys are
    class names and values are class counts (in frames)</p>
</div>


                            </div>
                            <div id="Task.behaviors_dict" class="classattr">
                                        <input id="Task.behaviors_dict-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">behaviors_dict</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Dict</span>:</span></span>

                <label class="view-source-button" for="Task.behaviors_dict-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.behaviors_dict"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.behaviors_dict-1854"><a href="#Task.behaviors_dict-1854"><span class="linenos">1854</span></a>    <span class="k">def</span> <span class="nf">behaviors_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="Task.behaviors_dict-1855"><a href="#Task.behaviors_dict-1855"><span class="linenos">1855</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.behaviors_dict-1856"><a href="#Task.behaviors_dict-1856"><span class="linenos">1856</span></a><span class="sd">        Get a behavior dictionary</span>
</span><span id="Task.behaviors_dict-1857"><a href="#Task.behaviors_dict-1857"><span class="linenos">1857</span></a>
</span><span id="Task.behaviors_dict-1858"><a href="#Task.behaviors_dict-1858"><span class="linenos">1858</span></a><span class="sd">        Keys are label indices and values are label names.</span>
</span><span id="Task.behaviors_dict-1859"><a href="#Task.behaviors_dict-1859"><span class="linenos">1859</span></a>
</span><span id="Task.behaviors_dict-1860"><a href="#Task.behaviors_dict-1860"><span class="linenos">1860</span></a><span class="sd">        Returns</span>
</span><span id="Task.behaviors_dict-1861"><a href="#Task.behaviors_dict-1861"><span class="linenos">1861</span></a><span class="sd">        -------</span>
</span><span id="Task.behaviors_dict-1862"><a href="#Task.behaviors_dict-1862"><span class="linenos">1862</span></a><span class="sd">        behaviors_dict : dict</span>
</span><span id="Task.behaviors_dict-1863"><a href="#Task.behaviors_dict-1863"><span class="linenos">1863</span></a><span class="sd">            behavior dictionary</span>
</span><span id="Task.behaviors_dict-1864"><a href="#Task.behaviors_dict-1864"><span class="linenos">1864</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.behaviors_dict-1865"><a href="#Task.behaviors_dict-1865"><span class="linenos">1865</span></a>
</span><span id="Task.behaviors_dict-1866"><a href="#Task.behaviors_dict-1866"><span class="linenos">1866</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">()</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Get a behavior dictionary</p>

<p>Keys are label indices and values are label names.</p>

<h2 id="returns">Returns</h2>

<p>behaviors_dict : dict
    behavior dictionary</p>
</div>


                            </div>
                            <div id="Task.update_parameters" class="classattr">
                                        <input id="Task.update_parameters-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_parameters</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Task.update_parameters-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.update_parameters"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.update_parameters-1868"><a href="#Task.update_parameters-1868"><span class="linenos">1868</span></a>    <span class="k">def</span> <span class="nf">update_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.update_parameters-1869"><a href="#Task.update_parameters-1869"><span class="linenos">1869</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.update_parameters-1870"><a href="#Task.update_parameters-1870"><span class="linenos">1870</span></a><span class="sd">        Update training parameters from a dictionary</span>
</span><span id="Task.update_parameters-1871"><a href="#Task.update_parameters-1871"><span class="linenos">1871</span></a>
</span><span id="Task.update_parameters-1872"><a href="#Task.update_parameters-1872"><span class="linenos">1872</span></a><span class="sd">        Parameters</span>
</span><span id="Task.update_parameters-1873"><a href="#Task.update_parameters-1873"><span class="linenos">1873</span></a><span class="sd">        ----------</span>
</span><span id="Task.update_parameters-1874"><a href="#Task.update_parameters-1874"><span class="linenos">1874</span></a><span class="sd">        parameters : dict</span>
</span><span id="Task.update_parameters-1875"><a href="#Task.update_parameters-1875"><span class="linenos">1875</span></a><span class="sd">            the update dictionary</span>
</span><span id="Task.update_parameters-1876"><a href="#Task.update_parameters-1876"><span class="linenos">1876</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.update_parameters-1877"><a href="#Task.update_parameters-1877"><span class="linenos">1877</span></a>
</span><span id="Task.update_parameters-1878"><a href="#Task.update_parameters-1878"><span class="linenos">1878</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lr&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
</span><span id="Task.update_parameters-1879"><a href="#Task.update_parameters-1879"><span class="linenos">1879</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parallel&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">)</span>
</span><span id="Task.update_parameters-1880"><a href="#Task.update_parameters-1880"><span class="linenos">1880</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
</span><span id="Task.update_parameters-1881"><a href="#Task.update_parameters-1881"><span class="linenos">1881</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
</span><span id="Task.update_parameters-1882"><a href="#Task.update_parameters-1882"><span class="linenos">1882</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="Task.update_parameters-1883"><a href="#Task.update_parameters-1883"><span class="linenos">1883</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
</span><span id="Task.update_parameters-1884"><a href="#Task.update_parameters-1884"><span class="linenos">1884</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
</span><span id="Task.update_parameters-1885"><a href="#Task.update_parameters-1885"><span class="linenos">1885</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">augment_train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;augment_train&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">augment_train</span><span class="p">))</span>
</span><span id="Task.update_parameters-1886"><a href="#Task.update_parameters-1886"><span class="linenos">1886</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">augment_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;augment_val&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">augment_val</span><span class="p">))</span>
</span><span id="Task.update_parameters-1887"><a href="#Task.update_parameters-1887"><span class="linenos">1887</span></a>        <span class="n">ssl_weights</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ssl_weights&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_weights</span><span class="p">)</span>
</span><span id="Task.update_parameters-1888"><a href="#Task.update_parameters-1888"><span class="linenos">1888</span></a>        <span class="k">if</span> <span class="n">ssl_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.update_parameters-1889"><a href="#Task.update_parameters-1889"><span class="linenos">1889</span></a>            <span class="n">ssl_weights</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_losses</span><span class="p">]</span>
</span><span id="Task.update_parameters-1890"><a href="#Task.update_parameters-1890"><span class="linenos">1890</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ssl_weights</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
</span><span id="Task.update_parameters-1891"><a href="#Task.update_parameters-1891"><span class="linenos">1891</span></a>            <span class="n">ssl_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">ssl_weights</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_losses</span><span class="p">]</span>
</span><span id="Task.update_parameters-1892"><a href="#Task.update_parameters-1892"><span class="linenos">1892</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ssl_weights</span> <span class="o">=</span> <span class="n">ssl_weights</span>
</span><span id="Task.update_parameters-1893"><a href="#Task.update_parameters-1893"><span class="linenos">1893</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_epochs</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_epochs&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">)</span>
</span><span id="Task.update_parameters-1894"><a href="#Task.update_parameters-1894"><span class="linenos">1894</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_save_epochs</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="Task.update_parameters-1895"><a href="#Task.update_parameters-1895"><span class="linenos">1895</span></a>            <span class="s2">&quot;model_save_epochs&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_epochs</span>
</span><span id="Task.update_parameters-1896"><a href="#Task.update_parameters-1896"><span class="linenos">1896</span></a>        <span class="p">)</span>
</span><span id="Task.update_parameters-1897"><a href="#Task.update_parameters-1897"><span class="linenos">1897</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_save_path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">)</span>
</span><span id="Task.update_parameters-1898"><a href="#Task.update_parameters-1898"><span class="linenos">1898</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pseudolabel</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pseudolabel&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudolabel</span><span class="p">)</span>
</span><span id="Task.update_parameters-1899"><a href="#Task.update_parameters-1899"><span class="linenos">1899</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">T1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pseudolabel_start&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T1</span><span class="p">))</span>
</span><span id="Task.update_parameters-1900"><a href="#Task.update_parameters-1900"><span class="linenos">1900</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">T2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;alpha_growth_stop&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T2</span><span class="p">))</span>
</span><span id="Task.update_parameters-1901"><a href="#Task.update_parameters-1901"><span class="linenos">1901</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;correction_interval&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">))</span>
</span><span id="Task.update_parameters-1902"><a href="#Task.update_parameters-1902"><span class="linenos">1902</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_f</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pseudolabel_alpha_f&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_f</span><span class="p">)</span>
</span><span id="Task.update_parameters-1903"><a href="#Task.update_parameters-1903"><span class="linenos">1903</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;log_file&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Update training parameters from a dictionary</p>

<h2 id="parameters">Parameters</h2>

<p>parameters : dict
    the update dictionary</p>
</div>


                            </div>
                            <div id="Task.generate_uncertainty_score" class="classattr">
                                        <input id="Task.generate_uncertainty_score-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_uncertainty_score</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">classes</span><span class="p">:</span> <span class="n">List</span>,</span><span class="param">	<span class="n">augment_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span>,</span><span class="param">	<span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;least_confidence&#39;</span>,</span><span class="param">	<span class="n">predicted</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">behaviors_dict</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Dict</span>:</span></span>

                <label class="view-source-button" for="Task.generate_uncertainty_score-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.generate_uncertainty_score"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.generate_uncertainty_score-1905"><a href="#Task.generate_uncertainty_score-1905"><span class="linenos">1905</span></a>    <span class="k">def</span> <span class="nf">generate_uncertainty_score</span><span class="p">(</span>
</span><span id="Task.generate_uncertainty_score-1906"><a href="#Task.generate_uncertainty_score-1906"><span class="linenos">1906</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Task.generate_uncertainty_score-1907"><a href="#Task.generate_uncertainty_score-1907"><span class="linenos">1907</span></a>        <span class="n">classes</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
</span><span id="Task.generate_uncertainty_score-1908"><a href="#Task.generate_uncertainty_score-1908"><span class="linenos">1908</span></a>        <span class="n">augment_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Task.generate_uncertainty_score-1909"><a href="#Task.generate_uncertainty_score-1909"><span class="linenos">1909</span></a>        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
</span><span id="Task.generate_uncertainty_score-1910"><a href="#Task.generate_uncertainty_score-1910"><span class="linenos">1910</span></a>        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;least_confidence&quot;</span><span class="p">,</span>
</span><span id="Task.generate_uncertainty_score-1911"><a href="#Task.generate_uncertainty_score-1911"><span class="linenos">1911</span></a>        <span class="n">predicted</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.generate_uncertainty_score-1912"><a href="#Task.generate_uncertainty_score-1912"><span class="linenos">1912</span></a>        <span class="n">behaviors_dict</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Task.generate_uncertainty_score-1913"><a href="#Task.generate_uncertainty_score-1913"><span class="linenos">1913</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="Task.generate_uncertainty_score-1914"><a href="#Task.generate_uncertainty_score-1914"><span class="linenos">1914</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.generate_uncertainty_score-1915"><a href="#Task.generate_uncertainty_score-1915"><span class="linenos">1915</span></a><span class="sd">        Generate frame-wise scores for active learning</span>
</span><span id="Task.generate_uncertainty_score-1916"><a href="#Task.generate_uncertainty_score-1916"><span class="linenos">1916</span></a>
</span><span id="Task.generate_uncertainty_score-1917"><a href="#Task.generate_uncertainty_score-1917"><span class="linenos">1917</span></a><span class="sd">        Parameters</span>
</span><span id="Task.generate_uncertainty_score-1918"><a href="#Task.generate_uncertainty_score-1918"><span class="linenos">1918</span></a><span class="sd">        ----------</span>
</span><span id="Task.generate_uncertainty_score-1919"><a href="#Task.generate_uncertainty_score-1919"><span class="linenos">1919</span></a><span class="sd">        classes : list</span>
</span><span id="Task.generate_uncertainty_score-1920"><a href="#Task.generate_uncertainty_score-1920"><span class="linenos">1920</span></a><span class="sd">            a list of class names or indices; their confidence scores will be computed separately and stacked</span>
</span><span id="Task.generate_uncertainty_score-1921"><a href="#Task.generate_uncertainty_score-1921"><span class="linenos">1921</span></a><span class="sd">        augment_n : int, default 0</span>
</span><span id="Task.generate_uncertainty_score-1922"><a href="#Task.generate_uncertainty_score-1922"><span class="linenos">1922</span></a><span class="sd">            the number of augmentations to average over</span>
</span><span id="Task.generate_uncertainty_score-1923"><a href="#Task.generate_uncertainty_score-1923"><span class="linenos">1923</span></a><span class="sd">        batch_size : int, default 32</span>
</span><span id="Task.generate_uncertainty_score-1924"><a href="#Task.generate_uncertainty_score-1924"><span class="linenos">1924</span></a><span class="sd">            the batch size</span>
</span><span id="Task.generate_uncertainty_score-1925"><a href="#Task.generate_uncertainty_score-1925"><span class="linenos">1925</span></a><span class="sd">        method : {&quot;least_confidence&quot;, &quot;entropy&quot;}</span>
</span><span id="Task.generate_uncertainty_score-1926"><a href="#Task.generate_uncertainty_score-1926"><span class="linenos">1926</span></a><span class="sd">            the method used to calculate the scores from the probability predictions (`&quot;least_confidence&quot;`: `1 - p_i` if</span>
</span><span id="Task.generate_uncertainty_score-1927"><a href="#Task.generate_uncertainty_score-1927"><span class="linenos">1927</span></a><span class="sd">            `p_i &gt; 0.5` or `p_i` if `p_i &lt; 0.5`; `&quot;entropy&quot;`: `- p_i * log(p_i) - (1 - p_i) * log(1 - p_i)`)</span>
</span><span id="Task.generate_uncertainty_score-1928"><a href="#Task.generate_uncertainty_score-1928"><span class="linenos">1928</span></a>
</span><span id="Task.generate_uncertainty_score-1929"><a href="#Task.generate_uncertainty_score-1929"><span class="linenos">1929</span></a><span class="sd">        Returns</span>
</span><span id="Task.generate_uncertainty_score-1930"><a href="#Task.generate_uncertainty_score-1930"><span class="linenos">1930</span></a><span class="sd">        -------</span>
</span><span id="Task.generate_uncertainty_score-1931"><a href="#Task.generate_uncertainty_score-1931"><span class="linenos">1931</span></a><span class="sd">        score_dicts : dict</span>
</span><span id="Task.generate_uncertainty_score-1932"><a href="#Task.generate_uncertainty_score-1932"><span class="linenos">1932</span></a><span class="sd">            a nested dictionary where first level keys are video ids, second level keys are clip ids and values</span>
</span><span id="Task.generate_uncertainty_score-1933"><a href="#Task.generate_uncertainty_score-1933"><span class="linenos">1933</span></a><span class="sd">            are score tensors</span>
</span><span id="Task.generate_uncertainty_score-1934"><a href="#Task.generate_uncertainty_score-1934"><span class="linenos">1934</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.generate_uncertainty_score-1935"><a href="#Task.generate_uncertainty_score-1935"><span class="linenos">1935</span></a>
</span><span id="Task.generate_uncertainty_score-1936"><a href="#Task.generate_uncertainty_score-1936"><span class="linenos">1936</span></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
</span><span id="Task.generate_uncertainty_score-1937"><a href="#Task.generate_uncertainty_score-1937"><span class="linenos">1937</span></a>        <span class="k">if</span> <span class="n">behaviors_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.generate_uncertainty_score-1938"><a href="#Task.generate_uncertainty_score-1938"><span class="linenos">1938</span></a>            <span class="n">behaviors_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span>
</span><span id="Task.generate_uncertainty_score-1939"><a href="#Task.generate_uncertainty_score-1939"><span class="linenos">1939</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">BehaviorDataset</span><span class="p">):</span>
</span><span id="Task.generate_uncertainty_score-1940"><a href="#Task.generate_uncertainty_score-1940"><span class="linenos">1940</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="Task.generate_uncertainty_score-1941"><a href="#Task.generate_uncertainty_score-1941"><span class="linenos">1941</span></a>                <span class="sa">f</span><span class="s2">&quot;The dataset parameter has to be either None, string, &quot;</span>
</span><span id="Task.generate_uncertainty_score-1942"><a href="#Task.generate_uncertainty_score-1942"><span class="linenos">1942</span></a>                <span class="sa">f</span><span class="s2">&quot;BehaviorDataset or Dataloader, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task.generate_uncertainty_score-1943"><a href="#Task.generate_uncertainty_score-1943"><span class="linenos">1943</span></a>            <span class="p">)</span>
</span><span id="Task.generate_uncertainty_score-1944"><a href="#Task.generate_uncertainty_score-1944"><span class="linenos">1944</span></a>        <span class="k">if</span> <span class="n">predicted</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Task.generate_uncertainty_score-1945"><a href="#Task.generate_uncertainty_score-1945"><span class="linenos">1945</span></a>            <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
</span><span id="Task.generate_uncertainty_score-1946"><a href="#Task.generate_uncertainty_score-1946"><span class="linenos">1946</span></a>                <span class="n">dataset</span><span class="p">,</span>
</span><span id="Task.generate_uncertainty_score-1947"><a href="#Task.generate_uncertainty_score-1947"><span class="linenos">1947</span></a>                <span class="n">raw_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task.generate_uncertainty_score-1948"><a href="#Task.generate_uncertainty_score-1948"><span class="linenos">1948</span></a>                <span class="n">apply_primary_function</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task.generate_uncertainty_score-1949"><a href="#Task.generate_uncertainty_score-1949"><span class="linenos">1949</span></a>                <span class="n">augment_n</span><span class="o">=</span><span class="n">augment_n</span><span class="p">,</span>
</span><span id="Task.generate_uncertainty_score-1950"><a href="#Task.generate_uncertainty_score-1950"><span class="linenos">1950</span></a>                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="Task.generate_uncertainty_score-1951"><a href="#Task.generate_uncertainty_score-1951"><span class="linenos">1951</span></a>            <span class="p">)</span>
</span><span id="Task.generate_uncertainty_score-1952"><a href="#Task.generate_uncertainty_score-1952"><span class="linenos">1952</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">generate_full_length_prediction</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="Task.generate_uncertainty_score-1953"><a href="#Task.generate_uncertainty_score-1953"><span class="linenos">1953</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">classes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Task.generate_uncertainty_score-1954"><a href="#Task.generate_uncertainty_score-1954"><span class="linenos">1954</span></a>            <span class="n">behaviors_dict_inverse</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">behaviors_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Task.generate_uncertainty_score-1955"><a href="#Task.generate_uncertainty_score-1955"><span class="linenos">1955</span></a>            <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">behaviors_dict_inverse</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">]</span>
</span><span id="Task.generate_uncertainty_score-1956"><a href="#Task.generate_uncertainty_score-1956"><span class="linenos">1956</span></a>        <span class="k">for</span> <span class="n">v_id</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">predicted</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Task.generate_uncertainty_score-1957"><a href="#Task.generate_uncertainty_score-1957"><span class="linenos">1957</span></a>            <span class="k">for</span> <span class="n">clip_id</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Task.generate_uncertainty_score-1958"><a href="#Task.generate_uncertainty_score-1958"><span class="linenos">1958</span></a>                <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;least_confidence&quot;</span><span class="p">:</span>
</span><span id="Task.generate_uncertainty_score-1959"><a href="#Task.generate_uncertainty_score-1959"><span class="linenos">1959</span></a>                    <span class="n">predicted</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">][</span><span class="n">vv</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">vv</span><span class="p">[</span><span class="n">vv</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">]</span>
</span><span id="Task.generate_uncertainty_score-1960"><a href="#Task.generate_uncertainty_score-1960"><span class="linenos">1960</span></a>                <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;entropy&quot;</span><span class="p">:</span>
</span><span id="Task.generate_uncertainty_score-1961"><a href="#Task.generate_uncertainty_score-1961"><span class="linenos">1961</span></a>                    <span class="n">predicted</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">][</span><span class="n">vv</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Task.generate_uncertainty_score-1962"><a href="#Task.generate_uncertainty_score-1962"><span class="linenos">1962</span></a>                        <span class="o">-</span><span class="n">vv</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">vv</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">vv</span><span class="p">)</span>
</span><span id="Task.generate_uncertainty_score-1963"><a href="#Task.generate_uncertainty_score-1963"><span class="linenos">1963</span></a>                    <span class="p">)[</span><span class="n">vv</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">100</span><span class="p">]</span>
</span><span id="Task.generate_uncertainty_score-1964"><a href="#Task.generate_uncertainty_score-1964"><span class="linenos">1964</span></a>                <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
</span><span id="Task.generate_uncertainty_score-1965"><a href="#Task.generate_uncertainty_score-1965"><span class="linenos">1965</span></a>                    <span class="n">predicted</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">vv</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Task.generate_uncertainty_score-1966"><a href="#Task.generate_uncertainty_score-1966"><span class="linenos">1966</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Task.generate_uncertainty_score-1967"><a href="#Task.generate_uncertainty_score-1967"><span class="linenos">1967</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Task.generate_uncertainty_score-1968"><a href="#Task.generate_uncertainty_score-1968"><span class="linenos">1968</span></a>                        <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> method is not recognized; please choose from [&#39;least_confidence&#39;, &#39;entropy&#39;]&quot;</span>
</span><span id="Task.generate_uncertainty_score-1969"><a href="#Task.generate_uncertainty_score-1969"><span class="linenos">1969</span></a>                    <span class="p">)</span>
</span><span id="Task.generate_uncertainty_score-1970"><a href="#Task.generate_uncertainty_score-1970"><span class="linenos">1970</span></a>                <span class="n">predicted</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">][</span><span class="n">vv</span> <span class="o">==</span> <span class="o">-</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Task.generate_uncertainty_score-1971"><a href="#Task.generate_uncertainty_score-1971"><span class="linenos">1971</span></a>
</span><span id="Task.generate_uncertainty_score-1972"><a href="#Task.generate_uncertainty_score-1972"><span class="linenos">1972</span></a>        <span class="n">predicted</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Task.generate_uncertainty_score-1973"><a href="#Task.generate_uncertainty_score-1973"><span class="linenos">1973</span></a>            <span class="n">v_id</span><span class="p">:</span> <span class="p">{</span><span class="n">clip_id</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">classes</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">clip_id</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">video_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Task.generate_uncertainty_score-1974"><a href="#Task.generate_uncertainty_score-1974"><span class="linenos">1974</span></a>            <span class="k">for</span> <span class="n">v_id</span><span class="p">,</span> <span class="n">video_dict</span> <span class="ow">in</span> <span class="n">predicted</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Task.generate_uncertainty_score-1975"><a href="#Task.generate_uncertainty_score-1975"><span class="linenos">1975</span></a>        <span class="p">}</span>
</span><span id="Task.generate_uncertainty_score-1976"><a href="#Task.generate_uncertainty_score-1976"><span class="linenos">1976</span></a>        <span class="k">return</span> <span class="n">predicted</span>
</span></pre></div>


            <div class="docstring"><p>Generate frame-wise scores for active learning</p>

<h2 id="parameters">Parameters</h2>

<p>classes : list
    a list of class names or indices; their confidence scores will be computed separately and stacked
augment_n : int, default 0
    the number of augmentations to average over
batch_size : int, default 32
    the batch size
method : {"least_confidence", "entropy"}
    the method used to calculate the scores from the probability predictions (<code>"least_confidence"</code>: <code>1 - p_i</code> if
    <code>p_i &gt; 0.5</code> or <code>p_i</code> if <code>p_i &lt; 0.5</code>; <code>"entropy"</code>: <code>- p_i * log(p_i) - (1 - p_i) * log(1 - p_i)</code>)</p>

<h2 id="returns">Returns</h2>

<p>score_dicts : dict
    a nested dictionary where first level keys are video ids, second level keys are clip ids and values
    are score tensors</p>
</div>


                            </div>
                            <div id="Task.generate_bald_score" class="classattr">
                                        <input id="Task.generate_bald_score-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_bald_score</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">classes</span><span class="p">:</span> <span class="n">List</span>,</span><span class="param">	<span class="n">augment_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span>,</span><span class="param">	<span class="n">num_models</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>,</span><span class="param">	<span class="n">kernel_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">11</span></span><span class="return-annotation">) -> <span class="n">Dict</span>:</span></span>

                <label class="view-source-button" for="Task.generate_bald_score-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.generate_bald_score"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.generate_bald_score-1978"><a href="#Task.generate_bald_score-1978"><span class="linenos">1978</span></a>    <span class="k">def</span> <span class="nf">generate_bald_score</span><span class="p">(</span>
</span><span id="Task.generate_bald_score-1979"><a href="#Task.generate_bald_score-1979"><span class="linenos">1979</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Task.generate_bald_score-1980"><a href="#Task.generate_bald_score-1980"><span class="linenos">1980</span></a>        <span class="n">classes</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
</span><span id="Task.generate_bald_score-1981"><a href="#Task.generate_bald_score-1981"><span class="linenos">1981</span></a>        <span class="n">augment_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Task.generate_bald_score-1982"><a href="#Task.generate_bald_score-1982"><span class="linenos">1982</span></a>        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
</span><span id="Task.generate_bald_score-1983"><a href="#Task.generate_bald_score-1983"><span class="linenos">1983</span></a>        <span class="n">num_models</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="Task.generate_bald_score-1984"><a href="#Task.generate_bald_score-1984"><span class="linenos">1984</span></a>        <span class="n">kernel_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
</span><span id="Task.generate_bald_score-1985"><a href="#Task.generate_bald_score-1985"><span class="linenos">1985</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="Task.generate_bald_score-1986"><a href="#Task.generate_bald_score-1986"><span class="linenos">1986</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Task.generate_bald_score-1987"><a href="#Task.generate_bald_score-1987"><span class="linenos">1987</span></a><span class="sd">        Generate frame-wise Bayesian Active Learning by Disagreement scores for active learning</span>
</span><span id="Task.generate_bald_score-1988"><a href="#Task.generate_bald_score-1988"><span class="linenos">1988</span></a>
</span><span id="Task.generate_bald_score-1989"><a href="#Task.generate_bald_score-1989"><span class="linenos">1989</span></a><span class="sd">        Parameters</span>
</span><span id="Task.generate_bald_score-1990"><a href="#Task.generate_bald_score-1990"><span class="linenos">1990</span></a><span class="sd">        ----------</span>
</span><span id="Task.generate_bald_score-1991"><a href="#Task.generate_bald_score-1991"><span class="linenos">1991</span></a><span class="sd">        classes : list</span>
</span><span id="Task.generate_bald_score-1992"><a href="#Task.generate_bald_score-1992"><span class="linenos">1992</span></a><span class="sd">            a list of class names or indices; their confidence scores will be computed separately and stacked</span>
</span><span id="Task.generate_bald_score-1993"><a href="#Task.generate_bald_score-1993"><span class="linenos">1993</span></a><span class="sd">        augment_n : int, default 0</span>
</span><span id="Task.generate_bald_score-1994"><a href="#Task.generate_bald_score-1994"><span class="linenos">1994</span></a><span class="sd">            the number of augmentations to average over</span>
</span><span id="Task.generate_bald_score-1995"><a href="#Task.generate_bald_score-1995"><span class="linenos">1995</span></a><span class="sd">        batch_size : int, default 32</span>
</span><span id="Task.generate_bald_score-1996"><a href="#Task.generate_bald_score-1996"><span class="linenos">1996</span></a><span class="sd">            the batch size</span>
</span><span id="Task.generate_bald_score-1997"><a href="#Task.generate_bald_score-1997"><span class="linenos">1997</span></a><span class="sd">        num_models : int, default 10</span>
</span><span id="Task.generate_bald_score-1998"><a href="#Task.generate_bald_score-1998"><span class="linenos">1998</span></a><span class="sd">            the number of dropout masks to apply</span>
</span><span id="Task.generate_bald_score-1999"><a href="#Task.generate_bald_score-1999"><span class="linenos">1999</span></a><span class="sd">        kernel_size : int, default 11</span>
</span><span id="Task.generate_bald_score-2000"><a href="#Task.generate_bald_score-2000"><span class="linenos">2000</span></a><span class="sd">            the size of the smoothing gaussian kernel</span>
</span><span id="Task.generate_bald_score-2001"><a href="#Task.generate_bald_score-2001"><span class="linenos">2001</span></a>
</span><span id="Task.generate_bald_score-2002"><a href="#Task.generate_bald_score-2002"><span class="linenos">2002</span></a><span class="sd">        Returns</span>
</span><span id="Task.generate_bald_score-2003"><a href="#Task.generate_bald_score-2003"><span class="linenos">2003</span></a><span class="sd">        -------</span>
</span><span id="Task.generate_bald_score-2004"><a href="#Task.generate_bald_score-2004"><span class="linenos">2004</span></a><span class="sd">        score_dicts : dict</span>
</span><span id="Task.generate_bald_score-2005"><a href="#Task.generate_bald_score-2005"><span class="linenos">2005</span></a><span class="sd">            a nested dictionary where first level keys are video ids, second level keys are clip ids and values</span>
</span><span id="Task.generate_bald_score-2006"><a href="#Task.generate_bald_score-2006"><span class="linenos">2006</span></a><span class="sd">            are score tensors</span>
</span><span id="Task.generate_bald_score-2007"><a href="#Task.generate_bald_score-2007"><span class="linenos">2007</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Task.generate_bald_score-2008"><a href="#Task.generate_bald_score-2008"><span class="linenos">2008</span></a>
</span><span id="Task.generate_bald_score-2009"><a href="#Task.generate_bald_score-2009"><span class="linenos">2009</span></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
</span><span id="Task.generate_bald_score-2010"><a href="#Task.generate_bald_score-2010"><span class="linenos">2010</span></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="Task.generate_bald_score-2011"><a href="#Task.generate_bald_score-2011"><span class="linenos">2011</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">BehaviorDataset</span><span class="p">):</span>
</span><span id="Task.generate_bald_score-2012"><a href="#Task.generate_bald_score-2012"><span class="linenos">2012</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="Task.generate_bald_score-2013"><a href="#Task.generate_bald_score-2013"><span class="linenos">2013</span></a>                <span class="sa">f</span><span class="s2">&quot;The dataset parameter has to be either None, string, &quot;</span>
</span><span id="Task.generate_bald_score-2014"><a href="#Task.generate_bald_score-2014"><span class="linenos">2014</span></a>                <span class="sa">f</span><span class="s2">&quot;BehaviorDataset or Dataloader, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Task.generate_bald_score-2015"><a href="#Task.generate_bald_score-2015"><span class="linenos">2015</span></a>            <span class="p">)</span>
</span><span id="Task.generate_bald_score-2016"><a href="#Task.generate_bald_score-2016"><span class="linenos">2016</span></a>        <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Task.generate_bald_score-2017"><a href="#Task.generate_bald_score-2017"><span class="linenos">2017</span></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_models</span><span class="p">):</span>
</span><span id="Task.generate_bald_score-2018"><a href="#Task.generate_bald_score-2018"><span class="linenos">2018</span></a>            <span class="n">predicted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
</span><span id="Task.generate_bald_score-2019"><a href="#Task.generate_bald_score-2019"><span class="linenos">2019</span></a>                <span class="n">dataset</span><span class="p">,</span>
</span><span id="Task.generate_bald_score-2020"><a href="#Task.generate_bald_score-2020"><span class="linenos">2020</span></a>                <span class="n">raw_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task.generate_bald_score-2021"><a href="#Task.generate_bald_score-2021"><span class="linenos">2021</span></a>                <span class="n">apply_primary_function</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task.generate_bald_score-2022"><a href="#Task.generate_bald_score-2022"><span class="linenos">2022</span></a>                <span class="n">augment_n</span><span class="o">=</span><span class="n">augment_n</span><span class="p">,</span>
</span><span id="Task.generate_bald_score-2023"><a href="#Task.generate_bald_score-2023"><span class="linenos">2023</span></a>                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="Task.generate_bald_score-2024"><a href="#Task.generate_bald_score-2024"><span class="linenos">2024</span></a>                <span class="n">train_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Task.generate_bald_score-2025"><a href="#Task.generate_bald_score-2025"><span class="linenos">2025</span></a>            <span class="p">)</span>
</span><span id="Task.generate_bald_score-2026"><a href="#Task.generate_bald_score-2026"><span class="linenos">2026</span></a>            <span class="n">predicted</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">generate_full_length_prediction</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="Task.generate_bald_score-2027"><a href="#Task.generate_bald_score-2027"><span class="linenos">2027</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">classes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Task.generate_bald_score-2028"><a href="#Task.generate_bald_score-2028"><span class="linenos">2028</span></a>                <span class="n">behaviors_dict_inverse</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Task.generate_bald_score-2029"><a href="#Task.generate_bald_score-2029"><span class="linenos">2029</span></a>                    <span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">behaviors_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Task.generate_bald_score-2030"><a href="#Task.generate_bald_score-2030"><span class="linenos">2030</span></a>                <span class="p">}</span>
</span><span id="Task.generate_bald_score-2031"><a href="#Task.generate_bald_score-2031"><span class="linenos">2031</span></a>                <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">behaviors_dict_inverse</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">]</span>
</span><span id="Task.generate_bald_score-2032"><a href="#Task.generate_bald_score-2032"><span class="linenos">2032</span></a>            <span class="k">for</span> <span class="n">v_id</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">predicted</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Task.generate_bald_score-2033"><a href="#Task.generate_bald_score-2033"><span class="linenos">2033</span></a>                <span class="k">for</span> <span class="n">clip_id</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Task.generate_bald_score-2034"><a href="#Task.generate_bald_score-2034"><span class="linenos">2034</span></a>                    <span class="n">vv</span><span class="p">[</span><span class="n">vv</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vv</span><span class="p">[</span><span class="n">vv</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">100</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">int</span><span class="p">()</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
</span><span id="Task.generate_bald_score-2035"><a href="#Task.generate_bald_score-2035"><span class="linenos">2035</span></a>                    <span class="n">predicted</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">vv</span>
</span><span id="Task.generate_bald_score-2036"><a href="#Task.generate_bald_score-2036"><span class="linenos">2036</span></a>            <span class="n">predicted</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Task.generate_bald_score-2037"><a href="#Task.generate_bald_score-2037"><span class="linenos">2037</span></a>                <span class="n">v_id</span><span class="p">:</span> <span class="p">{</span><span class="n">clip_id</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">classes</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">clip_id</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">video_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Task.generate_bald_score-2038"><a href="#Task.generate_bald_score-2038"><span class="linenos">2038</span></a>                <span class="k">for</span> <span class="n">v_id</span><span class="p">,</span> <span class="n">video_dict</span> <span class="ow">in</span> <span class="n">predicted</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Task.generate_bald_score-2039"><a href="#Task.generate_bald_score-2039"><span class="linenos">2039</span></a>            <span class="p">}</span>
</span><span id="Task.generate_bald_score-2040"><a href="#Task.generate_bald_score-2040"><span class="linenos">2040</span></a>            <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</span><span id="Task.generate_bald_score-2041"><a href="#Task.generate_bald_score-2041"><span class="linenos">2041</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">v_id</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">v_id</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
</span><span id="Task.generate_bald_score-2042"><a href="#Task.generate_bald_score-2042"><span class="linenos">2042</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">kernel_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">kernel_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Task.generate_bald_score-2043"><a href="#Task.generate_bald_score-2043"><span class="linenos">2043</span></a>        <span class="n">gauss</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">))</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">1</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="p">]</span>
</span><span id="Task.generate_bald_score-2044"><a href="#Task.generate_bald_score-2044"><span class="linenos">2044</span></a>        <span class="n">gauss</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">gauss</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">gauss</span><span class="p">]</span>
</span><span id="Task.generate_bald_score-2045"><a href="#Task.generate_bald_score-2045"><span class="linenos">2045</span></a>        <span class="n">kernel</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">([[</span><span class="n">gauss</span><span class="p">]])</span>
</span><span id="Task.generate_bald_score-2046"><a href="#Task.generate_bald_score-2046"><span class="linenos">2046</span></a>        <span class="k">for</span> <span class="n">v_id</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="Task.generate_bald_score-2047"><a href="#Task.generate_bald_score-2047"><span class="linenos">2047</span></a>            <span class="k">for</span> <span class="n">clip_id</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">v_id</span><span class="p">]:</span>
</span><span id="Task.generate_bald_score-2048"><a href="#Task.generate_bald_score-2048"><span class="linenos">2048</span></a>                <span class="n">consensus</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Task.generate_bald_score-2049"><a href="#Task.generate_bald_score-2049"><span class="linenos">2049</span></a>                    <span class="p">(</span>
</span><span id="Task.generate_bald_score-2050"><a href="#Task.generate_bald_score-2050"><span class="linenos">2050</span></a>                        <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
</span><span id="Task.generate_bald_score-2051"><a href="#Task.generate_bald_score-2051"><span class="linenos">2051</span></a>                            <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span>
</span><span id="Task.generate_bald_score-2052"><a href="#Task.generate_bald_score-2052"><span class="linenos">2052</span></a>                        <span class="p">)</span>
</span><span id="Task.generate_bald_score-2053"><a href="#Task.generate_bald_score-2053"><span class="linenos">2053</span></a>                        <span class="o">&gt;</span> <span class="mf">0.5</span>
</span><span id="Task.generate_bald_score-2054"><a href="#Task.generate_bald_score-2054"><span class="linenos">2054</span></a>                    <span class="p">)</span>
</span><span id="Task.generate_bald_score-2055"><a href="#Task.generate_bald_score-2055"><span class="linenos">2055</span></a>                    <span class="o">.</span><span class="n">int</span><span class="p">()</span>
</span><span id="Task.generate_bald_score-2056"><a href="#Task.generate_bald_score-2056"><span class="linenos">2056</span></a>                    <span class="o">.</span><span class="n">float</span><span class="p">()</span>
</span><span id="Task.generate_bald_score-2057"><a href="#Task.generate_bald_score-2057"><span class="linenos">2057</span></a>                <span class="p">)</span>
</span><span id="Task.generate_bald_score-2058"><a href="#Task.generate_bald_score-2058"><span class="linenos">2058</span></a>                <span class="n">consensus</span><span class="p">[</span><span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>
</span><span id="Task.generate_bald_score-2059"><a href="#Task.generate_bald_score-2059"><span class="linenos">2059</span></a>                <span class="n">result</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">consensus</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Task.generate_bald_score-2060"><a href="#Task.generate_bald_score-2060"><span class="linenos">2060</span></a>                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">:</span>
</span><span id="Task.generate_bald_score-2061"><a href="#Task.generate_bald_score-2061"><span class="linenos">2061</span></a>                    <span class="n">result</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">!=</span> <span class="n">consensus</span><span class="p">)</span><span class="o">.</span><span class="n">int</span><span class="p">()</span>
</span><span id="Task.generate_bald_score-2062"><a href="#Task.generate_bald_score-2062"><span class="linenos">2062</span></a>                <span class="n">result</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">num_models</span>
</span><span id="Task.generate_bald_score-2063"><a href="#Task.generate_bald_score-2063"><span class="linenos">2063</span></a>                <span class="n">res</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Task.generate_bald_score-2064"><a href="#Task.generate_bald_score-2064"><span class="linenos">2064</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)):</span>
</span><span id="Task.generate_bald_score-2065"><a href="#Task.generate_bald_score-2065"><span class="linenos">2065</span></a>                    <span class="n">res</span><span class="p">[</span>
</span><span id="Task.generate_bald_score-2066"><a href="#Task.generate_bald_score-2066"><span class="linenos">2066</span></a>                        <span class="n">i</span><span class="p">,</span> <span class="n">floor</span><span class="p">(</span><span class="n">kernel_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="p">:</span> <span class="o">-</span><span class="n">floor</span><span class="p">(</span><span class="n">kernel_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="Task.generate_bald_score-2067"><a href="#Task.generate_bald_score-2067"><span class="linenos">2067</span></a>                    <span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">conv1d</span><span class="p">(</span>
</span><span id="Task.generate_bald_score-2068"><a href="#Task.generate_bald_score-2068"><span class="linenos">2068</span></a>                        <span class="n">result</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">kernel</span>
</span><span id="Task.generate_bald_score-2069"><a href="#Task.generate_bald_score-2069"><span class="linenos">2069</span></a>                    <span class="p">)[</span>
</span><span id="Task.generate_bald_score-2070"><a href="#Task.generate_bald_score-2070"><span class="linenos">2070</span></a>                        <span class="mi">0</span><span class="p">,</span> <span class="o">...</span>
</span><span id="Task.generate_bald_score-2071"><a href="#Task.generate_bald_score-2071"><span class="linenos">2071</span></a>                    <span class="p">]</span>
</span><span id="Task.generate_bald_score-2072"><a href="#Task.generate_bald_score-2072"><span class="linenos">2072</span></a>                <span class="n">result</span><span class="p">[</span><span class="n">v_id</span><span class="p">][</span><span class="n">clip_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
</span><span id="Task.generate_bald_score-2073"><a href="#Task.generate_bald_score-2073"><span class="linenos">2073</span></a>        <span class="k">return</span> <span class="n">result</span>
</span></pre></div>


            <div class="docstring"><p>Generate frame-wise Bayesian Active Learning by Disagreement scores for active learning</p>

<h2 id="parameters">Parameters</h2>

<p>classes : list
    a list of class names or indices; their confidence scores will be computed separately and stacked
augment_n : int, default 0
    the number of augmentations to average over
batch_size : int, default 32
    the batch size
num_models : int, default 10
    the number of dropout masks to apply
kernel_size : int, default 11
    the size of the smoothing gaussian kernel</p>

<h2 id="returns">Returns</h2>

<p>score_dicts : dict
    a nested dictionary where first level keys are video ids, second level keys are clip ids and values
    are score tensors</p>
</div>


                            </div>
                            <div id="Task.get_normalization_stats" class="classattr">
                                        <input id="Task.get_normalization_stats-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_normalization_stats</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Task.get_normalization_stats-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Task.get_normalization_stats"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Task.get_normalization_stats-2075"><a href="#Task.get_normalization_stats-2075"><span class="linenos">2075</span></a>    <span class="k">def</span> <span class="nf">get_normalization_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="Task.get_normalization_stats-2076"><a href="#Task.get_normalization_stats-2076"><span class="linenos">2076</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">stats</span>
</span></pre></div>


    

                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.type) {
                    case "function":
                        heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span><span class="signature">${doc.signature}:</span>`;
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.type}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>